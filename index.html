<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora News Ticker - V80 (Night Mode Features)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@500;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js" type="module"></script>
    <script src="https://unpkg.com/suncalc@1.8.0/suncalc.js"></script>

    <style>
        :root {
            /* Palette */
            --bg-grad-1: #020617;
            --bg-grad-2: #1e293b;
            --bg-grad-3: #0f172a;
            
            /* Glass UI */
            --glass-bg: rgba(10, 15, 30, 0.92); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 4px 25px 0 rgba(0, 0, 0, 0.6);
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-color: #38bdf8;
            --accent-warm: #fbbf24;
            --accent-danger: #ef4444;
            --accent-next: #a855f7; 
            
            --font-head: 'Montserrat', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --card-radius: 12px;
            --bar-height: 170px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            background-color: transparent;
            font-family: var(--font-body);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .ambient-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3));
            background-size: 300% 300%;
            animation: skyFlow 60s ease infinite;
        }
        @keyframes skyFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .ticker-container { width: 100%; max-width: 1200px; height: var(--bar-height); display: flex; gap: 10px; position: relative; }
        @media (max-width: 900px) { .ticker-container { height: auto; flex-direction: column; } }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow); overflow: hidden; position: relative;
            perspective: 1000px;
        }

        /* --- FLIP MECHANICS (BOUNCY!) --- */
        .panel-flipper {
            width: 100%; height: 100%;
            transition: transform 1.2s cubic-bezier(0.3, 2.5, 0.6, 0.8);
            transform-style: preserve-3d;
            position: relative;
        }
        .panel-flipper.flipped { transform: rotateX(180deg); }
        .panel-face {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column; background: var(--glass-bg);
        }
        .panel-face.back { transform: rotateX(180deg); display: flex; align-items: center; justify-content: center; }

        /* --- IDENTITY --- */
        .identity-panel { width: 190px; flex-shrink: 0; }
        
        .id-content { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.4));
        }
        
        .credits-content {
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            background: linear-gradient(135deg, #0f172a, #1e293b);
        }
        
        .cr-logo { font-size: 1.5rem; margin-bottom: 5px; color: var(--accent-warm); animation: pulseLogo 2s infinite; }
        .cr-head { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 2px;}
        .cr-dev { font-family: var(--font-head); font-size: 1.3rem; font-weight: 900; color: #fff; margin: 0 0 8px 0; background: linear-gradient(to right, #fff, var(--accent-warm)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cr-ft { font-size: 0.5rem; font-family: var(--font-mono); color: #64748b; border-top: 1px solid #334155; padding-top: 4px; width: 85%; }

        .brand-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .brand-logo svg { width: 24px; height: 24px; fill: var(--accent-color); filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.6)); animation: pulseLogo 3s infinite ease-in-out; }
        .brand-name { font-family: var(--font-head); font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; color: #fff; }
        .clock-display { font-family: var(--font-mono); font-size: 1.4rem; font-weight: 500; color: #fff; line-height: 1; margin-bottom: 4px; letter-spacing: 0.5px; opacity: 0.9; }
        .date-display { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500; }
        .nameday-badge { background: rgba(var(--accent-warm), 0.15); color: var(--accent-warm); padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 600; max-width: 100%; border: 1px solid rgba(251, 191, 36, 0.3); }

        /* --- NEWS --- */
        .news-panel { flex-grow: 1; display: flex; flex-direction: column; position: relative; cursor: pointer; }
        .news-panel:hover .news-card.visible { transform: scale(1.01); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); border: 1px solid rgba(56, 189, 248, 0.3); background: rgba(255,255,255,0.02); border-radius: var(--card-radius); }

        .news-viewport { flex-grow: 1; position: relative; overflow: hidden; z-index: 2; }
        .news-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding: 12px 20px; gap: 5px; opacity: 0; visibility: hidden; transform: translateY(15px);
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .news-card.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .news-header-row { flex: 0 0 auto; display: flex; align-items: center; gap: 10px; margin-bottom: 6px; width: 100%; }
        .news-meta { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent-color); font-weight: 700; }
        .provider-identity { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 15px; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .provider-icon { width: 14px; height: 14px; border-radius: 50%; }
        .news-content-wrapper { flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; min-height: 0; gap: 4px; }
        .news-title { flex: 0 0 auto; font-family: var(--font-head); font-size: 1.05rem; font-weight: 700; line-height: 1.3; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; width: 90%; }
        .news-desc { flex: 0 1 auto; font-size: 0.8rem; color: #cbd5e1; font-weight: 400; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; max-width: 98%; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        
        .news-image-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; mask-image: linear-gradient(to right, transparent, black 15%, black 100%); opacity: 0; transition: opacity 1s ease; pointer-events: none; z-index: 1; }
        .news-image-overlay img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(30%) contrast(1.2); }
        .news-panel.has-image .news-image-overlay { opacity: 0.12; }
        .news-card.breaking { background: linear-gradient(90deg, rgba(220, 38, 38, 0.25), rgba(220, 38, 38, 0.05)); border-left: 4px solid var(--accent-danger); }

        /* NIGHT INFO CARD STYLE */
        .news-card.night-info {
            background: radial-gradient(circle at top left, #312e81, #1e1b4b);
            border-left: 4px solid #a855f7;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .ni-icon { font-size: 3rem; margin-bottom: 10px; animation: float 6s ease-in-out infinite; }
        .ni-text { font-family: var(--font-head); font-size: 1.1rem; color: #fff; line-height: 1.5; font-weight: 600; max-width: 80%; }
        .ni-sub { font-size: 0.8rem; color: var(--accent-color); margin-top: 10px; font-weight: 700; text-transform: uppercase; }

        .goodbye-card { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #334155 0%, #020617 100%); opacity: 0; visibility: hidden; transition: opacity 1s; z-index: 100; }
        .goodbye-card.active { opacity: 1; visibility: visible; }
        .gb-moon { font-size: 3rem; margin-bottom: 8px; filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.5)); animation: float 6s ease-in-out infinite; }
        .gb-title { font-family: var(--font-head); font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 4px; }
        .gb-sub { font-size: 0.8rem; color: var(--accent-color); font-family: var(--font-mono); }

        .big-clock-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .big-clock-layer.active { opacity: 1; pointer-events: all; }
        .bc-time { font-family: var(--font-mono); font-size: 4rem; font-weight: 700; color: #fff; text-shadow: 0 0 30px rgba(56, 189, 248, 0.5); }
        .bc-label { color: var(--accent-warm); font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; }

        .program-badge { position: absolute; top: 12px; right: 12px; font-family: var(--font-head); font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); text-transform: uppercase; background: rgba(0,0,0,0.5); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; z-index: 10; }
        .program-badge.breaking-mode { background: var(--accent-danger); color: #fff; border-color: transparent; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); animation: pulseRed 1s infinite; }

        .night-sub-label { position: absolute; top: 38px; right: 12px; font-family: var(--font-mono); font-size: 0.55rem; color: var(--accent-warm); text-transform: uppercase; font-weight: 700; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px; z-index: 9; opacity: 0; transition: opacity 0.5s; pointer-events: none; border: 1px solid rgba(251, 191, 36, 0.2); }
        .night-sub-label.active { opacity: 1; }

        .controls-bar { height: 28px; border-top: 1px solid var(--glass-border); display: flex; align-items: center; padding: 0 10px; background: rgba(0,0,0,0.3); font-size: 0.7rem; z-index: 5; position: relative; justify-content: space-between; }
        
        .next-prog-alert { 
            display: none; 
            align-items: center; 
            gap: 5px; 
            color: var(--accent-next); 
            font-weight: 700; 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .next-prog-alert.active { display: flex; }
        
        .progress-line-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); z-index: 6; }
        .progress-line { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-color), var(--accent-warm)); box-shadow: 0 0 8px var(--accent-color); }
        .animate-progress { animation: progressFill linear forwards; }
        @keyframes progressFill { from { width: 0%; } to { width: 100%; } }
        
        #timeline-container { display: none; flex-grow: 1; gap: 3px; overflow-x: auto; scrollbar-width: none; mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent); }
        #timeline-container.visible { display: flex; }
        .timeline-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #ccc; font-family: var(--font-mono); font-size: 0.65rem; padding: 1px 5px; border-radius: 3px; cursor: pointer; transition: all 0.2s; }
        .timeline-btn:hover, .timeline-btn.active { background: var(--accent-warm); color: #000; font-weight:700; }
        
        .control-group { display: flex; gap: 8px; align-items: center; }
        .control-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; padding: 3px 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; }
        .control-btn:hover { background: var(--accent-color); color: #000; }
        .control-btn svg { width: 12px; height: 12px; stroke: currentColor; stroke-width: 3; fill: none; }

        /* --- WEATHER & SCHEDULE FLIPPER --- */
        .weather-panel { width: 240px; flex-shrink: 0; }
        
        .weather-header-container { height: 28px; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; padding: 0 8px; z-index: 10; width: 100%; position: absolute; top:0; left:0;}
        .weather-location-header { font-size: 0.75rem; font-weight: 700; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center; width: 100%; text-transform: uppercase; transition: opacity 0.5s; }
        
        .weather-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 10px 10px 10px; }
        .weather-main { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
        .weather-main-left { display: flex; align-items: center; justify-content: center; width: 45%; }
        .weather-main-right { display: flex; flex-direction: column; align-items: flex-end; width: 55%; }
        .weather-temp-big { font-family: var(--font-head); font-size: 2.2rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); line-height: 1; }
        .weather-feels { font-size: 0.6rem; color: var(--accent-warm); text-transform: uppercase; margin-top: 2px; font-weight: 600; }
        .weather-icon-big svg { width: 52px; height: 52px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.4)); }
        .weather-details-list { padding: 5px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.65rem; display: flex; flex-direction: column; gap: 3px; margin-top: 5px; }
        .wd-row { display: flex; justify-content: space-between; color: #ccc; }
        .wd-val { color: #fff; font-weight: 600; }

        .schedule-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 10px 10px 10px; }
        .schedule-list { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; justify-content: center; }
        .schedule-item { display: flex; align-items: flex-start; gap: 8px; padding: 6px; border-radius: 4px; border-left: 3px solid transparent; transition: background 0.3s, border-color 0.3s; }
        .schedule-item.active-highlight { background: rgba(56, 189, 248, 0.2); border-left-color: var(--accent-color); }
        .schedule-item.active-highlight .sch-name { color: #fff; font-weight: 700; }
        .schedule-item.active-highlight .sch-label { color: var(--accent-color); }
        .sch-time { font-family: var(--font-mono); font-size: 0.75rem; color: #fff; font-weight: 700; width: 40px; flex-shrink: 0; margin-top: 2px; }
        .sch-label { font-size: 0.6rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; transition: color 0.3s;}
        .sch-name { font-size: 0.75rem; color: #94a3b8; line-height: 1.2; white-space: normal; transition: color 0.3s; }

        /* PROMO CARD DESIGN - REVISED */
        .promo-content {
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 15px;
            background: linear-gradient(135deg, #312e81, #1e1b4b);
            text-align: center;
        }
        .promo-text-top { font-size: 0.8rem; font-weight: 600; color: #cbd5e1; letter-spacing: 1px; margin-bottom: 5px; }
        .promo-brand-lockup { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .promo-brand-lockup .brand-logo svg { width: 32px; height: 32px; fill: var(--accent-color); filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.5)); }
        .promo-brand-lockup .brand-name { font-size: 1.4rem; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .promo-text-bottom { font-size: 0.85rem; font-weight: 700; color: #fff; letter-spacing: 0.5px; }

        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        .loader-spinner { width: 32px; height: 32px; border: 3px solid rgba(56, 189, 248, 0.3); border-radius: 50%; border-top-color: var(--accent-color); animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.95); opacity: 0.8; } }
        @keyframes pulseRed { 0%, 100% { background-color: var(--accent-danger); box-shadow: 0 0 5px var(--accent-danger); } 50% { background-color: #dc2626; box-shadow: 0 0 20px var(--accent-danger); } }
        .strobe-effect { animation: strobeAnim 1.5s ease-out forwards; }
        @keyframes strobeAnim { 0% { opacity: 0; transform: scale(1.1); filter: brightness(2); } 10% { opacity: 1; } 20% { opacity: 0; } 30% { opacity: 1; } 40% { opacity: 0; } 50% { opacity: 1; filter: brightness(1); transform: scale(1); } 100% { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .manual-refresh { position: absolute; top: 5px; right: 5px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; cursor: pointer; opacity: 0; transition: opacity 0.3s; }
        .identity-panel:hover .manual-refresh { opacity: 0.5; }
    </style>
</head>
<body data-theme="night">

    <div class="ambient-background" id="sky-bg"></div>

    <section class="ticker-container">
        
        <!-- PANEL 1: IDENTITY (Flippable) -->
        <div class="glass-panel identity-panel">
            <div class="panel-flipper" id="id-flipper">
                <!-- Front: ID -->
                <div class="panel-face">
                    <div class="id-content">
                        <div class="brand-wrapper">
                            <div class="brand-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                            <div class="brand-name">TKP NEWS</div>
                        </div>
                        <div id="clock" class="clock-display">--:--:--</div>
                        <div id="date-display" class="date-display">...</div>
                        <div id="nameday" class="nameday-badge"></div>
                        <div class="manual-refresh" id="manual-refresh-trigger"></div>
                    </div>
                </div>
                <!-- Back: Credits -->
                <div class="panel-face back">
                    <div class="credits-content">
                        <div class="cr-logo">‚ú¶</div>
                        <div class="cr-head">FEJLESZT√âS √âS DESIGN</div>
                        <div class="cr-dev">Robi</div>
                        <div class="cr-ft">&copy; <span id="cr-year">2025</span> Minden jog fenntartva</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL 2: NEWS CONTENT -->
        <div class="glass-panel news-panel" id="news-container">
            <div class="loading-overlay" id="loading-overlay">
                <div class="loader-spinner"></div>
                <div>H√≠rek friss√≠t√©se...</div>
            </div>
            
            <div class="big-clock-layer" id="big-clock-layer">
                <div class="bc-time" id="bc-time-display">00:00:00</div>
                <div class="bc-label">K√ñVETKEZ≈ê H√çRCSOMAG BET√ñLT√âSE...</div>
            </div>

            <div class="goodbye-card" id="goodbye-card">
                <div class="gb-moon">üåô</div>
                <div class="gb-title">J√ì √âJSZAK√ÅT!</div>
                <div class="gb-sub">A TKP NEWS ELK√ñSZ√ñN M√ÅRA</div>
            </div>

            <div id="news-bg-image" class="news-image-overlay"><img id="bg-img-element" src="" alt=""></div>

            <div class="news-viewport" id="news-viewport">
                <div id="program-badge" class="program-badge">BET√ñLT√âS...</div>
                <div id="night-sub-label" class="night-sub-label">AZ EL≈êZ≈ê NAP H√çREINEK √ñSSZEFOGLAL√ìJA</div>
                <div id="track-a" class="news-card"></div>
                <div id="track-b" class="news-card"></div>
            </div>

            <div class="progress-line-container"><div id="progress-bar" class="progress-line"></div></div>

            <div class="controls-bar" id="controls-bar-stop-click">
                <div id="timeline-container"></div>
                <div id="next-prog-alert" class="next-prog-alert"></div>
                <div class="control-group">
                    <span id="counter-display" style="font-family:var(--font-mono); color:var(--text-muted); margin-right:5px; font-weight:700;">0/0</span>
                    <button class="control-btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                    <button class="control-btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                </div>
            </div>
        </div>

        <!-- PANEL 3: WEATHER / SCHEDULE / PROMO (Flippable) -->
        <div class="glass-panel weather-panel">
            <div class="panel-flipper" id="weather-flipper">
                <!-- Front: Weather -->
                <div class="panel-face">
                     <div class="weather-header-container">
                        <div class="weather-location-header">
                            <span id="weather-loc-name">NY√çREGYH√ÅZA</span>
                            <span id="weather-loc-time" style="font-weight:400; font-size:0.85em; opacity:0.8; font-family:var(--font-mono);">--:--:--</span>
                        </div>
                    </div>
                    <div class="weather-view">
                        <div class="weather-main">
                            <div class="weather-main-left">
                                <div class="weather-icon-big" id="weather-icon-slot"></div>
                            </div>
                            <div class="weather-main-right">
                                <div class="weather-temp-big" id="weather-temp">--¬∞</div>
                                <div class="weather-feels" id="weather-feels"></div>
                            </div>
                        </div>
                        <div class="weather-details-list">
                            <div class="wd-row"><span>P√°ra</span><span class="wd-val" id="wd-hum">--%</span></div>
                            <div class="wd-row"><span>Sz√©l</span><span class="wd-val" id="wd-wind">--</span></div>
                            <div class="wd-row"><span>Nyom√°s</span><span class="wd-val" id="wd-press">-- hPa</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Back: Schedule OR Promo (Content swapped by JS) -->
                <div class="panel-face back">
                    <div class="weather-header-container">
                        <div class="weather-location-header" id="schedule-header-text">M≈∞SORAJ√ÅNL√ì</div>
                    </div>
                    
                    <!-- Schedule Content -->
                    <div class="schedule-view" id="schedule-view">
                         <div class="schedule-list" id="schedule-list-content"></div>
                    </div>

                    <!-- Promo Content (Hidden by default) -->
                    <div class="promo-content" id="promo-view" style="display:none;">
                        <div class="promo-text-top">K√ñVESD A</div>
                        <div class="promo-brand-lockup">
                             <div class="brand-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                             <div class="brand-name">TKP NEWS</div>
                        </div>
                        <div class="promo-text-bottom">H√çRS√ÅVOT 24 √ìR√ÅBAN!</div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        const WUNDERGROUND_API_KEY = "e1f10a1e78da46f5b10a1e78da96f525"; 
        const NYIREGYHAZA_COORDS = { lat: 47.95, lon: 21.71 };
        const NYIREGYHAZA_ID = "INYREG37"; 
        
        const ICONS = {
            CLEAR: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`,
            CLEAR_NIGHT: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            CLOUDY: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
            FOG: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5"><path d="M4 15h16M4 12h16M4 9h16M4 18h16"/></svg>`,
            RAIN: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`,
            SNOW: `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg>`,
            THUNDER: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`
        };

        const SKY_PHASES = {
            DEEP_NIGHT: { stops: ["#020617", "#0f172a", "#000000"] },
            ASTRO_DAWN: { stops: ["#0f172a", "#1e1b4b", "#172554"] },
            NAUTICAL_DAWN: { stops: ["#1e1b4b", "#312e81", "#4338ca"] },
            CIVIL_DAWN: { stops: ["#312e81", "#4f46e5", "#c026d3"] },
            SUNRISE:    { stops: ["#4f46e5", "#db2777", "#f59e0b"] },
            MORNING:    { stops: ["#0ea5e9", "#7dd3fc", "#bae6fd"] },
            NOON:       { stops: ["#0284c7", "#38bdf8", "#e0f2fe"] }
        };

        const PWS_MAP = { "ISRVR13": "S√°rv√°r", "IOSZK4": "Oszk√≥", "ISZNTD6": "Sz√°nt√≥d", "IBALAT149": "Balatonszemes", "IBUZSK1": "Csisztapuszta", "ISZEKS12": "Szeksz√°rd", "IJNOSH2": "J√°noshalma", "IPCS52": "P√©cs", "IPPRD1": "P√°pr√°d", "IKISKU42": "Kiskunhalas", "INEMES10": "Nemesn√°dudvar", "ISZEGE67": "Szeged", "IBKSCS12": "B√©k√©scsaba", "IFZESG2": "F√ºzesgyarmat", "IMIKEP2": "Mikep√©rcs", "ITGLS2": "T√©gl√°s", "IGACSL1": "Gacs√°ly", "IFLESD1": "F√ºlesd", "IKISSZ3": "Kisszekeres", "ILEVEL2": "Levelek", "IKEMEC2": "Kemecse", "INAGYC6": "Nagycserkesz", "ITISZA15": "Tiszavasv√°ri", "INEMES19": "Nemesbikk", "IEGERS22": "Egersz√≥l√°t", "IBKKSZ5": "B√ºkkszenterzs√©bet", "IPSZT1": "P√°szt√≥", "IPALOT13": "Palot√°s", "IGDLL37": "G√∂d√∂ll≈ë", "IZSMBK6": "Zs√°mb√©k", "ICSORN6": "Csorna", "IGAGYV1": "Gagyvend√©gi", "IMARTO122": "Martonyi", "IKAZIN14": "Kazincbarcika", "IPUTNO1": "Putnok", "IZABAR1": "Zabar", "ISALGT1": "Salg√≥tarj√°n", "IKARAN11": "Karancslapujt≈ë", "IBEKLC3": "Bek√∂lce", "IMTRAB1": "M√°traballa", "IVC267": "V√°c", "IPILIS37": "Pilisv√∂r√∂sv√°r", "IFELCS4": "Felcs√∫t", "IBUDAK6": "Budakeszi", "IBIATO9": "Biatorb√°gy", "ICSKVR4": "Cs√°kv√°r", "IOROSZ2": "Oroszl√°ny", "IBALINKA2": "Bakony", "ISR67": "S√∫r", "IPANNO3": "Pannonhalma", "IKAJRP2": "Kaj√°rp√©c", "IPPA11": "P√°pa", "ICELLD14": "Celld√∂m√∂lk", "IHEVES2": "Heves", "IGYNGY22": "Gy√∂ngy√∂s", "ISZCSN9": "Sz√©cs√©ny", "ITAHIT11": "Tahit√≥tfalu", "IESZTE5": "Esztergom", "ITATA16": "Tata", "IKARTAL4": "Kartal", "IMARTO67": "Martonv√°s√°r", "ISZOLNOK10": "Szolnok", "ISZOLN13": "Szolnok", "INAGYK59": "Nagyk≈ër√∂s", "IKECSK31": "Kecskem√©t", "IKALOCSA2": "Kalocsa", "IBONYH1": "Bonyh√°d", "ISZENT114": "Szentl≈ërinc", "ILJUBL47": "Ljubljana", "IBAKTA4": "Baktal√≥r√°nth√°za", "IJFEHR1": "√öjfeh√©rt√≥", "IPAPOS6": "Papos", "ISONKD1": "Sonk√°d", "INAPKO1": "Napkor", "IHARSN4": "Hars√°ny", "IBKKSZ2": "B√ºkkszentkereszt", "INYREG37": "Ny√≠regyh√°za", "IPUSZT3": "Pusztadobos", "ITISZA93": "Tisza√∫jv√°ros", "IEGER76": "Eger", "IHAJDD7": "Hajd√∫dorog", "IGYULA12": "Gyula", "IMAGYA4": "Magyarcsan√°d", "IHDMEZ21": "H√≥dmez≈ëv√°s√°rhely", "ISZEGE23": "Szeged-R√≥kus", "ICSENG9": "Csengele", "INAGYN1": "Nagyny√°r√°d", "IKIRLY1": "Kir√°lyegyh√°za", "ITAMSI1": "Tam√°si", "IZALAE45": "Zalaegerszeg", "IFARKA7": "Farkasgyep≈±", "INYRAC1": "Ny√≠racs√°d", "ISZAMO11": "Szamos√∫jlak", "IGVAVE1": "G√°vavencsell≈ë", "IEDELN2": "Edel√©ny", "INYRI1": "Ny√≠ri", "IBTTS1": "B√ºtt√∂s", "IZD2": "√ìzd" };
        
        // 30 Magyar V√°ros (Open-Meteo)
        const HUNGARIAN_CITIES_OM = [
            { name: 'Debrecen', lat: 47.53, lon: 21.62 }, { name: 'Miskolc', lat: 48.10, lon: 20.78 }, 
            { name: 'Szombathely', lat: 47.23, lon: 16.62 }, { name: 'Gy≈ër', lat: 47.68, lon: 17.63 },
            { name: 'P√©cs', lat: 46.07, lon: 18.23 }, { name: 'Szeged', lat: 46.25, lon: 20.15 },
            { name: 'Eger', lat: 47.90, lon: 20.37 }, { name: 'Veszpr√©m', lat: 47.09, lon: 17.91 },
            { name: 'Zalaegerszeg', lat: 46.84, lon: 16.84 }, { name: 'B√©k√©scsaba', lat: 46.68, lon: 21.09 },
            { name: 'Kaposv√°r', lat: 46.36, lon: 17.79 }, { name: 'Tatab√°nya', lat: 47.57, lon: 18.40 },
            { name: 'Salg√≥tarj√°n', lat: 48.10, lon: 19.80 }, { name: 'Szeksz√°rd', lat: 46.35, lon: 18.70 },
            { name: 'Sopron', lat: 47.68, lon: 16.58 }, { name: 'H√≥dmez≈ëv√°s√°rhely', lat: 46.43, lon: 20.32 },
            { name: 'Nagykanizsa', lat: 46.45, lon: 16.99 }, { name: 'Duna√∫jv√°ros', lat: 46.96, lon: 18.93 },
            { name: '√ârd', lat: 47.38, lon: 18.91 }, { name: 'Szolnok', lat: 47.18, lon: 20.20 },
            { name: 'Kecskem√©t', lat: 46.88, lon: 19.64 }, { name: 'Baja', lat: 46.18, lon: 18.95 },
            { name: 'Cegl√©d', lat: 47.17, lon: 19.80 }, { name: 'V√°c', lat: 47.78, lon: 19.13 },
            { name: 'G√∂d√∂ll≈ë', lat: 47.60, lon: 19.35 }, { name: '√ìzd', lat: 48.22, lon: 20.29 },
            { name: 'P√°pa', lat: 47.33, lon: 17.47 }, { name: 'Gyula', lat: 46.65, lon: 21.28 },
            { name: 'Hajd√∫b√∂sz√∂rm√©ny', lat: 47.67, lon: 21.51 }, { name: 'Ny√≠regyh√°za', lat: 47.95, lon: 21.71 }
        ];

        // 60+ K√ºlf√∂ldi V√°ros (Open-Meteo)
        const FOREIGN_CITIES = [ 
            { name: 'London', lat: 51.50, lon: -0.12 }, { name: 'New York', lat: 40.71, lon: -74.00 }, { name: 'Toki√≥', lat: 35.68, lon: 139.69 }, 
            { name: 'Peking', lat: 39.90, lon: 116.40 }, { name: 'Moszkva', lat: 55.75, lon: 37.61 }, { name: 'Sydney', lat: -33.86, lon: 151.20 }, 
            { name: 'P√°rizs', lat: 48.85, lon: 2.35 }, { name: 'Berlin', lat: 52.52, lon: 13.40 }, { name: 'R√≥ma', lat: 41.90, lon: 12.49 }, 
            { name: 'Dubai', lat: 25.20, lon: 55.27 }, { name: 'Isztambul', lat: 41.00, lon: 28.97 }, { name: 'B√©cs', lat: 48.20, lon: 16.37 },
            { name: 'Los Angeles', lat: 34.05, lon: -118.24 }, { name: 'Madrid', lat: 40.41, lon: -3.70 }, { name: 'Toronto', lat: 43.65, lon: -79.38 },
            { name: 'Mumbai', lat: 19.07, lon: 72.87 }, { name: 'Szingap√∫r', lat: 1.35, lon: 103.81 }, { name: 'Kair√≥', lat: 30.04, lon: 31.23 },
            { name: 'Rio de Janeiro', lat: -22.90, lon: -43.17 }, { name: 'Pr√°ga', lat: 50.07, lon: 14.43 }, { name: 'Amszterdam', lat: 52.36, lon: 4.90 },
            { name: 'Barcelona', lat: 41.38, lon: 2.17 }, { name: 'Z√ºrich', lat: 47.37, lon: 8.54 }, { name: 'Vars√≥', lat: 52.22, lon: 21.01 },
            { name: 'Bangkok', lat: 13.75, lon: 100.50 }, { name: 'Sz√∂ul', lat: 37.56, lon: 126.97 }, { name: 'Mexik√≥v√°ros', lat: 19.43, lon: -99.13 },
            { name: 'Buenos Aires', lat: -34.60, lon: -58.38 }, { name: 'Jakarta', lat: -6.20, lon: 106.84 }, { name: 'Lima', lat: -12.04, lon: -77.04 },
            { name: 'Fokv√°ros', lat: -33.92, lon: 18.42 }, { name: 'Helsinki', lat: 60.17, lon: 24.93 }, { name: 'Oslo', lat: 59.91, lon: 10.75 },
            { name: 'Stockholm', lat: 59.32, lon: 18.06 }, { name: 'Koppenh√°ga', lat: 55.67, lon: 12.56 }, { name: 'Reykjavik', lat: 64.14, lon: -21.94 },
            { name: 'Dublin', lat: 53.34, lon: -6.26 }, { name: 'Lisszabon', lat: 38.72, lon: -9.13 }, { name: 'Ath√©n', lat: 37.98, lon: 23.72 },
            { name: 'Ankara', lat: 39.93, lon: 32.85 }, { name: 'Jeruzs√°lem', lat: 31.76, lon: 35.21 }, { name: '√öjdelhi', lat: 28.61, lon: 77.20 },
            { name: 'Chicago', lat: 41.87, lon: -87.62 }, { name: 'San Francisco', lat: 37.77, lon: -122.41 }, { name: 'Vancouver', lat: 49.28, lon: -123.12 },
            { name: 'Montreal', lat: 45.50, lon: -73.56 }, { name: 'Sao Paulo', lat: -23.55, lon: -46.63 }, { name: 'Santiago', lat: -33.44, lon: -70.66 },
            { name: 'Bogota', lat: 4.71, lon: -74.07 }, { name: 'Casablanca', lat: 33.57, lon: -7.58 }, { name: 'Lagos', lat: 6.52, lon: 3.37 },
            { name: 'Nairobi', lat: -1.29, lon: 36.82 }, { name: 'Rij√°d', lat: 24.71, lon: 46.67 }, { name: 'Teher√°n', lat: 35.68, lon: 51.38 },
            { name: 'Karacsi', lat: 24.86, lon: 67.00 }, { name: 'Sanghaj', lat: 31.23, lon: 121.47 }, { name: 'Oszaka', lat: 34.69, lon: 135.50 },
            { name: 'Manila', lat: 14.59, lon: 120.98 }, { name: 'Kuala Lumpur', lat: 3.13, lon: 101.68 }, { name: 'Hanoi', lat: 21.02, lon: 105.83 },
            { name: 'Melbourne', lat: -37.81, lon: 144.96 }, { name: 'Auckland', lat: -36.84, lon: 174.76 }, { name: 'Br√ºsszel', lat: 50.85, lon: 4.35 },
            { name: 'Genf', lat: 46.20, lon: 6.14 }, { name: 'M√ºnchen', lat: 48.13, lon: 11.58 }, { name: 'Mil√°n√≥', lat: 45.46, lon: 9.19 },
            { name: 'N√°poly', lat: 40.85, lon: 14.26 }, { name: 'Velence', lat: 45.44, lon: 12.31 }, { name: 'Lyon', lat: 45.76, lon: 4.83 },
            { name: 'Marseille', lat: 43.29, lon: 5.36 }
        ];

        const BACKUP_FEEDS = {
            "Telex": "https://telex.hu/rss", "Index": "https://index.hu/24ora/rss/", "24hu": "https://24.hu/feed/", "Origo": "https://www.origo.hu/contentpartner/rss/hir-cent/origo.xml",
            "HVG": "https://hvg.hu/rss", "444": "https://444.hu/feed", "Infostart": "https://infostart.hu/rss", "Portfolio": "https://www.portfolio.hu/rss/all.xml", "P√©nzcentrum": "https://www.penzcentrum.hu/rss/all.xml",
            "N√©pszava": "https://nepszava.hu/rss", "Magyar Nemzet": "https://magyarnemzet.hu/feed", "Mandiner": "https://mandiner.hu/feed", "Blikk": "https://www.blikk.hu/rss",
            "Hirado.hu": "https://hirado.hu/feed/", "ATV": "https://www.atv.hu/feed", "RTL": "https://rtl.hu/rss", "Economx": "https://economx.hu/rss", "Napi.hu": "https://www.napi.hu/rss",
            "Magyar H√≠rlap": "https://www.magyarhirlap.hu/rss", "Pesti Sr√°cok": "https://pestisracok.hu/feed/", "Nemzeti Sport": "https://www.nemzetisport.hu/feed", "M4 Sport": "https://m4sport.hu/feed",
            "H√≠r TV": "https://hirtv.hu/rss", "Priv√°tbank√°r": "https://www.privatbankar.hu/rss/all.xml"
        };

        const firebaseConfig = { apiKey: "AIzaSyDgBgiNSxjgWP_jmaoHpf0Qejo8_OO4sPg", authDomain: "robi-oldala.firebaseapp.com", databaseURL: "https://robi-oldala-default-rtdb.europe-west1.firebasedatabase.app", projectId: "robi-oldala", storageBucket: "robi-oldala.appspot.com", messagingSenderId: "300815778397", appId: "1:300815778397:web:ec609be55cc8afd193c3b4" };
        const CORS_PROXIES = ["https://api.allorigins.win/raw?url=", "https://cors.eu.org/", "https://thingproxy.freeboard.io/fetch/"];
        
        const THEMATIC_BLOCKS = [
            { start: 0,    name: '√âjszakai m≈±szak', type: 'summary_yesterday', refreshMinutes: 30 },
            { start: 6,    name: 'Napind√≠t√≥',       type: 'morning_catchup', timeWindowHours: 0, refreshMinutes: 15 },
            { start: 7,    name: 'Reggeli gyors',   type: 'fresh', timeWindowHours: 2, refreshMinutes: 10 },
            { start: 9,    name: 'D√©lel≈ëtt a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15 },
            { start: 12,   name: 'D√©lid≈ëben',       type: 'fresh', timeWindowHours: 2, refreshMinutes: 15 },
            { start: 14,   name: 'D√©lut√°n a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15 },
            { start: 18,   name: 'Esti gyors',      type: 'fresh', timeWindowHours: 2, refreshMinutes: 10 },
            { start: 20,   name: 'Este a TKP NEWS-al',    type: 'fresh', timeWindowHours: 3, refreshMinutes: 15 },
            { start: 22,   name: 'K√©s≈ë este a TKP NEWS-al', type: 'fresh', timeWindowHours: 4, refreshMinutes: 20 },
            { start: 23.98,name: 'Elk√∂sz√∂n√©s',      type: 'goodbye' }
        ];

        const CALENDAR_DATA = { honapok: ["janu√°r", "febru√°r", "m√°rcius", "√°prilis", "m√°jus", "j√∫nius", "j√∫lius", "augusztus", "szeptember", "okt√≥ber", "november", "december"], napok: ["vas√°rnap", "h√©tf≈ë", "kedd", "szerda", "cs√ºt√∂rt√∂k", "p√©ntek", "szombat"], nameDays: { "01-01": ["Fruzsina"], "01-02": ["√Åbel"], "01-03": ["Benj√°min"], "01-04": ["Titusz"], "01-05": ["Simon"], "01-06": ["Boldizs√°r"], "01-07": ["Attila", "Ram√≥na"], "01-08": ["Gy√∂ngyv√©r"], "01-09": ["Marcell"], "01-10": ["Mel√°nia"], "01-11": ["√Ågota"], "01-12": ["Ern≈ë"], "01-13": ["Veronika"], "01-14": ["B√≥dog"], "01-15": ["L√≥r√°nd", "L√≥r√°nt"], "01-16": ["Guszt√°v"], "01-17": ["Antal", "Ant√≥nia"], "01-18": ["Piroska"], "01-19": ["M√°ri√≥", "S√°ra"], "01-20": ["F√°bi√°n", "Sebesty√©n"], "01-21": ["√Ågnes"], "01-22": ["Art√∫r", "Vince"], "01-23": ["Rajmund", "Zelma"], "01-24": ["Tim√≥t"], "01-25": ["P√°l"], "01-26": ["Paula", "Vanda"], "01-27": ["Angelika"], "01-28": ["Karola", "K√°roly"], "01-29": ["Ad√©l"], "01-30": ["Martina"], "01-31": ["Gerda", "Marcella"], "02-01": ["Ign√°c"], "02-02": ["Aida", "Karolina"], "02-03": ["Bal√°zs"], "02-04": ["Csenge", "R√°hel"], "02-05": ["√Ågota", "Ingrid"], "02-06": ["D√≥ra", "Dorottya"], "02-07": ["R√≥me√≥", "T√≥dor"], "02-08": ["Aranka"], "02-09": ["Abig√©l", "Alex"], "02-10": ["Elvira"], "02-11": ["Bertold", "Marietta"], "02-12": ["L√≠dia", "L√≠via"], "02-13": ["Ella", "Linda"], "02-14": ["B√°lint", "Valentin"], "02-15": ["Georgina", "Kolos"], "02-16": ["Julianna", "Lilla"], "02-17": ["Don√°t"], "02-18": ["Bernadett"], "02-19": ["Zsuzsanna"], "02-20": ["Alad√°r", "√Ålmos"], "02-21": ["Eleon√≥ra"], "02-22": ["Gerzson"], "02-23": ["Alfr√©d"], "02-24": ["M√°ty√°s"], "02-25": ["G√©za"], "02-26": ["Edina"], "02-27": ["√Åkos", "B√°tor"], "02-28": ["Elem√©r"], "02-29": ["Sz√∂k≈ënap"], "03-01": ["Albin"], "03-02": ["Lujza"], "03-03": ["Korn√©lia"], "03-04": ["K√°zm√©r"], "03-05": ["Adorj√°n", "Adri√°n"], "03-06": ["Inez", "Leon√≥ra"], "03-07": ["Tam√°s"], "03-08": ["Zolt√°n"], "03-09": ["Fanni", "Franciska"], "03-10": ["Ildik√≥"], "03-11": ["Szil√°rd"], "03-12": ["Gergely"], "03-13": ["Ajtony", "Kriszti√°n"], "03-14": ["Matild"], "03-15": ["Krist√≥f"], "03-16": ["Henrietta"], "03-17": ["Gertr√∫d", "Patrik"], "03-18": ["Ede", "S√°ndor"], "03-19": ["B√°nk", "J√≥zsef"], "03-20": ["Klaudia"], "03-21": ["Benedek"], "03-22": ["Be√°ta", "Izolda"], "03-23": ["Em≈ëke"], "03-24": ["G√°bor", "Karina"], "03-25": ["Ir√©n", "√çrisz"], "03-26": ["Em√°nuel"], "03-27": ["Hajnalka"], "03-28": ["Gedeon", "Johanna"], "03-29": ["Auguszta"], "03-30": ["Zal√°n"], "03-31": ["√Årp√°d"], "04-01": ["Hug√≥"], "04-02": ["√Åron"], "04-03": ["Buda", "Rich√°rd"], "04-04": ["Izidor"], "04-05": ["Vince"], "04-06": ["B√≠borka", "Vilmos"], "04-07": ["Herman"], "04-08": ["D√©nes"], "04-09": ["Erhard"], "04-10": ["Zsolt"], "04-11": ["Le√≥", "Szaniszl√≥"], "04-12": ["Gyula"], "04-13": ["Ida"], "04-14": ["Tibor"], "04-15": ["Anaszt√°zia", "Tas"], "04-16": ["Csongor"], "04-17": ["Rudolf"], "04-18": ["Andrea", "Ilma"], "04-19": ["Emma"], "04-20": ["Tivadar"], "04-21": ["Konr√°d"], "04-22": ["Csilla", "No√©mi"], "04-23": ["B√©la"], "04-24": ["Gy√∂rgy"], "04-25": ["M√°rk"], "04-26": ["Ervin"], "04-27": ["Zita"], "04-28": ["Val√©ria"], "04-29": ["P√©ter"], "04-30": ["Katalin", "Kitti"], "05-01": ["F√ºl√∂p", "Jakab"], "05-02": ["Zsigmond"], "05-03": ["Irma", "T√≠mea"], "05-04": ["Fl√≥ri√°n", "M√≥nika"], "05-05": ["Adri√°n", "Gy√∂rgyi"], "05-06": ["Frida", "Ivett"], "05-07": ["Gizella"], "05-08": ["Mih√°ly"], "05-09": ["Gergely"], "05-10": ["√Årmin", "P√°lma"], "05-11": ["Ferenc"], "05-12": ["Pongr√°c"], "05-13": ["Imola", "Szerv√°c"], "05-14": ["Bonif√°c"], "05-15": ["Szonja", "Zs√≥fia"], "05-16": ["Botond", "M√≥zes"], "05-17": ["Paszk√°l"], "05-18": ["Alexandra", "Erik"], "05-19": ["Iv√≥", "Mil√°n"], "05-20": ["Bern√°t", "Fel√≠cia"], "05-21": ["Konstantin"], "05-22": ["J√∫lia", "Rita"], "05-23": ["Dezs≈ë"], "05-24": ["Eliza", "Eszter"], "05-25": ["Orb√°n"], "05-26": ["Evelin", "F√ºl√∂p"], "05-27": ["Hella"], "05-28": ["Csan√°d", "Emil"], "05-29": ["Magdolna"], "05-30": ["Janka", "Zsanett"], "05-31": ["Ang√©la"], "06-01": ["T√ºnde"], "06-02": ["Anita", "K√°rmen"], "06-03": ["Klotild"], "06-04": ["Bulcs√∫"], "06-05": ["Fatime"], "06-06": ["Cintia", "Norbert"], "06-07": ["R√≥bert"], "06-08": ["Med√°rd"], "06-09": ["F√©lix"], "06-10": ["Gr√©ta", "Margit"], "06-11": ["Barnab√°s"], "06-12": ["Vill≈ë"], "06-13": ["Anett", "Antal"], "06-14": ["Vazul"], "06-15": ["Jol√°n", "Vid"], "06-16": ["Jusztin"], "06-17": ["Alida", "Laura"], "06-18": ["Arnold", "Levente"], "06-19": ["Gy√°rf√°s"], "06-20": ["Rafael"], "06-21": ["Alajos", "Leila"], "06-22": ["Paulina"], "06-23": ["Zolt√°n"], "06-24": ["Iv√°n"], "06-25": ["Vilmos"], "06-26": ["J√°nos", "P√°l"], "06-27": ["L√°szl√≥"], "06-28": ["Ir√©n", "Levente"], "06-29": ["P√©ter", "P√°l"], "06-30": ["P√°l"], "07-01": ["Annam√°ria", "Tiham√©r"], "07-02": ["Ott√≥"], "07-03": ["Korn√©l", "Soma"], "07-04": ["Ulrik"], "07-05": ["Emese", "Sarolta"], "07-06": ["Csaba"], "07-07": ["Apoll√≥nia"], "07-08": ["Ell√°k"], "07-09": ["Lukr√©cia"], "07-10": ["Am√°lia"], "07-11": ["Lili", "N√≥ra"], "07-12": ["Dalma", "Izabella"], "07-13": ["Jen≈ë"], "07-14": ["√ñrs", "Stella"], "07-15": ["Henrik", "Roland"], "07-16": ["Valter"], "07-17": ["Elek", "Endre"], "07-18": ["Frigyes"], "07-19": ["Em√≠lia"], "07-20": ["Ill√©s"], "07-21": ["D√°niel", "Daniella"], "07-22": ["Magdolna"], "07-23": ["Lenke"], "07-24": ["Kincs≈ë", "Kinga"], "07-25": ["Jakab", "Krist√≥f"], "07-26": ["Anik√≥", "Anna"], "07-27": ["Lili√°na", "Olga"], "07-28": ["Szabolcs"], "07-29": ["Fl√≥ra", "M√°rta"], "07-30": ["Judit", "X√©nia"], "07-31": ["Oszk√°r"], "08-01": ["Bogl√°rka"], "08-02": ["Lehel"], "08-03": ["Hermina"], "08-04": ["Dominika", "Dominik", "Domonkos"], "08-05": ["Krisztina"], "08-06": ["Berta", "Bettina"], "08-07": ["Ibolya"], "08-08": ["L√°szl√≥"], "08-09": ["Em≈ëd"], "08-10": ["L≈ërinc"], "08-11": ["Tiborc", "Zsuzsanna"], "08-12": ["Kl√°ra"], "08-13": ["Ipoly"], "08-14": ["Marcell"], "08-15": ["M√°ria"], "08-16": ["√Åbrah√°m"], "08-17": ["J√°cint"], "08-18": ["Ilona"], "08-19": ["Huba"], "08-20": ["Istv√°n"], "08-21": ["Hajna", "S√°muel"], "08-22": ["Menyh√©rt", "Mirjam"], "08-23": ["Bence"], "08-24": ["Bertalan"], "08-25": ["Lajos", "Patr√≠cia"], "08-26": ["Izs√≥"], "08-27": ["G√°sp√°r"], "08-28": ["√Ågoston"], "08-29": ["Beatrix", "Erna"], "08-30": ["R√≥zsa"], "08-31": ["Bella", "Erika"], "09-01": ["Egon", "Egyed"], "09-02": ["Dorina", "Rebeka"], "09-03": ["Hilda"], "09-04": ["Roz√°lia"], "09-05": ["L≈ërinc", "Viktor"], "09-06": ["Zakari√°s"], "09-07": ["Regina"], "09-08": ["Adrienn", "M√°ria"], "09-09": ["√Åd√°m"], "09-10": ["Hunor", "Nikolett"], "09-11": ["Teod√≥ra"], "09-12": ["M√°ria"], "09-13": ["Korn√©l"], "09-14": ["Rox√°na", "Szer√©na"], "09-15": ["Enik≈ë", "Melitta"], "09-16": ["Edit"], "09-17": ["Zs√≥fia"], "09-18": ["Di√°na"], "09-19": ["Vilhelmina"], "09-20": ["Friderika"], "09-21": ["M√°t√©", "Mirella"], "09-22": ["M√≥ric"], "09-23": ["Tekla"], "09-24": ["Gell√©rt", "Merc√©desz"], "09-25": ["Eufrozina", "Kende"], "09-26": ["Jusztina", "P√°l"], "09-27": ["Adalbert"], "09-28": ["Vencel"], "09-29": ["Mih√°ly"], "09-30": ["Jeromos"], "10-01": ["Malvin"], "10-02": ["Petra"], "10-03": ["Helga"], "10-04": ["Ferenc"], "10-05": ["Aur√©l"], "10-06": ["Br√∫n√≥", "Ren√°ta"], "10-07": ["Am√°lia"], "10-08": ["Kopp√°ny"], "10-09": ["D√©nes"], "10-10": ["Gedeon"], "10-11": ["Brigitta"], "10-12": ["Miksa"], "10-13": ["Ede", "K√°lm√°n"], "10-14": ["Hel√©n"], "10-15": ["Ter√©z"], "10-16": ["G√°l"], "10-17": ["Hedvig"], "10-18": ["Luk√°cs"], "10-19": ["N√°ndor"], "10-20": ["Vendel"], "10-21": ["Orsolya"], "10-22": ["El≈ëd"], "10-23": ["Gy√∂ngyi"], "10-24": ["Salamon"], "10-25": ["Bianka", "Blanka"], "10-26": ["D√∂m√∂t√∂r"], "10-27": ["Szabina"], "10-28": ["Simon", "Szimonetta"], "10-29": ["N√°rcisz"], "10-30": ["Alfonz"], "10-31": ["Farkas"], "11-01": ["Marianna"], "11-02": ["Achilles"], "11-03": ["Gy≈ëz≈ë"], "11-04": ["K√°roly"], "11-05": ["Imre"], "11-06": ["L√©n√°rd"], "11-07": ["Rezs≈ë"], "11-08": ["Zsombor"], "11-09": ["Tivadar"], "11-10": ["R√©ka"], "11-11": ["M√°rton"], "11-12": ["J√≥n√°s", "Ren√°t√≥"], "11-13": ["Szilvia"], "11-14": ["Aliz"], "11-15": ["Albert", "Lip√≥t"], "11-16": ["√ñd√∂n"], "11-17": ["Gergely", "Hortenzia"], "11-18": ["Jen≈ë"], "11-19": ["Erzs√©bet", "Elizabet"], "11-20": ["Jol√°n"], "11-21": ["Oliv√©r"], "11-22": ["Cec√≠lia"], "11-23": ["Kelemen", "Klementina"], "11-24": ["Emma"], "11-25": ["Katalin"], "11-26": ["Vir√°g"], "11-27": ["Virgil"], "11-28": ["Stef√°nia"], "11-29": ["Taksony"], "11-30": ["Andor", "Andr√°s"], "12-01": ["Elza"], "12-02": ["Melinda", "Vivien"], "12-03": ["Ferenc", "Ol√≠via"], "12-04": ["Barbara", "Borb√°la"], "12-05": ["Vilma"], "12-06": ["Mikl√≥s"], "12-07": ["Ambrus"], "12-08": ["M√°ria"], "12-09": ["Nat√°lia"], "12-10": ["Judit"], "12-12": ["Gabriella"], "12-13": ["Luca", "Ot√≠lia"], "12-14": ["Szil√°rda"], "12-15": ["Val√©r"], "12-16": ["Aletta", "Etelka"], "12-17": ["L√°z√°r", "Olimpia"], "12-18": ["Auguszta"], "12-19": ["Viola"], "12-20": ["Teofil"], "12-21": ["Tam√°s"], "12-22": ["Z√©n√≥"], "12-23": ["Vikt√≥ria"], "12-24": ["√Åd√°m", "√âva"], "12-25": ["Eug√©nia"], "12-26": ["Istv√°n"], "12-27": ["J√°nos"], "12-28": ["Kamilla"], "12-29": ["Tamara", "Tam√°s"], "12-30": ["D√°vid"], "12-31": ["Szilveszter"] } };

        // --- STATE & DOM ---
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const feedsRef = ref(database, 'feeds');
        
        const el = {
            clock: document.getElementById('clock'),
            date: document.getElementById('date-display'),
            nameday: document.getElementById('nameday'),
            trackA: document.getElementById('track-a'),
            trackB: document.getElementById('track-b'),
            progressBar: document.getElementById('progress-bar'),
            loading: document.getElementById('loading-overlay'),
            counter: document.getElementById('counter-display'),
            newsBg: document.getElementById('news-bg-image'),
            bgImg: document.getElementById('bg-img-element'),
            weatherLocName: document.getElementById('weather-loc-name'),
            weatherLocTime: document.getElementById('weather-loc-time'),
            weatherTemp: document.getElementById('weather-temp'),
            weatherFeels: document.getElementById('weather-feels'),
            weatherIcon: document.getElementById('weather-icon-slot'),
            wdHum: document.getElementById('wd-hum'),
            wdWind: document.getElementById('wd-wind'),
            wdPress: document.getElementById('wd-press'),
            weatherView: document.getElementById('weather-view'),
            scheduleView: document.getElementById('schedule-view'),
            scheduleList: document.getElementById('schedule-list-content'),
            promoView: document.getElementById('promo-view'),
            timelineContainer: document.getElementById('timeline-container'),
            newsContainer: document.getElementById('news-container'),
            newsViewport: document.getElementById('news-viewport'),
            badge: document.getElementById('program-badge'),
            nightSubLabel: document.getElementById('night-sub-label'),
            sky: document.getElementById('sky-bg'),
            weatherHeader: document.querySelector('.weather-location-header'),
            scheduleHeaderText: document.getElementById('schedule-header-text'),
            idFlipper: document.getElementById('id-flipper'),
            weatherFlipper: document.getElementById('weather-flipper'),
            goodbyeCard: document.getElementById('goodbye-card'),
            bigClockLayer: document.getElementById('big-clock-layer'),
            bcTime: document.getElementById('bc-time-display'),
            nextProgAlert: document.getElementById('next-prog-alert'),
            crYear: document.getElementById('cr-year')
        };

        let state = {
            activeTrack: 'a',
            items: [],
            currentIndex: 0,
            block: null,
            rssFeeds: {},
            pwsData: [],
            weatherIndex: 0,
            flipTimer: null,
            loading: false,
            breaking: false,
            scheduleActive: false,
            lastScheduleMin: -1,
            wasBreaking: false,
            currentItem: null,
            scheduleHighlightIndex: 0,
            scheduleInterval: null,
            nextItems: [],
            updatePending: false,
            weatherPlaylist: [],
            weatherPlaylistIndex: 0,
            isPaused: false,
            cardStartTime: 0,
            currentDuration: 18000,
            remainingTime: 0,
            seenBreakingLinks: new Set(),
            lastBreakingCheckTime: Date.now(),
            lastNightInfoTime: 0 
        };

        // --- UTILITIES ---
        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        
        async function fetchWithProxyFallback(url) {
            for (const proxy of CORS_PROXIES) {
                try {
                    const res = await fetch(proxy + url, { signal: AbortSignal.timeout(4000) });
                    if(res.ok) return res;
                } catch(e){}
            }
            throw new Error('All proxies failed for ' + url);
        }

        function extractImageUrl(item, descHtml) {
            const media = item.querySelector("content, media\\:content");
            if(media && media.getAttribute('url')) return media.getAttribute('url');
            const enclosure = item.querySelector("enclosure");
            if(enclosure && enclosure.getAttribute('type')?.startsWith('image')) return enclosure.getAttribute('url');
            const match = descHtml.match(/src="([^"]+)"/);
            return match ? match[1] : null;
        }

        function getFavicon(url) {
            try { const domain = new URL(url).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`; } catch(e) { return ''; }
        }

        function getSourceName(link) {
            try {
                const url = new URL(link);
                const host = url.hostname.replace('www.', '').toLowerCase();
                const map = { 'telex.hu': 'TELEX', 'index.hu': 'INDEX', '24.hu': '24.HU', 'origo.hu': 'ORIGO', 'hirado.hu':'HIRADO', 'rtl.hu':'RTL', 'atv.hu':'ATV' };
                if(map[host]) return map[host];
                return host.split('.')[0].toUpperCase();
            } catch(e) { return "H√çR"; }
        }

        // --- FLIP CONTROLLER ---
        function flipPanel(panelType, showBack) {
            const flipper = panelType === 'identity' ? el.idFlipper : el.weatherFlipper;
            if(showBack) flipper.classList.add('flipped');
            else flipper.classList.remove('flipped');
        }

        // --- CREDITS LOGIC ---
        function showCredits() {
            flipPanel('identity', true);
            setTimeout(() => { flipPanel('identity', false); }, 10000);
        }

        // --- SOLAR ENGINE ---
        function updateSkyGradient() {
            const now = new Date();
            const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
            const altitudeDeg = sunPos.altitude * (180 / Math.PI);
            let stops = SKY_PHASES.DEEP_NIGHT.stops;
            if (altitudeDeg < -18) stops = SKY_PHASES.DEEP_NIGHT.stops;
            else if (altitudeDeg < -12) stops = SKY_PHASES.ASTRO_DAWN.stops;
            else if (altitudeDeg < -6) stops = SKY_PHASES.NAUTICAL_DAWN.stops;
            else if (altitudeDeg < 0) stops = SKY_PHASES.CIVIL_DAWN.stops;
            else if (altitudeDeg < 6) stops = SKY_PHASES.SUNRISE.stops;
            else if (altitudeDeg < 25) stops = SKY_PHASES.MORNING.stops;
            else stops = SKY_PHASES.NOON.stops;
            el.sky.style.background = `linear-gradient(135deg, ${stops[0]}, ${stops[1]}, ${stops[2]})`;
        }

        // --- WEATHER (10 PWS -> 5 HU -> 10 Foreign) ---
        function calculateFeelsLike(temp, hum, wind) {
            if (temp <= 10 && wind > 4.8) { return 13.12 + 0.6215 * temp - 11.37 * Math.pow(wind, 0.16) + 0.3965 * temp * Math.pow(wind, 0.16); }
            else if (temp >= 27 && hum >= 40) { return temp - 0.55 * (1 - (hum / 100)) * (temp - 14); }
            return temp; 
        }

        function getWindDirStr(deg) {
            if (deg === undefined || deg === null) return "";
            const sectors = ["√âSZAKI", "√âSZAKKELETI", "KELETI", "D√âLKELETI", "D√âLI", "D√âLNYUGATI", "NYUGATI", "√âSZAKNYUGATI"];
            deg += 22.5; if (deg < 0) deg += 360; deg = deg % 360;
            return sectors[Math.floor(deg / 45)];
        }

        function getIconFromWMO(code, isNight) {
            if(code === 0) return isNight ? ICONS.CLEAR_NIGHT : ICONS.CLEAR;
            if(code >= 1 && code <= 3) return ICONS.CLOUDY;
            if(code === 45 || code === 48) return ICONS.FOG;
            if(code >= 51 && code <= 67) return ICONS.RAIN;
            if(code >= 80 && code <= 82) return ICONS.RAIN;
            if(code >= 71 && code <= 77) return ICONS.SNOW;
            if(code >= 95) return ICONS.THUNDER;
            return ICONS.CLOUDY;
        }

        async function fetchWeatherData() {
            // 1. l√©p√©s: V√°lasszunk 10 random PWS-t
            let newPWS = [];
            const stationKeys = Object.keys(PWS_MAP).sort(() => 0.5 - Math.random()).slice(0, 10);
            
            for (const id of stationKeys) {
                try {
                    const url = `https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${WUNDERGROUND_API_KEY}&numericPrecision=decimal`;
                    const res = await fetch(url);
                    if(!res.ok) continue; 
                    const data = await res.json();
                    if(data.observations && data.observations.length > 0) {
                        const obs = data.observations[0];
                        if(obs.metric.temp !== null) {
                             let wmoCode = 0; 
                             try {
                                 const skyUrl = `https://api.open-meteo.com/v1/forecast?latitude=${obs.lat}&longitude=${obs.lon}&current=weather_code`;
                                 const skyRes = await fetch(skyUrl); const skyData = await skyRes.json(); 
                                 wmoCode = skyData.current.weather_code;
                             } catch(e) {}

                             newPWS.push({
                                name: PWS_MAP[id] || id, lat: obs.lat, lon: obs.lon, 
                                temp: obs.metric.temp, hum: obs.humidity, wind: obs.metric.windSpeed, winddir: obs.winddir,
                                press: obs.metric.pressure, precip: obs.metric.precipRate,
                                wmo: wmoCode, updatedAt: new Date(), type: 'PWS'
                            });
                        }
                    }
                } catch(e) {}
            }

            // Seg√©df√ºggv√©ny Open-Meteo lek√©r√©shez
            async function getOpenMeteoData(cityList, count) {
                let results = [];
                const keys = cityList.sort(() => 0.5 - Math.random()).slice(0, count);
                for(const city of keys) {
                    try {
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,wind_direction_10m,weather_code,apparent_temperature`;
                        const res = await fetch(url); const data = await res.json();
                        results.push({
                            name: city.name, lat: city.lat, lon: city.lon, 
                            temp: data.current.temperature_2m, hum: data.current.relative_humidity_2m, 
                            wind: data.current.wind_speed_10m, winddir: data.current.wind_direction_10m, 
                            press: data.current.surface_pressure, precip: 0, wmo: data.current.weather_code, 
                            feelsLike: data.current.apparent_temperature, updatedAt: new Date(), type: 'OM'
                        });
                    } catch(e) {}
                }
                return results;
            }
            
            // 2. l√©p√©s: 5 random Magyar v√°ros (Open-Meteo)
            let newHuOM = await getOpenMeteoData(HUNGARIAN_CITIES_OM, 5);

            // 3. l√©p√©s: 10 random K√ºlf√∂ldi v√°ros (Open-Meteo)
            let newForeign = await getOpenMeteoData(FOREIGN_CITIES, 10);

            // 4. l√©p√©s: √ñsszef≈±zz√ºk: PWS -> Magyar OM -> K√ºlf√∂ldi
            state.weatherPlaylist = [...newPWS, ...newHuOM, ...newForeign];
            state.weatherPlaylistIndex = 0; 
        }

        function displayWeather() {
            if(state.weatherPlaylist.length === 0 || state.scheduleActive) return;
            
            if (state.weatherPlaylistIndex >= state.weatherPlaylist.length) { 
                fetchWeatherData(); 
                state.weatherPlaylistIndex = 0; 
                if (state.weatherPlaylist.length === 0) return; 
            }
            
            const item = state.weatherPlaylist[state.weatherPlaylistIndex];
            state.weatherPlaylistIndex++;
            
            el.weatherLocName.textContent = item.name;
            el.weatherLocTime.style.display = 'inline'; 
            el.weatherLocTime.textContent = item.updatedAt ? item.updatedAt.toLocaleTimeString('hu-HU') : '--:--:--';

            const temp = typeof item.temp === 'number' ? item.temp : 0;
            const hum = item.hum || 0;
            const wind = typeof item.wind === 'number' ? item.wind : 0;
            const press = typeof item.press === 'number' ? item.press : 0;
            
            el.weatherTemp.textContent = temp.toFixed(1) + "¬∞";
            
            let feelsLikeVal = item.feelsLike;
            if (feelsLikeVal === undefined) { feelsLikeVal = calculateFeelsLike(temp, hum, wind); }
            el.weatherFeels.textContent = `H≈ê√âRZET: ${feelsLikeVal.toFixed(1)}¬∞`;

            el.wdHum.textContent = hum + "%";
            const dirStr = getWindDirStr(item.winddir);
            el.wdWind.textContent = `${wind.toFixed(1)} km/h ${dirStr}`;
            el.wdPress.textContent = press.toFixed(1) + " hPa";
            
            const now = new Date();
            const sunTimes = SunCalc.getTimes(now, item.lat || NYIREGYHAZA_COORDS.lat, item.lon || NYIREGYHAZA_COORDS.lon);
            const isNight = now < sunTimes.sunrise || now > sunTimes.sunset;
            
            el.weatherIcon.innerHTML = getIconFromWMO(item.wmo || 0, isNight);
        }

        // --- SCHEDULE ---
        function displaySchedule() {
            if (!state.block || state.block.name === 'Elk√∂sz√∂n√©s') return;
            state.scheduleActive = true;
            
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            let html = '';
            const labels = ["MOST", "K√ñVETKEZIK", "K√âS≈êBB"]; 
            
            el.weatherLocName.textContent = "M≈∞SORAJ√ÅNL√ì";
            el.weatherLocTime.style.display = 'none';
            // Biztos√≠tjuk, hogy l√°that√≥ a sz√∂veg kezdetben
            el.scheduleHeaderText.style.opacity = '1';
            el.scheduleHeaderText.textContent = "M≈∞SORAJ√ÅNL√ì";

            for(let i = 0; i < 3; i++) {
                const idx = (currentIndex + i) % THEMATIC_BLOCKS.length;
                const block = THEMATIC_BLOCKS[idx];
                const hour = Math.floor(block.start);
                const min = Math.round((block.start % 1) * 60);
                const timeStr = `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                html += `<div class="schedule-item" id="sch-item-${i}"><div class="sch-time">${timeStr}</div><div style="flex-grow:1;"><div class="sch-label">${labels[i]}</div><div class="sch-name">${block.name}</div></div></div>`;
            }
            el.scheduleList.innerHTML = html;
            flipPanel('weather', true);
            
            state.scheduleHighlightIndex = 0;
            updateScheduleHighlight();
            state.scheduleInterval = setInterval(updateScheduleHighlight, 5000); 

            setTimeout(() => {
                clearInterval(state.scheduleInterval);
                el.scheduleView.style.display = "none";
                el.promoView.style.display = "flex";
                // Itt t√ºntetj√ºk el a "M≈∞SORAJ√ÅNL√ì" feliratot, hogy csak a promo l√°tsz√≥djon
                el.scheduleHeaderText.style.opacity = '0';
            }, 15000);

            setTimeout(() => {
                flipPanel('weather', false);
                state.scheduleActive = false;
                el.scheduleView.style.display = "flex"; 
                el.promoView.style.display = "none";
                // Vissza√°ll√≠tjuk a feliratot a k√∂vetkez≈ë alkalomra
                el.scheduleHeaderText.style.opacity = '1';
                el.scheduleHeaderText.textContent = "M≈∞SORAJ√ÅNL√ì";
                displayWeather(); 
            }, 25000);
        }

        function updateScheduleHighlight() {
            document.querySelectorAll('.schedule-item').forEach(item => item.classList.remove('active-highlight'));
            const currentItem = document.getElementById(`sch-item-${state.scheduleHighlightIndex}`);
            if(currentItem) currentItem.classList.add('active-highlight');
            state.scheduleHighlightIndex = (state.scheduleHighlightIndex + 1) % 3;
        }

        // --- TIMELINE ---
        function generateTimeline() {
            if(!state.block || state.block.type !== 'summary_yesterday') { el.timelineContainer.classList.remove('visible'); return; }
            const hours = [...new Set(state.items.map(item => item.date.getHours()))].sort((a,b)=>a-b);
            let html = '';
            hours.forEach(h => { html += `<button class="timeline-btn" data-hour="${h}">${String(h).padStart(2,'0')}</button>`; });
            el.timelineContainer.innerHTML = html;
            el.timelineContainer.classList.add('visible');
            el.timelineContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); const h = parseInt(btn.dataset.hour); const idx = state.items.findIndex(i => i.date.getHours() === h); if(idx !== -1) { state.currentIndex = idx; showNextItem(false); } });
            });
        }

        function updateTimelineActive() {
            if(!state.block || state.block.type !== 'summary_yesterday') return;
            const item = state.items[state.currentIndex % state.items.length];
            if(!item) return;
            const h = item.date.getHours();
            el.timelineContainer.querySelectorAll('.timeline-btn').forEach(btn => { btn.classList.toggle('active', parseInt(btn.dataset.hour) === h); });
        }

        // --- NEWS LOGIC ---
        async function checkBreakingNews() {
            const now = Date.now();
            const threeMinutesAgo = now - (3 * 60 * 1000); 
            
            for(const [src, url] of Object.entries(BACKUP_FEEDS)) {
                try {
                    const res = await fetchWithProxyFallback(url);
                    const txt = await res.text();
                    const xml = new DOMParser().parseFromString(txt, "text/xml");
                    const items = xml.querySelectorAll("item");
                    
                    for(let i=0; i<2; i++) { 
                        const item = items[i]; if(!item) continue;
                        const dateStr = item.querySelector("pubDate")?.textContent;
                        if(!dateStr) continue;
                        const date = new Date(dateStr);
                        const link = item.querySelector("link")?.textContent;
                        
                        if(date.getTime() > threeMinutesAgo && link && !state.seenBreakingLinks.has(link)) {
                            const title = item.querySelector("title")?.textContent || "";
                            
                            state.seenBreakingLinks.add(link); 
                            state.breakingItem = {
                                title: title, 
                                desc: stripHtml(item.querySelector("description")?.textContent || ""),
                                source: src, 
                                date: date, 
                                link: link
                            };
                            state.nextIsBreaking = true;
                            
                            clearTimeout(state.flipTimer);
                            showNextItem(false);
                            return; 
                        }
                    }
                } catch(e) {}
            }
        }

        function updateTimeAndState() {
            const now = new Date();
            el.clock.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            el.date.textContent = `${now.getFullYear()}. ${CALENDAR_DATA.honapok[now.getMonth()]} ${now.getDate()}.`;
            const key = `${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            if(CALENDAR_DATA.nameDays[key]) el.nameday.textContent = CALENDAR_DATA.nameDays[key].join(', ') + ' n√©vnap';

            updateSkyGradient();

            const h = now.getHours() + now.getMinutes()/60;
            let currentBlock = THEMATIC_BLOCKS.findLast(b => h >= b.start) || THEMATIC_BLOCKS[THEMATIC_BLOCKS.length-1];
            
            if(currentBlock.name === 'Elk√∂sz√∂n√©s') el.goodbyeCard.classList.add('active');
            else el.goodbyeCard.classList.remove('active');

            if (!state.block || state.block.name !== currentBlock.name) {
                state.block = currentBlock;
                el.badge.textContent = state.block.name;
                refreshNews();
            }

            // √âjszakai M≈±szak al-felirat kezel√©se
            if(state.block.type === 'summary_yesterday') {
                el.nightSubLabel.classList.add('active');
            } else {
                el.nightSubLabel.classList.remove('active');
            }

            const min = now.getMinutes();
            if((min === 0 || min === 20 || min === 40) && now.getSeconds() === 0 && min !== state.lastScheduleMin) {
                state.lastScheduleMin = min; displaySchedule();
            }
            
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            const nextBlock = THEMATIC_BLOCKS[(currentIndex + 1) % THEMATIC_BLOCKS.length];
            const nextStartMin = (nextBlock.start * 60);
            const currentMin = (now.getHours() * 60) + now.getMinutes();
            let diff = nextStartMin - currentMin;
            if (diff < 0) diff += 1440; 
            
            if(diff <= 15 && diff > 0) {
                const nH = Math.floor(nextBlock.start);
                const nM = Math.round((nextBlock.start % 1) * 60);
                const nTime = `${String(nH).padStart(2,'0')}:${String(nM).padStart(2,'0')}`;
                
                el.nextProgAlert.textContent = `K√ñVETKEZIK: ${nTime} ${nextBlock.name}`;
                el.nextProgAlert.classList.add('active');
            } else {
                el.nextProgAlert.classList.remove('active');
            }

            if((min === 0 || min === 15 || min === 30 || min === 45) && now.getSeconds() === 50) {
                refreshNews(true);
            }
            
            if(min === 59 && now.getSeconds() >= 50) {
                el.bigClockLayer.classList.add('active');
                el.bcTime.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                if(now.getSeconds() === 50) showCredits();
            } else {
                if(el.bigClockLayer.classList.contains('active')) {
                    el.bigClockLayer.classList.remove('active');
                    if(state.block.type !== 'summary_yesterday') {
                        state.currentIndex = 0; 
                        if(state.nextItems.length > 0) { state.items = state.nextItems; state.nextItems = []; }
                        showNextItem(false); 
                    }
                }
            }
        }

        async function refreshNews(silent = false) {
            if(!silent) el.loading.classList.add('active');
            
            let feeds = BACKUP_FEEDS;
            if(Object.keys(state.rssFeeds).length > 0) feeds = { ...feeds, ...state.rssFeeds };

            let fetchedItems = [];
            const promises = Object.entries(feeds).map(async ([key, url]) => {
                try {
                    const res = await fetchWithProxyFallback(url);
                    let txt;
                    if(url.includes('ma.hu')) txt = new TextDecoder('iso-8859-2').decode(await res.arrayBuffer());
                    else txt = await res.text();
                    const xml = new DOMParser().parseFromString(txt, "text/xml");
                    xml.querySelectorAll("item").forEach(item => {
                        const title = item.querySelector("title")?.textContent || "";
                        const descHtml = item.querySelector("description")?.textContent || "";
                        const link = item.querySelector("link")?.textContent;
                        const dateStr = item.querySelector("pubDate")?.textContent;
                        if(title && dateStr) {
                             fetchedItems.push({
                                title: title, link: link, desc: stripHtml(descHtml).substring(0, 300), source: key, date: new Date(dateStr), img: extractImageUrl(item, descHtml)
                             });
                        }
                    });
                } catch(e) {}
            });
            await Promise.allSettled(promises);
            fetchedItems.sort((a,b) => b.date - a.date);

            const now = new Date();
            let filtered = [];
            
            if(state.block.type === 'summary_yesterday') {
                const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0,0,0,0);
                const end = new Date(yesterday); end.setHours(23,59,59,999);
                filtered = fetchedItems.filter(item => item.date >= yesterday && item.date <= end);
                filtered.sort((a,b) => a.date - b.date); 
            } else if(state.block.type === 'morning_catchup') {
                let start = new Date(now); start.setHours(0,0,0,0);
                filtered = fetchedItems.filter(item => item.date >= start);
            } else if(state.block.type === 'fresh') {
                let timeLimit = new Date();
                timeLimit.setHours(now.getHours() - (state.block.timeWindowHours || 2));
                filtered = fetchedItems.filter(item => item.date >= timeLimit);
            } else {
                let timeLimit = new Date(); timeLimit.setHours(0,0,0,0);
                filtered = fetchedItems.filter(item => item.date >= timeLimit);
            }

            const rawItems = filtered.length > 0 ? filtered : fetchedItems.slice(0, 20);
            
            // --- DUPLIK√ÅCI√ì SZ≈∞R√âSE (Link alapj√°n) ---
            const uniqueItems = [];
            const seenLinks = new Set();
            for(const item of rawItems) {
                if(!seenLinks.has(item.link)) {
                    uniqueItems.push(item);
                    seenLinks.add(item.link);
                }
            }
            
            if(silent) {
                state.nextItems = uniqueItems;
                state.updatePending = true;
            } else {
                state.items = uniqueItems;
                if(!silent) {
                    el.loading.classList.remove('active');
                    state.currentIndex = 0;
                    showNextItem(false); 
                }
            }
            
            if(state.block.type === 'summary_yesterday') generateTimeline();
            else el.timelineContainer.classList.remove('visible');
        }

        function showNextItem(advance = true) {
            if(state.breaking) return;
            clearTimeout(state.flipTimer);
            
            // 1. BREAKING NEWS CHECK
            if(state.nextIsBreaking && state.breakingItem) {
                state.breaking = true;
                state.nextIsBreaking = false;
                state.wasBreaking = true;
                renderCard(state.breakingItem, true);
                el.progressBar.style.animationDuration = '30s';
                state.currentDuration = 30000;
                state.cardStartTime = Date.now();
                state.flipTimer = setTimeout(() => { state.breaking = false; showNextItem(false); }, 30000);
                return;
            }

            // 2. NIGHT INFO CARD CHECK (10 mins)
            if(state.block.type === 'summary_yesterday') {
                const now = Date.now();
                if (now - state.lastNightInfoTime > 600000) { // 10 perc
                    renderNightInfoCard();
                    state.lastNightInfoTime = now;
                    // Norm√°l id≈ëtartam
                    el.progressBar.style.animationDuration = '18s';
                    state.currentDuration = 18000;
                    state.cardStartTime = Date.now();
                    // Nem l√©ptetj√ºk a currentIndex-et, √≠gy a k√∂vetkez≈ë h√≠v√°sn√°l folytat√≥dik a h√≠r
                    state.flipTimer = setTimeout(() => showNextItem(false), 18000); 
                    return;
                }
            }

            if(state.updatePending && !state.breaking) {
                state.items = state.nextItems;
                state.nextItems = [];
                if(state.block.type !== 'summary_yesterday') {
                    state.currentIndex = 0; 
                    advance = false;
                }
                state.updatePending = false;
            }

            if(state.items.length === 0) { el[state.activeTrack === 'a' ? 'trackA' : 'trackB'].innerHTML = `<div class="news-title">Nincs h√≠r...</div>`; return; }
            
            if(advance) state.currentIndex++;
            
            // --- BIZTONS√ÅGI ELLEN≈êRZ√âS: Ne legyen ugyanaz a h√≠r egym√°s ut√°n ---
            let item = state.items[state.currentIndex % state.items.length];
            if(state.currentItem && (item.link === state.currentItem.link || item.title === state.currentItem.title)) {
                state.currentIndex++;
                item = state.items[state.currentIndex % state.items.length];
            }
            
            state.currentItem = item;
            renderCard(item, false);
            
            el.progressBar.style.animationDuration = '18s';
            state.currentDuration = 18000;
            state.cardStartTime = Date.now();
            state.flipTimer = setTimeout(() => showNextItem(true), 18000);
        }

        // Night Info Card Render
        function renderNightInfoCard() {
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA'];
            const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            
            el.badge.textContent = state.block.name;
            el.badge.classList.remove('breaking-mode');

            const html = `
                <div class="ni-icon">üåô</div>
                <div class="ni-text">Jelenleg az el≈ëz≈ë nap h√≠reit olvassa, de ha friss h√≠r √©rkezik az √©jszaka folyam√°n akkor az azonnal megjelenik.</div>
                <div class="ni-sub">TKP NEWS √âjszakai √úgyelet</div>
            `;
            nextTrack.innerHTML = html;
            
            nextTrack.classList.add('night-info'); // Add specific class
            nextTrack.classList.remove('breaking');
            el.newsBg.parentElement.classList.remove('has-image');

            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.classList.add('animate-progress');
        }

        function renderCard(item, isBreaking) {
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA'];
            const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            const fav = getFavicon(item.link);
            const displaySource = getSourceName(item.link);
            const timeStr = item.date.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});

            // Reset night info class
            nextTrack.classList.remove('night-info');

            if(isBreaking) {
                el.badge.textContent = "MOST √âRKEZETT!"; el.badge.classList.add('breaking-mode');
            } else if (state.wasBreaking) {
                el.badge.classList.remove('breaking-mode'); el.badge.textContent = state.block.name; el.badge.style.opacity = '0';
                setTimeout(() => { el.badge.classList.add('strobe-effect'); el.badge.style.opacity = '1'; }, 5000);
                state.wasBreaking = false;
            } else {
                el.badge.textContent = state.block.name; el.badge.classList.remove('breaking-mode');
            }

            const html = `
                <div class="news-header-row">
                    <div class="news-meta">
                        <div class="provider-identity"><img src="${fav}" class="provider-icon"> ${displaySource}</div>
                        <span>${timeStr}</span>
                    </div>
                </div>
                <div class="news-content-wrapper">
                    <div class="news-title">${item.title}</div>
                    <div class="news-desc">${item.desc}</div>
                </div>
            `;
            nextTrack.innerHTML = html;
            
            if(isBreaking) nextTrack.classList.add('breaking'); else nextTrack.classList.remove('breaking');
            if(item.img) { el.bgImg.src = item.img; el.newsBg.parentElement.classList.add('has-image'); } else { el.newsBg.parentElement.classList.remove('has-image'); }

            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.counter.textContent = `${(state.currentIndex % state.items.length) + 1} / ${state.items.length}`;
            
            updateTimelineActive();
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.classList.add('animate-progress');
        }

        el.newsViewport.addEventListener('mouseenter', () => {
            if(!state.isPaused) {
                clearTimeout(state.flipTimer);
                el.progressBar.style.animationPlayState = 'paused';
                state.isPaused = true;
                const elapsed = Date.now() - state.cardStartTime;
                state.remainingTime = Math.max(0, state.currentDuration - elapsed);
            }
        });

        el.newsViewport.addEventListener('mouseleave', () => {
            if(state.isPaused) {
                el.progressBar.style.animationPlayState = 'running';
                state.isPaused = false;
                state.cardStartTime = Date.now(); 
                state.currentDuration = state.remainingTime;
                state.flipTimer = setTimeout(() => showNextItem(true), state.remainingTime);
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            el.crYear.textContent = new Date().getFullYear(); 
            setInterval(updateTimeAndState, 1000);
            updateTimeAndState();
            onValue(feedsRef, (snap) => { state.rssFeeds = snap.val() || {}; refreshNews(); });
            
            fetchWeatherData();
            // 2.5 percenk√©nt √∫jrat√∂ltj√ºk az id≈ëj√°r√°s playlistet
            setInterval(fetchWeatherData, 150000); 
            setInterval(displayWeather, 6000);
            
            setInterval(checkBreakingNews, 60000); 
            setTimeout(checkBreakingNews, 5000);

            setInterval(showCredits, 300000); 

            document.getElementById('manual-refresh-trigger').addEventListener('click', () => refreshNews());
            document.getElementById('next-btn').addEventListener('click', (e) => { e.stopPropagation(); showNextItem(); });
            document.getElementById('prev-btn').addEventListener('click', (e) => { e.stopPropagation(); state.currentIndex -= 2; showNextItem(); });
            
            el.newsContainer.addEventListener('click', (e) => {
                if(e.target.closest('.controls-bar')) return;
                if(state.currentItem && state.currentItem.link) window.open(state.currentItem.link, '_blank');
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Legfrissebb Láncszem - Napi Párbaj</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <style>
        :root {
            --primary-color: #c8102e; /* Erőteljes piros */
            --accent-color: #ffd700; /* Elegáns arany a kiemeléshez */
            --background-dark: #1a1a1a; /* Sötét antracit */
            --background-light: #2c2c2c; /* Világosabb szürke konténerekhez */
            --text-light: #f5f5f5; /* Törtfehér a jobb olvashatóságért */
            --text-dark: #1a1a1a;
            --danger-color: #e53935;  /* Figyelmeztető piros */
            --success-color: #388e3c; /* Nemzeti zöld */
            --selected-color: #ffd700; /* Arany a kiválasztáshoz */
            --explanation-bg: #212121;
        }

        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&family=Poppins:wght@400;600&display=swap');

        /* ALAP ANIMÁCIÓK */
        @keyframes background-pan { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes glow { 0% { text-shadow: 0 0 4px var(--primary-color), 0 0 8px var(--primary-color); } 100% { text-shadow: 0 0 6px var(--primary-color), 0 0 10px var(--primary-color); } }
        @keyframes flash-warning { 0%, 100% { background-color: var(--danger-color); box-shadow: 0 0 15px #ff0000; } 50% { background-color: var(--background-light); box-shadow: none; } }
        @keyframes pulse-correct {
            0% { box-shadow: 0 0 10px var(--success-color), 0 0 20px rgba(56, 142, 60, 0.5); transform: scale(1.02); }
            50% { box-shadow: 0 0 20px var(--success-color), 0 0 40px rgba(56, 142, 60, 0.8); transform: scale(1.04); }
            100% { box-shadow: 0 0 10px var(--success-color), 0 0 20px rgba(56, 142, 60, 0.5); transform: scale(1.02); }
        }
        @keyframes strobe-flash {
            0%, 100% { background-color: #4d441a; border-color: var(--selected-color); box-shadow: 0 0 15px var(--selected-color); }
            50% { background-color: #8a7833; border-color: #fff; box-shadow: 0 0 25px #fff; }
        }

        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-dark);
            background-image: linear-gradient(270deg, #1a1a1a, #212121, #1a1a1a);
            background-size: 200% 200%;
            animation: background-pan 30s linear infinite;
            color: var(--text-light);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; text-align: center; overflow-x: hidden;
        }

        .screen { display: none; width: 100%; height: 100%; }
        .screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        h1, h2, h3 { 
            font-family: 'Merriweather', serif;
            text-transform: uppercase; 
            color: var(--text-light); 
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }
        h1 { color: var(--primary-color); animation: glow 2s ease-in-out infinite alternate; }

        button {
            background: linear-gradient(145deg, var(--primary-color), #a30e25);
            color: var(--text-light); border: none; padding: 14px 32px;
            font-size: 1.2em; font-family: 'Merriweather', serif; text-transform: uppercase; cursor: pointer; transition: all 0.2s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); border: 2px solid #d32f2f;
            border-radius: 8px;
        }
        button:hover:not(:disabled) { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 20px rgba(200, 16, 46, 0.5); }
        button:active:not(:disabled) { transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 10px rgba(200, 16, 46, 0.4); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; border-color: #555;}
        
        .container {
            width: 90%; max-width: 1200px;
            background-color: rgba(44, 44, 44, 0.7); backdrop-filter: blur(10px); padding: 40px; border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .container button { margin: 10px; }
        
        #game-code-display { font-size: 3.5em; font-weight: 700; letter-spacing: 10px; background-color: var(--background-dark); padding: 15px; border-radius: 10px; border: 2px dashed var(--primary-color); margin: 20px 0; cursor: pointer; }
        input { padding: 12px; font-size: 1.6em; border-radius: 8px; border: 2px solid var(--accent-color); background-color: var(--background-dark); color: #fff; text-align: center; width: 280px; font-family: 'Poppins'; }

        /* JÁTÉK KÉPERNYŐ */
        #game-screen { max-width: 1400px; width: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 20px; width: 100%; }
        .player-info-box { padding: 15px 20px; background-color: var(--background-light); border: 2px solid rgba(255,255,255,0.1); border-radius: 15px; width: 35%; transition: all 0.3s ease; }
        .player-info-box.active { border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .player-info-box .name { font-size: 1.5em; font-family: 'Merriweather', serif; color: var(--text-light); }
        .player-info-box .score-label { font-size: 0.9em; text-transform: uppercase; opacity: 0.7; }
        .player-info-box .score { font-size: 2em; font-weight: 700; color: #fff; }
        
        .main-game-area { display: flex; gap: 20px; flex-grow: 1; width: 100%; }
        #money-pyramid { width: 400px; background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; display: flex; flex-direction: column-reverse; align-items: center; justify-content: space-around; }
        .pyramid-level { width: 80%; min-height: 35px; line-height: 35px; margin: 2px 0; border-radius: 5px; text-align: center; font-weight: 600; font-size: 1.2em; color: var(--text-light); border: 1px solid rgba(255,215,0,0.3); transition: all 0.3s ease; }
        .pyramid-level.current { background-color: var(--primary-color); color: var(--text-light); transform: scale(1.05); font-weight: 700; border-color: var(--accent-color); }
        
        #game-center-area { flex-grow: 1; display: flex; flex-direction: column; }
        .game-status-display { background-color: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); min-height: 120px; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; }
        #last-action-display { font-size: 1.5em; height: 40px; transition: color 0.3s; }
        #turn-display { font-size: 1.2em; }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .action-buttons button { flex-grow: 1; }
        
        /* MODÁLIS ABLAK (KÉRDÉS) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;}
        .modal-content { background: var(--background-light); border: 2px solid var(--accent-color); box-shadow: 0 0 30px var(--accent-color); padding: 40px; border-radius: 15px; width: 95%; max-width: 900px; }
        #timer-display { font-size: 3.5em; font-weight: 700; color: var(--text-light); background-color: var(--success-color); padding: 5px 25px; border-radius: 8px; margin: 10px auto 25px; width: fit-content; }
        #timer-display.timer-warning { animation: flash-warning 0.8s infinite; }
        #modal-question { font-size: 1.8em; }
        #modal-options button { display: block; width: 100%; margin: 12px 0; background-color: #3e3e3e; color: #f0f0f0; border: 2px solid rgba(255,255,255,0.3); padding: 18px; font-size: 1.2em; font-family: 'Poppins', sans-serif; text-transform: none; border-radius: 10px; transition: all 0.3s; }
        #modal-options button:hover:not(:disabled) { background-color: #505050; border-color: var(--accent-color); }
        
        #modal-options button.strobing { animation: strobe-flash 0.2s linear infinite; }
        #modal-options button.correct { border-color: var(--success-color); background-color: #1c3e20; color: #fff; }
        #modal-options button.incorrect { border-color: var(--danger-color); background-color: #4a1919; color: #ffb8b8; }
        #modal-options button.pulsing-correct { animation: pulse-correct 1.5s infinite; }
        #modal-explanation { margin-top: 20px; padding: 15px; background-color: var(--explanation-bg); border-radius: 10px; border-left: 5px solid var(--accent-color); text-align: left; font-size: 1.1em; }
        #modal-footer { margin-top: 20px; }
        
        /* SZERENCSEKERÉK */
        #wheel-modal .modal-content { max-width: 600px; }
        #wheel-container { position: relative; width: 100%; max-width: 500px; margin: 20px auto; aspect-ratio: 1/1; }
        #wheel-canvas { width: 100%; height: 100%; }
        #wheel-pointer {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 50px;
            background: linear-gradient(45deg, #ffeb3b, #ffd700);
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            transform: translate(-50%, -120%) rotate(180deg);
            z-index: 10; border-top: 3px solid #b89b00;
        }
        #wheel-result { font-size: 1.6em; font-family: 'Merriweather', serif; margin-top: 20px; height: 35px; color: var(--selected-color); }

        /* MOBIL NÉZET */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 2.2em; }
            h2 { font-size: 1.5em; }
            #game-code-display { font-size: 2.5em; letter-spacing: 5px;}

            #game-screen { padding: 10px; }
            .game-header { flex-direction: column; }
            .player-info-box { width: 100%; }
            .player-info-box .name { font-size: 1.3em; }
            .player-info-box .score { font-size: 1.8em; }
            
            .main-game-area { flex-direction: column; }
            #money-pyramid { width: 100%; order: 2; margin-top: 15px; padding: 10px; }
            #game-center-area { width: 100%; order: 1; }
            
            .action-buttons { flex-direction: column; align-items: stretch; }
            .action-buttons button { width: 100%; margin: 5px 0; }

            .modal-content { padding: 20px; }
            #modal-question { font-size: 1.3em; }
            #modal-options button { font-size: 1.1em; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><h2 id="loading-text">Kapcsolódás...</h2></div>
    <div id="name-setup-screen" class="screen">
        <div class="container">
            <h1>A LÁNCSZEM</h1>
            <h2>Üdv a játékban!</h2>
            <p>Kérlek, add meg a játékosneved:</p>
            <input type="text" id="player-name-input" maxlength="15" placeholder="Játékosnév">
            <br><br>
            <button id="save-name-btn">Mentés és Tovább</button>
        </div>
    </div>
    <div id="menu-screen" class="screen">
        <div class="container">
            <h1 id="welcome-message">Üdv, Játékos!</h1>
            <p>Hívd ki egy barátodat egy egész napos párbajra!</p>
            <button id="host-game-btn">Játék Létrehozása</button>
            <button id="join-game-btn">Csatlakozás Játékhoz</button>
        </div>
    </div>
    <div id="host-wait-screen" class="screen">
        <div class="container">
            <h2>Várakozás a másik játékosra...</h2>
            <p>Oszd meg ezt a kódot a barátoddal (kattints a másoláshoz):</p>
            <div id="game-code-display" title="Kattints a másoláshoz">----</div>
            <button id="cancel-host-btn">Mégse</button>
        </div>
    </div>
    <div id="join-screen" class="screen">
        <div class="container">
            <h2>Csatlakozás játékhoz</h2>
            <p>Írd be a 4-jegyű kódot:</p>
            <input type="text" id="join-code-input" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="----">
            <br><br>
            <button id="confirm-join-btn">Csatlakozás!</button>
            <button id="cancel-join-btn">Vissza</button>
        </div>
    </div>
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div id="player1-info" class="player-info-box">
                <div id="player1-name" class="name">1. Játékos</div>
                <div class="score-label">Napi Pontszám</div>
                <div id="player1-score" class="score">0 Ft</div>
            </div>
            <div style="text-align: center;">
                <h3 id="game-progress-text">Kérdés: 1 / 10</h3>
            </div>
            <div id="player2-info" class="player-info-box">
                <div id="player2-name" class="name">2. Játékos</div>
                <div class="score-label">Napi Pontszám</div>
                <div id="player2-score" class="score">0 Ft</div>
            </div>
        </div>
        <div class="main-game-area">
            <div id="money-pyramid"></div>
            <div id="game-center-area">
                <div class="game-status-display">
                    <h3 id="last-action-display">Kezdődjön a játék!</h3>
                    <p id="turn-display">Az 1. Játékos kezd.</p>
                </div>
                <div class="action-buttons">
                    <button id="bank-btn">BANK</button>
                    <button id="answer-btn">Válaszolok</button>
                </div>
            </div>
        </div>
    </div>
    <div id="answer-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="timer-display">20.0</div>
            <h2 id="modal-question">Kérdés betöltése...</h2>
            <div id="modal-options"></div>
            <div id="modal-explanation" style="display: none;"></div>
            <div id="modal-footer">
                <button id="confirm-answer-btn" style="display: none;">Válasz lezárása</button>
            </div>
        </div>
    </div>
    <div id="wheel-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="wheel-title">A kör győztese pörget!</h2>
            <p id="wheel-subtitle"></p>
            <div id="wheel-container">
                <canvas id="wheel-canvas"></canvas>
                <div id="wheel-pointer"></div>
            </div>
            <h3 id="wheel-result"></h3>
            <button id="spin-btn">PÖRGETÉS!</button>
            <button id="next-round-btn" style="display: none;">Következő kör</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDToVf58oqEO9s-WAF87IS1GDIb8LKtNMA",
      authDomain: "a-leggyengebb-lancszem.firebaseapp.com",
      databaseURL: "https://a-leggyengebb-lancszem-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "a-leggyengebb-lancszem",
      storageBucket: "a-leggyengebb-lancszem.appspot.com",
      messagingSenderId: "454539315458",
      appId: "1:454539315458:web:ef8c9ae8981e71a1b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const MONEY_PYRAMID = [ { value: 0 }, { value: 10000, label: "10 000 Ft" }, { value: 25000, label: "25 000 Ft" }, { value: 50000, label: "50 000 Ft" }, { value: 100000, label: "100 000 Ft" }, { value: 200000, label: "200 000 Ft" }, { value: 350000, label: "350 000 Ft" }, { value: 500000, label: "500 000 Ft" }, { value: 1000000, label: "1 000 000 Ft" } ];
    const QUESTIONS_PER_ROUND = 10;
    const WHEEL_PRIZES = [
        { label: "10k Ft", value: 10000, color: "#42a5f5" }, { label: "CSŐD", value: 0, color: "#ef5350" }, 
        { label: "50k Ft", value: 50000, color: "#29b6f6" }, { label: "DUPLÁZÓ", value: "double", color: "#ab47bc" },
        { label: "25k Ft", value: 25000, color: "#4dd0e1" }, { label: "BANK FELE", value: "half", color: "#ffa726" },
        { label: "100k Ft", value: 100000, color: "#26c6da" }, { label: "+50k Ft", value: 50000, color: "#66bb6a" }
    ];
    const ALL_QUESTIONS = [
        { "question": "Melyik bolygó a legnagyobb a Naprendszerben?", "options": ["Föld", "Jupiter", "Mars", "Szaturnusz"], "answer": "Jupiter", "explanation": "A Jupiter tömege több mint kétszerese a Naprendszer összes többi bolygója együttes tömegének." },
        { "question": "Hány lába van egy póknak?", "options": ["6", "8", "10", "12"], "answer": "8", "explanation": "A pókok a pókszabásúak osztályába tartoznak, melyek egyik fő jellemzője a nyolc láb." },
        { "question": "Mi a víz kémiai képlete?", "options": ["H2O", "CO2", "O2", "NaCl"], "answer": "H2O", "explanation": "A vízmolekula két hidrogén (H) és egy oxigén (O) atomból áll." },
        { "question": "Ki írta a Hamletet?", "options": ["Charles Dickens", "J.K. Rowling", "William Shakespeare", "Tolkien"], "answer": "William Shakespeare", "explanation": "A 'Hamlet, dán királyfi' Shakespeare egyik legismertebb tragédiája." },
    ];
    
    const screens = { loading: document.getElementById('loading-screen'), nameSetup: document.getElementById('name-setup-screen'), menu: document.getElementById('menu-screen'), hostWait: document.getElementById('host-wait-screen'), join: document.getElementById('join-screen'), game: document.getElementById('game-screen'), wheel: document.getElementById('wheel-modal'), answerModal: document.getElementById('answer-modal') };
    let localPlayer = { uid: null, name: null };
    let currentGameId = null; 
    let gameUnsubscribe = null;
    let scoreUnsubscribers = [];
    let timerInterval = null;

    function getTodayString() { return new Date().toISOString().slice(0, 10); }
    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); if(screens[screenName]) screens[screenName].classList.add('active'); }

    onAuthStateChanged(auth, async (user) => {
        try {
            if (user) {
                localPlayer.uid = user.uid;
                const playerSnap = await get(ref(db, `players/${user.uid}`));
                if (playerSnap.exists() && playerSnap.val().name) {
                    localPlayer.name = playerSnap.val().name;
                    document.getElementById('welcome-message').textContent = `Üdv újra, ${localPlayer.name}!`;
                    switchScreen('menu');
                } else {
                    switchScreen('nameSetup');
                }
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Hiba az authentikáció során:", error);
            document.getElementById('loading-text').textContent = "Hiba a kapcsolódás során.";
        }
    });

    document.getElementById('save-name-btn').addEventListener('click', async () => {
        const name = document.getElementById('player-name-input').value.trim();
        if (name.length < 3) return alert("A névnek legalább 3 karakterből kell állnia.");
        localPlayer.name = name;
        await set(ref(db, `players/${localPlayer.uid}`), { name });
        document.getElementById('welcome-message').textContent = `Üdv, ${localPlayer.name}!`;
        switchScreen('menu');
    });

    async function joinGame() {
        const gameId = document.getElementById('join-code-input').value.trim();
        if (gameId.length !== 4) return alert("Kérlek, egy 4-jegyű kódot adj meg.");
        
        try {
            const gameRef = ref(db, `games/${gameId}`);
            const snapshot = await get(gameRef);

            if (snapshot.exists() && snapshot.val().status === 'waiting') {
                currentGameId = gameId;
                const today = getTodayString();
                const myScoreRef = ref(db, `dailyScores/${today}/${localPlayer.uid}`);
                const myScoreSnap = await get(myScoreRef);
                if (!myScoreSnap.exists()) {
                    await set(myScoreRef, { name: localPlayer.name, score: 0 });
                }
                
                const p1 = snapshot.val().player1;
                const p2 = { uid: localPlayer.uid, name: localPlayer.name };
                const questions = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_ROUND);
                
                await update(gameRef, {
                    player2: p2, status: 'active',
                    roundScores: { [p1.uid]: 0, [p2.uid]: 0 },
                    turn: p1.uid, chainLevel: 0, questionIndex: 0, questions,
                    lastAction: `${p2.name} csatlakozott! Kezdődjön a játék!`,
                    questionActive: false, answerRevealed: false, selectedAnswer: null,
                });

                onDisconnect(gameRef).remove();
                listenToGameUpdates(gameId);
            } else {
                alert("A játék nem található, vagy már elindult.");
            }
        } catch (error) {
            console.error("Hiba a csatlakozás során:", error);
            alert("Hiba történt a játékhoz való csatlakozás közben.");
        }
    }
    
    async function createNewRound(gameId, p1, p2) {
        const questions = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_ROUND);
        await set(ref(db, `games/${gameId}`), {
            status: 'active', player1: p1, player2: p2,
            roundScores: { [p1.uid]: 0, [p2.uid]: 0 },
            turn: p1.uid, chainLevel: 0, questionIndex: 0, questions,
            lastAction: 'Kezdődjön az új kör!',
            questionActive: false, answerRevealed: false, selectedAnswer: null,
        });
    }
    
    document.getElementById('host-game-btn').addEventListener('click', async () => {
        try {
            const today = getTodayString();
            const myScoreRef = ref(db, `dailyScores/${today}/${localPlayer.uid}`);
            const myScoreSnap = await get(myScoreRef);
            if (!myScoreSnap.exists()) {
                await set(myScoreRef, { name: localPlayer.name, score: 0 });
            }
            currentGameId = (Math.floor(Math.random() * 9000) + 1000).toString();
            const gameRef = ref(db, `games/${currentGameId}`);
            await set(gameRef, { status: 'waiting', player1: { uid: localPlayer.uid, name: localPlayer.name }});
            onDisconnect(gameRef).remove();
            
            listenToGameUpdates(currentGameId);
            document.getElementById('game-code-display').textContent = currentGameId;
            switchScreen('hostWait');
        } catch(error) {
            console.error("Hiba a játék létrehozása közben:", error);
            alert("Hiba történt a játék létrehozása közben.");
        }
    });

    document.getElementById('join-game-btn').addEventListener('click', () => switchScreen('join'));
    document.getElementById('cancel-join-btn').addEventListener('click', () => switchScreen('menu'));
    document.getElementById('confirm-join-btn').addEventListener('click', joinGame);

    function listenToDailyScores(p1uid, p2uid) {
        unsubscribeDailyScores();
        const today = getTodayString();
        const p1Unsub = onValue(ref(db, `dailyScores/${today}/${p1uid}/score`), (snap) => {
            if (document.getElementById('player1-score')) document.getElementById('player1-score').textContent = `${(snap.val() || 0).toLocaleString()} Ft`;
        });
        const p2Unsub = onValue(ref(db, `dailyScores/${today}/${p2uid}/score`), (snap) => {
            if (document.getElementById('player2-score')) document.getElementById('player2-score').textContent = `${(snap.val() || 0).toLocaleString()} Ft`;
        });
        scoreUnsubscribers.push(p1Unsub, p2Unsub);
    }
    
    function unsubscribeDailyScores() {
        scoreUnsubscribers.forEach(unsub => unsub());
        scoreUnsubscribers = [];
    }
    
    function listenToGameUpdates(gameId) {
        if (gameUnsubscribe) gameUnsubscribe();
        const gameRef = ref(db, `games/${gameId}`);
        gameUnsubscribe = onValue(gameRef, (snapshot) => {
            if (!snapshot.exists()) {
                if (gameUnsubscribe) gameUnsubscribe();
                unsubscribeDailyScores();
                if (screens.game.classList.contains('active') || screens.hostWait.classList.contains('active')) {
                    alert("A játék véget ért vagy a másik játékos kilépett.");
                    switchScreen('menu');
                }
                return;
            }
            const gameData = snapshot.val();
            if (gameData.player2 && scoreUnsubscribers.length === 0) {
                listenToDailyScores(gameData.player1.uid, gameData.player2.uid);
            }
            updateUI(gameData);
        });
    }

    function updateUI(gameData) {
        if (!gameData) return;
        
        if (gameData.status === 'waiting' || !gameData.player2) {
             switchScreen('hostWait');
             return;
        }

        if ((gameData.status === 'active' || gameData.status === 'roundOver') && !screens.game.classList.contains('active') && !screens.wheel.style.display === 'flex' ) {
            switchScreen('game');
        }

        document.getElementById('player1-name').textContent = gameData.player1.name;
        document.getElementById('player2-name').textContent = gameData.player2.name;

        if (gameData.status === 'roundOver') {
            showWheelUI(gameData);
        } else if (gameData.status === 'active' && screens.wheel.style.display === 'flex') {
            screens.wheel.style.display = 'none';
            switchScreen('game');
        }

        document.getElementById('player1-info').classList.toggle('active', gameData.turn === gameData.player1.uid);
        document.getElementById('player2-info').classList.toggle('active', gameData.turn === gameData.player2.uid);
        
        for (let i = 1; i < MONEY_PYRAMID.length; i++) {
            const pyramidEl = document.getElementById(`pyramid-level-${i}`);
            if(pyramidEl) pyramidEl.classList.toggle('current', i === gameData.chainLevel);
        }
        
        document.getElementById('last-action-display').textContent = gameData.lastAction;
        const turnPlayerName = gameData.turn === gameData.player1.uid ? gameData.player1.name : gameData.player2.name;
        document.getElementById('turn-display').textContent = `${turnPlayerName} következik.`;
        document.getElementById('game-progress-text').textContent = `Kérdés: ${Math.min(gameData.questionIndex + 1, QUESTIONS_PER_ROUND)} / ${QUESTIONS_PER_ROUND}`;
        
        const myTurn = gameData.turn === localPlayer.uid;
        document.getElementById('answer-btn').disabled = !myTurn || gameData.questionActive;
        document.getElementById('bank-btn').disabled = !myTurn || gameData.chainLevel === 0 || gameData.questionActive;
        
        if (gameData.questionActive && screens.answerModal.style.display !== 'flex') {
            showQuestionModal(gameData);
        } else if (!gameData.questionActive && screens.answerModal.style.display === 'flex') {
            hideQuestionModal();
        } else if (gameData.questionActive && screens.answerModal.style.display === 'flex') {
            if(gameData.answerRevealed) revealAnswer(gameData);
        }
    }

    document.getElementById('answer-btn').addEventListener('click', () => {
        if(currentGameId) update(ref(db, `games/${currentGameId}`), { questionActive: true });
    });

    function showQuestionModal(data) {
        screens.answerModal.style.display = 'flex';
        const question = data.questions[data.questionIndex];
        document.getElementById('modal-question').textContent = question.question;
        const explanationEl = document.getElementById('modal-explanation');
        explanationEl.style.display = 'none';
        explanationEl.innerHTML = `<b>Magyarázat:</b> ${question.explanation}`;

        const optionsContainer = document.getElementById('modal-options');
        optionsContainer.innerHTML = '';
        question.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => handleSelectOption(btn, opt);
            optionsContainer.appendChild(btn);
        });
        
        if(data.answerRevealed) {
            revealAnswer(data);
        } else if (data.turn === localPlayer.uid) {
            startTimer(20, async () => {
                 await update(ref(db, `games/${currentGameId}`), { 
                     lastAction: `${data.turn === data.player1.uid ? data.player1.name : data.player2.name} kifutott az időből!`,
                     chainLevel: 0,
                     turn: data.turn === data.player1.uid ? data.player2.uid : data.player1.uid,
                     questionActive: false, selectedAnswer: null, answerRevealed: false,
                     // JAVÍTVA: Az index itt is lép, hogy a következő játékos új kérdést kapjon
                     questionIndex: Math.min(data.questionIndex + 1, QUESTIONS_PER_ROUND)
                 });
            });
        }
    }

    function hideQuestionModal() {
        stopTimer();
        screens.answerModal.style.display = 'none';
    }

    function handleSelectOption(btn, option) {
        stopTimer();
        document.querySelectorAll('#modal-options button').forEach(b => b.disabled = true);
        btn.classList.add('strobing');
        setTimeout(async () => {
            await update(ref(db, `games/${currentGameId}`), {
                selectedAnswer: option, answerRevealed: true,
            });
        }, 1000);
    }

    function revealAnswer(data) {
        stopTimer();
        document.querySelectorAll('#modal-options button').forEach(b => {
            b.disabled = true;
            b.classList.remove('strobing');
        });
        
        const question = data.questions[data.questionIndex];
        document.querySelectorAll('#modal-options button').forEach(btn => {
            if (btn.textContent === question.answer) btn.classList.add('correct', 'pulsing-correct');
            if (btn.textContent === data.selectedAnswer && data.selectedAnswer !== question.answer) btn.classList.add('incorrect');
        });

        document.getElementById('modal-explanation').style.display = 'block';

        if (localPlayer.uid === data.player1.uid) {
            setTimeout(() => calculateNextState(data), 4000);
        }
    }
    
    // VÉGLEGESEN JAVÍTOTT LOGIKA
    async function calculateNextState(data) {
      try {
        const isCorrect = data.selectedAnswer === data.questions[data.questionIndex].answer;
        const turnPlayer = data.turn === data.player1.uid ? data.player1 : data.player2;
        
        const updates = {};
        // A kérdés indexe MINDIG növekszik, miután egy kérdésre válaszoltak.
        const nextQuestionIndex = data.questionIndex + 1;

        if (isCorrect) {
            updates.chainLevel = Math.min(data.chainLevel + 1, MONEY_PYRAMID.length - 1);
            updates.lastAction = `${turnPlayer.name} helyesen válaszolt! A sorozat folytatódik.`;
            updates.turn = data.turn; // A kör nem változik
        } else {
            updates.chainLevel = 0;
            updates.turn = data.turn === data.player1.uid ? data.player2.uid : data.player1.uid; // A kör a másik játékosé
            updates.lastAction = `${turnPlayer.name} hibázott! A lánc megszakadt.`;
        }
        
        // A kérdés indexének kezelése a kör vége ellenőrzéssel együtt
        if (nextQuestionIndex >= QUESTIONS_PER_ROUND) {
            updates.status = 'roundOver';
            // Ha az utolsó kérdés helyes volt, a pénzt még hozzáadjuk
            if (isCorrect) {
                const finalBank = updates.chainLevel > 0 ? MONEY_PYRAMID[updates.chainLevel].value : 0;
                if(finalBank > 0) {
                    const dailyScoreRef = ref(db, `dailyScores/${getTodayString()}/${data.turn}/score`);
                    await runTransaction(dailyScoreRef, (score) => (score || 0) + finalBank);
                    updates.lastAction += ` Az utolsó körben bankolt ${finalBank.toLocaleString()} Ft-ot!`;
                }
            }
        } else {
            updates.questionIndex = nextQuestionIndex;
        }
        
        updates.questionActive = false;
        updates.answerRevealed = false;
        updates.selectedAnswer = null;
        await update(ref(db, `games/${currentGameId}`), updates);
      } catch (error) {
          console.error("Hiba a játék állapotának kiszámítása közben:", error);
      }
    }
    
    document.getElementById('bank-btn').addEventListener('click', async () => {
        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        if (!data || data.turn !== localPlayer.uid) return;
        
        const pointsToBank = MONEY_PYRAMID[data.chainLevel].value;
        if (pointsToBank <= 0) return;

        const turnPlayer = data.turn === data.player1.uid ? data.player1 : data.player2;
        const today = getTodayString();
        const dailyScoreRef = ref(db, `dailyScores/${today}/${data.turn}/score`);
        
        await runTransaction(dailyScoreRef, (currentScore) => (currentScore || 0) + pointsToBank);

        await update(ref(db, `games/${currentGameId}`), {
            chainLevel: 0,
            turn: data.turn === data.player1.uid ? data.player2.uid : data.player1.uid,
            lastAction: `${turnPlayer.name} bankolt ${pointsToBank.toLocaleString()} Ft-ot!`,
            // JAVÍTVA: Bankolás után is a következő kérdés jön
            questionIndex: Math.min(data.questionIndex + 1, QUESTIONS_PER_ROUND)
        });
    });

    function startTimer(duration, onEnd) {
        stopTimer();
        let timeLeft = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.textContent = timeLeft.toFixed(1);
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            timerDisplay.textContent = timeLeft.toFixed(1);
            timerDisplay.classList.toggle('timer-warning', timeLeft <= 5.0);
            if (timeLeft <= 0) {
                stopTimer();
                if (onEnd) onEnd();
            }
        }, 100);
    }
    function stopTimer() { clearInterval(timerInterval); }

    const wheelCanvas = document.getElementById('wheel-canvas');
    let ctx = wheelCanvas ? wheelCanvas.getContext('2d') : null;
    let currentAngle = 0;
    
    function drawWheel() {
        if(!ctx) return;
        const size = wheelCanvas.width;
        const center = size / 2;
        const radius = size / 2 - 10;
        const arcSize = (2 * Math.PI) / WHEEL_PRIZES.length;
        
        ctx.clearRect(0, 0, size, size);
        ctx.font = `bold ${size * 0.045}px 'Merriweather', serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        WHEEL_PRIZES.forEach((prize, i) => {
            const angle = currentAngle + i * arcSize;
            ctx.beginPath();
            ctx.fillStyle = prize.color;
            ctx.moveTo(center, center);
            ctx.arc(center, center, radius, angle, angle + arcSize);
            ctx.closePath();
            ctx.fill();

            ctx.save();
            ctx.fillStyle = '#fff';
            ctx.translate(center, center);
            ctx.rotate(angle + arcSize / 2);
            ctx.fillText(prize.label, radius * 0.6, 0);
            ctx.restore();
        });
    }
    
    function showWheelUI(data) {
        switchScreen('game');
        screens.wheel.style.display = 'flex';
        
        const p1RoundScore = data.roundScores[data.player1.uid] || 0;
        const p2RoundScore = data.roundScores[data.player2.uid] || 0;
        const winner = p1RoundScore >= p2RoundScore ? data.player1 : data.player2;

        document.getElementById('wheel-title').textContent = `${winner.name} pörget!`;
        document.getElementById('wheel-subtitle').textContent = `Kör eredmény: ${data.player1.name} ${p1RoundScore.toLocaleString()} Ft vs ${data.player2.name} ${p2RoundScore.toLocaleString()} Ft`;
        document.getElementById('spin-btn').disabled = winner.uid !== localPlayer.uid;
        document.getElementById('next-round-btn').style.display = 'none';
        document.getElementById('wheel-result').textContent = "";
        
        const container = document.getElementById('wheel-container');
        if(container && wheelCanvas) {
            wheelCanvas.width = container.clientWidth;
            wheelCanvas.height = container.clientHeight;
            drawWheel();
        }
    }

    let spinAnimation;
    function spinWheel() {
        document.getElementById('spin-btn').disabled = true;
        let velocity = Math.random() * 0.2 + 0.3;
        const friction = 0.995;

        function animate() {
            velocity *= friction;
            currentAngle += velocity;
            drawWheel();
            if (velocity > 0.001) {
                spinAnimation = requestAnimationFrame(animate);
            } else {
                finishSpin();
            }
        }
        animate();
    }

    async function finishSpin() {
        const arcSize = (2 * Math.PI) / WHEEL_PRIZES.length;
        const pointerAngle = 1.5 * Math.PI;
        const finalAngle = (currentAngle % (2 * Math.PI) + (2*Math.PI)) % (2*Math.PI);
        const relativeAngle = ((2*Math.PI) - finalAngle + pointerAngle) % (2*Math.PI);
        const prizeIndex = Math.floor(relativeAngle / arcSize);
        const prize = WHEEL_PRIZES[prizeIndex];

        document.getElementById('wheel-result').textContent = `Nyeremény: ${prize.label}!`;

        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        
        const p1RoundScore = data.roundScores[data.player1.uid] || 0;
        const p2RoundScore = data.roundScores[data.player2.uid] || 0;
        const winnerUid = p1RoundScore >= p2RoundScore ? data.player1.uid : data.player2.uid;
        
        if (winnerUid === localPlayer.uid) {
            const scoreRef = ref(db, `dailyScores/${getTodayString()}/${winnerUid}/score`);
            await runTransaction(scoreRef, (currentScore) => {
                if (currentScore === null) currentScore = 0;
                if (prize.value === 'double') return currentScore * 2;
                if (prize.value === 'half') return Math.floor(currentScore / 2);
                if (prize.value === 0) return 0;
                return currentScore + prize.value;
            });
        }
        
        document.getElementById('next-round-btn').style.display = 'block';
    }
    
    document.getElementById('spin-btn').addEventListener('click', spinWheel);
    
    document.getElementById('next-round-btn').addEventListener('click', async () => {
        if (!currentGameId) return;
        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        if(localPlayer.uid === data.player1.uid) {
            await createNewRound(currentGameId, data.player1, data.player2);
        }
    });

    (function init() {
        const pyramidContainer = document.getElementById('money-pyramid');
        pyramidContainer.innerHTML = '';
        MONEY_PYRAMID.slice(1).forEach((level, index) => { 
            const levelDiv = document.createElement('div'); 
            levelDiv.id = `pyramid-level-${index + 1}`; 
            levelDiv.classList.add('pyramid-level'); 
            levelDiv.textContent = level.label; 
            levelDiv.style.width = `${40 + (index * 6)}%`;
            pyramidContainer.appendChild(levelDiv);
        });
        
        document.getElementById('cancel-host-btn').addEventListener('click', () => { 
            if(gameUnsubscribe) gameUnsubscribe(); 
            if(currentGameId) remove(ref(db, `games/${currentGameId}`)); 
            switchScreen('menu'); 
        });
    })();

</script>

</body>
</html>

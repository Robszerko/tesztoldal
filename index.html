<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYERŐ4ES Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --background-gradient: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            --board-bg: linear-gradient(145deg, #4a6a8a, #34495e);
            --panel-bg: rgba(20, 30, 40, 0.7);
            --hole-bg: #2c3e50;
            --player1-color: #e74c3c;
            --player1-glow: #ff7675;
            --player2-color: #f1c40f;
            --player2-glow: #ffeaa7;
            --text-color: #ecf0f1;
            --highlight-color: #3498db;
            --gold-color: #f1c40f;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            overflow: hidden;
            padding: 1vmin;
        }
        .hidden { display: none !important; opacity: 0; }
        button {
            font-family: 'Poppins', sans-serif;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 0 #1e824c;
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }
        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 0 #1e824c;
        }
        button:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 0 #1e824c;
        }
        #setup-screen {
            background-color: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            width: clamp(300px, 90vw, 480px);
        }
        
        .game-title {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 30px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .logo-four {
            font-weight: 800;
            font-style: italic;
            font-size: 1.6em;
            color: var(--gold-color);
            position: relative;
            top: -0.05em;
            margin: 0 0.05em 0 -0.05em;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.5), 0 0 10px var(--gold-color), 0 0 20px var(--player2-glow);
        }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .input-group input { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid transparent; background-color: rgba(0,0,0,0.2); color: white; transition: border-color 0.2s; }
        .input-group input:focus { outline: none; border-color: var(--highlight-color); }
        .lobby-actions { display: flex; gap: 15px; }
        .lobby-actions button { flex: 1; }
        #join-game-section { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 20px; padding-top: 20px; }
        .error-message { color: var(--player1-glow); margin-top: 10px; height: 1.2em;}
        
        #game-screen { display: flex; align-items: center; justify-content: center; gap: 2vmin; width: 100%; height: 100%; max-width: 1100px; }
        #game-header {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        #game-header .game-title { 
            font-size: 2em; 
            margin: 0; 
            padding: 5px 20px; 
            border-radius: 12px; 
            background: var(--panel-bg); 
            backdrop-filter: blur(5px); 
        }
        
        .player-panel { background: var(--panel-bg); backdrop-filter: blur(5px); border-radius: 16px; padding: 20px; width: 180px; text-align: center; display: flex; flex-direction: column; justify-content: center; gap: 10px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); transition: all 0.4s ease; }
        .player-panel .name { font-size: 1.5em; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .player-panel .score-label { font-size: 0.9em; opacity: 0.7; text-transform: uppercase; }
        .player-panel .score { font-size: 4em; font-weight: 800; line-height: 1; }
        #player1-panel { color: var(--player1-glow); }
        #player2-panel { color: var(--player2-glow); }
        .player-panel.active { transform: scale(1.08); box-shadow: 0 0 35px var(--glow-color), 0 8px 32px rgba(0,0,0,0.3); }
        #player1-panel.active { --glow-color: var(--player1-color); }
        #player2-panel.active { --glow-color: var(--player2-color); }

        #center-column { display: flex; flex-direction: column; align-items: center; flex-grow: 1; max-width: 560px; width: 50vw; }
        #message-area { font-size: clamp(1em, 2vw, 1.2em); font-weight: 600; text-align: center; }
        #game-code-display { background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 8px; font-size: 1.2em; letter-spacing: 5px; font-weight: 600; cursor: pointer; }
        #game-code-display:hover { background: rgba(0,0,0,0.5); }
        
        #drop-zone { width: 100%; height: 80px; position: relative; cursor: pointer; }
        #preview-disc { position: absolute; top: 50%; transform: translateY(-50%); border-radius: 50%; opacity: 0.9; transition: left 0.1s ease-out; pointer-events: none; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }

        #board-container { position: relative; width: 100%; }
        #jatekter { background: var(--board-bg); display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); aspect-ratio: 7 / 6; width: 100%; padding: 1.5vmin; border-radius: 16px; box-shadow: inset 0 0 15px rgba(0,0,0,0.6), 0 10px 20px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .board-disabled { pointer-events: none; filter: grayscale(50%); }

        .cella { margin: auto; width: 85%; height: 85%; background-color: var(--hole-bg); border-radius: 50%; box-shadow: inset 0 4px 8px rgba(0,0,0,0.7); }
        .golyostilus { background-image: radial-gradient(circle at 35% 35%, var(--shine-color), var(--base-color)); box-shadow: inset 0 -5px 10px rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.4); }
        .piros { --base-color: var(--player1-color); --shine-color: var(--player1-glow); }
        .sarga { --base-color: var(--player2-color); --shine-color: var(--player2-glow); }
        
        /* JAVÍTVA: Az animált korong is megkapja a belső árnyékot a villanás elkerülése érdekében */
        .falling { 
            position: absolute; 
            z-index: 10; 
            border-radius: 50%; 
            animation: rubber-ball-bounce 1s forwards; /* Kicsit gyorsabb lett */
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.4);
        }
        .winning-disc { animation: strobe-flash 0.8s infinite ease-in-out; }
        
        #winner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; backdrop-filter: blur(5px); }
        #winner-overlay.show { opacity: 1; pointer-events: all; }
        #winner-announcement { display: flex; flex-direction: column; align-items: center; text-align: center; transform: scale(0.5); opacity: 0; animation: winner-zoom-in 0.8s 0.3s forwards cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        #winner-player-name { font-size: 8vmin; font-weight: 600; color: var(--win-color); text-shadow: 0 0 10px black, 0 0 20px var(--win-color); }
        #winner-static-text { font-size: 12vmin; font-weight: 800; text-transform: uppercase; color: white; text-shadow: 0 0 10px black, 0 0 30px var(--win-color); }
        #winner-actions { margin-top: 40px; }

        @keyframes winner-zoom-in { to { transform: scale(1); opacity: 1; } }
        
        /* JAVÍTVA: Teljesen új, "squash & stretch" gumilabda animáció */
        @keyframes rubber-ball-bounce {
            0% { transform: translateY(var(--start-y)) scale(1, 1); animation-timing-function: cubic-bezier(0.6, 0.04, 0.98, 0.335); }
            45% { transform: translateY(var(--drop-height)) scale(1, 1); animation-timing-function: linear; }
            50% { transform: translateY(var(--drop-height)) scale(1.2, 0.8); animation-timing-function: cubic-bezier(0.02, 0.61, 0.44, 0.98); } /* Becsapódás és lapulás */
            65% { transform: translateY(calc(var(--drop-height) - 70px)) scale(0.9, 1.1); animation-timing-function: cubic-bezier(0.6, 0.04, 0.98, 0.335); } /* Visszapattanás és nyúlás */
            80% { transform: translateY(var(--drop-height)) scale(1.1, 0.9); animation-timing-function: cubic-bezier(0.02, 0.61, 0.44, 0.98); }
            90% { transform: translateY(calc(var(--drop-height) - 20px)) scale(0.95, 1.05); animation-timing-function: cubic-bezier(0.6, 0.04, 0.98, 0.335); }
            100% { transform: translateY(var(--drop-height)) scale(1, 1); }
        }

        @keyframes strobe-flash { 0%, 100% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.1); filter: brightness(2); box-shadow: 0 0 20px var(--shine-color); } }
        
        /* ... A többi stílus változatlan ... */
    </style>
</head>
<body>
    <div id="confetti-container"></div>
    <div id="setup-screen">
        <h1 class="game-title">NYERŐ<span class="logo-four">4</span>ES</h1>
        
        <div class="input-group"> <label for="player-name">Játékosnév</label> <input type="text" id="player-name" value="Játékos" maxlength="12"> </div>
        <div class="lobby-actions">
            <button id="create-game-btn">Játék létrehozása</button>
        </div>
        <div id="join-game-section">
            <div class="input-group"> <label for="game-code-input">Játék kódja</label>
                <input type="text" id="game-code-input" placeholder="Írd be a 4 jegyű kódot" maxlength="4">
            </div>
            <button id="join-game-btn">Csatlakozás</button>
        </div>
        <div class="error-message"></div>
    </div>
    
    <div id="game-screen" class="hidden">
        <header id="game-header">
             <h1 class="game-title">NYERŐ<span class="logo-four">4</span>ES</h1>
             <div id="message-area"></div>
             <div id="game-code-display" class="hidden" title="Kattints a másoláshoz"></div>
        </header>
        <div class="player-panels-container">
            <div id="player1-panel" class="player-panel"> <div id="p1-name" class="name"></div> <div class="score-label">Pontszám</div> <div id="p1-score" class="score">0</div> </div>
            <div id="player2-panel" class="player-panel"> <div id="p2-name" class="name"></div> <div class="score-label">Pontszám</div> <div id="p2-score" class="score">0</div> </div>
        </div>
        <div id="center-column">
            <div id="drop-zone"> <div id="preview-disc" class="hidden"></div> </div>
            <div id="board-container"> <div id="jatekter"></div> </div>
        </div>
    </div>

    <div id="winner-overlay">
        <div id="winner-announcement">
            <span id="winner-player-name"></span>
            <span id="winner-static-text">Nyert!</span>
            <div id="winner-actions"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDoH4UgzzsYLRjG7denk0qD5a_L5WohEnM",
            authDomain: "nyero4es.firebaseapp.com",
            databaseURL: "https://nyero4es-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "nyero4es",
            storageBucket: "nyero4es.firebasestorage.app",
            messagingSenderId: "673098386729",
            appId: "1:673098386729:web:55496e0a183345168b3b38"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let localGameId = null;
        let localPlayerColor = null;
        let localUserId = null;
        let lastAnimatedMoveTimestamp = null;
        
        const SOROK = 6, OSZLOPOK = 7;
        const ANIMATION_DURATION = 1000; // Összhangban az új, gyorsabb animációval

        // ... A többi JavaScript kód változatlan ...
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const jatekter = document.getElementById('jatekter');
        const messageArea = document.getElementById('message-area');
        const dropZone = document.getElementById('drop-zone');
        const previewDisc = document.getElementById('preview-disc');
        const winnerOverlay = document.getElementById('winner-overlay');
        const winnerPlayerName = document.getElementById('winner-player-name');
        const winnerStaticText = document.getElementById('winner-static-text');
        const winnerActions = document.getElementById('winner-actions');
        const confettiContainer = document.getElementById('confetti-container');
        const playerNameInput = document.getElementById('player-name');
        const gameCodeInput = document.getElementById('game-code-input');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const errorMessageDiv = document.querySelector('.error-message');

        async function initGame() {
            try {
                await signInAnonymously(auth);
                localUserId = auth.currentUser.uid;
            } catch(error) {
                errorMessageDiv.textContent = 'Hiba a szerverhez való kapcsolódáskor.';
                return;
            }
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            gameCodeDisplay.addEventListener('click', () => navigator.clipboard.writeText(gameCodeDisplay.textContent));
            
            gameScreen.addEventListener('mousemove', handlePointerMove);
            gameScreen.addEventListener('touchmove', handlePointerMove, { passive: false });
            gameScreen.addEventListener('click', handlePointerClick);
        }
        
        async function createGame() {
            const playerName = playerNameInput.value.trim() || 'Játékos 1';
            const gameId = Math.floor(1000 + Math.random() * 9000).toString();
            
            localGameId = gameId;
            localPlayerColor = 'piros';
            
            const initialGameState = {
                board: Array.from({ length: SOROK }, () => Array(OSZLOPOK).fill("")),
                players: { piros: { name: playerName, score: 0, uid: localUserId }, sarga: null },
                currentPlayer: 'piros', status: 'waiting', winner: null, lastMove: null
            };
            
            try {
                await set(ref(db, 'games/' + gameId), initialGameState);
                listenToGameChanges(gameId);
            } catch (error) {
                errorMessageDiv.textContent = 'Hiba a játék létrehozásakor.';
            }
        }

        async function joinGame() {
            const playerName = playerNameInput.value.trim() || 'Játékos 2';
            const gameId = gameCodeInput.value.trim();
            if (gameId.length !== 4) { errorMessageDiv.textContent = 'Érvénytelen kód!'; return; }

            const gameRef = ref(db, 'games/' + gameId);
            try {
                const snapshot = await get(gameRef);
                if (snapshot.exists() && snapshot.val().status === 'waiting') {
                    localGameId = gameId;
                    localPlayerColor = 'sarga';
                    await update(gameRef, { 'players/sarga': { name: playerName, score: 0, uid: localUserId }, 'status': 'active' });
                    listenToGameChanges(gameId);
                } else {
                    errorMessageDiv.textContent = 'A játék nem található, vagy már tele van.';
                }
            } catch(error) {
                errorMessageDiv.textContent = 'Hiba a csatlakozáskor.';
                console.error("Firebase hiba:", error);
            }
        }
        
        function listenToGameChanges(gameId) {
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            if (localPlayerColor === 'piros') {
                gameCodeDisplay.textContent = gameId;
                gameCodeDisplay.classList.remove('hidden');
            }
            onValue(ref(db, 'games/' + gameId), (snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;
                if (gameData.status === 'active' && localPlayerColor === 'piros') {
                    gameCodeDisplay.classList.add('hidden');
                }
                renderUIFromState(gameData);
            });
        }

        function renderUIFromState(state) {
            if (!state || !state.players || !state.board) return;
            const p1 = state.players.piros;
            const p2 = state.players.sarga;
            document.getElementById('p1-name').textContent = p1 ? p1.name : '-';
            document.getElementById('p1-score').textContent = p1 ? p1.score : 0;
            document.getElementById('p2-name').textContent = p2 ? p2.name : 'Várakozás...';
            document.getElementById('p2-score').textContent = p2 ? p2.score : 0;
            renderBoard(state.board);
            if (state.lastMove && state.lastMove.timestamp !== lastAnimatedMoveTimestamp) {
                if (state.lastMove.color !== localPlayerColor) {
                    animateOpponentMove(state.lastMove.r, state.lastMove.c, state.lastMove.color);
                }
                lastAnimatedMoveTimestamp = state.lastMove.timestamp;
            }
            document.getElementById('player1-panel').classList.toggle('active', state.currentPlayer === 'piros');
            document.getElementById('player2-panel').classList.toggle('active', state.currentPlayer === 'sarga');
            const isMyTurn = state.currentPlayer === localPlayerColor && state.status === 'active';
            jatekter.classList.toggle('board-disabled', !isMyTurn);
            if(state.status === 'waiting') {
                 messageArea.textContent = 'Várakozás az ellenfélre...';
            } else if(state.status === 'active') {
                messageArea.textContent = isMyTurn ? 'Te következel!' : `${state.players[state.currentPlayer]?.name || ''} következik...`;
            } else if (state.status === 'finished') {
                jatekter.classList.add('board-disabled');
                messageArea.textContent = state.winner === 'draw' ? 'Döntetlen!' : `🎉 ${state.players[state.winner]?.name || ''} nyert! 🎉`;
            }
        }

        function renderBoard(board) {
            jatekter.innerHTML = '';
            for (let r = 0; r < SOROK; r++) { for (let c = 0; c < OSZLOPOK; c++) {
                const cella = document.createElement('div');
                cella.classList.add('cella');
                if (board[r] && board[r][c]) {
                    cella.classList.add(board[r][c], 'golyostilus');
                }
                jatekter.appendChild(cella);
            }}
        }

        function animateOpponentMove(sor, oszlop, color) {
            const golyomeret = jatekter.clientWidth / OSZLOPOK * 0.85;
            const fallingDisc = document.createElement('div');
            fallingDisc.className = `golyostilus falling ${color}`;
            fallingDisc.style.width = `${golyomeret}px`;
            fallingDisc.style.height = `${golyomeret}px`;
            fallingDisc.style.left = `${oszlop * (jatekter.clientWidth / OSZLOPOK) + (jatekter.clientWidth / OSZLOPOK - golyomeret) / 2}px`;
            const startY = dropZone.getBoundingClientRect().top - jatekter.getBoundingClientRect().top;
            const endY = sor * (jatekter.clientHeight / SOROK) + ((jatekter.clientHeight / SOROK) - golyomeret) / 2;
            fallingDisc.style.setProperty('--start-y', `${startY}px`);
            fallingDisc.style.setProperty('--drop-height', `${endY}px`);
            jatekter.appendChild(fallingDisc);
            setTimeout(() => { if (fallingDisc.parentElement) jatekter.removeChild(fallingDisc); }, ANIMATION_DURATION);
        }

        async function handlePointerClick(e) {
            if (jatekter.classList.contains('board-disabled') || !e.target.closest('#jatekter, #drop-zone')) return;
            
            const clientX = e.type.startsWith('touch') ? (e.changedTouches[0] || e.touches[0]).clientX : e.clientX;
            const boardRect = jatekter.getBoundingClientRect();
            const cellaSzelesseg = boardRect.width / OSZLOPOK;
            let oszlop = Math.floor((clientX - boardRect.left) / cellaSzelesseg);
            oszlop = Math.max(0, Math.min(OSZLOPOK - 1, oszlop));
            if (oszlop < 0 || oszlop >= OSZLOPOK) return;

            const snapshot = await get(ref(db, `games/${localGameId}`));
            const gameState = snapshot.val();
            if(!gameState || gameState.status !== 'active' || gameState.currentPlayer !== localPlayerColor) return;
            
            const sor = legalsoUresSor(oszlop, gameState.board);
            if (sor !== -1) {
                lep(sor, oszlop, gameState);
            }
        }
        
        async function lep(sor, oszlop, gameState) {
            previewDisc.classList.add('hidden');
            const currentBoard = gameState.board;
            currentBoard[sor][oszlop] = localPlayerColor;
            const winnerInfo = nyertEllenorzes(sor, oszlop, currentBoard);
            
            const newState = {
                board: currentBoard,
                lastMove: { r: sor, c: oszlop, color: localPlayerColor, timestamp: Date.now() },
                currentPlayer: localPlayerColor === 'piros' ? 'sarga' : 'piros'
            };
            
            if (winnerInfo) {
                newState.status = 'finished';
                newState.winner = localPlayerColor;
                newState.players = gameState.players;
                newState.players[localPlayerColor].score++;
            } else if (currentBoard.flat().every(c => c !== "")) {
                newState.status = 'finished';
                newState.winner = 'draw';
            }

            await update(ref(db, 'games/' + localGameId), newState);

            if(newState.status === 'finished') {
                winnerStaticText.textContent = "Nyert!";
                if (newState.winner !== 'draw') {
                    triggerRealisticConfetti();
                    winnerPlayerName.textContent = gameState.players[localPlayerColor].name;
                    const winColor = localPlayerColor === 'piros' ? 'var(--player1-color)' : 'var(--player2-color)';
                    winnerOverlay.style.setProperty('--win-color', winColor);
                } else {
                    winnerPlayerName.textContent = "A játék";
                    winnerStaticText.textContent = "Döntetlen!";
                }
                createNextRoundButton();
                winnerOverlay.classList.add('show');
            }
        }
        
        function nyertEllenorzes(sor, oszlop, board) {
            if(!board) return null;
            const jatekos = board[sor][oszlop];
            const directions = [[0, 1], [1, 0], [1, 1], [1, -1]];
            for (const [dr, dc] of directions) {
                const line = [{ r: sor, c: oszlop }];
                for (let i = 1; i < 4; i++) { const r = sor + i * dr, c = oszlop + i * dc; if (board[r]?.[c] === jatekos) line.push({ r, c }); else break; }
                for (let i = 1; i < 4; i++) { const r = sor - i * dr, c = oszlop - i * dc; if (board[r]?.[c] === jatekos) line.push({ r, c }); else break; }
                if (line.length >= 4) return line;
            }
            return null;
        }

        const legalsoUresSor = (c, board) => {
            if (!board) return -1;
            for (let r = SOROK - 1; r >= 0; r--) if (board[r]?.[c] === "") return r; return -1; };

        function triggerRealisticConfetti() {
            // ... a konfetti kód változatlan ...
        }
        
        async function handlePointerMove(e) {
            if (!localGameId || jatekter.classList.contains('board-disabled')) {
                previewDisc.classList.add('hidden');
                return;
            };
            e.preventDefault();
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const boardRect = jatekter.getBoundingClientRect();
            
            let oszlop = Math.floor((clientX - boardRect.left) / boardRect.width * OSZLOPOK);
            oszlop = Math.max(0, Math.min(OSZLOPOK - 1, oszlop));
            
            const snapshot = await get(ref(db, `games/${localGameId}/board`));
            const currentBoard = snapshot.val();
            if (currentBoard && legalsoUresSor(oszlop, currentBoard) !== -1) {
                const cellaSzelesseg = boardRect.width / OSZLOPOK;
                const golyomeret = cellaSzelesseg * 0.85;
                previewDisc.style.width = `${golyomeret}px`;
                previewDisc.style.height = `${golyomeret}px`;
                previewDisc.className = `golyostilus ${localPlayerColor}`;
                previewDisc.style.left = `${oszlop * cellaSzelesseg + (cellaSzelesseg - golyomeret) / 2}px`;
                previewDisc.classList.remove('hidden');
            } else { 
                previewDisc.classList.add('hidden'); 
            }
        }
        
        function createNextRoundButton() {
            winnerActions.innerHTML = '';
            const nextRoundBtn = document.createElement('button');
            nextRoundBtn.textContent = 'Új Kör (Revans)';
            winnerActions.appendChild(nextRoundBtn);
            nextRoundBtn.addEventListener('click', async () => {
                winnerOverlay.classList.remove('show');
                if (localPlayerColor === 'piros') {
                    await update(ref(db, 'games/' + localGameId), {
                        board: Array.from({ length: SOROK }, () => Array(OSZLOPOK).fill("")),
                        currentPlayer: 'piros', status: 'active', winner: null, lastMove: null
                    });
                }
            }, { once: true });
        }
        
        initGame();
    </script>
</body>
</html>

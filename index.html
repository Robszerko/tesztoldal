<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Legfrissebb Láncszem - Napi Párbaj</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00d4ff;
            --accent-color: #9f50ff;
            --background-dark: #000c24;
            --background-light: #0b1a3d;
            --text-light: #f0f0f0;
            --text-dark: #000c24;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --selected-color: #ffc107;
            --explanation-bg: #122a57;
        }

        /* ALAP ANIMÁCIÓK */
        @keyframes background-pan { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes glow { 0% { text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color); } 100% { text-shadow: 0 0 10px var(--primary-color), 0 0 15px var(--primary-color); } }
        @keyframes flash-warning { 0%, 100% { background-color: var(--danger-color); box-shadow: 0 0 15px #ff0000; } 50% { background-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); } }
        @keyframes pulse-correct {
            0% { box-shadow: 0 0 10px var(--success-color), 0 0 20px rgba(40, 167, 69, 0.5); transform: scale(1.02); }
            50% { box-shadow: 0 0 20px var(--success-color), 0 0 40px rgba(40, 167, 69, 0.8); transform: scale(1.04); }
            100% { box-shadow: 0 0 10px var(--success-color), 0 0 20px rgba(40, 167, 69, 0.5); transform: scale(1.02); }
        }

        /* ALAP BEÁLLÍTÁSOK */
        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-dark);
            background-image: linear-gradient(270deg, var(--background-light), var(--background-dark), var(--background-light));
            background-size: 200% 200%;
            animation: background-pan 30s linear infinite;
            color: var(--text-light);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; text-align: center; overflow-x: hidden;
        }

        .screen { display: none; width: 100%; height: 100%; }
        .screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        h1, h2, h3 { font-family: 'Russo One', sans-serif; text-transform: uppercase; color: var(--primary-color); text-shadow: 0 0 8px var(--primary-color);}

        /* GOMBOK */
        button {
            background: linear-gradient(145deg, var(--accent-color), #673ab7);
            color: var(--text-light); border: none; padding: 14px 32px;
            font-size: 1.3em; font-family: 'Russo One', sans-serif; cursor: pointer; transition: all 0.2s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); border: 2px solid var(--accent-color);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 10% 100%, 0 75%);
        }
        button:hover:not(:disabled) { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 20px rgba(159, 80, 255, 0.5); }
        button:active:not(:disabled) { transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 10px rgba(159, 80, 255, 0.4); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; border-color: #555;}
        
        .secondary-btn { background: transparent; border-color: var(--primary-color); color: var(--primary-color); font-size: 1.1em; padding: 10px 25px; }

        .container {
            width: 90%; max-width: 1200px;
            background-color: rgba(11, 26, 61, 0.7); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px;
            border: 1px solid var(--primary-color); box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
            clip-path: polygon(0 10%, 10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
        }
        .container button { margin: 10px; }
        
        #game-code-display { font-size: 3.5em; font-weight: 700; letter-spacing: 10px; background-color: var(--background-dark); padding: 15px; border-radius: 10px; border: 2px dashed var(--primary-color); margin: 20px 0; cursor: pointer; }
        input { padding: 12px; font-size: 1.6em; border-radius: 8px; border: 2px solid var(--primary-color); background-color: var(--background-dark); color: #fff; text-align: center; width: 280px; font-family: 'Poppins'; }

        /* JÁTÉK KÉPERNYŐ */
        #game-screen { max-width: 1400px; width: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 20px; width: 100%; }
        .player-info-box { padding: 15px 20px; background-color: rgba(11, 26, 61, 0.6); border: 2px solid var(--primary-color); border-radius: 15px; width: 35%; transition: all 0.3s ease; }
        .player-info-box.active { border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .player-info-box .name { font-size: 1.5em; font-family: 'Russo One'; color: var(--primary-color); }
        .player-info-box .score-label { font-size: 0.9em; text-transform: uppercase; opacity: 0.7; }
        .player-info-box .score { font-size: 2em; font-weight: 700; color: #fff; }
        
        .main-game-area { display: flex; gap: 20px; flex-grow: 1; width: 100%; }
        #money-pyramid { width: 400px; background-color: rgba(0,0,0,0.3); border: 1px solid var(--primary-color); padding: 15px; border-radius: 15px; display: flex; flex-direction: column-reverse; align-items: center; justify-content: space-around; }
        .pyramid-level { width: 80%; min-height: 35px; line-height: 35px; margin: 2px 0; border-radius: 5px; text-align: center; font-weight: 600; font-size: 1.2em; color: var(--primary-color); transition: all 0.3s ease; }
        .pyramid-level.current { background-color: var(--accent-color); color: var(--text-dark); transform: scale(1.05); font-weight: 700; }
        #game-center-area { flex-grow: 1; display: flex; flex-direction: column; }
        .game-status-display { background-color: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 1px solid var(--primary-color); min-height: 120px; display: flex; flex-direction: column; justify-content: center;}
        #last-action-display { font-size: 1.5em; height: 40px; transition: color 0.3s; }
        #turn-display { font-size: 1.2em; }
        
        /* MODÁLIS ABLAK (KÉRDÉS) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;}
        .modal-content { background: var(--background-light); border: 2px solid var(--primary-color); box-shadow: 0 0 30px var(--primary-color); padding: 40px; border-radius: 15px; width: 95%; max-width: 900px; }
        #timer-display { font-size: 3.5em; font-weight: 700; color: var(--text-dark); background-color: var(--success-color); padding: 5px 25px; border-radius: 8px; margin: 10px auto 25px; width: fit-content; }
        #timer-display.timer-warning { animation: flash-warning 0.8s infinite; }
        #modal-question { font-size: 1.8em; }
        #modal-options button { display: block; width: 100%; margin: 12px 0; background-color: #1c2e59; color: #f0f0f0; border: 2px solid var(--primary-color); padding: 18px; font-size: 1.4em; border-radius: 10px; transition: all 0.3s; }
        #modal-options button:hover:not(:disabled) { background-color: #2b4588; border-color: var(--accent-color); }
        #modal-options button.selected { border-color: var(--selected-color); background-color: #474023; box-shadow: 0 0 15px var(--selected-color); transform: scale(1.02); }
        #modal-options button.correct { border-color: var(--success-color); background-color: #14361f; color: #fff; }
        #modal-options button.incorrect { border-color: var(--danger-color); background-color: #42191e; color: #ffb8b8; }
        #modal-options button.pulsing-correct { animation: pulse-correct 1.5s infinite; }
        #modal-explanation { margin-top: 20px; padding: 15px; background-color: var(--explanation-bg); border-radius: 10px; border-left: 5px solid var(--primary-color); text-align: left; font-size: 1.1em; }
        #modal-footer { margin-top: 20px; }
        
        /* SZERENCSEKERÉK */
        #wheel-modal .modal-content { max-width: 600px; }
        #wheel-container { position: relative; width: 100%; max-width: 500px; margin: 20px auto; aspect-ratio: 1/1; }
        #wheel-canvas { width: 100%; height: 100%; }
        #wheel-pointer {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 50px;
            background: linear-gradient(45deg, #ffeb3b, #ffc107);
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            transform: translate(-50%, -120%) rotate(180deg);
            z-index: 10; border-top: 3px solid #c89200;
        }
        #wheel-result { font-size: 1.6em; font-family: 'Russo One'; margin-top: 20px; height: 35px; color: var(--selected-color); }

        /* MOBIL NÉZET */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            #game-screen { padding: 10px; }
            .game-header, .main-game-area { flex-direction: column; }
            .player-info-box { width: 100%; }
            #money-pyramid { width: 100%; order: 2; margin-top: 15px; flex-direction: column; }
            #game-center-area { width: 100%; order: 1; }
            .modal-content { padding: 20px; }
            #modal-question { font-size: 1.3em; }
            #modal-options button { font-size: 1.1em; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><h2 id="loading-text">Kapcsolódás...</h2></div>
    <div id="name-setup-screen" class="screen">
        <div class="container">
            <h1>A LÁNCSZEM</h1>
            <h2>Üdv a játékban!</h2>
            <p>Kérlek, add meg a játékosneved:</p>
            <input type="text" id="player-name-input" maxlength="15" placeholder="Játékosnév">
            <br><br>
            <button id="save-name-btn">Mentés és Tovább</button>
        </div>
    </div>
    <div id="menu-screen" class="screen">
        <div class="container">
            <h1 id="welcome-message">Üdv, Játékos!</h1>
            <p>Hívd ki egy barátodat egy egész napos párbajra!</p>
            <button id="host-game-btn">Játék Létrehozása</button>
            <button id="join-game-btn">Csatlakozás Játékhoz</button>
        </div>
    </div>
    <div id="host-wait-screen" class="screen">
        <div class="container">
            <h2>Várakozás a másik játékosra...</h2>
            <p>Oszd meg ezt a kódot a barátoddal (kattints a másoláshoz):</p>
            <div id="game-code-display" title="Kattints a másoláshoz">----</div>
            <button id="cancel-host-btn">Mégse</button>
        </div>
    </div>
    <div id="join-screen" class="screen">
        <div class="container">
            <h2>Csatlakozás játékhoz</h2>
            <p>Írd be a 4-jegyű kódot:</p>
            <input type="text" id="join-code-input" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="----">
            <br><br>
            <button id="confirm-join-btn">Csatlakozás!</button>
            <button id="cancel-join-btn">Vissza</button>
        </div>
    </div>
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div id="player1-info" class="player-info-box">
                <div id="player1-name" class="name">1. Játékos</div>
                <div class="score-label">Napi Pontszám</div>
                <div id="player1-score" class="score">0 Ft</div>
            </div>
            <div style="text-align: center; width: 30%;">
                <h3 id="game-progress-text">Kérdés: 1 / 10</h3>
            </div>
            <div id="player2-info" class="player-info-box">
                <div id="player2-name" class="name">2. Játékos</div>
                <div class="score-label">Napi Pontszám</div>
                <div id="player2-score" class="score">0 Ft</div>
            </div>
        </div>
        <div class="main-game-area">
            <div id="money-pyramid"></div>
            <div id="game-center-area">
                <div class="game-status-display">
                    <h3 id="last-action-display">Kezdődjön a játék!</h3>
                    <p id="turn-display">Az 1. Játékos kezd.</p>
                </div>
                <div class="action-buttons" style="margin-top: auto;">
                    <button id="bank-btn">BANK</button>
                    <button id="answer-btn">Válaszolok</button>
                </div>
            </div>
        </div>
    </div>
    <div id="answer-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="timer-display">20.0</div>
            <h2 id="modal-question">Kérdés betöltése...</h2>
            <div id="modal-options"></div>
            <div id="modal-explanation" style="display: none;"></div>
            <div id="modal-footer">
                <button id="confirm-answer-btn" disabled>Válasz lezárása</button>
            </div>
        </div>
    </div>
    <div id="wheel-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="wheel-title">A kör győztese pörget!</h2>
            <p id="wheel-subtitle"></p>
            <div id="wheel-container">
                <canvas id="wheel-canvas"></canvas>
                <div id="wheel-pointer"></div>
            </div>
            <h3 id="wheel-result"></h3>
            <button id="spin-btn">PÖRGETÉS!</button>
            <button id="next-round-btn" style="display: none;">Következő kör</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDToVf58oqEO9s-WAF87IS1GDIb8LKtNMA",
      authDomain: "a-leggyengebb-lancszem.firebaseapp.com",
      databaseURL: "https://a-leggyengebb-lancszem-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "a-leggyengebb-lancszem",
      storageBucket: "a-leggyengebb-lancszem.appspot.com",
      messagingSenderId: "454539315458",
      appId: "1:454539315458:web:ef8c9ae8981e71a1b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const MONEY_PYRAMID = [ { value: 0 }, { value: 10000, label: "10 000 Ft" }, { value: 25000, label: "25 000 Ft" }, { value: 50000, label: "50 000 Ft" }, { value: 100000, label: "100 000 Ft" }, { value: 200000, label: "200 000 Ft" }, { value: 350000, label: "350 000 Ft" }, { value: 500000, label: "500 000 Ft" }, { value: 1000000, label: "1 000 000 Ft" } ];
    const QUESTIONS_PER_ROUND = 10;
    const WHEEL_PRIZES = [
        { label: "10k Ft", value: 10000, color: "#42a5f5" }, { label: "CSŐD", value: 0, color: "#ef5350" }, 
        { label: "50k Ft", value: 50000, color: "#29b6f6" }, { label: "DUPLÁZÓ", value: "double", color: "#ab47bc" },
        { label: "25k Ft", value: 25000, color: "#4dd0e1" }, { label: "BANK FELE", value: "half", color: "#ffa726" },
        { label: "100k Ft", value: 100000, color: "#26c6da" }, { label: "+50k Ft", value: 50000, color: "#66bb6a" }
    ];
    const ALL_QUESTIONS = [
        { "question": "Melyik bolygó a legnagyobb a Naprendszerben?", "options": ["Föld", "Jupiter", "Mars", "Szaturnusz"], "answer": "Jupiter", "explanation": "A Jupiter tömege több mint kétszerese a Naprendszer összes többi bolygója együttes tömegének." },
        { "question": "Hány lába van egy póknak?", "options": ["6", "8", "10", "12"], "answer": "8", "explanation": "A pókok a pókszabásúak osztályába tartoznak, melyek egyik fő jellemzője a nyolc láb, ellentétben a rovarokkal, melyeknek hat van." },
        { "question": "Mi a víz kémiai képlete?", "options": ["H2O", "CO2", "O2", "NaCl"], "answer": "H2O", "explanation": "A vízmolekula két hidrogén (H) és egy oxigén (O) atomból áll, innen a H2O képlet." },
        { "question": "Ki írta a Hamletet?", "options": ["Charles Dickens", "J.K. Rowling", "William Shakespeare", "Tolkien"], "answer": "William Shakespeare", "explanation": "A 'Hamlet, dán királyfi' William Shakespeare egyik legismertebb és legtöbbet idézett tragédiája." },
        { "question": "Melyik a világ legmagasabb hegye?", "options": ["K2", "Mount Everest", "Kancsendzönga", "Lhoce"], "answer": "Mount Everest", "explanation": "A Mount Everest (Csomolungma) a Himalájában található, és 8848,86 méteres magasságával a Föld legmagasabb pontja." },
        { "question": "Melyik ország fővárosa Tokió?", "options": ["Kína", "Dél-Korea", "Japán", "Thaiföld"], "answer": "Japán", "explanation": "Tokió Japán fővárosa és a világ egyik legnépesebb metropolisza." },
        { "question": "Melyik évben kezdődött a második világháború?", "options": ["1939", "1941", "1945", "1914"], "answer": "1939", "explanation": "A második világháború 1939. szeptember 1-jén kezdődött, amikor Németország lerohanta Lengyelországot." },
        { "question": "Hány kontinens van a Földön?", "options": ["5", "6", "7", "8"], "answer": "7", "explanation": "A legelterjedtebb földrajzi felosztás szerint hét kontinens van: Ázsia, Afrika, Észak-Amerika, Dél-Amerika, Antarktisz, Európa és Ausztrália." },
        { "question": "Ki festette a Mona Lisát?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "answer": "Leonardo da Vinci", "explanation": "A Mona Lisa Leonardo da Vinci reneszánsz festőművész leghíresebb alkotása, amely a párizsi Louvre-ban található." },
        { "question": "Melyik a legkeményebb természetes anyag a Földön?", "options": ["Arany", "Vas", "Kvarc", "Gyémánt"], "answer": "Gyémánt", "explanation": "A gyémánt a Mohs-féle keménységi skálán a legmagasabb, 10-es értéket éri el, ami a legkeményebb ismert természetes anyaggá teszi." },
        { "question": "Hány nap van egy szökőévben?", "options": ["364", "365", "366", "367"], "answer": "366", "explanation": "Szökőévekben a február hónap 29 napos, így az év 366 napból áll a szokásos 365 helyett." },
        { "question": "Melyik óceán a legnagyobb?", "options": ["Atlanti-óceán", "Indiai-óceán", "Csendes-óceán", "Jeges-tenger"], "answer": "Csendes-óceán", "explanation": "A Csendes-óceán a Föld legnagyobb és legmélyebb óceánja, területe nagyobb, mint a bolygó összes szárazföldje együttvéve." },
        { "question": "Ki volt az első ember a Holdon?", "options": ["Jurij Gagarin", "Buzz Aldrin", "Neil Armstrong", "Michael Collins"], "answer": "Neil Armstrong", "explanation": "Neil Armstrong, az Apollo–11 űrhajó parancsnoka volt az első ember, aki 1969. július 20-án a Holdra lépett." },
        { "question": "Melyik város Olaszország fővárosa?", "options": ["Velence", "Milánó", "Róma", "Nápoly"], "answer": "Róma", "explanation": "Róma, az 'Örök Város' Olaszország fővárosa és az ókori Római Birodalom központja volt." },
        { "question": "Melyik állat a 'dzsungel királya'?", "options": ["Tigris", "Elefánt", "Oroszlán", "Medve"], "answer": "Oroszlán", "explanation": "Bár az oroszlánok jellemzően szavannákon élnek, erejük és fenséges megjelenésük miatt hagyományosan a 'dzsungel' (és az állatok) királyaként emlegetik őket." },
        { "question": "Melyik a leggyorsabb szárazföldi állat?", "options": ["Gepárd", "Gazella", "Oroszlán", "Ló"], "answer": "Gepárd", "explanation": "A gepárd rövid távon képes elérni a 100-120 km/h sebességet is, ezzel a leggyorsabb szárazföldi emlős." },
        { "question": "Melyik a Föld legszárazabb sivataga?", "options": ["Szahara", "Góbi", "Kalahári", "Atacama"], "answer": "Atacama", "explanation": "Az Atacama-sivatag Chilében a Föld legszárazabb helye, egyes területein évtizedekig nem esik mérhető csapadék." },
        { "question": "Melyik folyó folyik keresztül Párizson?", "options": ["Duna", "Temze", "Szajna", "Tiberis"], "answer": "Szajna", "explanation": "A Szajna (Seine) folyó szeli ketté Párizst, számos híres híd ível át rajta." },
        { "question": "Melyik ország zászlajában található egy juharlevél?", "options": ["Svájc", "Kanada", "Ausztria", "Japán"], "answer": "Kanada", "explanation": "Kanada nemzeti jelképe a juharlevél, amely a zászlajuk központi eleme." },
        { "question": "Mi Ausztrália fővárosa?", "options": ["Sydney", "Melbourne", "Perth", "Canberra"], "answer": "Canberra", "explanation": "Bár Sydney a legnagyobb város, a főváros a tervezett város, Canberra." },
        { "question": "Melyik fém folyékony szobahőmérsékleten?", "options": ["Ólom", "Higany", "Cink", "Gallium"], "answer": "Higany", "explanation": "A higany az egyetlen fém, amely normál légköri nyomáson és szobahőmérsékleten folyékony halmazállapotú." },
        { "question": "Hány csont van egy átlagos felnőtt emberi testben?", "options": ["206", "212", "198", "230"], "answer": "206", "explanation": "Egy újszülöttnek több csontja van, de ezek egy része idővel összeforr, így a felnőtt csontváz 206 csontból áll." },
        { "question": "Melyik vitamin hiánya okozza a skorbutot?", "options": ["A-vitamin", "D-vitamin", "B12-vitamin", "C-vitamin"], "answer": "C-vitamin", "explanation": "A skorbut a súlyos C-vitamin (aszkorbinsav) hiány következtében kialakuló betegség, régen a tengerészek körében volt gyakori." },
        { "question": "Mi a modern ember tudományos neve?", "options": ["Homo erectus", "Homo habilis", "Homo neanderthalensis", "Homo sapiens"], "answer": "Homo sapiens", "explanation": "A 'Homo sapiens' latinul 'bölcs embert' jelent, ez a ma élő emberfaj tudományos elnevezése." },
        { "question": "Melyik évben omlott le a berlini fal?", "options": ["1985", "1991", "1989", "1990"], "answer": "1989", "explanation": "A berlini fal leomlása 1989. november 9-én kezdődött, és a hidegháború végének szimbolikus eseménye lett." },
        { "question": "Ki volt az Amerikai Egyesült Államok első elnöke?", "options": ["Thomas Jefferson", "Abraham Lincoln", "George Washington", "John Adams"], "answer": "George Washington", "explanation": "George Washington vezette a kontinentális hadsereget a függetlenségi háborúban, és 1789-ben lett az USA első elnöke." },
        { "question": "Melyik ókori civilizáció építette a Colosseumot?", "options": ["Görög", "Egyiptomi", "Római", "Perzsa"], "answer": "Római", "explanation": "A Colosseum, eredeti nevén Amphitheatrum Flavium, a Római Birodalom legnagyobb amfiteátruma volt Rómában." },
        { "question": "Ki festette a 'Csillagos éj' című híres festményt?", "options": ["Claude Monet", "Pablo Picasso", "Vincent van Gogh", "Salvador Dalí"], "answer": "Vincent van Gogh", "explanation": "A 'Csillagos éj' Vincent van Gogh holland posztimpresszionista festő egyik legismertebb műve." },
        { "question": "Melyik Victor Hugo regény főszereplője Jean Valjean?", "options": ["A párizsi Notre-Dame", "A nyomorultak", "A tenger munkásai", "A nevető ember"], "answer": "A nyomorultak", "explanation": "Jean Valjean 'A nyomorultak' (Les Misérables) című regény központi karaktere, aki a társadalmi igazságtalanságok elől menekül." },
        { "question": "Ki szerezte 'A négy évszak' című hegedűverseny-sorozatot?", "options": ["Bach", "Mozart", "Beethoven", "Vivaldi"], "answer": "Vivaldi", "explanation": "Antonio Vivaldi olasz barokk zeneszerző leghíresebb műve a négy hegedűversenyből álló 'A négy évszak'." },
        { "question": "Melyik görög isten a tenger ura?", "options": ["Zeusz", "Hádész", "Apollón", "Poszeidón"], "answer": "Poszeidón", "explanation": "Poszeidón a görög mitológiában a tengerek, földrengések és lovak istene, jelképe a háromágú szigony." },
        { "question": "Hány karika van az olimpiai zászlón?", "options": ["5", "7", "6", "4"], "answer": "5", "explanation": "Az olimpiai zászlón öt, egymásba fonódó karika található, amelyek az öt lakott kontinenst (Európa, Ázsia, Afrika, Amerika, Ausztrália) szimbolizálják." },
        { "question": "Ki volt a 'Queen' együttes legendás énekese?", "options": ["David Bowie", "Elton John", "Freddie Mercury", "Mick Jagger"], "answer": "Freddie Mercury", "explanation": "Freddie Mercury páratlan hangterjedelmével és színpadi jelenlétével a rocktörténelem egyik legkiemelkedőbb frontembere volt." },
        { "question": "Melyik sportágban használják a 'szett' és a 'gem' kifejezéseket?", "options": ["Kosárlabda", "Golf", "Tenisz", "Vízilabda"], "answer": "Tenisz", "explanation": "A teniszben a mérkőzés szettekből (játszmákból), a szettek pedig gemekből (játékokból) állnak." },
        { "question": "Melyik kitalált városban él Batman?", "options": ["Metropolis", "Star City", "Central City", "Gotham City"], "answer": "Gotham City", "explanation": "Batman, a 'Sötét Lovag' a DC Comics által kitalált Gotham City bűnözőitől védi a lakosságot." },
        { "question": "Melyik hangszernek van általában 88 billentyűje?", "options": ["Csembaló", "Orgona", "Zongora", "Szintetizátor"], "answer": "Zongora", "explanation": "A modern akusztikus és digitális zongorák szabványosan 88 billentyűvel (52 fehér és 36 fekete) rendelkeznek." },
        { "question": "Milyen állat a 'kapibara' (vízidisznó)?", "options": ["Hüllő", "Kétéltű", "Sertésféle", "Rágcsáló"], "answer": "Rágcsáló", "explanation": "A kapibara a világ legnagyobb termetű rágcsálója, Dél-Amerikában őshonos." },
        { "question": "Hány mező van egy szabványos sakktáblán?", "options": ["36", "49", "64", "81"], "answer": "64", "explanation": "A sakktábla 8x8-as négyzethálóból áll, így összesen 64 (32 világos és 32 sötét) mező található rajta." },
        { "question": "Melyik cég logója egy megharapott alma?", "options": ["Microsoft", "Apple", "Google", "Amazon"], "answer": "Apple", "explanation": "Az Apple Inc. ikonikus logója egy stilizált, megharapott alma." },
        { "question": "Melyik országban található a Gízai nagy piramis?", "options": ["Szudán", "Líbia", "Egyiptom", "Marokkó"], "answer": "Egyiptom", "explanation": "A Kheopsz fáraó síremlékeként épült gízai nagy piramis Egyiptomban, Kairó mellett található." },
        { "question": "Mi a japán szumó birkózók küzdőterének neve?", "options": ["Tatami", "Ring", "Pástra", "Dohjó"], "answer": "Dohjó", "explanation": "A dohjó az agyagból és homokból készült, kör alakú küzdőtér, ahol a szumó mérkőzések zajlanak." },
        { "question": "Melyik a leghosszabb folyó Dél-Amerikában?", "options": ["Paraná", "Orinoco", "Amazonas", "Madeira"], "answer": "Amazonas", "explanation": "Vízhozamát tekintve a legnagyobb, hosszát tekintve pedig a Nílussal vetekedve a világ leghosszabb folyója az Amazonas." },
        { "question": "Ki írta az 'Egri csillagok' című regényt?", "options": ["Jókai Mór", "Mikszáth Kálmán", "Gárdonyi Géza", "Móricz Zsigmond"], "answer": "Gárdonyi Géza", "explanation": "Az 'Egri csillagok' Gárdonyi Géza 1901-ben megjelent népszerű történelmi regénye Eger 1552-es ostromáról." },
        { "question": "Melyik elem vegyjele az 'Au'?", "options": ["Ezüst", "Arany", "Alumínium", "Argon"], "answer": "Arany", "explanation": "Az 'Au' vegyjel a latin 'aurum' szóból származik, ami aranyat jelent." },
        { "question": "Melyik sportágban vált világhírűvé Michael Jordan?", "options": ["Baseball", "Amerikai futball", "Kosárlabda", "Jégkorong"], "answer": "Kosárlabda", "explanation": "Michael Jordant széles körben minden idők legjobb kosárlabdázójának tartják." },
        { "question": "Mi a neve a római mitológia főistenének?", "options": ["Mars", "Neptunus", "Jupiter", "Apollo"], "answer": "Jupiter", "explanation": "Jupiter a római mitológiában az istenek királya, az ég és a villámok ura, a görög Zeusz megfelelője." },
        { "question": "Melyik városban áll a Szabadság-szobor?", "options": ["Washington D.C.", "Boston", "Philadelphia", "New York"], "answer": "New York", "explanation": "A Szabadság-szobor New York kikötőjében, a Liberty Islanden található." },
        { "question": "Körülbelül hány földi nap egy év a Marson?", "options": ["225", "365", "687", "821"], "answer": "687", "explanation": "Mivel a Mars távolabb kering a Naptól, egy marsi év körülbelül 687 földi napig tart." },
        { "question": "Melyik országból származik a tequila?", "options": ["Spanyolország", "Kuba", "Brazília", "Mexikó"], "answer": "Mexikó", "explanation": "A tequila egy mexikói eredetvédett ital, amelyet a kék agávé növényből készítenek." }
    ];
    
    const screens = { loading: document.getElementById('loading-screen'), nameSetup: document.getElementById('name-setup-screen'), menu: document.getElementById('menu-screen'), hostWait: document.getElementById('host-wait-screen'), join: document.getElementById('join-screen'), game: document.getElementById('game-screen'), wheel: document.getElementById('wheel-modal'), answerModal: document.getElementById('answer-modal') };
    let localPlayer = { uid: null, name: null };
    let currentGameId = null; 
    let gameUnsubscribe = null;
    let scoreUnsubscribers = [];
    let timerInterval = null;
    let localSelectedAnswer = null;

    function getTodayString() { return new Date().toISOString().slice(0, 10); }
    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); if(screens[screenName]) screens[screenName].classList.add('active'); }

    onAuthStateChanged(auth, async (user) => {
        try {
            if (user) {
                localPlayer.uid = user.uid;
                const playerSnap = await get(ref(db, `players/${user.uid}`));
                if (playerSnap.exists() && playerSnap.val().name) {
                    localPlayer.name = playerSnap.val().name;
                    document.getElementById('welcome-message').textContent = `Üdv újra, ${localPlayer.name}!`;
                    switchScreen('menu');
                } else {
                    switchScreen('nameSetup');
                }
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Hiba az authentikáció vagy adatbetöltés során:", error);
            document.getElementById('loading-text').textContent = "Hiba a kapcsolódás során. Kérjük, frissítse az oldalt.";
        }
    });

    document.getElementById('save-name-btn').addEventListener('click', async () => {
        const name = document.getElementById('player-name-input').value.trim();
        if (name.length < 3) return alert("A névnek legalább 3 karakterből kell állnia.");
        localPlayer.name = name;
        await set(ref(db, `players/${localPlayer.uid}`), { name });
        document.getElementById('welcome-message').textContent = `Üdv, ${localPlayer.name}!`;
        switchScreen('menu');
    });

    // JAVÍTÁS: A csatlakozás logikája leegyszerűsítve, a kör indítását a hostra bízva
    async function joinGame() {
        const gameId = document.getElementById('join-code-input').value;
        if (!gameId) return;
        
        try {
            const gameRef = ref(db, `games/${gameId}`);
            const snapshot = await get(gameRef);

            if (snapshot.exists() && snapshot.val().status === 'waiting') {
                currentGameId = gameId;
                const p1 = snapshot.val().player1;
                const p2 = { uid: localPlayer.uid, name: localPlayer.name };
                
                // Napi pontszám létrehozása, ha szükséges
                const today = getTodayString();
                for (const player of [p1, p2]) {
                    const dailyScoreRef = ref(db, `dailyScores/${today}/${player.uid}`);
                    const dailyScoreSnap = await get(dailyScoreRef);
                    if (!dailyScoreSnap.exists()) {
                        await set(dailyScoreRef, { name: player.name, score: 0 });
                    }
                }
                
                // Egyszerűsített csatlakozás: csak a 2. játékos adatait adjuk hozzá és elindítjuk a kört
                const questions = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_ROUND);
                await update(gameRef, {
                    player2: p2,
                    status: 'active',
                    roundScores: { [p1.uid]: 0, [p2.uid]: 0 },
                    turn: p1.uid,
                    chainLevel: 0,
                    questionIndex: 0,
                    questions,
                    lastAction: `${p2.name} csatlakozott! Kezdődjön a játék!`,
                    questionActive: false,
                    answerRevealed: false,
                    selectedAnswer: null,
                });

                onDisconnect(ref(db, `games/${gameId}`)).remove();
                listenToDailyScores(p1.uid, p2.uid);
                listenToGameUpdates(gameId);
            } else {
                alert("A játék nem található, vagy már tele van.");
            }
        } catch (error) {
            console.error("Hiba a csatlakozás során:", error);
            alert("Hiba történt a játékhoz való csatlakozás közben. Kérjük, próbálja újra.");
        }
    }
    
    // ... a többi kód változatlan az előző, működő verzióból ...

    async function createNewRound(gameId, p1, p2) {
        const questions = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_ROUND);
        const roundData = {
            status: 'active',
            player1: p1,
            player2: p2,
            roundScores: { [p1.uid]: 0, [p2.uid]: 0 },
            turn: p1.uid,
            chainLevel: 0,
            questionIndex: 0,
            questions,
            lastAction: 'Kezdődjön az új kör!',
            questionActive: false,
            answerRevealed: false,
            selectedAnswer: null,
        };
        await set(ref(db, `games/${gameId}`), roundData);
    }
    
    document.getElementById('host-game-btn').addEventListener('click', async () => {
        currentGameId = (Math.floor(Math.random() * 9000) + 1000).toString();
        const p1Data = { uid: localPlayer.uid, name: localPlayer.name };
        const initialGameData = { status: 'waiting', player1: p1Data };
        
        const gameRef = ref(db, `games/${currentGameId}`);
        await set(gameRef, initialGameData);
        onDisconnect(gameRef).remove();
        
        listenToGameUpdates(currentGameId);
        document.getElementById('game-code-display').textContent = currentGameId;
        switchScreen('hostWait');
    });

    document.getElementById('join-game-btn').addEventListener('click', () => switchScreen('join'));
    document.getElementById('cancel-join-btn').addEventListener('click', () => switchScreen('menu'));
    document.getElementById('confirm-join-btn').addEventListener('click', joinGame);


    function listenToDailyScores(p1uid, p2uid) {
        unsubscribeDailyScores();
        const today = getTodayString();
        const p1ScoreRef = ref(db, `dailyScores/${today}/${p1uid}/score`);
        const p2ScoreRef = ref(db, `dailyScores/${today}/${p2uid}/score`);

        const p1Unsub = onValue(p1ScoreRef, (snap) => document.getElementById('player1-score').textContent = `${(snap.val() || 0).toLocaleString()} Ft`);
        const p2Unsub = onValue(p2ScoreRef, (snap) => document.getElementById('player2-score').textContent = `${(snap.val() || 0).toLocaleString()} Ft`);
        
        scoreUnsubscribers.push(p1Unsub, p2Unsub);
    }
    
    function unsubscribeDailyScores() {
        scoreUnsubscribers.forEach(unsub => unsub());
        scoreUnsubscribers = [];
    }
    
    let lastKnownStatus = '';
    function listenToGameUpdates(gameId) {
        if (gameUnsubscribe) gameUnsubscribe();
        const gameRef = ref(db, `games/${gameId}`);
        gameUnsubscribe = onValue(gameRef, (snapshot) => {
            if (!snapshot.exists()) {
                alert("A játék véget ért vagy megszakadt.");
                if(gameUnsubscribe) gameUnsubscribe();
                unsubscribeDailyScores();
                switchScreen('menu');
                return;
            }
            const gameData = snapshot.val();
            
            if (lastKnownStatus === 'active' && gameData.status === 'roundOver') {
                if(gameData.player1.uid === localPlayer.uid) {
                   finalizeRoundScores(gameData);
                }
            }
            lastKnownStatus = gameData.status;

            updateUI(gameData);
        });
    }

    async function finalizeRoundScores(gameData) {
        const today = getTodayString();
        for (const player of [gameData.player1, gameData.player2]) {
            const roundScore = gameData.roundScores[player.uid] || 0;
            if (roundScore > 0) {
                const dailyScoreRef = ref(db, `dailyScores/${today}/${player.uid}/score`);
                await runTransaction(dailyScoreRef, (currentScore) => (currentScore || 0) + roundScore);
            }
        }
    }

    function updateUI(gameData) {
        if (!gameData) return;
        
        if (gameData.status === 'waiting' || !gameData.player2) {
             switchScreen('hostWait');
             document.getElementById('last-action-display').textContent = 'Várakozás a másik játékosra...';
             document.getElementById('turn-display').textContent = '';
             return;
        }

        document.getElementById('player1-name').textContent = gameData.player1.name;
        document.getElementById('player2-name').textContent = gameData.player2.name;

        if (gameData.status === 'active') {
            switchScreen('game');
            if (screens.wheel.style.display === 'flex') screens.wheel.style.display = 'none';
        } else if (gameData.status === 'roundOver') {
            showWheelUI(gameData);
        }

        document.getElementById('player1-info').classList.toggle('active', gameData.turn === gameData.player1.uid);
        document.getElementById('player2-info').classList.toggle('active', gameData.turn === gameData.player2.uid);
        
        for (let i = 1; i < MONEY_PYRAMID.length; i++) {
            document.getElementById(`pyramid-level-${i}`).classList.toggle('current', i === gameData.chainLevel);
        }
        
        document.getElementById('last-action-display').textContent = gameData.lastAction;
        const turnPlayerName = gameData.turn === gameData.player1.uid ? gameData.player1.name : gameData.player2.name;
        document.getElementById('turn-display').textContent = `${turnPlayerName} következik.`;
        document.getElementById('game-progress-text').textContent = `Kérdés: ${Math.min(gameData.questionIndex + 1, QUESTIONS_PER_ROUND)} / ${QUESTIONS_PER_ROUND}`;
        
        const myTurn = gameData.turn === localPlayer.uid;
        document.getElementById('answer-btn').disabled = !myTurn || gameData.questionActive;
        document.getElementById('bank-btn').disabled = !myTurn || gameData.chainLevel === 0 || gameData.questionActive;
        
        if (gameData.questionActive) {
            showQuestionModal(gameData);
        } else {
            hideQuestionModal();
        }
    }

    document.getElementById('answer-btn').addEventListener('click', () => {
        update(ref(db, `games/${currentGameId}`), { questionActive: true });
    });

    function showQuestionModal(data) {
        screens.answerModal.style.display = 'flex';
        const question = data.questions[data.questionIndex];
        const confirmBtn = document.getElementById('confirm-answer-btn');
        const explanationEl = document.getElementById('modal-explanation');

        document.getElementById('modal-question').textContent = question.question;
        explanationEl.style.display = 'none';
        explanationEl.innerHTML = `<b>Magyarázat:</b> ${question.explanation}`;
        confirmBtn.style.display = 'block';

        const optionsContainer = document.getElementById('modal-options');
        optionsContainer.innerHTML = '';
        question.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => handleSelectOption(btn, opt);
            optionsContainer.appendChild(btn);
        });
        
        localSelectedAnswer = null;
        confirmBtn.disabled = true;

        if(data.answerRevealed) {
            revealAnswer(data);
        } else if (data.turn === localPlayer.uid) {
            startTimer(20, async () => {
                 await update(ref(db, `games/${currentGameId}`), { 
                     lastAction: `${data.turn === data.player1.uid ? data.player1.name : data.player2.name} kifutott az időből!`,
                     chainLevel: 0,
                     turn: data.turn === data.player1.uid ? data.player2.uid : data.player1.uid,
                     questionActive: false,
                     selectedAnswer: null,
                     answerRevealed: false
                 });
            });
        }
    }

    function hideQuestionModal() {
        stopTimer();
        screens.answerModal.style.display = 'none';
    }

    function handleSelectOption(btn, option) {
        document.querySelectorAll('#modal-options button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        localSelectedAnswer = option;
        document.getElementById('confirm-answer-btn').disabled = false;
    }

    document.getElementById('confirm-answer-btn').addEventListener('click', async () => {
        if (!localSelectedAnswer) return;
        stopTimer();
        document.getElementById('confirm-answer-btn').disabled = true;
        await update(ref(db, `games/${currentGameId}`), {
            selectedAnswer: localSelectedAnswer,
            answerRevealed: true,
        });
    });

    function revealAnswer(data) {
        stopTimer();
        document.querySelectorAll('#modal-options button').forEach(b => b.disabled = true);
        
        const question = data.questions[data.questionIndex];
        const correctOpt = question.answer;
        const selectedOpt = data.selectedAnswer;

        document.querySelectorAll('#modal-options button').forEach(btn => {
            if (btn.textContent === correctOpt) {
                btn.classList.add('correct', 'pulsing-correct');
            }
            if (btn.textContent === selectedOpt && selectedOpt !== correctOpt) {
                btn.classList.add('incorrect');
            }
        });

        document.getElementById('modal-explanation').style.display = 'block';
        document.getElementById('confirm-answer-btn').style.display = 'none';

        if (localPlayer.uid === data.player1.uid) {
            setTimeout(() => calculateNextState(data), 4000);
        }
    }

    async function calculateNextState(data) {
      try {
        const question = data.questions[data.questionIndex];
        const isCorrect = data.selectedAnswer === question.answer;
        const turnPlayer = data.turn === data.player1.uid ? data.player1 : data.player2;
        
        let newChainLevel = data.chainLevel;
        let newTurn = data.turn;
        let lastAction = '';
        const updates = {};

        if (isCorrect) {
            newChainLevel = Math.min(data.chainLevel + 1, MONEY_PYRAMID.length - 1);
            lastAction = `${turnPlayer.name} helyesen válaszolt!`;
        } else {
            newChainLevel = 0;
            newTurn = data.turn === data.player1.uid ? data.player2.uid : data.player1.uid;
            lastAction = `${turnPlayer.name} hibázott! A lánc megszakadt.`;
        }
        
        const nextQuestionIndex = data.questionIndex + 1;
        if (nextQuestionIndex >= QUESTIONS_PER_ROUND) {
            updates.status = 'roundOver';
            if(isCorrect) {
                const finalBank = MONEY_PYRAMID[newChainLevel].value;
                if(finalBank > 0) {
                    updates[`roundScores/${data.turn}`] = (data.roundScores[data.turn] || 0) + finalBank;
                    lastAction += ` Az utolsó körben bankolt ${finalBank.toLocaleString()} Ft-ot!`;
                }
            }
        } else {
            updates.questionIndex = nextQuestionIndex;
        }
        
        updates.chainLevel = newChainLevel;
        updates.turn = newTurn;
        updates.questionActive = false;
        updates.answerRevealed = false;
        updates.selectedAnswer = null;
        updates.lastAction = lastAction;
        await update(ref(db, `games/${currentGameId}`), updates);
      } catch (error) {
          console.error("Hiba a játék állapotának kiszámítása közben:", error);
      }
    }
    
    document.getElementById('bank-btn').addEventListener('click', async () => {
        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        if (data.turn !== localPlayer.uid) return;
        
        const pointsToBank = MONEY_PYRAMID[data.chainLevel].value;
        const turnPlayer = data.turn === data.player1.uid ? data.player1 : data.player2;

        await update(ref(db, `games/${currentGameId}`), {
            [`roundScores/${data.turn}`]: (data.roundScores[data.turn] || 0) + pointsToBank,
            chainLevel: 0,
            turn: data.turn === data.player1.uid ? data.player2.uid : data.player1.uid,
            lastAction: `${turnPlayer.name} bankolt ${pointsToBank.toLocaleString()} Ft-ot!`
        });
    });

    function startTimer(duration, onEnd) {
        stopTimer();
        let timeLeft = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.textContent = timeLeft.toFixed(1);
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            timerDisplay.textContent = timeLeft.toFixed(1);
            timerDisplay.classList.toggle('timer-warning', timeLeft <= 5.0);
            if (timeLeft <= 0) {
                stopTimer();
                if (onEnd) onEnd();
            }
        }, 100);
    }
    function stopTimer() { clearInterval(timerInterval); }

    const wheelCanvas = document.getElementById('wheel-canvas');
    const ctx = wheelCanvas.getContext('2d');
    let currentAngle = 0;
    
    function drawWheel() {
        if(!wheelCanvas.getContext) return;
        const size = wheelCanvas.width;
        const center = size / 2;
        const radius = size / 2 - 10;
        const arcSize = (2 * Math.PI) / WHEEL_PRIZES.length;
        
        ctx.clearRect(0, 0, size, size);
        ctx.font = `bold ${size * 0.045}px 'Russo One'`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        WHEEL_PRIZES.forEach((prize, i) => {
            const angle = currentAngle + i * arcSize;
            ctx.beginPath();
            ctx.fillStyle = prize.color;
            ctx.moveTo(center, center);
            ctx.arc(center, center, radius, angle, angle + arcSize);
            ctx.closePath();
            ctx.fill();

            ctx.save();
            ctx.fillStyle = '#fff';
            ctx.translate(center, center);
            ctx.rotate(angle + arcSize / 2);
            ctx.fillText(prize.label, radius * 0.6, 0);
            ctx.restore();
        });
    }
    
    function showWheelUI(data) {
        screens.wheel.style.display = 'flex';
        const p1RoundScore = data.roundScores[data.player1.uid] || 0;
        const p2RoundScore = data.roundScores[data.player2.uid] || 0;
        let winner;
        if(p1RoundScore > p2RoundScore) winner = data.player1;
        else if (p2RoundScore > p1RoundScore) winner = data.player2;
        else winner = data.player1;

        document.getElementById('wheel-subtitle').textContent = `Gratulálunk, ${winner.name}! Te pörgethetsz. (Kör eredménye: ${p1RoundScore.toLocaleString()} Ft vs ${p2RoundScore.toLocaleString()} Ft)`;
        document.getElementById('spin-btn').disabled = winner.uid !== localPlayer.uid;
        document.getElementById('next-round-btn').style.display = 'none';
        document.getElementById('wheel-result').textContent = "";
        
        const container = document.getElementById('wheel-container');
        wheelCanvas.width = container.clientWidth;
        wheelCanvas.height = container.clientHeight;
        drawWheel();
    }

    let spinAnimation;
    function spinWheel() {
        document.getElementById('spin-btn').disabled = true;
        let velocity = Math.random() * 0.2 + 0.3;
        const friction = 0.995;

        function animate() {
            velocity *= friction;
            currentAngle += velocity;
            drawWheel();
            if (velocity > 0.001) {
                spinAnimation = requestAnimationFrame(animate);
            } else {
                finishSpin();
            }
        }
        animate();
    }

    async function finishSpin() {
        const arcSize = (2 * Math.PI) / WHEEL_PRIZES.length;
        const pointerAngle = 1.5 * Math.PI;
        const finalAngle = (currentAngle % (2 * Math.PI) + (2*Math.PI)) % (2*Math.PI);
        const relativeAngle = ((2*Math.PI) - finalAngle + pointerAngle) % (2*Math.PI);
        const prizeIndex = Math.floor(relativeAngle / arcSize);
        const prize = WHEEL_PRIZES[prizeIndex];

        document.getElementById('wheel-result').textContent = `Nyeremény: ${prize.label}!`;

        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        
        const p1RoundScore = data.roundScores[data.player1.uid] || 0;
        const p2RoundScore = data.roundScores[data.player2.uid] || 0;
        const winnerUid = p1RoundScore >= p2RoundScore ? data.player1.uid : data.player2.uid;
        
        const today = getTodayString();
        const scoreRef = ref(db, `dailyScores/${today}/${winnerUid}/score`);

        runTransaction(scoreRef, (currentScore) => {
            if (currentScore === null) currentScore = 0;
            if (prize.value === 'double') return currentScore * 2;
            if (prize.value === 'half') return Math.floor(currentScore / 2);
            if (prize.value === 0) return 0;
            return currentScore + prize.value;
        });
        
        document.getElementById('next-round-btn').style.display = 'block';
    }
    
    document.getElementById('spin-btn').addEventListener('click', spinWheel);
    
    // JAVÍTÁS: A gomb most már a localPlayer.uid alapján ellenőriz, de a biztonság kedvéért
    // a DB írást csak a host (player1) végzi el.
    document.getElementById('next-round-btn').addEventListener('click', async () => {
        const gameSnap = await get(ref(db, `games/${currentGameId}`));
        const data = gameSnap.val();
        if(localPlayer.uid === data.player1.uid) {
            await createNewRound(currentGameId, data.player1, data.player2);
        }
    });

    (function init() {
        const pyramidContainer = document.getElementById('money-pyramid');
        MONEY_PYRAMID.slice(1).forEach((level, index) => { 
            const levelDiv = document.createElement('div'); 
            levelDiv.id = `pyramid-level-${index + 1}`; 
            levelDiv.classList.add('pyramid-level'); 
            levelDiv.textContent = level.label; 
            levelDiv.style.width = `${40 + (index * 6)}%`;
            pyramidContainer.appendChild(levelDiv);
        });
        
        document.getElementById('cancel-host-btn').addEventListener('click', () => { if(gameUnsubscribe) gameUnsubscribe(); remove(ref(db, `games/${currentGameId}`)); switchScreen('menu'); });
    })();

</script>

</body>
</html>

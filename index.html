<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora News Ticker - V141 (Razor Sharp Edition)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@300;400;500;700;800;900&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js" type="module"></script>
    <script src="https://unpkg.com/suncalc@1.8.0/suncalc.js"></script>

    <style>
        :root {
            /* Palette */
            --bg-grad-1: #020617;
            --bg-grad-2: #1e293b;
            --bg-grad-3: #0f172a;
            
            /* Sharp UI - No Blur, High Contrast */
            /* Megsz√ºntett√ºk az elmos√°st, helyette szinte teli fekete/k√©k h√°tt√©r */
            --panel-bg: rgba(6, 10, 25, 0.96); 
            --panel-border: rgba(255, 255, 255, 0.12);
            --panel-shadow: 0 4px 30px rgba(0, 0, 0, 0.8);
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-color: #38bdf8;
            --accent-warm: #fbbf24;
            --accent-danger: #ef4444;
            --accent-next: #a855f7; 
            
            --font-head: 'Montserrat', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-serif: 'Playfair Display', serif;
            
            /* CAPSULE DESIGN VARS */
            --cap-radius-outer: 90px; 
            --cap-radius-inner: 8px; 
            --bar-height: 185px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            background-color: transparent;
            font-family: var(--font-body);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            /* T≈∞√âLES BET≈∞K K√âNYSZER√çT√âSE */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* STABLE BACKGROUND */
        .ambient-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3));
            background-size: 300% 300%;
            animation: skyFlow 60s ease infinite;
        }
        @keyframes skyFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- CONTAINER --- */
        .ticker-container { 
            width: 100%; max-width: 1650px; 
            height: var(--bar-height); 
            display: flex; 
            gap: 0px; 
            position: relative; 
            justify-content: center; 
            align-items: stretch;
            transition: gap 1.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ticker-container.open { gap: 8px; }

        @media (max-width: 900px) { 
            .ticker-container { height: auto; flex-direction: column; gap: 10px !important; } 
            .glass-panel { border-radius: 12px !important; }
            .id-content, .weather-view { padding: 10px !important; }
        }

        /* SHARP PANEL DESIGN (Removed Blur) */
        .glass-panel {
            background: var(--panel-bg); 
            /* Blur t√∂r√∂lve a tisztas√°g √©rdek√©ben */
            backdrop-filter: none; 
            -webkit-backdrop-filter: none;
            
            border: 1px solid var(--panel-border); 
            box-shadow: var(--panel-shadow); position: relative;
            perspective: 1000px;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .glass-panel.loaded { opacity: 1; transform: scale(1); }

        /* --- SHAPES --- */
        .identity-panel { 
            width: 200px; flex-shrink: 0; z-index: 10; overflow: hidden;
            border-radius: var(--cap-radius-outer) var(--cap-radius-inner) var(--cap-radius-inner) var(--cap-radius-outer);
        }
        .weather-panel { 
            width: 250px; flex-shrink: 0; z-index: 10; overflow: hidden;
            border-radius: var(--cap-radius-inner) var(--cap-radius-outer) var(--cap-radius-outer) var(--cap-radius-inner);
        }
        .news-panel { 
            flex: 0; opacity: 0;
            display: flex; flex-direction: column; position: relative; cursor: pointer; 
            overflow: visible !important; 
            border-radius: var(--cap-radius-inner);
            transition: flex 1.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease 0.5s; 
        }
        .ticker-container.open .news-panel { flex: 1; opacity: 1; }

        /* --- FLIPPER --- */
        .panel-flipper {
            width: 100%; height: 100%;
            transition: transform 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; position: relative;
        }
        .panel-flipper.flipped { transform: rotateX(900deg); }
        .panel-face {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column; background: var(--panel-bg); /* Sharp BG */
        }
        .panel-face.back { transform: rotateX(180deg); display: flex; align-items: center; justify-content: center; }

        /* --- LEFT PANEL CONTENT --- */
        .id-content { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; 
            padding: 15px 10px 15px 30px; text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
        }
        .brand-wrapper { 
            display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;
            padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 5px;
            cursor: pointer;
        }
        .brand-logo svg { width: 24px; height: 24px; fill: var(--accent-color); filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.4)); animation: pulseLogo 3s infinite ease-in-out; }
        .brand-name { font-family: var(--font-head); font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; color: #fff; }
        .clock-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .clock-display-unified { display: flex; align-items: baseline; gap: 3px; margin-bottom: 4px; }
        .clock-hm { font-family: var(--font-mono); font-size: 1.9rem; font-weight: 700; color: #ffffff; line-height: 1; letter-spacing: -0.5px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .clock-s { font-family: var(--font-mono); font-size: 1.0rem; font-weight: 600; color: var(--accent-color); line-height: 1; opacity: 0.9; }
        .date-display { font-size: 0.7rem; color: #cbd5e1; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1.4; margin-top: 5px; }
        .footer-info { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 5px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
        .nameday-badge { background: rgba(var(--accent-warm), 0.1); color: var(--accent-warm); padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; max-width: 100%; border: 1px solid rgba(251, 191, 36, 0.15); letter-spacing: 0.5px; }

        /* --- CREDITS & ECONOMY --- */
        .credits-content { 
            background: #080c14; opacity: 0; z-index: 1; pointer-events: none;
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            position: absolute; top: 0; left: 0; transition: opacity 0.4s ease; padding-left: 30px; 
        }
        .credits-content.active { opacity: 1; z-index: 2; pointer-events: all; }
        .cr-container { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; }
        .cr-name-main { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: #fff; letter-spacing: 1px; font-style: italic; margin-bottom: 8px; background: linear-gradient(to bottom, #fff 30%, var(--accent-warm) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cr-line { width: 40px; height: 1px; background: rgba(255,255,255,0.2); margin-bottom: 8px; }
        .cr-bottom-text { font-family: var(--font-mono); font-size: 0.6rem; color: #64748b; line-height: 1.5; }
        
        .economy-content { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            position: absolute; top: 0; left: 0; transition: opacity 0.3s;
            background: linear-gradient(135deg, #0a1829, #162a42); 
            opacity: 0; z-index: 1; pointer-events: none;
            border: 1px solid rgba(251, 191, 36, 0.2); padding-left: 30px; 
        }
        .economy-content.active { opacity: 1; z-index: 2; pointer-events: all; }
        .eco-header { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; width: 100%; justify-content: center; }
        .eco-carousel { width: 100%; flex-grow: 1; position: relative; }
        .eco-slide { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; gap: 6px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .eco-slide.active { opacity: 1; pointer-events: all; }
        .eco-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; }
        .eco-curr { display: flex; align-items: center; gap: 5px; font-family: var(--font-head); font-weight: 700; color: var(--accent-color); font-size: 0.9rem; }
        .eco-val { font-family: var(--font-mono); font-weight: 700; color: #fff; font-size: 0.85rem; }

        /* --- NEWS PANEL --- */
        .news-viewport { 
            flex-grow: 1; position: relative; overflow: hidden; z-index: 2; 
            border-radius: var(--cap-radius-inner);
            padding-bottom: 30px; 
        }
        .news-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding: 15px 25px; gap: 8px; opacity: 0; visibility: hidden; transform: translateY(15px);
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .news-card.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .news-header-row { flex: 0 0 auto; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; width: 100%; overflow: hidden; position: relative; }
        .news-meta { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent-color); font-weight: 700; white-space: nowrap; z-index: 2; }
        .provider-identity { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 15px; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .provider-icon { width: 16px; height: 16px; border-radius: 50%; }
        .news-content-wrapper { 
            flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; min-height: 0; gap: 8px; 
            background: linear-gradient(90deg, rgba(2,6,23,0.98) 0%, rgba(2,6,23,0.85) 45%, rgba(2,6,23,0.4) 85%, rgba(2,6,23,0.1) 100%);
            padding: 15px 20px 20px 15px; border-radius: 8px; margin-left: -10px; margin-right: -5px;
        }
        .news-title { 
            flex: 0 0 auto; font-family: var(--font-head); font-size: 1.1rem; font-weight: 700; line-height: 1.4; color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,1); /* Reduced shadow spread for sharpness */
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; width: 95%; z-index: 5; padding-bottom: 2px; 
        }
        .news-desc { 
            flex: 0 1 auto; font-size: 0.85rem; color: #e2e8f0; font-weight: 400; line-height: 1.5; 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; max-width: 98%; 
            text-shadow: 0 1px 2px rgba(0,0,0,1); z-index: 5; padding-bottom: 4px; 
        }
        .news-image-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            mask-image: linear-gradient(to right, rgba(0,0,0,0.3) 0%, black 50%); 
            opacity: 0; transition: opacity 1s ease; pointer-events: none; z-index: 1; 
        }
        .news-image-overlay img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(0%) contrast(1.1); }
        .news-panel.has-image .news-image-overlay { opacity: 0.75; } 
        .default-news-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 0; transition: opacity 1s ease; }
        .news-panel:not(.has-image) .default-news-bg { opacity: 1; }
        .dnb-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, #1e3a8a, #0f172a 70%, #020617); }
        .dnb-world-map { position: absolute; top: 5%; right: -5%; width: 70%; height: 80%; background-image: radial-gradient(rgba(255,255,255,0.12) 1px, transparent 1px); background-size: 20px 20px; mask-image: radial-gradient(circle, black 30%, transparent 80%); transform: rotate(-10deg); }
        .dnb-watermark { position: absolute; top: 50%; left: 70%; transform: translate(-50%, -50%); opacity: 0.04; pointer-events: none; }
        .dnb-watermark svg { width: 400px; height: 400px; fill: #fff; }
        .dnb-text-strip { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-around; transform: rotate(-3deg); opacity: 0.05; font-family: var(--font-head); font-weight: 900; font-size: 4.5rem; color: #fff; white-space: nowrap; letter-spacing: 5px; }

        /* --- THEMATIC BADGES --- */
        .program-badge { 
            position: absolute; top: 12px; right: 12px; 
            font-family: var(--font-head); font-size: 0.65rem; font-weight: 800; 
            letter-spacing: 0.5px; text-transform: uppercase; 
            padding: 3px 8px; border-radius: 4px; 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: opacity 0.5s; z-index: 10; opacity: 0; 
        }
        .program-badge.visible { opacity: 1; }

        /* Color Classes */
        .badge-night { background: rgba(30, 27, 75, 0.95); border-color: #818cf8; color: #c7d2fe; }
        .badge-dawn { background: rgba(159, 18, 57, 0.95); border-color: #fb7185; color: #ffe4e6; }
        .badge-morning { background: rgba(180, 83, 9, 0.95); border-color: #fcd34d; color: #fef3c7; }
        .badge-day { background: rgba(3, 105, 161, 0.95); border-color: #7dd3fc; color: #e0f2fe; }
        .badge-noon { background: rgba(161, 98, 7, 0.95); border-color: #fde047; color: #fefce8; }
        .badge-afternoon { background: rgba(15, 118, 110, 0.95); border-color: #5eead4; color: #ccfbf1; }
        .badge-sunset { background: rgba(134, 25, 143, 0.95); border-color: #e879f9; color: #fae8ff; }
        .badge-evening { background: rgba(88, 28, 135, 0.95); border-color: #c084fc; color: #f3e8ff; }
        
        /* Centered Night Summary Label */
        .night-summary-container {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; pointer-events: none;
        }
        .night-summary-label { 
            color: var(--accent-warm); font-size: 0.65rem; font-weight: 700; 
            background: rgba(0,0,0,0.6); border: 1px solid rgba(251, 191, 36, 0.3); 
            padding: 2px 10px; border-radius: 15px;
        }

        .news-card.night-info { background: radial-gradient(circle at top left, #312e81, #1e1b4b); border-left: 4px solid #a855f7; alignItems: center; justify-content: center; text-align: center; padding-bottom: 35px; }
        .goodbye-card { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #334155 0%, #020617 100%); opacity: 0; visibility: hidden; transition: opacity 1s; z-index: 100; }
        .goodbye-card.active { opacity: 1; visibility: visible; }
        .gb-moon { font-size: 3rem; margin-bottom: 8px; filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.5)); animation: float 6s ease-in-out infinite; }
        .gb-title { font-family: var(--font-head); font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 4px; text-align: center; }
        
        /* BIG CLOCK */
        .big-clock-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        .big-clock-layer.active { opacity: 1; pointer-events: all; }
        .bc-time { font-family: var(--font-mono); font-size: 4.5rem; font-weight: 700; color: #fff; letter-spacing: -2px; animation: breathe 4s infinite ease-in-out; text-shadow: 0 0 20px rgba(56, 189, 248, 0.3); margin-bottom: 5px; font-variant-numeric: tabular-nums; }
        .bc-label { color: var(--accent-warm); font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; margin-top: 15px; font-weight: 600; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        
        /* --- CONTROLS BAR (SHARP) --- */
        .controls-bar { 
            position: absolute; 
            top: calc(100% - 28px); 
            left: 0; width: 100%;
            height: 28px; 
            border-top: 1px solid var(--panel-border); 
            background: #020617; /* Solid Black/Blue */
            font-size: 0.7rem; 
            z-index: 200; 
            overflow: hidden; 
            opacity: 0; 
            transition: height 0.6s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.5s ease;
            pointer-events: auto;
            cursor: pointer;
        }
        .ticker-container.open .controls-bar { opacity: 1; }

        /* ACTIVE STATE: Expands DOWN */
        .controls-bar.breaking-active {
            height: 60px; 
            background: #020617; 
            border-top: 1px solid #7f1d1d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8);
        }
        
        /* Normal Controls container */
        .controls-normal-content {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; height: 28px; padding: 0 10px;
            transition: opacity 0.3s;
            position: absolute; top: 0; left: 0;
            pointer-events: auto !important; 
            z-index: 101;
        }
        .controls-bar.breaking-active .controls-normal-content { opacity: 0; pointer-events: none !important; }

        /* INTRO LAYER */
        .bp-intro-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        
        /* VILLOG√ì FELIRAT ANIM√ÅCI√ì */
        .bp-intro-text {
            font-family: var(--font-head); font-weight: 900; font-size: 1.2rem;
            color: #fff; letter-spacing: 2px; text-transform: uppercase;
            animation: flashIntro 0.4s ease-in-out infinite;
        }
        @keyframes flashIntro {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
            50% { opacity: 0.2; text-shadow: none; color: #ef4444; }
        }

        /* NEWS LAYER */
        .bp-news-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; padding: 0 20px;
            opacity: 0; transition: opacity 0.5s;
        }
        
        .bp-badge {
            font-size: 0.6rem; font-weight: 800; color: #fff; background: #be123c;
            padding: 2px 6px; border-radius: 4px; text-transform: uppercase;
            margin-right: 15px; flex-shrink: 0;
        }
        
        .bp-meta {
            font-size: 0.75rem; font-family: var(--font-mono); color: #94a3b8; font-weight: 700;
            margin-right: 25px; flex-shrink: 0; white-space: nowrap;
        }
        
        .bp-text-scroller {
            flex-grow: 1; overflow: hidden; position: relative; height: 100%; display: flex; align-items: center;
            mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent);
        }
        
        #bp-text {
            font-family: var(--font-head); font-weight: 700; color: #fff; font-size: 1.05rem;
            white-space: nowrap; position: relative;
            will-change: transform; 
        }

        @keyframes scrollTextLeft {
            0% { transform: translateX(0); }
            100% { transform: translateX(var(--scroll-dist)); } 
        }

        .update-indicator { display: none; font-size: 0.65rem; font-weight: 700; color: var(--accent-warm); margin-right: 10px; animation: pulseText 1s infinite; }
        .update-indicator.active { display: block; }
        .next-prog-alert { display: none; align-items: center; gap: 5px; color: var(--accent-next); font-weight: 700; font-size: 0.65rem; text-transform: uppercase; background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding: 2px 8px; border-radius: 4px; }
        .next-prog-alert.active { display: flex; }
        
        .progress-line-container { position: absolute; bottom: 28px; /* Lift above controls */ left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); z-index: 6; }
        .progress-line { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-color), var(--accent-warm)); box-shadow: 0 0 8px var(--accent-color); }
        .animate-progress { animation: progressFill linear forwards; }
        @keyframes progressFill { from { width: 0%; } to { width: 100%; } }
        
        /* TIMELINE FIX: Added z-index and pointer-events */
        #timeline-container { display: none; flex-grow: 1; gap: 3px; overflow-x: auto; scrollbar-width: none; mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent); pointer-events: auto !important; z-index: 105; }
        #timeline-container.visible { display: flex; }
        
        .timeline-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #ccc; font-family: var(--font-mono); font-size: 0.65rem; padding: 1px 5px; border-radius: 3px; cursor: pointer; transition: all 0.2s; pointer-events: auto !important; }
        .timeline-btn:hover, .timeline-btn.active { background: var(--accent-warm); color: #000; font-weight:700; }
        
        .control-group { display: flex; gap: 8px; align-items: center; pointer-events: auto; z-index: 105; }
        .control-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; padding: 3px 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; pointer-events: auto !important; }
        .control-btn:hover { background: var(--accent-color); color: #000; }
        .control-btn svg { width: 12px; height: 12px; stroke: currentColor; stroke-width: 3; fill: none; }

        /* --- WEATHER & SCHEDULE FLIPPER --- */
        .weather-header-container { 
            height: 28px; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--glass-border); 
            display: flex; align-items: center; justify-content: center;
            padding: 0 55px 0 15px; 
            z-index: 10; width: 100%; position: absolute; top:0; left:0;
        }
        /* FIXED HEADER LAYOUT (Only Location Name) */
        .weather-location-header { 
            display: flex; justify-content: center; align-items: center; width: 100%; 
            font-weight: 700; color: var(--accent-color); transition: opacity 0.5s; 
            font-size: 0.8rem; text-transform: uppercase;
        }
        
        .weather-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 55px 10px 20px; }
        .weather-main { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
        .weather-main-left { display: flex; align-items: center; justify-content: center; width: 45%; }
        .weather-main-right { display: flex; flex-direction: column; align-items: flex-end; width: 55%; }
        .weather-temp-big { font-family: var(--font-head); font-size: 2.4rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); line-height: 1; }
        .weather-feels { font-size: 0.65rem; color: var(--accent-warm); text-transform: uppercase; margin-top: 2px; font-weight: 600; }
        .weather-icon-big svg { width: 56px; height: 56px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.4)); }
        .weather-details-list { padding: 5px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.7rem; display: flex; flex-direction: column; gap: 3px; margin-top: 5px; }
        .wd-row { display: flex; justify-content: space-between; color: #ccc; }
        .wd-val { color: #fff; font-weight: 600; }
        
        /* WEATHER FOOTER */
        .weather-footer-time {
            font-family: var(--font-mono); font-size: 0.7rem; color: #94a3b8; 
            text-align: center; margin-top: auto; padding-bottom: 5px; width: 100%; font-weight: 400;
        }

        /* --- SCHEDULE --- */
        .schedule-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 55px 5px 15px; justify-content: flex-start; }
        .schedule-list { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; justify-content: flex-start; }
        .schedule-item { display: flex; align-items: flex-start; gap: 8px; padding: 4px 8px; border-radius: 4px; border-left: 3px solid transparent; transition: background 0.3s, border-color 0.3s; }
        .schedule-item.active-highlight { background: rgba(56, 189, 248, 0.2); border-left-color: var(--accent-color); }
        .schedule-item.active-highlight .sch-name { color: #fff; font-weight: 700; }
        .schedule-item.active-highlight .sch-label { color: var(--accent-color); }
        .sch-time { font-family: var(--font-mono); font-size: 0.8rem; color: #fff; font-weight: 700; width: 45px; flex-shrink: 0; margin-top: 2px; }
        .sch-label { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 1px; transition: color 0.3s;}
        .sch-name { font-size: 0.8rem; color: #94a3b8; line-height: 1.2; white-space: normal; transition: color 0.3s; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* PROMO */
        .promo-content { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: linear-gradient(135deg, #1e1b4b, #312e81); text-align: center; padding-right: 60px; }
        .promo-main-block { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #e2e8f0; font-size: 0.9rem; font-weight: 600; }
        .promo-logo-inline { display: inline-flex; align-items: center; gap: 6px; margin: 4px 0; }
        .promo-logo-inline svg { width: 24px; height: 24px; fill: var(--accent-color); filter: drop-shadow(0 0 5px rgba(56,189,248,0.5)); }
        .promo-tkp { font-family: var(--font-head); font-weight: 900; color: #fff; font-size: 1.1rem; }
        .promo-24-wrapper { position: relative; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
        .promo-24-block { font-family: var(--font-head); font-size: 4rem; font-weight: 900; line-height: 1; color: #fff; background: linear-gradient(to bottom, #fff 40%, var(--accent-color) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 10px rgba(56,189,248,0.3)); }
        .promo-daynight-badge { position: absolute; right: -30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .promo-dn-icon { width: 20px; height: 20px; }
        .promo-dn-sun { fill: var(--accent-warm); filter: drop-shadow(0 0 5px rgba(251,191,36,0.6)); }
        .promo-dn-moon { fill: #38bdf8; filter: drop-shadow(0 0 5px rgba(56,189,248,0.6)); }
        .promo-dn-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .promo-sub { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-warm); font-weight: 700; }

        .loading-overlay { display: none; } 
        
        #dev-menu {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent-color);
            padding: 20px; border-radius: 12px; z-index: 9999;
            display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            color: #fff; font-family: var(--font-mono);
        }
        #dev-menu h3 { margin: 0 0 10px 0; color: var(--accent-warm); text-transform: uppercase; font-size: 0.9rem; }
        .dev-btn {
            background: rgba(56, 189, 248, 0.2); border: 1px solid var(--accent-color);
            color: #fff; padding: 8px; cursor: pointer; font-family: var(--font-body); font-weight: 600;
            transition: background 0.2s;
        }
        .dev-btn:hover { background: var(--accent-color); color: #000; }
        .dev-close { background: #dc2626; border-color: #ef4444; margin-top: 10px; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.95); opacity: 0.8; } }
        @keyframes pulseRed { 0%, 100% { background-color: var(--accent-danger); box-shadow: 0 0 5px var(--accent-danger); } 50% { background-color: #dc2626; box-shadow: 0 0 20px var(--accent-danger); } }
        .strobe-effect { animation: strobeAnim 1.5s ease-out forwards; }
        @keyframes strobeAnim { 0% { opacity: 0; transform: scale(1.1); filter: brightness(2); } 10% { opacity: 1; } 20% { opacity: 0; } 30% { opacity: 1; } 40% { opacity: 0; } 50% { opacity: 1; filter: brightness(1); transform: scale(1); } 100% { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes breathe { 0%{transform:scale(1);} 50%{transform:scale(1.02);} 100%{transform:scale(1);} }

        .manual-refresh { position: absolute; top: 5px; right: 5px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; cursor: pointer; opacity: 0; transition: opacity 0.3s; }
        .identity-panel:hover .manual-refresh { opacity: 0.5; }
    </style>
</head>
<body data-theme="night">

    <div class="ambient-background" id="sky-bg"></div>

    <!-- DEV MENU -->
    <div id="dev-menu">
        <h3>Fejleszt≈ëi Men√º</h3>
        <button class="dev-btn" onclick="window.triggerTestBreaking()">Teszt: R√∂vid H√≠r</button>
        <button class="dev-btn" onclick="window.triggerTestBreakingLong()">Teszt: Hossz√∫ H√≠r</button>
        <button class="dev-btn" onclick="window.location.reload()">√öjrat√∂lt√©s</button>
        <button class="dev-btn dev-close" onclick="window.closeDevMenu()">Bez√°r√°s</button>
    </div>

    <section class="ticker-container" id="ticker-container">
        
        <!-- PANEL 1: IDENTITY & ECONOMY (Flippable) -->
        <div class="glass-panel identity-panel" id="panel-left">
            <div class="panel-flipper" id="id-flipper">
                <!-- Front: ID -->
                <div class="panel-face">
                    <div class="id-content">
                        <div class="brand-wrapper" id="brand-click-area">
                            <div class="brand-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                            <div class="brand-name">TKP NEWS</div>
                        </div>
                        
                        <div class="clock-container">
                            <div class="clock-display-unified">
                                <span id="clock-hm" class="clock-hm">--:--</span>
                                <span id="clock-s" class="clock-s">:--</span>
                            </div>
                            <div id="date-display" class="date-display">...</div>
                        </div>
                        
                        <div class="footer-info">
                            <div id="nameday" class="nameday-badge"></div>
                        </div>
                        
                        <div class="manual-refresh" id="manual-refresh-trigger"></div>
                    </div>
                </div>
                <!-- Back: Credits & Economy -->
                <div class="panel-face back">
                    <div class="back-face-container">
                        <div class="credits-content" id="credits-content">
                            <div class="cr-container">
                                <div class="cr-logo-icon">‚ú¶</div>
                                <div class="cr-text-madeby">A H√çRCS√çK PANELT K√âSZ√çTETTE</div>
                                <div class="cr-name-main">ROBI</div>
                                <div class="cr-line"></div>
                                <div class="cr-bottom-text">
                                    <div>&copy; <span id="cr-year">2025</span> Copyright by: Robi</div>
                                    <div>Minden jog fenntartva!</div>
                                </div>
                            </div>
                        </div>
                        <div class="economy-content" id="economy-content">
                            <div class="eco-header">
                                <div class="brand-logo" style="transform: scale(0.6);"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                                <div class="eco-title">√ÅRFOLYAM</div>
                            </div>
                            <div class="eco-carousel">
                                <div class="eco-slide active" id="eco-slide-0">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/eu.png" class="eco-flag"> EUR</div><div class="eco-val" id="rate-eur">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/us.png" class="eco-flag"> USD</div><div class="eco-val" id="rate-usd">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ch.png" class="eco-flag"> CHF</div><div class="eco-val" id="rate-chf">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-1">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/gb.png" class="eco-flag"> GBP</div><div class="eco-val" id="rate-gbp">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/au.png" class="eco-flag"> AUD</div><div class="eco-val" id="rate-aud">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ca.png" class="eco-flag"> CAD</div><div class="eco-val" id="rate-cad">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-2">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/pl.png" class="eco-flag"> PLN</div><div class="eco-val" id="rate-pln">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/cz.png" class="eco-flag"> CZK</div><div class="eco-val" id="rate-czk">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ro.png" class="eco-flag"> RON</div><div class="eco-val" id="rate-ron">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-3">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/jp.png" class="eco-flag"> JPY</div><div class="eco-val" id="rate-jpy">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/cn.png" class="eco-flag"> CNY</div><div class="eco-val" id="rate-cny">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/tr.png" class="eco-flag"> TRY</div><div class="eco-val" id="rate-try">---.-- Ft</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL 2: NEWS CONTENT -->
        <div class="glass-panel news-panel" id="news-container">
            
            <div class="default-news-bg">
                <div class="dnb-gradient"></div>
                <div class="dnb-world-map"></div>
                <div class="dnb-watermark"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                <div class="dnb-text-strip"><span>NEWS</span><span>H√çREK</span><span>NACHRICHTEN</span><span>NOUVELLES</span></div>
            </div>

            <div class="loading-overlay" id="loading-overlay"></div>
            
            <div class="big-clock-layer" id="big-clock-layer">
                <div class="bc-time" id="bc-time-display">00:00:00</div>
                <div class="bc-label">K√ñVETKEZ≈ê H√çRCSOMAG BET√ñLT√âSE...</div>
            </div>

            <div class="goodbye-card" id="goodbye-card">
                <div class="gb-moon">üåô</div>
                <div class="gb-title">Nyugodalmas √©jszak√°t k√≠v√°n a</div>
                <div class="gb-brand-lockup">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    <div class="gb-brand-text">TKP NEWS</div>
                </div>
            </div>

            <div id="news-bg-image" class="news-image-overlay"><img id="bg-img-element" src="" alt=""></div>

            <div class="news-viewport" id="news-viewport">
                <div id="program-badge" class="program-badge">BET√ñLT√âS...</div>
                <div id="track-a" class="news-card"></div>
                <div id="track-b" class="news-card"></div>
            </div>

            <div class="progress-line-container"><div id="progress-bar" class="progress-line"></div></div>

            <!-- SIMPLIFIED CONTROLS BAR V141 (Solid & Sharp) -->
            <div class="controls-bar" id="controls-bar-main">
                <!-- Normal Content -->
                <div class="controls-normal-content" id="controls-normal">
                    <div id="timeline-container"></div>
                    <div id="update-indicator" class="update-indicator">FRISS√çT√âS...</div>
                    <div id="next-prog-alert" class="next-prog-alert"></div>
                    <div class="control-group">
                        <span id="counter-display" style="font-family:var(--font-mono); color:var(--text-muted); margin-right:5px; font-weight:700;">0/0</span>
                        <button class="control-btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        <button class="control-btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                    </div>
                </div>

                <!-- Breaking Content Layers -->
                <div class="bp-intro-layer" id="bp-intro-layer">
                    <span class="bp-intro-text">MOST √âRKEZETT</span>
                </div>

                <div class="bp-news-layer" id="bp-news-layer">
                    <div class="bp-badge">Most √ârkezett</div>
                    <div class="bp-meta">
                        <span id="bp-time">00:00</span> | <span id="bp-source">Forr√°s</span>
                    </div>
                    <div class="bp-text-scroller">
                        <span id="bp-text">H√≠r sz√∂vege...</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- PANEL 3: WEATHER / SCHEDULE / PROMO (Flippable) -->
        <div class="glass-panel weather-panel" id="panel-right">
            <div class="panel-flipper" id="weather-flipper">
                <div class="panel-face">
                     <div class="weather-header-container">
                        <div class="weather-location-header">
                            <span class="wlh-loc" id="weather-loc-name">NY√çREGYH√ÅZA</span>
                        </div>
                    </div>
                    <div class="weather-view">
                        <div class="weather-main">
                            <div class="weather-main-left">
                                <div class="weather-icon-big" id="weather-icon-slot"></div>
                            </div>
                            <div class="weather-main-right">
                                <div class="weather-temp-big" id="weather-temp">--¬∞</div>
                                <div class="weather-feels" id="weather-feels"></div>
                            </div>
                        </div>
                        <div class="weather-details-list">
                            <div class="wd-row"><span>P√°ra</span><span class="wd-val" id="wd-hum">--%</span></div>
                            <div class="wd-row"><span>Sz√©l</span><span class="wd-val" id="wd-wind">--</span></div>
                            <div class="wd-row"><span>Nyom√°s</span><span class="wd-val" id="wd-press">-- hPa</span></div>
                        </div>
                        <!-- Footer Time -->
                        <div class="weather-footer-time" id="weather-loc-time">Friss√≠tve: --:--:--</div>
                    </div>
                </div>
                <div class="panel-face back">
                    <div class="weather-header-container" id="schedule-header">
                        <div class="weather-location-header">M≈∞SORAJ√ÅNL√ì</div>
                    </div>
                    <div class="schedule-view" id="schedule-view">
                         <div class="schedule-list" id="schedule-list-content"></div>
                    </div>
                    <div class="promo-content" id="promo-view" style="display:none;">
                        <div class="promo-main-block">
                            <span>K√∂vesd a</span>
                            <div class="promo-logo-inline">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                <span class="promo-tkp">TKP NEWS</span>
                            </div>
                            <span>oldal√°t a nap</span>
                        </div>
                        <div class="promo-24-wrapper">
                            <div class="promo-24-block">24</div>
                            <div class="promo-daynight-badge">
                                <svg class="promo-dn-icon promo-dn-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path stroke="var(--accent-warm)" stroke-width="2" d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none"/></svg>
                                <div class="promo-dn-sep"></div>
                                <svg class="promo-dn-icon promo-dn-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="var(--accent-color)"/></svg>
                            </div>
                        </div>
                        <div class="promo-sub">√≥r√°j√°ban</div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        const WUNDERGROUND_API_KEY = "e1f10a1e78da46f5b10a1e78da96f525"; 
        const NYIREGYHAZA_COORDS = { lat: 47.95, lon: 21.71 };
        
        const AV_KEYS = ['4E5FW0E8H9BOEZS3', 'YP3VYIF03PGIM0ND', 'DHP4BBF68UVU0I3L'];
        
        const ICONS = {
            CLEAR: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`,
            CLEAR_NIGHT: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            CLOUDY: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
            CLOUDY_NIGHT: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><circle cx="18" cy="6" r="3" stroke="var(--accent-warm)" stroke-width="1.5" fill="none" /></svg>`,
            FOG: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5"><path d="M4 15h16M4 12h16M4 9h16M4 18h16"/></svg>`,
            RAIN: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`,
            SNOW: `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg>`,
            THUNDER: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`
        };

        const SKY_PHASES = {
            DEEP_NIGHT: { stops: ["#020617", "#0f172a", "#000000"] },
            ASTRO_DAWN: { stops: ["#0f172a", "#1e1b4b", "#172554"] },
            NAUTICAL_DAWN: { stops: ["#1e1b4b", "#312e81", "#4338ca"] },
            CIVIL_DAWN: { stops: ["#312e81", "#4f46e5", "#c026d3"] },
            SUNRISE:    { stops: ["#4f46e5", "#db2777", "#f59e0b"] },
            MORNING:    { stops: ["#0ea5e9", "#7dd3fc", "#bae6fd"] },
            NOON:       { stops: ["#0284c7", "#38bdf8", "#e0f2fe"] }
        };

        const PWS_MAP = { "ISRVR13": "S√°rv√°r", "IOSZK4": "Oszk√≥", "ISZNTD6": "Sz√°nt√≥d", "IBALAT149": "Balatonszemes", "IBUZSK1": "Csisztapuszta", "ISZEKS12": "Szeksz√°rd", "IJNOSH2": "J√°noshalma", "IPCS52": "P√©cs", "IPPRD1": "P√°pr√°d", "IKISKU42": "Kiskunhalas", "INEMES10": "Nemesn√°dudvar", "ISZEGE67": "Szeged", "IBKSCS12": "B√©k√©scsaba", "IFZESG2": "F√ºzesgyarmat", "IMIKEP2": "Mikep√©rcs", "ITGLS2": "T√©gl√°s", "IGACSL1": "Gacs√°ly", "IFLESD1": "F√ºlesd", "IKISSZ3": "Kisszekeres", "ILEVEL2": "Levelek", "IKEMEC2": "Kemecse", "INAGYC6": "Nagycserkesz", "ITISZA15": "Tiszavasv√°ri", "INEMES19": "Nemesbikk", "IEGERS22": "Egersz√≥l√°t", "IBKKSZ5": "B√ºkkszenterzs√©bet", "IPSZT1": "P√°szt√≥", "IPALOT13": "Palot√°s", "IGDLL37": "G√∂d√∂ll≈ë", "IZSMBK6": "Zs√°mb√©k", "ICSORN6": "Csorna", "IGAGYV1": "Gagyvend√©gi", "IMARTO122": "Martonyi", "IKAZIN14": "Kazincbarcika", "IPUTNO1": "Putnok", "IZABAR1": "Zabar", "ISALGT1": "Salg√≥tarj√°n", "IKARAN11": "Karancslapujt≈ë", "IBEKLC3": "Bek√∂lce", "IMTRAB1": "M√°traballa", "IVC267": "V√°c", "IPILIS37": "Pilisv√∂r√∂sv√°r", "IFELCS4": "Felcs√∫t", "IBUDAK6": "Budakeszi", "IBIATO9": "Biatorb√°gy", "ICSKVR4": "Cs√°kv√°r", "IOROSZ2": "Oroszl√°ny", "IBALINKA2": "Bakony", "ISR67": "S√∫r", "IPANNO3": "Pannonhalma", "IKAJRP2": "Kaj√°rp√©c", "IPPA11": "P√°pa", "ICELLD14": "Celld√∂m√∂lk", "IHEVES2": "Heves", "IGYNGY22": "Gy√∂ngy√∂s", "ISZCSN9": "Sz√©cs√©ny", "ITAHIT11": "Tahit√≥tfalu", "IESZTE5": "Esztergom", "ITATA16": "Tata", "IKARTAL4": "Kartal", "IMARTO67": "Martonv√°s√°r", "ISZOLNOK10": "Szolnok", "ISZOLN13": "Szolnok", "INAGYK59": "Nagyk≈ër√∂s", "IKECSK31": "Kecskem√©t", "IKALOCSA2": "Kalocsa", "IBONYH1": "Bonyh√°d", "ISZENT114": "Szentl≈ërinc", "ILJUBL47": "Ljubljana", "IBAKTA4": "Baktal√≥r√°nth√°za", "IJFEHR1": "√öjfeh√©rt√≥", "IPAPOS6": "Papos", "ISONKD1": "Sonk√°d", "INAPKO1": "Napkor", "IHARSN4": "Hars√°ny", "IBKKSZ2": "B√ºkkszentkereszt", "INYREG37": "Ny√≠regyh√°za", "IPUSZT3": "Pusztadobos", "ITISZA93": "Tisza√∫jv√°ros", "IEGER76": "Eger", "IHAJDD7": "Hajd√∫dorog", "IGYULA12": "Gyula", "IMAGYA4": "Magyarcsan√°d", "IHDMEZ21": "H√≥dmez≈ëv√°s√°rhely", "ISZEGE23": "Szeged-R√≥kus", "ICSENG9": "Csengele", "INAGYN1": "Nagyny√°r√°d", "IKIRLY1": "Kir√°lyegyh√°za", "ITAMSI1": "Tam√°si", "IZALAE45": "Zalaegerszeg", "IFARKA7": "Farkasgyep≈±", "INYRAC1": "Ny√≠racs√°d", "ISZAMO11": "Szamos√∫jlak", "IGVAVE1": "G√°vavencsell≈ë", "IEDELN2": "Edel√©ny", "INYRI1": "Ny√≠ri", "IBTTS1": "B√ºtt√∂s", "IZD2": "√ìzd" };
        
        const HUNGARIAN_CITIES_OM = [ { name: 'Debrecen', lat: 47.53, lon: 21.62 }, { name: 'Miskolc', lat: 48.10, lon: 20.78 }, { name: 'Szombathely', lat: 47.23, lon: 16.62 }, { name: 'Gy≈ër', lat: 47.68, lon: 17.63 }, { name: 'P√©cs', lat: 46.07, lon: 18.23 }, { name: 'Szeged', lat: 46.25, lon: 20.15 }, { name: 'Eger', lat: 47.90, lon: 20.37 }, { name: 'Veszpr√©m', lat: 47.09, lon: 17.91 }, { name: 'Zalaegerszeg', lat: 46.84, lon: 16.84 }, { name: 'B√©k√©scsaba', lat: 46.68, lon: 21.09 }, { name: 'Kaposv√°r', lat: 46.36, lon: 17.79 }, { name: 'Tatab√°nya', lat: 47.57, lon: 18.40 }, { name: 'Salg√≥tarj√°n', lat: 48.10, lon: 19.80 }, { name: 'Szeksz√°rd', lat: 46.35, lon: 18.70 }, { name: 'Sopron', lat: 47.68, lon: 16.58 }, { name: 'H√≥dmez≈ëv√°s√°rhely', lat: 46.43, lon: 20.32 }, { name: 'Nagykanizsa', lat: 46.45, lon: 16.99 }, { name: 'Duna√∫jv√°ros', lat: 46.96, lon: 18.93 }, { name: '√ârd', lat: 47.38, lon: 18.91 }, { name: 'Szolnok', lat: 47.18, lon: 20.20 }, { name: 'Kecskem√©t', lat: 46.88, lon: 19.64 }, { name: 'Baja', lat: 46.18, lon: 18.95 }, { name: 'Cegl√©d', lat: 47.17, lon: 19.80 }, { name: 'V√°c', lat: 47.78, lon: 19.13 }, { name: 'G√∂d√∂ll≈ë', lat: 47.60, lon: 19.35 }, { name: '√ìzd', lat: 48.22, lon: 20.29 }, { name: 'P√°pa', lat: 47.33, lon: 17.47 }, { name: 'Gyula', lat: 46.65, lon: 21.28 }, { name: 'Hajd√∫b√∂sz√∂rm√©ny', lat: 47.67, lon: 21.51 }, { name: 'Ny√≠regyh√°za', lat: 47.95, lon: 21.71 }, { name: 'Balatonf√ºred', lat: 46.96, lon: 17.89 }, { name: 'Keszthely', lat: 46.76, lon: 17.24 }, { name: 'Si√≥fok', lat: 46.90, lon: 18.05 }, { name: 'Kom√°rom', lat: 47.74, lon: 18.11 }, { name: 'Esztergom', lat: 47.79, lon: 18.74 }, { name: 'Tata', lat: 47.65, lon: 18.31 }, { name: 'Moh√°cs', lat: 45.99, lon: 18.68 }, { name: 'Paks', lat: 46.62, lon: 18.86 }, { name: 'Kalocsa', lat: 46.53, lon: 18.98 }, { name: 'Kiskunf√©legyh√°za', lat: 46.71, lon: 19.85 }, { name: 'J√°szber√©ny', lat: 47.50, lon: 19.91 }, { name: 'Hatvan', lat: 47.66, lon: 19.67 }, { name: 'Gy√∂ngy√∂s', lat: 47.78, lon: 19.93 }, { name: 'Kazincbarcika', lat: 48.25, lon: 20.62 }, { name: 'S√°toralja√∫jhely', lat: 48.40, lon: 21.65 }, { name: 'Kisv√°rda', lat: 48.22, lon: 22.08 }, { name: 'M√°t√©szalka', lat: 47.95, lon: 22.32 }, { name: 'Mak√≥', lat: 46.22, lon: 20.47 }, { name: 'Szentes', lat: 46.65, lon: 20.26 }, { name: 'Orosh√°za', lat: 46.57, lon: 20.66 }, { name: 'Karcag', lat: 47.31, lon: 20.93 }, { name: 'Hajd√∫szoboszl√≥', lat: 47.45, lon: 21.39 }, { name: 'T√∂r√∂kszentmikl√≥s', lat: 47.17, lon: 20.41 }, { name: 'Gy√°l', lat: 47.38, lon: 19.22 }, { name: 'Dunakeszi', lat: 47.64, lon: 19.14 }, { name: 'Buda√∂rs', lat: 47.46, lon: 18.96 }, { name: 'Szentendre', lat: 47.66, lon: 19.07 }, { name: 'Szigetszentmikl√≥s', lat: 47.34, lon: 19.05 }, { name: 'Mosonmagyar√≥v√°r', lat: 47.87, lon: 17.27 }, { name: 'Bicske', lat: 47.49, lon: 18.63 }, { name: 'Monor', lat: 47.35, lon: 19.45 }, { name: 'Mez≈ëk√∂vesd', lat: 47.81, lon: 20.57 }, { name: 'Tisza√∫jv√°ros', lat: 47.92, lon: 21.05 }, { name: 'S√°rospatak', lat: 48.32, lon: 21.57 } ];

        const FOREIGN_CITIES = [ { name: 'London', lat: 51.50, lon: -0.12 }, { name: 'New York', lat: 40.71, lon: -74.00 }, { name: 'Toki√≥', lat: 35.68, lon: 139.69 }, { name: 'Peking', lat: 39.90, lon: 116.40 }, { name: 'Moszkva', lat: 55.75, lon: 37.61 }, { name: 'Sydney', lat: -33.86, lon: 151.20 }, { name: 'P√°rizs', lat: 48.85, lon: 2.35 }, { name: 'Berlin', lat: 52.52, lon: 13.40 }, { name: 'R√≥ma', lat: 41.90, lon: 12.49 }, { name: 'Dubai', lat: 25.20, lon: 55.27 }, { name: 'Isztambul', lat: 41.00, lon: 28.97 }, { name: 'B√©cs', lat: 48.20, lon: 16.37 }, { name: 'Los Angeles', lat: 34.05, lon: -118.24 }, { name: 'Madrid', lat: 40.41, lon: -3.70 }, { name: 'Toronto', lat: 43.65, lon: -79.38 }, { name: 'Mumbai', lat: 19.07, lon: 72.87 }, { name: 'Szingap√∫r', lat: 1.35, lon: 103.81 }, { name: 'Kair√≥', lat: 30.04, lon: 31.23 }, { name: 'Rio de Janeiro', lat: -22.90, lon: -43.17 }, { name: 'Pr√°ga', lat: 50.07, lon: 14.43 }, { name: 'Amszterdam', lat: 52.36, lon: 4.90 }, { name: 'Barcelona', lat: 41.38, lon: 2.17 }, { name: 'Z√ºrich', lat: 47.37, lon: 8.54 }, { name: 'Vars√≥', lat: 52.22, lon: 21.01 }, { name: 'Bangkok', lat: 13.75, lon: 100.50 }, { name: 'Sz√∂ul', lat: 37.56, lon: 126.97 }, { name: 'Mexik√≥v√°ros', lat: 19.43, lon: -99.13 }, { name: 'Buenos Aires', lat: -34.60, lon: -58.38 }, { name: 'Jakarta', lat: -6.20, lon: 106.84 }, { name: 'Lima', lat: -12.04, lon: -77.04 }, { name: 'Fokv√°ros', lat: -33.92, lon: 18.42 }, { name: 'Helsinki', lat: 60.17, lon: 24.93 }, { name: 'Oslo', lat: 59.91, lon: 10.75 }, { name: 'Stockholm', lat: 59.32, lon: 18.06 }, { name: 'Koppenh√°ga', lat: 55.67, lon: 12.56 }, { name: 'Reykjavik', lat: 64.14, lon: -21.94 }, { name: 'Dublin', lat: 53.34, lon: -6.26 }, { name: 'Lisszabon', lat: 38.72, lon: -9.13 }, { name: 'Ath√©n', lat: 37.98, lon: 23.72 }, { name: 'Ankara', lat: 39.93, lon: 32.85 }, { name: 'Jeruzs√°lem', lat: 31.76, lon: 35.21 }, { name: '√öjdelhi', lat: 28.61, lon: 77.20 }, { name: 'Chicago', lat: 41.87, lon: -87.62 }, { name: 'San Francisco', lat: 37.77, lon: -122.41 }, { name: 'Vancouver', lat: 49.28, lon: -123.12 }, { name: 'Montreal', lat: 45.50, lon: -73.56 }, { name: 'Sao Paulo', lat: -23.55, lon: -46.63 }, { name: 'Santiago', lat: -33.44, lon: -70.66 }, { name: 'Bogota', lat: 4.71, lon: -74.07 }, { name: 'Casablanca', lat: 33.57, lon: -7.58 }, { name: 'Lagos', lat: 6.52, lon: 3.37 }, { name: 'Nairobi', lat: -1.29, lon: 36.82 }, { name: 'Rij√°d', lat: 24.71, lon: 46.67 }, { name: 'Teher√°n', lat: 35.68, lon: 51.38 }, { name: 'Karacsi', lat: 24.86, lon: 67.00 }, { name: 'Sanghaj', lat: 31.23, lon: 121.47 }, { name: 'Oszaka', lat: 34.69, lon: 135.50 }, { name: 'Manila', lat: 14.59, lon: 120.98 }, { name: 'Kuala Lumpur', lat: 3.13, lon: 101.68 }, { name: 'Hanoi', lat: 21.02, lon: 105.83 }, { name: 'Melbourne', lat: -37.81, lon: 144.96 }, { name: 'Auckland', lat: -36.84, lon: 174.76 }, { name: 'Br√ºsszel', lat: 50.85, lon: 4.35 }, { name: 'Genf', lat: 46.20, lon: 6.14 }, { name: 'M√ºnchen', lat: 48.13, lon: 11.58 }, { name: 'Mil√°n√≥', lat: 45.46, lon: 9.19 }, { name: 'N√°poly', lat: 40.85, lon: 14.26 }, { name: 'Velence', lat: 45.44, lon: 12.31 }, { name: 'Lyon', lat: 45.76, lon: 4.83 }, { name: 'Marseille', lat: 43.29, lon: 5.36 }, { name: 'Las Vegas', lat: 36.16, lon: -115.13 }, { name: 'Miami', lat: 25.76, lon: -80.19 }, { name: 'Boston', lat: 42.36, lon: -71.05 }, { name: 'Seattle', lat: 47.60, lon: -122.33 }, { name: 'Denver', lat: 39.73, lon: -104.99 }, { name: 'Havanna', lat: 23.11, lon: -82.36 }, { name: 'Panamav√°ros', lat: 8.98, lon: -79.51 }, { name: 'Caracas', lat: 10.48, lon: -66.90 }, { name: 'La Paz', lat: -16.50, lon: -68.11 }, { name: 'Kijev', lat: 50.45, lon: 30.52 }, { name: 'Minszk', lat: 53.90, lon: 27.56 }, { name: 'Bukarest', lat: 44.42, lon: 26.10 }, { name: 'Belgr√°d', lat: 44.78, lon: 20.44 }, { name: 'Z√°gr√°b', lat: 45.81, lon: 15.98 }, { name: 'Szlov√©nia', lat: 46.05, lon: 14.50 }, { name: 'Pozsony', lat: 48.14, lon: 17.10 }, { name: 'Krakk√≥', lat: 50.06, lon: 19.94 }, { name: 'Gdansk', lat: 54.35, lon: 18.64 }, { name: 'Hamburg', lat: 53.55, lon: 9.99 }, { name: 'Frankfurt', lat: 50.11, lon: 8.68 }, { name: 'K√∂ln', lat: 50.93, lon: 6.96 }, { name: 'Stuttgart', lat: 48.77, lon: 9.18 }, { name: 'Manchester', lat: 53.48, lon: -2.24 }, { name: 'Birmingham', lat: 52.48, lon: -1.89 }, { name: 'Glasgow', lat: 55.86, lon: -4.25 }, { name: 'Edinburgh', lat: 55.95, lon: -3.18 }, { name: 'Valencia', lat: 39.46, lon: -0.37 }, { name: 'Sevilla', lat: 37.38, lon: -5.98 }, { name: 'Porto', lat: 41.15, lon: -8.62 }, { name: 'Tel Aviv', lat: 32.08, lon: 34.78 }, { name: 'Doha', lat: 25.28, lon: 51.53 }, { name: 'Abu Dhabi', lat: 24.45, lon: 54.37 } ];

        const BACKUP_FEEDS = {
            "Telex": "https://telex.hu/rss", "Index": "https://index.hu/24ora/rss/", "24hu": "https://24.hu/feed/", "Origo": "https://www.origo.hu/contentpartner/rss/hir-cent/origo.xml",
            "HVG": "https://hvg.hu/rss", "444": "https://444.hu/feed", "Infostart": "https://infostart.hu/rss", "Portfolio": "https://www.portfolio.hu/rss/all.xml", "P√©nzcentrum": "https://www.penzcentrum.hu/rss/all.xml",
            "N√©pszava": "https://nepszava.hu/rss", "Magyar Nemzet": "https://magyarnemzet.hu/feed", "Mandiner": "https://mandiner.hu/feed", "Blikk": "https://www.blikk.hu/rss",
            "Hirado.hu": "https://hirado.hu/feed/", "ATV": "https://www.atv.hu/feed", "RTL": "https://rtl.hu/rss", "Economx": "https://economx.hu/rss", "Napi.hu": "https://www.napi.hu/rss",
            "Magyar H√≠rlap": "https://www.magyarhirlap.hu/rss", "Pesti Sr√°cok": "https://pestisracok.hu/feed/", "Nemzeti Sport": "https://www.nemzetisport.hu/feed", "M4 Sport": "https://m4sport.hu/feed",
            "H√≠r TV": "https://hirtv.hu/rss", "Priv√°tbank√°r": "https://www.privatbankar.hu/rss/all.xml"
        };

        const firebaseConfig = { apiKey: "AIzaSyDgBgiNSxjgWP_jmaoHpf0Qejo8_OO4sPg", authDomain: "robi-oldala.firebaseapp.com", databaseURL: "https://robi-oldala-default-rtdb.europe-west1.firebasedatabase.app", projectId: "robi-oldala", storageBucket: "robi-oldala.appspot.com", messagingSenderId: "300815778397", appId: "1:300815778397:web:ec609be55cc8afd193c3b4" };
        const CORS_PROXIES = ["https://api.allorigins.win/raw?url=", "https://cors.eu.org/", "https://thingproxy.freeboard.io/fetch/"];
        
        const THEMATIC_BLOCKS = [
            { start: 0,    name: '√âjszakai m≈±szak', type: 'summary_yesterday', refreshMinutes: 30, styleClass: 'badge-night' },
            { start: 6,    name: 'Napind√≠t√≥',       type: 'morning_catchup', timeWindowHours: 0, refreshMinutes: 15, styleClass: 'badge-dawn' },
            { start: 7,    name: 'Reggeli gyors',   type: 'fresh', timeWindowHours: 2, refreshMinutes: 10, styleClass: 'badge-morning' },
            { start: 9,    name: 'D√©lel≈ëtt a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-day' },
            { start: 12,   name: 'D√©lid≈ëben',       type: 'fresh', timeWindowHours: 2, refreshMinutes: 15, styleClass: 'badge-noon' },
            { start: 14,   name: 'D√©lut√°n a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-afternoon' },
            { start: 18,   name: 'Esti gyors',      type: 'fresh', timeWindowHours: 2, refreshMinutes: 10, styleClass: 'badge-sunset' },
            { start: 20,   name: 'Este a TKP NEWS-al',    type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-evening' },
            { start: 22,   name: 'K√©s≈ë este a TKP NEWS-al', type: 'fresh', timeWindowHours: 4, refreshMinutes: 20, styleClass: 'badge-night' },
            { start: 23.98,name: 'Elk√∂sz√∂n√©s',      type: 'goodbye', styleClass: 'badge-night' }
        ];

        const CALENDAR_DATA = { honapok: ["janu√°r", "febru√°r", "m√°rcius", "√°prilis", "m√°jus", "j√∫nius", "j√∫lius", "augusztus", "szeptember", "okt√≥ber", "november", "december"], napok: ["vas√°rnap", "h√©tf≈ë", "kedd", "szerda", "cs√ºt√∂rt√∂k", "p√©ntek", "szombat"], nameDays: { "01-01": ["Fruzsina"], "01-02": ["√Åbel"], "01-03": ["Benj√°min"], "01-04": ["Titusz"], "01-05": ["Simon"], "01-06": ["Boldizs√°r"], "01-07": ["Attila", "Ram√≥na"], "01-08": ["Gy√∂ngyv√©r"], "01-09": ["Marcell"], "01-10": ["Mel√°nia"], "01-11": ["√Ågota"], "01-12": ["Ern≈ë"], "01-13": ["Veronika"], "01-14": ["B√≥dog"], "01-15": ["L√≥r√°nd", "L√≥r√°nt"], "01-16": ["Guszt√°v"], "01-17": ["Antal", "Ant√≥nia"], "01-18": ["Piroska"], "01-19": ["M√°ri√≥", "S√°ra"], "01-20": ["F√°bi√°n", "Sebesty√©n"], "01-21": ["√Ågnes"], "01-22": ["Art√∫r", "Vince"], "01-23": ["Rajmund", "Zelma"], "01-24": ["Tim√≥t"], "01-25": ["P√°l"], "01-26": ["Paula", "Vanda"], "01-27": ["Angelika"], "01-28": ["Karola", "K√°roly"], "01-29": ["Ad√©l"], "01-30": ["Martina"], "01-31": ["Gerda", "Marcella"], "02-01": ["Ign√°c"], "02-02": ["Aida", "Karolina"], "02-03": ["Bal√°zs"], "02-04": ["Csenge", "R√°hel"], "02-05": ["√Ågota", "Ingrid"], "02-06": ["D√≥ra", "Dorottya"], "02-07": ["R√≥me√≥", "T√≥dor"], "02-08": ["Aranka"], "02-09": ["Abig√©l", "Alex"], "02-10": ["Elvira"], "02-11": ["Bertold", "Marietta"], "02-12": ["L√≠dia", "L√≠via"], "02-13": ["Ella", "Linda"], "02-14": ["B√°lint", "Valentin"], "02-15": ["Georgina", "Kolos"], "02-16": ["Julianna", "Lilla"], "02-17": ["Don√°t"], "02-18": ["Bernadett"], "02-19": ["Zsuzsanna"], "02-20": ["Alad√°r", "√Ålmos"], "02-21": ["Eleon√≥ra"], "02-22": ["Gerzson"], "02-23": ["Alfr√©d"], "02-24": ["M√°ty√°s"], "02-25": ["G√©za"], "02-26": ["Edina"], "02-27": ["√Åkos", "B√°tor"], "02-28": ["Elem√©r"], "02-29": ["Sz√∂k≈ënap"], "03-01": ["Albin"], "03-02": ["Lujza"], "03-03": ["Korn√©lia"], "03-04": ["K√°zm√©r"], "03-05": ["Adorj√°n", "Adri√°n"], "03-06": ["Inez", "Leon√≥ra"], "03-07": ["Tam√°s"], "03-08": ["Zolt√°n"], "03-09": ["Fanni", "Franciska"], "03-10": ["Ildik√≥"], "03-11": ["Szil√°rd"], "03-12": ["Gergely"], "03-13": ["Ajtony", "Kriszti√°n"], "03-14": ["Matild"], "03-15": ["Krist√≥f"], "03-16": ["Henrietta"], "03-17": ["Gertr√∫d", "Patrik"], "03-18": ["Ede", "S√°ndor"], "03-19": ["B√°nk", "J√≥zsef"], "03-20": ["Klaudia"], "03-21": ["Benedek"], "03-22": ["Be√°ta", "Izolda"], "03-23": ["Em≈ëke"], "03-24": ["G√°bor", "Karina"], "03-25": ["Ir√©n", "√çrisz"], "03-26": ["Em√°nuel"], "03-27": ["Hajnalka"], "03-28": ["Gedeon", "Johanna"], "03-29": ["Auguszta"], "03-30": ["Zal√°n"], "03-31": ["√Årp√°d"], "04-01": ["Hug√≥"], "04-02": ["√Åron"], "04-03": ["Buda", "Rich√°rd"], "04-04": ["Izidor"], "04-05": ["Vince"], "04-06": ["B√≠borka", "Vilmos"], "04-07": ["Herman"], "04-08": ["D√©nes"], "04-09": ["Erhard"], "04-10": ["Zsolt"], "04-11": ["Le√≥", "Szaniszl√≥"], "04-12": ["Gyula"], "04-13": ["Ida"], "04-14": ["Tibor"], "04-15": ["Anaszt√°zia", "Tas"], "04-16": ["Csongor"], "04-17": ["Rudolf"], "04-18": ["Andrea", "Ilma"], "04-19": ["Emma"], "04-20": ["Tivadar"], "04-21": ["Konr√°d"], "04-22": ["Csilla", "No√©mi"], "04-23": ["B√©la"], "04-24": ["Gy√∂rgy"], "04-25": ["M√°rk"], "04-26": ["Ervin"], "04-27": ["Zita"], "04-28": ["Val√©ria"], "04-29": ["P√©ter"], "04-30": ["Katalin", "Kitti"], "05-01": ["F√ºl√∂p", "Jakab"], "05-02": ["Zsigmond"], "05-03": ["Irma", "T√≠mea"], "05-04": ["Fl√≥ri√°n", "M√≥nika"], "05-05": ["Adri√°n", "Gy√∂rgyi"], "05-06": ["Frida", "Ivett"], "05-07": ["Gizella"], "05-08": ["Mih√°ly"], "05-09": ["Gergely"], "05-10": ["√Årmin", "P√°lma"], "05-11": ["Ferenc"], "05-12": ["Pongr√°c"], "05-13": ["Imola", "Szerv√°c"], "05-14": ["Bonif√°c"], "05-15": ["Szonja", "Zs√≥fia"], "05-16": ["Botond", "M√≥zes"], "05-17": ["Paszk√°l"], "05-18": ["Alexandra", "Erik"], "05-19": ["Iv√≥", "Mil√°n"], "05-20": ["Bern√°t", "Fel√≠cia"], "05-21": ["Konstantin"], "05-22": ["J√∫lia", "Rita"], "05-23": ["Dezs≈ë"], "05-24": ["Eliza", "Eszter"], "05-25": ["Orb√°n"], "05-26": ["Evelin", "F√ºl√∂p"], "05-27": ["Hella"], "05-28": ["Csan√°d", "Emil"], "05-29": ["Magdolna"], "05-30": ["Janka", "Zsanett"], "05-31": ["Ang√©la"], "06-01": ["T√ºnde"], "06-02": ["Anita", "K√°rmen"], "06-03": ["Klotild"], "06-04": ["Bulcs√∫"], "06-05": ["Fatime"], "06-06": ["Cintia", "Norbert"], "06-07": ["R√≥bert"], "06-08": ["Med√°rd"], "06-09": ["F√©lix"], "06-10": ["Gr√©ta", "Margit"], "06-11": ["Barnab√°s"], "06-12": ["Vill≈ë"], "06-13": ["Anett", "Antal"], "06-14": ["Vazul"], "06-15": ["Jol√°n", "Vid"], "06-16": ["Jusztin"], "06-17": ["Alida", "Laura"], "06-18": ["Arnold", "Levente"], "06-19": ["Gy√°rf√°s"], "06-20": ["Rafael"], "06-21": ["Alajos", "Leila"], "06-22": ["Paulina"], "06-23": ["Zolt√°n"], "06-24": ["Iv√°n"], "06-25": ["Vilmos"], "06-26": ["J√°nos", "P√°l"], "06-27": ["L√°szl√≥"], "06-28": ["Ir√©n", "Levente"], "06-29": ["P√©ter", "P√°l"], "06-30": ["P√°l"], "07-01": ["Annam√°ria", "Tiham√©r"], "07-02": ["Ott√≥"], "07-03": ["Korn√©l", "Soma"], "07-04": ["Ulrik"], "07-05": ["Emese", "Sarolta"], "07-06": ["Csaba"], "07-07": ["Apoll√≥nia"], "07-08": ["Ell√°k"], "07-09": ["Lukr√©cia"], "07-10": ["Am√°lia"], "07-11": ["Lili", "N√≥ra"], "07-12": ["Dalma", "Izabella"], "07-13": ["Jen≈ë"], "07-14": ["√ñrs", "Stella"], "07-15": ["Henrik", "Roland"], "07-16": ["Valter"], "07-17": ["Elek", "Endre"], "07-18": ["Frigyes"], "07-19": ["Em√≠lia"], "07-20": ["Ill√©s"], "07-21": ["D√°niel", "Daniella"], "07-22": ["Magdolna"], "07-23": ["Lenke"], "07-24": ["Kincs≈ë", "Kinga"], "07-25": ["Jakab", "Krist√≥f"], "07-26": ["Anik√≥", "Anna"], "07-27": ["Lili√°na", "Olga"], "07-28": ["Szabolcs"], "07-29": ["Fl√≥ra", "M√°rta"], "07-30": ["Judit", "X√©nia"], "07-31": ["Oszk√°r"], "08-01": ["Bogl√°rka"], "08-02": ["Lehel"], "08-03": ["Hermina"], "08-04": ["Dominika", "Dominik", "Domonkos"], "08-05": ["Krisztina"], "08-06": ["Berta", "Bettina"], "08-07": ["Ibolya"], "08-08": ["L√°szl√≥"], "08-09": ["Em≈ëd"], "08-10": ["L≈ërinc"], "08-11": ["Tiborc", "Zsuzsanna"], "08-12": ["Kl√°ra"], "08-13": ["Ipoly"], "08-14": ["Marcell"], "08-15": ["M√°ria"], "08-16": ["√Åbrah√°m"], "08-17": ["J√°cint"], "08-18": ["Ilona"], "08-19": ["Huba"], "08-20": ["Istv√°n"], "08-21": ["Hajna", "S√°muel"], "08-22": ["Menyh√©rt", "Mirjam"], "08-23": ["Bence"], "08-24": ["Bertalan"], "08-25": ["Lajos", "Patr√≠cia"], "08-26": ["Izs√≥"], "08-27": ["G√°sp√°r"], "08-28": ["√Ågoston"], "08-29": ["Beatrix", "Erna"], "08-30": ["R√≥zsa"], "08-31": ["Bella", "Erika"], "09-01": ["Egon", "Egyed"], "09-02": ["Dorina", "Rebeka"], "09-03": ["Hilda"], "09-04": ["Roz√°lia"], "09-05": ["L≈ërinc", "Viktor"], "09-06": ["Zakari√°s"], "09-07": ["Regina"], "09-08": ["Adrienn", "M√°ria"], "09-09": ["√Åd√°m"], "09-10": ["Hunor", "Nikolett"], "09-11": ["Teod√≥ra"], "09-12": ["M√°ria"], "09-13": ["Korn√©l"], "09-14": ["Rox√°na", "Szer√©na"], "09-15": ["Enik≈ë", "Melitta"], "09-16": ["Edit"], "09-17": ["Zs√≥fia"], "09-18": ["Di√°na"], "09-19": ["Vilhelmina"], "09-20": ["Friderika"], "09-21": ["M√°t√©", "Mirella"], "09-22": ["M√≥ric"], "09-23": ["Tekla"], "09-24": ["Gell√©rt", "Merc√©desz"], "09-25": ["Eufrozina", "Kende"], "09-26": ["Jusztina", "P√°l"], "09-27": ["Adalbert"], "09-28": ["Vencel"], "09-29": ["Mih√°ly"], "09-30": ["Jeromos"], "10-01": ["Malvin"], "10-02": ["Petra"], "10-03": ["Helga"], "10-04": ["Ferenc"], "10-05": ["Aur√©l"], "10-06": ["Br√∫n√≥", "Ren√°ta"], "10-07": ["Am√°lia"], "10-08": ["Kopp√°ny"], "10-09": ["D√©nes"], "10-10": ["Gedeon"], "10-11": ["Brigitta"], "10-12": ["Miksa"], "10-13": ["Ede", "K√°lm√°n"], "10-14": ["Hel√©n"], "10-15": ["Ter√©z"], "10-16": ["G√°l"], "10-17": ["Hedvig"], "10-18": ["Luk√°cs"], "10-19": ["N√°ndor"], "10-20": ["Vendel"], "10-21": ["Orsolya"], "10-22": ["El≈ëd"], "10-23": ["Gy√∂ngyi"], "10-24": ["Salamon"], "10-25": ["Bianka", "Blanka"], "10-26": ["D√∂m√∂t√∂r"], "10-27": ["Szabina"], "10-28": ["Simon", "Szimonetta"], "10-29": ["N√°rcisz"], "10-30": ["Alfonz"], "10-31": ["Farkas"], "11-01": ["Marianna"], "11-02": ["Achilles"], "11-03": ["Gy≈ëz≈ë"], "11-04": ["K√°roly"], "11-05": ["Imre"], "11-06": ["L√©n√°rd"], "11-07": ["Rezs≈ë"], "11-08": ["Zsombor"], "11-09": ["Tivadar"], "11-10": ["R√©ka"], "11-11": ["M√°rton"], "11-12": ["J√≥n√°s", "Ren√°t√≥"], "11-13": ["Szilvia"], "11-14": ["Aliz"], "11-15": ["Albert", "Lip√≥t"], "11-16": ["√ñd√∂n"], "11-17": ["Gergely", "Hortenzia"], "11-18": ["Jen≈ë"], "11-19": ["Erzs√©bet", "Elizabet"], "11-20": ["Jol√°n"], "11-21": ["Oliv√©r"], "11-22": ["Cec√≠lia"], "11-23": ["Kelemen", "Klementina"], "11-24": ["Emma"], "11-25": ["Katalin"], "11-26": ["Vir√°g"], "11-27": ["Virgil"], "11-28": ["Stef√°nia"], "11-29": ["Taksony"], "11-30": ["Andor", "Andr√°s"], "12-01": ["Elza"], "12-02": ["Melinda", "Vivien"], "12-03": ["Ferenc", "Ol√≠via"], "12-04": ["Barbara", "Borb√°la"], "12-05": ["Vilma"], "12-06": ["Mikl√≥s"], "12-07": ["Ambrus"], "12-08": ["M√°ria"], "12-09": ["Nat√°lia"], "12-10": ["Judit"], "12-12": ["Gabriella"], "12-13": ["Luca", "Ot√≠lia"], "12-14": ["Szil√°rda"], "12-15": ["Val√©r"], "12-16": ["Aletta", "Etelka"], "12-17": ["L√°z√°r", "Olimpia"], "12-18": ["Auguszta"], "12-19": ["Viola"], "12-20": ["Teofil"], "12-21": ["Tam√°s"], "12-22": ["Z√©n√≥"], "12-23": ["Vikt√≥ria"], "12-24": ["√Åd√°m", "√âva"], "12-25": ["Eug√©nia"], "12-26": ["Istv√°n"], "12-27": ["J√°nos"], "12-28": ["Kamilla"], "12-29": ["Tamara", "Tam√°s"], "12-30": ["D√°vid"], "12-31": ["Szilveszter"] } };

        // --- STATE & DOM ---
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const feedsRef = ref(database, 'feeds');
        
        const el = {
            clockHm: document.getElementById('clock-hm'),
            clockS: document.getElementById('clock-s'),
            date: document.getElementById('date-display'),
            nameday: document.getElementById('nameday'),
            trackA: document.getElementById('track-a'),
            trackB: document.getElementById('track-b'),
            progressBar: document.getElementById('progress-bar'),
            loading: document.getElementById('loading-overlay'),
            counter: document.getElementById('counter-display'),
            newsBg: document.getElementById('news-bg-image'),
            bgImg: document.getElementById('bg-img-element'),
            weatherLocName: document.getElementById('weather-loc-name'),
            weatherLocTime: document.getElementById('weather-loc-time'),
            weatherTemp: document.getElementById('weather-temp'),
            weatherFeels: document.getElementById('weather-feels'),
            weatherIcon: document.getElementById('weather-icon-slot'),
            wdHum: document.getElementById('wd-hum'),
            wdWind: document.getElementById('wd-wind'),
            wdPress: document.getElementById('wd-press'),
            weatherView: document.getElementById('weather-view'),
            scheduleView: document.getElementById('schedule-view'),
            scheduleList: document.getElementById('schedule-list-content'),
            promoView: document.getElementById('promo-view'),
            timelineContainer: document.getElementById('timeline-container'),
            newsContainer: document.getElementById('news-container'),
            newsViewport: document.getElementById('news-viewport'),
            badge: document.getElementById('program-badge'),
            sky: document.getElementById('sky-bg'),
            weatherHeader: document.querySelector('.weather-location-header'),
            idFlipper: document.getElementById('id-flipper'),
            weatherFlipper: document.getElementById('weather-flipper'),
            goodbyeCard: document.getElementById('goodbye-card'),
            bigClockLayer: document.getElementById('big-clock-layer'),
            bcTime: document.getElementById('bc-time-display'),
            nextProgAlert: document.getElementById('next-prog-alert'),
            crYear: document.getElementById('cr-year'),
            updateIndicator: document.getElementById('update-indicator'),
            creditsContent: document.getElementById('credits-content'),
            economyContent: document.getElementById('economy-content'),
            controlsBar: document.getElementById('controls-bar-main'),
            
            // Breaking System
            controlsContent: document.getElementById('controls-normal'),
            bpIntroLayer: document.getElementById('bp-intro-layer'),
            bpNewsLayer: document.getElementById('bp-news-layer'),
            bpTime: document.getElementById('bp-time'),
            bpSource: document.getElementById('bp-source'),
            bpText: document.getElementById('bp-text'),
            bpTextScroller: document.querySelector('.bp-text-scroller'),
            
            mainContainer: document.querySelector('.ticker-container'),
            leftPanel: document.querySelector('.identity-panel'),
            rightPanel: document.querySelector('.weather-panel'),
            middlePanel: document.querySelector('.news-panel'),

            // Dev Menu
            devMenu: document.getElementById('dev-menu')
        };

        let state = {
            activeTrack: 'a',
            items: [],
            currentIndex: 0,
            block: null,
            rssFeeds: {},
            pwsData: [],
            weatherIndex: 0,
            flipTimer: null,
            loading: false,
            scheduleActive: false,
            lastScheduleMin: -1,
            currentItem: null,
            scheduleHighlightIndex: 0,
            scheduleInterval: null,
            nextItems: [],
            weatherPlaylist: [],
            weatherPlaylistIndex: 0,
            isPaused: false,
            cardStartTime: 0,
            currentDuration: 18000,
            remainingTime: 0,
            seenBreakingLinks: new Set(),
            lastBreakingCheckTime: Date.now(),
            lastNightInfoTime: 0,
            retryQueue: [], 
            retryInterval: null,
            retryCount: 0, 
            economyVisible: false,
            economyRates: { EUR: null, USD: null, CHF: null, GBP: null, AUD: null, CAD: null, PLN: null, CZK: null, RON: null, JPY: null, CNY: null, TRY: null },
            economyKeyIndex: 0,
            economyCarouselInterval: null,
            economySlideIndex: 0,
            pendingListReset: false,
            isTransitioning: false,
            lastRefreshTimestamp: Date.now(),
            breakingActive: false,
            breakingLink: null
        };

        // --- UTILITIES ---
        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        
        async function fetchWithProxyFallback(url) {
            for (const proxy of CORS_PROXIES) {
                try {
                    const res = await fetch(proxy + url, { signal: AbortSignal.timeout(4000) });
                    if(res.ok) return res;
                } catch(e){}
            }
            throw new Error('All proxies failed for ' + url);
        }

        function extractImageUrl(item, descHtml) {
            const media = item.querySelector("content, media\\:content");
            if(media && media.getAttribute('url')) return media.getAttribute('url');
            const enclosure = item.querySelector("enclosure");
            if(enclosure && enclosure.getAttribute('type')?.startsWith('image')) return enclosure.getAttribute('url');
            const match = descHtml.match(/src="([^"]+)"/);
            return match ? match[1] : null;
        }

        function getFavicon(url) {
            try { const domain = new URL(url).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`; } catch(e) { return ''; }
        }

        function getSourceName(link) {
            try {
                const url = new URL(link);
                const host = url.hostname.replace('www.', '').toLowerCase();
                const map = { 'telex.hu': 'TELEX', 'index.hu': 'INDEX', '24.hu': '24.HU', 'origo.hu': 'ORIGO', 'hirado.hu':'HIRADO', 'rtl.hu':'RTL', 'atv.hu':'ATV' };
                if(map[host]) return map[host];
                return host.split('.')[0].toUpperCase();
            } catch(e) { return "H√çR"; }
        }

        // --- FLIP CONTROLLER ---
        function flipPanel(panelType, showBack) {
            const flipper = panelType === 'identity' ? el.idFlipper : el.weatherFlipper;
            if(showBack) flipper.classList.add('flipped');
            else flipper.classList.remove('flipped');
        }

        // --- CREDITS & ECONOMY LOGIC ---
        function showCredits() {
            if(state.economyVisible) return; 
            el.creditsContent.classList.add('active');
            el.economyContent.classList.remove('active');
            flipPanel('identity', true);
            setTimeout(() => { flipPanel('identity', false); }, 10000);
        }

        function showEconomy() {
            state.economyVisible = true;
            el.creditsContent.classList.remove('active');
            el.economyContent.classList.add('active');
            state.economySlideIndex = 0;
            updateEconomySlide();
            state.economyCarouselInterval = setInterval(() => {
                state.economySlideIndex = (state.economySlideIndex + 1) % 4;
                updateEconomySlide();
            }, 8000); 
            flipPanel('identity', true);
            setTimeout(() => { 
                flipPanel('identity', false); 
                state.economyVisible = false;
                clearInterval(state.economyCarouselInterval);
            }, 32000); 
        }

        function updateEconomySlide() {
            document.querySelectorAll('.eco-slide').forEach((slide, idx) => {
                if(idx === state.economySlideIndex) slide.classList.add('active');
                else slide.classList.remove('active');
            });
        }

        async function fetchExchangeRates() {
            const currencies = ['EUR', 'USD', 'CHF', 'GBP', 'AUD', 'CAD', 'PLN', 'CZK', 'RON', 'JPY', 'CNY', 'TRY'];
            for (let i = 0; i < currencies.length; i++) {
                const curr = currencies[i];
                let success = false;
                let attempts = 0;
                while(!success && attempts < AV_KEYS.length) {
                    const apiKey = AV_KEYS[state.economyKeyIndex];
                    try {
                        const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${curr}&to_currency=HUF&apikey=${apiKey}`;
                        const res = await fetch(url, { signal: AbortSignal.timeout(3000) });
                        const data = await res.json();
                        if(data["Realtime Currency Exchange Rate"]) {
                            const rate = parseFloat(data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]).toFixed(2);
                            state.economyRates[curr] = rate;
                            const elId = `rate-${curr.toLowerCase()}`;
                            const element = document.getElementById(elId);
                            if(element) element.textContent = `${rate} Ft`;
                            success = true;
                        } else if (data["Note"] || data["Error Message"]) {
                            state.economyKeyIndex = (state.economyKeyIndex + 1) % AV_KEYS.length;
                            attempts++;
                        }
                    } catch(e) { attempts++; }
                }
            }
        }

        // --- SOLAR ENGINE ---
        function updateSkyGradient() {
            const now = new Date();
            const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
            const altitudeDeg = sunPos.altitude * (180 / Math.PI);
            let stops = SKY_PHASES.DEEP_NIGHT.stops;
            if (altitudeDeg < -18) stops = SKY_PHASES.DEEP_NIGHT.stops;
            else if (altitudeDeg < -12) stops = SKY_PHASES.ASTRO_DAWN.stops;
            else if (altitudeDeg < -6) stops = SKY_PHASES.NAUTICAL_DAWN.stops;
            else if (altitudeDeg < 0) stops = SKY_PHASES.CIVIL_DAWN.stops;
            else if (altitudeDeg < 6) stops = SKY_PHASES.SUNRISE.stops;
            else if (altitudeDeg < 25) stops = SKY_PHASES.MORNING.stops;
            else stops = SKY_PHASES.NOON.stops;
            el.sky.style.background = `linear-gradient(135deg, ${stops[0]}, ${stops[1]}, ${stops[2]})`;
        }

        // --- WEATHER ---
        function calculateFeelsLike(temp, hum, wind) {
            if (temp <= 10 && wind > 4.8) { return 13.12 + 0.6215 * temp - 11.37 * Math.pow(wind, 0.16) + 0.3965 * temp * Math.pow(wind, 0.16); }
            else if (temp >= 27 && hum >= 40) { return temp - 0.55 * (1 - (hum / 100)) * (temp - 14); }
            return temp; 
        }

        function getWindDirStr(deg) {
            if (deg === undefined || deg === null) return "";
            const sectors = ["√âSZAKI", "√âSZAKKELETI", "KELETI", "D√âLKELETI", "D√âLI", "D√âLNYUGATI", "NYUGATI", "√âSZAKNYUGATI"];
            deg += 22.5; if (deg < 0) deg += 360; deg = deg % 360;
            return sectors[Math.floor(deg / 45)];
        }

        function getIconFromIBMCode(code) {
            const c = parseInt(code);
            if ([31, 33].includes(c)) return ICONS.CLEAR_NIGHT; 
            if ([32, 34].includes(c)) return ICONS.CLEAR; 
            if ([26, 27, 28].includes(c)) return ICONS.CLOUDY; 
            if ([29].includes(c)) return ICONS.CLOUDY_NIGHT; 
            if ([30].includes(c)) return ICONS.CLOUDY; 
            if ([20, 21, 22, 19].includes(c)) return ICONS.FOG;
            if ([11, 12, 39, 40, 45, 9, 10].includes(c)) return ICONS.RAIN;
            if ([13, 14, 15, 16, 41, 42, 43, 46].includes(c)) return ICONS.SNOW;
            if ([3, 4, 17, 35, 37, 38, 47].includes(c)) return ICONS.THUNDER;
            return ICONS.CLOUDY; 
        }

        function getIconFromWMO(code, isNight) {
            if(isNight) {
                if(code === 0) return ICONS.CLEAR_NIGHT;
                if(code >= 1 && code <= 3) return ICONS.CLOUDY_NIGHT; 
                if(code === 45 || code === 48) return ICONS.FOG;
                if(code >= 51 && code <= 67) return ICONS.RAIN;
                if(code >= 80 && code <= 82) return ICONS.RAIN;
                if(code >= 71 && code <= 77) return ICONS.SNOW;
                if(code >= 95) return ICONS.THUNDER;
                return ICONS.CLOUDY_NIGHT;
            }
            if(code === 0) return ICONS.CLEAR;
            if(code >= 1 && code <= 3) return ICONS.CLOUDY;
            if(code === 45 || code === 48) return ICONS.FOG;
            if(code >= 51 && code <= 67) return ICONS.RAIN;
            if(code >= 80 && code <= 82) return ICONS.RAIN;
            if(code >= 71 && code <= 77) return ICONS.SNOW;
            if(code >= 95) return ICONS.THUNDER;
            return ICONS.CLOUDY;
        }

        async function fetchWeatherData() {
            const stationKeys = Object.keys(PWS_MAP).sort(() => 0.5 - Math.random()).slice(0, 10);
            const fetchPWS = async (id) => {
                try {
                    const url = `https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${WUNDERGROUND_API_KEY}&numericPrecision=decimal`;
                    const res = await fetch(url, { signal: AbortSignal.timeout(3000) }); 
                    if(!res.ok) return null;
                    const data = await res.json();
                    if(data.observations && data.observations.length > 0) {
                        const obs = data.observations[0];
                        if(obs.metric.temp !== null) {
                             let iconCode = 26;
                             try {
                                 const wxUrl = `https://api.weather.com/v3/wx/observations/current?geocode=${obs.lat},${obs.lon}&format=json&units=m&language=hu-HU&apiKey=${WUNDERGROUND_API_KEY}`;
                                 const wxRes = await fetch(wxUrl, { signal: AbortSignal.timeout(2000) });
                                 if(wxRes.ok) { const wxData = await wxRes.json(); if(wxData.iconCode !== undefined) iconCode = wxData.iconCode; }
                             } catch(e) {}
                             return { name: PWS_MAP[id] || id, lat: obs.lat, lon: obs.lon, temp: obs.metric.temp, hum: obs.humidity, wind: obs.metric.windSpeed, winddir: obs.metric.winddir, press: obs.metric.pressure, precip: obs.metric.precipRate, ibmIcon: iconCode, updatedAt: new Date(), type: 'PWS' };
                        }
                    }
                } catch(e) { return null; }
                return null;
            };

            const fetchOM = async (cityList, count) => {
                 const keys = cityList.sort(() => 0.5 - Math.random()).slice(0, count);
                 const promises = keys.map(async city => {
                    try {
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,wind_direction_10m,weather_code,apparent_temperature`;
                        const res = await fetch(url, { signal: AbortSignal.timeout(3000) });
                        const data = await res.json();
                        return { name: city.name, lat: city.lat, lon: city.lon, temp: data.current.temperature_2m, hum: data.current.relative_humidity_2m, wind: data.current.wind_speed_10m, winddir: data.current.wind_direction_10m, press: data.current.surface_pressure, precip: 0, wmo: data.current.weather_code, feelsLike: data.current.apparent_temperature, updatedAt: new Date(), type: 'OM' };
                    } catch(e) { return null; }
                 });
                 const results = await Promise.allSettled(promises);
                 return results.filter(r => r.status === 'fulfilled' && r.value).map(r => r.value);
            };

            const [pwsResults, huResults, foreignResults] = await Promise.all([ Promise.allSettled(stationKeys.map(id => fetchPWS(id))), fetchOM(HUNGARIAN_CITIES_OM, 5), fetchOM(FOREIGN_CITIES, 10) ]);
            const validPWS = pwsResults.filter(r => r.status === 'fulfilled' && r.value).map(r => r.value);
            state.weatherPlaylist = [...validPWS, ...huResults, ...foreignResults];
            state.weatherPlaylistIndex = 0;
        }

        function displayWeather() {
            if(state.weatherPlaylist.length === 0 || state.scheduleActive) return;
            if (state.weatherPlaylistIndex >= state.weatherPlaylist.length) { fetchWeatherData(); state.weatherPlaylistIndex = 0; if (state.weatherPlaylist.length === 0) return; }
            const item = state.weatherPlaylist[state.weatherPlaylistIndex];
            state.weatherPlaylistIndex++;
            el.weatherLocName.textContent = item.name;
            const timeStr = item.updatedAt ? item.updatedAt.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('weather-loc-time').textContent = `FRISS√çTVE: ${timeStr}`;
            const temp = typeof item.temp === 'number' ? item.temp : 0;
            const hum = item.hum || 0;
            const wind = typeof item.wind === 'number' ? item.wind : 0;
            const press = typeof item.press === 'number' ? item.press : 0;
            el.weatherTemp.textContent = temp.toFixed(1) + "¬∞";
            let feelsLikeVal = item.feelsLike;
            if (feelsLikeVal === undefined) { feelsLikeVal = calculateFeelsLike(temp, hum, wind); }
            el.weatherFeels.textContent = `H≈ê√âRZET: ${feelsLikeVal.toFixed(1)}¬∞`;
            el.wdHum.textContent = hum + "%";
            const dirStr = getWindDirStr(item.winddir);
            el.wdWind.textContent = `${wind.toFixed(1)} km/h ${dirStr}`;
            el.wdPress.textContent = press.toFixed(1) + " hPa";
            if (item.type === 'PWS' && item.ibmIcon !== undefined) { el.weatherIcon.innerHTML = getIconFromIBMCode(item.ibmIcon); } else {
                const now = new Date();
                const sunTimes = SunCalc.getTimes(now, item.lat || NYIREGYHAZA_COORDS.lat, item.lon || NYIREGYHAZA_COORDS.lon);
                const isNight = now < sunTimes.sunrise || now > sunTimes.sunset;
                el.weatherIcon.innerHTML = getIconFromWMO(item.wmo || 0, isNight);
            }
        }

        function displaySchedule() {
            if (!state.block || state.block.name === 'Elk√∂sz√∂n√©s') return;
            state.scheduleActive = true;
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            const labels = ["MOST", "K√ñVETKEZIK", "K√âS≈êBB"]; 
            el.weatherLocTime.style.display = 'none';
            const backHeader = document.getElementById('schedule-header');
            backHeader.style.display = 'flex'; 
            el.scheduleView.style.display = 'flex';
            el.promoView.style.display = 'none';
            let html = '';
            for(let i = 0; i < 3; i++) {
                const idx = (currentIndex + i) % THEMATIC_BLOCKS.length;
                const block = THEMATIC_BLOCKS[idx];
                const hour = Math.floor(block.start);
                const min = Math.round((block.start % 1) * 60);
                const timeStr = `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                html += `<div class="schedule-item" id="sch-item-${i}"><div class="sch-time">${timeStr}</div><div style="flex-grow:1;"><div class="sch-label">${labels[i]}</div><div class="sch-name">${block.name}</div></div></div>`;
            }
            el.scheduleList.innerHTML = html;
            flipPanel('weather', true);
            state.scheduleHighlightIndex = 0;
            updateScheduleHighlight();
            state.scheduleInterval = setInterval(updateScheduleHighlight, 5000); 
            setTimeout(() => { 
                clearInterval(state.scheduleInterval); 
                backHeader.style.display = 'none'; 
                el.scheduleView.style.display = "none"; 
                el.promoView.style.display = "flex"; 
            }, 15000);
            setTimeout(() => { 
                flipPanel('weather', false); 
                state.scheduleActive = false; 
                el.scheduleView.style.display = "flex"; 
                el.promoView.style.display = "none"; 
                displayWeather(); 
            }, 25000);
        }

        function updateScheduleHighlight() {
            document.querySelectorAll('.schedule-item').forEach(item => item.classList.remove('active-highlight'));
            const currentItem = document.getElementById(`sch-item-${state.scheduleHighlightIndex}`);
            if(currentItem) currentItem.classList.add('active-highlight');
            state.scheduleHighlightIndex = (state.scheduleHighlightIndex + 1) % 3;
        }

        function generateTimeline() {
            if(!state.block || state.block.type !== 'summary_yesterday') { el.timelineContainer.classList.remove('visible'); return; }
            const hours = [...new Set(state.items.map(item => item.date.getHours()))].sort((a,b)=>a-b);
            let html = '';
            hours.forEach(h => { html += `<button class="timeline-btn" data-hour="${h}">${String(h).padStart(2,'0')}</button>`; });
            el.timelineContainer.innerHTML = html;
            el.timelineContainer.classList.add('visible');
            el.timelineContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); const h = parseInt(btn.dataset.hour); const idx = state.items.findIndex(i => i.date.getHours() === h); if(idx !== -1) { state.currentIndex = idx; showNextItem(false); } });
            });
        }

        function updateTimelineActive() {
            if(!state.block || state.block.type !== 'summary_yesterday') return;
            const item = state.items[state.currentIndex % state.items.length];
            if(!item) return;
            const h = item.date.getHours();
            el.timelineContainer.querySelectorAll('.timeline-btn').forEach(btn => { btn.classList.toggle('active', parseInt(btn.dataset.hour) === h); });
        }

        function cleanUpOldItems() {
            if(!state.block) return;
            const now = new Date();
            let cutoffTime;
            if(state.block.type === 'fresh') {
                cutoffTime = new Date();
                const hoursBack = state.block.timeWindowHours || 2;
                cutoffTime.setHours(now.getHours() - hoursBack);
                const originalCount = state.items.length;
                state.items = state.items.filter(item => item.date >= cutoffTime);
                if (state.items.length < originalCount) { console.log(`Cleaned up ${originalCount - state.items.length} old news items.`); }
            } 
        }

        async function checkBreakingNews() {
            if(state.breakingActive) return; 
            const now = Date.now();
            const threeMinutesAgo = now - (3 * 60 * 1000); 
            for(const [src, url] of Object.entries(BACKUP_FEEDS)) {
                try {
                    const uniqueUrl = url + (url.includes('?') ? '&' : '?') + 'cB=' + now;
                    const res = await fetchWithProxyFallback(uniqueUrl);
                    const txt = await res.text();
                    const xml = new DOMParser().parseFromString(txt, "text/xml");
                    const items = xml.querySelectorAll("item");
                    for(let i=0; i<2; i++) { 
                        const item = items[i]; if(!item) continue;
                        const dateStr = item.querySelector("pubDate")?.textContent;
                        if(!dateStr) continue;
                        const date = new Date(dateStr);
                        const link = item.querySelector("link")?.textContent;
                        if(date.getTime() > threeMinutesAgo && link && !state.seenBreakingLinks.has(link)) {
                            const title = item.querySelector("title")?.textContent || "";
                            state.seenBreakingLinks.add(link); 
                            const breakingItem = { title: title, desc: stripHtml(item.querySelector("description")?.textContent || ""), source: getSourceName(link), date: date, link: link, img: extractImageUrl(item, item.querySelector("description")?.textContent || "") };
                            activateBreakingBar(breakingItem);
                            return; 
                        }
                    }
                } catch(e) {}
            }
        }

        function activateBreakingBar(item) {
            console.log("BREAKING ACTIVE:", item.title);
            state.breakingActive = true;
            state.breakingLink = item.link; 
            el.bpText.textContent = item.title;
            el.bpTime.textContent = item.date.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});
            el.bpSource.textContent = item.source;
            el.bpText.style.animation = 'none';
            el.controlsBar.classList.add('breaking-active');
            el.bpIntroLayer.style.opacity = '1';
            el.bpNewsLayer.style.opacity = '0';

            setTimeout(() => {
                el.bpIntroLayer.style.opacity = '0';
                setTimeout(() => {
                    el.bpNewsLayer.style.opacity = '1';
                    setTimeout(() => {
                        const containerWidth = document.querySelector('.bp-text-scroller').offsetWidth;
                        const textWidth = el.bpText.offsetWidth;
                        let totalDuration = 20000; 
                        if(textWidth > containerWidth) {
                            const dist = -(textWidth + 20) + "px"; 
                            el.bpText.style.setProperty('--scroll-dist', dist);
                            const speed = 80; 
                            const scrollDuration = (textWidth + containerWidth) / speed;
                            const animDuration = Math.max(scrollDuration, 10); 
                            el.bpText.style.animation = `scrollTextLeft ${animDuration}s linear 1s forwards`;
                            totalDuration = (1 + animDuration + 2) * 1000;
                        } else { totalDuration = 12000; }
                        
                        setTimeout(() => {
                            el.bpNewsLayer.style.opacity = '0';
                            setTimeout(() => {
                                el.controlsBar.classList.remove('breaking-active');
                                state.breakingActive = false;
                                el.bpText.style.animation = 'none';
                            }, 500);
                            
                        }, totalDuration);
                    }, 100);
                }, 500);
            }, 3000); 
        }
        
        el.controlsBar.addEventListener('click', (e) => {
             if(state.breakingActive && state.breakingLink) {
                 e.preventDefault(); e.stopPropagation();
                 window.open(state.breakingLink, '_blank');
             }
        });
        
        // --- DEV MENU FUNCTIONS ---
        window.triggerTestBreaking = function() {
            activateBreakingBar({
                title: "Ez egy r√∂vid teszt h√≠r.",
                date: new Date(),
                source: "TESZT",
                link: "#"
            });
        }
        window.triggerTestBreakingLong = function() {
            activateBreakingBar({
                title: "Ez egy nagyon hossz√∫ teszt h√≠r, hogy l√°ssuk, hogyan m≈±k√∂dik a sz√∂veg g√∂rget√©se, ha nem f√©r ki a k√©perny≈ëre, √©s sz√©pen elt≈±nik a forr√°s m√∂g√∂tt.",
                date: new Date(),
                source: "TESZT",
                link: "#"
            });
        }
        window.closeDevMenu = function() { el.devMenu.style.display = 'none'; }
        
        // Open Dev Menu Handler
        document.querySelector('.brand-wrapper').addEventListener('click', () => {
             const code = prompt("Fejleszt≈ëi k√≥d:");
             if(code === "0000") el.devMenu.style.display = 'flex';
        });

        function handleVisibilityChange() {
            if (document.visibilityState === 'visible') {
                const d = new Date();
                const remainder = d.getMinutes() % 15;
                d.setMinutes(d.getMinutes() - remainder);
                d.setSeconds(0);
                d.setMilliseconds(0);
                const lastCheckpoint = d.getTime();
                if (state.lastRefreshTimestamp < lastCheckpoint) { state.items = []; refreshNews(false); }
            }
        }

        function updateTimeAndState() {
            const now = new Date();
            el.clockHm.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});
            el.clockS.textContent = `:${String(now.getSeconds()).padStart(2, '0')}`;
            const days = ['vas√°rnap', 'h√©tf≈ë', 'kedd', 'szerda', 'cs√ºt√∂rt√∂k', 'p√©ntek', 'szombat'];
            el.date.textContent = `${now.getFullYear()}. ${CALENDAR_DATA.honapok[now.getMonth()]} ${now.getDate()}., ${days[now.getDay()]}`;
            const key = `${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            if(CALENDAR_DATA.nameDays[key]) el.nameday.textContent = CALENDAR_DATA.nameDays[key].join(', ') + ' n√©vnap';
            updateSkyGradient();
            const h = now.getHours() + now.getMinutes()/60;
            let currentBlock = THEMATIC_BLOCKS.findLast(b => h >= b.start) || THEMATIC_BLOCKS[THEMATIC_BLOCKS.length-1];
            const min = now.getMinutes();
            const sec = now.getSeconds();
            const hour = now.getHours();
            if (hour === 23 && min === 59) {
                if (sec >= 0 && sec < 50) { el.goodbyeCard.classList.add('active'); el.bigClockLayer.classList.remove('active'); } else if (sec >= 50) { el.goodbyeCard.classList.remove('active'); el.bigClockLayer.classList.add('active'); el.bcTime.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); if(sec === 50) showCredits(); }
            } else if (min === 59 && sec >= 50) { el.bigClockLayer.classList.add('active'); el.bcTime.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); if(sec === 50) showCredits(); } else {
                if(el.bigClockLayer.classList.contains('active')) { el.bigClockLayer.classList.remove('active'); el.goodbyeCard.classList.remove('active'); if(state.block.type !== 'summary_yesterday') { state.currentIndex = 0; if(state.nextItems.length > 0) { state.items = state.nextItems; state.nextItems = []; } showNextItem(false); } }
            }
            if (!state.block || state.block.name !== currentBlock.name) { state.block = currentBlock; el.badge.className = `program-badge visible ${state.block.styleClass}`; el.badge.textContent = state.block.name; refreshNews(); }
            if(state.block.type === 'summary_yesterday') { el.badge.classList.add('visible'); } else { el.badge.classList.add('visible'); }
            if((min === 0 || min === 20 || min === 40) && sec === 0 && min !== state.lastScheduleMin) { state.lastScheduleMin = min; displaySchedule(); }
            if((min === 12 || min === 32 || min === 52) && sec === 30) { fetchExchangeRates(); }
            if((min === 13 || min === 33 || min === 53) && sec === 0) { showEconomy(); }
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            const nextBlock = THEMATIC_BLOCKS[(currentIndex + 1) % THEMATIC_BLOCKS.length];
            const nextStartMin = (nextBlock.start * 60);
            const currentMin = (now.getHours() * 60) + now.getMinutes();
            let diff = nextStartMin - currentMin;
            if (diff < 0) diff += 1440; 
            if(diff <= 15 && diff > 0) {
                const nH = Math.floor(nextBlock.start); const nM = Math.round((nextBlock.start % 1) * 60);
                const nTime = `${String(nH).padStart(2,'0')}:${String(nM).padStart(2,'0')}`;
                el.nextProgAlert.textContent = `K√ñVETKEZIK: ${nTime} ${nextBlock.name}`; el.nextProgAlert.classList.add('active');
            } else { el.nextProgAlert.classList.remove('active'); }
            
            // √âJSZAKAI CSENDES√çT√âS: Csak 06:00 ut√°n friss√≠t√ºnk
            if (hour >= 6 && sec === 50 && (min === 14 || min === 29 || min === 44 || min === 59)) { 
                el.updateIndicator.classList.add('active'); 
                refreshNews(true); 
            }
            
            if (sec === 0 && (min === 0 || min === 15 || min === 30 || min === 45)) { state.pendingListReset = true; }
            if (sec === 0) cleanUpOldItems();
        }

        function filterItemsByBlock(items) {
            const now = new Date();
            let filtered = [];
            if(state.block.type === 'summary_yesterday') {
                const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0,0,0,0);
                const end = new Date(yesterday); end.setHours(23,59,59,999);
                filtered = items.filter(item => item.date >= yesterday && item.date <= end);
                filtered.sort((a,b) => a.date - b.date); 
            } else if(state.block.type === 'morning_catchup') {
                let start = new Date(now); start.setHours(0,0,0,0);
                filtered = items.filter(item => item.date >= start);
            } else if(state.block.type === 'fresh') {
                let timeLimit = new Date();
                timeLimit.setHours(now.getHours() - (state.block.timeWindowHours || 2));
                filtered = items.filter(item => item.date >= timeLimit);
            } else {
                let timeLimit = new Date(); timeLimit.setHours(0,0,0,0);
                filtered = items.filter(item => item.date >= timeLimit);
            }
            return filtered;
        }

        async function attemptFetchFeed(key, url) {
            const res = await fetchWithProxyFallback(url);
            let txt;
            if(url.includes('ma.hu')) txt = new TextDecoder('iso-8859-2').decode(await res.arrayBuffer());
            else txt = await res.text();
            const xml = new DOMParser().parseFromString(txt, "text/xml");
            const parsedItems = [];
            xml.querySelectorAll("item").forEach(item => {
                const title = item.querySelector("title")?.textContent || "";
                const descHtml = item.querySelector("description")?.textContent || "";
                const link = item.querySelector("link")?.textContent;
                const dateStr = item.querySelector("pubDate")?.textContent;
                if(title && dateStr) {
                    parsedItems.push({ title: title, link: link, desc: stripHtml(descHtml).substring(0, 300), source: key, date: new Date(dateStr), img: extractImageUrl(item, descHtml) });
                }
            });
            return parsedItems;
        }

        async function processRetries() {
            state.retryCount = (state.retryCount || 0) + 1;
            if(state.retryQueue.length === 0 || state.retryCount > 15) { clearInterval(state.retryInterval); state.retryQueue = []; return; }
            const currentQueue = [...state.retryQueue];
            state.retryQueue = []; 
            const fetched = [];
            for(const task of currentQueue) {
                try {
                    const items = await attemptFetchFeed(task.key, task.url);
                    fetched.push(...items);
                } catch(e) { state.retryQueue.push(task); }
            }
            if(fetched.length > 0) mergeNewItems(fetched);
        }

        function mergeNewItems(newItems) {
            const currentLink = state.currentItem ? state.currentItem.link : null;
            const combined = [...state.items, ...newItems];
            const uniqueMap = new Map();
            combined.forEach(item => uniqueMap.set(item.link, item));
            let uniqueItems = Array.from(uniqueMap.values());
            uniqueItems = filterItemsByBlock(uniqueItems);
            if(state.block.type !== 'summary_yesterday') { uniqueItems.sort((a,b) => b.date - a.date); }
            state.items = uniqueItems;
            if(currentLink) {
                const newIdx = state.items.findIndex(i => i.link === currentLink);
                if(newIdx !== -1) { state.currentIndex = newIdx; } else { state.currentIndex = state.currentIndex % state.items.length; }
            }
            if(state.items.length > 0) { el.counter.textContent = `${(state.currentIndex % state.items.length) + 1} / ${state.items.length}`; }
        }

        async function refreshNews(silent = false) {
            state.lastRefreshTimestamp = Date.now();
            state.retryCount = 0; 
            if(!silent) el.loading.classList.add('active');
            state.retryQueue = [];
            if(state.retryInterval) clearInterval(state.retryInterval);
            let feeds = BACKUP_FEEDS;
            if(Object.keys(state.rssFeeds).length > 0) feeds = { ...feeds, ...state.rssFeeds };
            let fetchedItems = [];
            const fetchPromises = Object.entries(feeds).map(async ([key, url]) => {
                try {
                    const items = await attemptFetchFeed(key, url);
                    fetchedItems.push(...items);
                } catch(e) { state.retryQueue.push({ key, url }); }
            });
            await Promise.allSettled(fetchPromises);
            const now = new Date();
            let cutoffTime = new Date(0); 
            if (state.block.type === 'fresh') {
                const hoursBack = state.block.timeWindowHours || 2;
                cutoffTime = new Date(now.getTime() - (hoursBack * 60 * 60 * 1000));
            } else if (state.block.type === 'morning_catchup') { cutoffTime = new Date(now); cutoffTime.setHours(0,0,0,0); }
            fetchedItems = fetchedItems.filter(item => item.date >= cutoffTime);
            fetchedItems.sort((a,b) => b.date - a.date);
            const filtered = filterItemsByBlock(fetchedItems); 
            const uniqueItems = [];
            const seenLinks = new Set();
            for(const item of filtered) { if(!seenLinks.has(item.link)) { uniqueItems.push(item); seenLinks.add(item.link); } }
            if(silent) { state.nextItems = uniqueItems; el.updateIndicator.classList.remove('active'); } else { state.items = uniqueItems; el.loading.classList.remove('active'); state.currentIndex = 0; showNextItem(false); }
            if(state.block.type === 'summary_yesterday') generateTimeline(); else el.timelineContainer.classList.remove('visible');
            if(state.retryQueue.length > 0) { state.retryInterval = setInterval(processRetries, 20000); }
            cleanUpOldItems();
        }

        function showNextItem(advance = true) {
            clearTimeout(state.flipTimer);
            state.isTransitioning = true;
            if(state.block.type === 'summary_yesterday') {
                const now = Date.now();
                if (now - state.lastNightInfoTime > 300000) { renderNightInfoCard(); return; }
            }
            if(state.pendingListReset && state.nextItems.length > 0) { state.items = state.nextItems; state.nextItems = []; state.currentIndex = -1; advance = true; state.pendingListReset = false; }
            if(state.items.length === 0) { el[state.activeTrack === 'a' ? 'trackA' : 'trackB'].innerHTML = `<div class="news-title">Nincs h√≠r...</div>`; return; }
            if(advance) state.currentIndex++;
            let item = state.items[state.currentIndex % state.items.length];
            if(state.items.length > 1 && state.currentItem && (item.link === state.currentItem.link || item.title === state.currentItem.title)) { state.currentIndex++; item = state.items[state.currentIndex % state.items.length]; }
            state.currentItem = item;
            renderCard(item, false);
            el.progressBar.style.animationDuration = '18s'; state.currentDuration = 18000; state.cardStartTime = Date.now();
            state.flipTimer = setTimeout(() => { state.isTransitioning = false; showNextItem(true); }, 18000);
        }

        function renderNightInfoCard() {
            state.lastNightInfoTime = Date.now(); 
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA'];
            const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            el.badge.className = `program-badge visible ${state.block.styleClass}`;
            el.badge.textContent = state.block.name;
            const html = `<div class="ni-icon">üåô</div><div class="ni-text">Jelenleg az √©jszakai m≈±szak h√≠reit olvasod. Ha friss h√≠r √©rkezik, az azonnal megjelenik r√∂vid id≈ëre.</div><div class="ni-sub">TKP NEWS √âjszakai √úgyelet</div>`;
            nextTrack.innerHTML = html;
            nextTrack.classList.add('night-info'); nextTrack.classList.remove('breaking');
            el.newsBg.parentElement.classList.remove('has-image');
            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.style.animationDuration = '10s'; el.progressBar.classList.add('animate-progress');
            state.flipTimer = setTimeout(() => { state.isTransitioning = false; showNextItem(false); }, 10000); 
        }

        function renderCard(item, isBreaking) {
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA'];
            const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            const fav = getFavicon(item.link);
            const displaySource = getSourceName(item.link);
            const timeStr = item.date.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});
            nextTrack.classList.remove('night-info');
            
            el.badge.className = `program-badge visible ${state.block.styleClass}`;
            el.badge.textContent = state.block.name;

            let headerHTML = `<div class="provider-identity"><img src="${fav}" class="provider-icon"> ${displaySource}</div><span>${timeStr}</span>`;
            el.badge.classList.remove('breaking-mode');
            if(state.block.type === 'summary_yesterday') {
                headerHTML += `<span class="night-summary-label visible">AZ EL≈êZ≈ê NAP H√çREINEK √ñSSZEFOGLAL√ìJA</span>`;
            }
            const html = `<div class="news-header-row"><div class="news-meta">${headerHTML}</div></div><div class="news-content-wrapper"><div class="news-title">${item.title}</div><div class="news-desc">${item.desc}</div></div>`;
            nextTrack.innerHTML = html;
            nextTrack.classList.remove('breaking');
            if(item.img) { el.bgImg.src = item.img; el.newsBg.parentElement.classList.add('has-image'); } else { el.newsBg.parentElement.classList.remove('has-image'); }
            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.counter.textContent = `${(state.currentIndex % state.items.length) + 1} / ${state.items.length}`;
            updateTimelineActive();
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.classList.add('animate-progress');
        }

        el.newsViewport.addEventListener('mouseenter', () => { if(!state.isPaused) { clearTimeout(state.flipTimer); el.progressBar.style.animationPlayState = 'paused'; state.isPaused = true; const elapsed = Date.now() - state.cardStartTime; state.remainingTime = Math.max(0, state.currentDuration - elapsed); } });
        el.newsViewport.addEventListener('mouseleave', () => { if(state.isPaused) { el.progressBar.style.animationPlayState = 'running'; state.isPaused = false; state.cardStartTime = Date.now(); state.currentDuration = state.remainingTime; state.flipTimer = setTimeout(() => { showNextItem(true); }, state.remainingTime); } });

        function initIntroSequence() { el.leftPanel.classList.add('loaded'); el.rightPanel.classList.add('loaded'); setTimeout(() => { el.mainContainer.classList.add('open'); }, 1500); }
        
        document.addEventListener("DOMContentLoaded", () => {
            el.crYear.textContent = new Date().getFullYear(); 
            document.addEventListener('visibilitychange', handleVisibilityChange);
            setInterval(updateTimeAndState, 1000); updateTimeAndState();
            onValue(feedsRef, (snap) => { state.rssFeeds = snap.val() || {}; refreshNews(); });
            fetchWeatherData(); setInterval(fetchWeatherData, 150000); setInterval(displayWeather, 6000);
            setInterval(checkBreakingNews, 20000); setTimeout(checkBreakingNews, 5000);
            setInterval(showCredits, 300000); 
            document.getElementById('manual-refresh-trigger').addEventListener('click', () => refreshNews());
            document.getElementById('next-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); showNextItem(true); });
            document.getElementById('prev-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); state.currentIndex -= 2; showNextItem(true); });
            el.newsContainer.addEventListener('click', (e) => { if(e.target.closest('.controls-bar') || e.target.closest('.breaking-pod')) return; if(state.currentItem && state.currentItem.link) window.open(state.currentItem.link, '_blank'); });
            setTimeout(fetchExchangeRates, 5000);
            initIntroSequence();
        });
    </script>
</body>
</html>

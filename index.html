<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Am≈ëba Pro Online</title>
    <style>
        /* CSS K√ìD */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        
        :root {
            --bg-gradient-start: #2c3e50; --bg-gradient-end: #1a2937;
            --container-bg: rgba(26, 41, 55, 0.6);
            --container-border: rgba(129, 140, 162, 0.2);
            --board-bg: #1c2b3a; --cell-border: #3e5369;
            --text-primary: #ecf0f1; --text-secondary: #bdc3c7;
            --accent-color: #3498db; --accent-glow: rgba(52, 152, 219, 0.5);
            --accent-secondary: #e67e22; --accent-secondary-glow: rgba(230, 126, 34, 0.5);
            --success-color: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5);
            --danger-color: #e74c3c;
            --x-color: #3498db; --o-color: #e67e22;
            --money-color: #f1c40f;

            /* AI Difficulty Colors */
            --board-bg-easy: #223a4e;
            --board-bg-normal: #1c2b3a;
            --board-bg-hard: #2a213e;
            --board-bg-genius: #3a2128;
        }

        .x-icon { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 52 52'%3E%3Cpath fill='none' stroke='%233498db' stroke-width='6' stroke-linecap='round' d='M10 10l32 32M42 10l-32 32'/%3E%3C/svg%3E"); }
        .o-icon { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 52 52'%3E%3Ccircle cx='26' cy='26' r='20' fill='none' stroke='%23e67e22' stroke-width='6'/%3E%3C/svg%3E"); }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { font-family: 'Montserrat', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100%; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: var(--text-primary); padding: 20px; }
        .hidden { display: none !important; }

        .logo { margin-bottom: 25px; filter: drop-shadow(0 0 15px var(--accent-glow)); text-align: center; }
        .logo svg { height: 70px; width: 100%; max-width: 420px; }

        .glass-container { background: var(--container-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--container-border); border-radius: 20px; box-shadow: 0 15px 30px var(--shadow-color); padding: 40px; }
        #lobbyContainer { display: flex; flex-direction: column; width: 100%; max-width: 500px; text-align: center; }
        #lobbyDescription { color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        #rulesLink { color: var(--accent-color); text-decoration: none; font-weight: 600; font-size: 0.9rem; margin-bottom: 20px; cursor: pointer; display: inline-block; }
        #rulesLink:hover { text-decoration: underline; }
        .copyright-notice { margin-top: -10px; margin-bottom: 20px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; }
        .input-group { margin-bottom: 20px; }
        input { width: 100%; padding: 15px; background-color: var(--board-bg); border: 1px solid var(--cell-border); border-radius: 10px; color: var(--text-primary); font-size: 1rem; transition: all 0.2s ease; }
        input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); outline: none; }
        input:disabled { background-color: #2b3748; color: var(--text-secondary); }
        
        .button-group { display: flex; flex-direction: column; gap: 15px; }
        .button-group .multiplayer-buttons, .button-group .secondary-buttons { display: flex; gap: 15px; }
        
        .lobby-btn { flex: 1; padding: 15px; font-size: 1rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; }
        .lobby-btn:disabled { background-color: var(--cell-border); color: var(--text-secondary); cursor: not-allowed; }
        .lobby-btn.bonus-ready { animation: bonus-glow 1.5s infinite; }
        @keyframes bonus-glow { 0%, 100% { box-shadow: 0 0 10px var(--money-color); } 50% { box-shadow: 0 0 25px var(--money-color); } }
        
        #startAIGameBtn { background: linear-gradient(45deg, var(--success-color), #27ae60); color: white; }
        #startAIGameBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }

        #createGameBtn { background-color: var(--accent-color); color: white; }
        #createGameBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px var(--accent-glow); }
        #joinGameBtn { background-color: transparent; border: 2px solid var(--accent-secondary); color: var(--accent-secondary); }
        #joinGameBtn:hover:not(:disabled) { background-color: var(--accent-secondary); color: white; }
        .secondary-btn { background-color: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); }
        .secondary-btn:hover:not(:disabled) { background-color: var(--text-secondary); color: white; }
        #joinAsSpectatorBtn { background-color: var(--accent-color); color: white; }
        
        .game-wrapper { display: flex; align-items: flex-start; gap: 40px; }
        #board-wrapper { position: relative; }
        #board { display: grid; width: 600px; height: 600px; background-color: var(--board-bg); border-radius: 15px; box-shadow: 0 15px 30px var(--shadow-color); border: 1px solid var(--cell-border); transition: background-color 0.5s ease; }
        
        body[data-difficulty="easy"] #board { background-color: var(--board-bg-easy); }
        body[data-difficulty="normal"] #board { background-color: var(--board-bg-normal); }
        body[data-difficulty="hard"] #board { background-color: var(--board-bg-hard); }
        body[data-difficulty="genius"] #board { background-color: var(--board-bg-genius); }

        .cell { border: 1px solid var(--cell-border); background-color: transparent; background-size: 70%; background-position: center; background-repeat: no-repeat; transition: background-color 0.2s; cursor: pointer; }
        .cell:not(.blocked):hover { background-color: rgba(255, 255, 255, 0.05); }
        .cell.disabled { cursor: not-allowed; }
        .cell.disabled:hover { background-color: transparent; }

        .game-panel { width: 300px; }
        .game-info { text-align: center; margin-top: 15px; }
        #spectatorCodeDisplay, #spectatorList { font-size: 0.9rem; color: var(--text-secondary); min-height: 20px; }
        #spectatorList span { margin-left: 8px; font-weight: 600; color: var(--text-primary); }

        .scoreboard { display: flex; justify-content: space-between; margin-top: 10px; gap: 15px; }
        .player-score { text-align: center; background: rgba(0,0,0,0.2); border: 2px solid var(--cell-border); border-radius: 15px; width: 100%; padding: 15px; transition: all 0.3s ease; background-size: cover; background-position: center; }
        .player-score.active { transform: scale(1.05); }
        #playerXPanel.active { border-color: var(--x-color); box-shadow: 0 0 20px var(--accent-glow); }
        #playerOPanel.active { border-color: var(--o-color); box-shadow: 0 0 20px var(--accent-secondary-glow); }
        .player-score .icon { width: 35px; height: 35px; margin: 0 auto 5px; }
        .player-score .player-icon { font-size: 1.5rem; min-height: 28px; }
        .player-score .name { font-weight: 600; font-size: 0.9rem; min-height: 50px; margin-bottom: 5px; word-break: break-all; }
        .player-score .score { font-size: 2rem; font-weight: 700; }
        .player-money-ingame { font-size: 0.8rem; color: var(--money-color); font-weight: 600; margin-top: 5px; }
        .player-projection { font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2; }

        #game-wager-display { text-align: center; margin-top: 20px; font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--money-color); }
        
        .game-status { text-align: center; min-height: 50px; font-size: 1.1rem; margin-top: 20px; }
        #gameCodeDisplay { margin-top: 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        #gameCodeText { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; color: var(--accent-color); letter-spacing: 3px; }
        #copyCodeBtn { padding: 8px 15px; font-size: 0.8rem; background-color: var(--cell-border); color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer; }
        
        #rematch-controls { margin-top: 15px; }
        #startRematchBtn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 10px; background-color: var(--success-color); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; margin-top: 10px; }
        #startRematchBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        #startRematchBtn:disabled { background-color: var(--cell-border); color: var(--text-secondary); cursor: not-allowed; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.5rem; font-weight: 600; }
        
        #avatar-selection h3, .options-group h3 { text-align: center; font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; font-weight: 600; }
        #avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; border: 3px solid transparent; background-size: cover; margin: 0 auto; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }
        .player-avatar { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; border: 3px solid var(--cell-border); background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        
        .radio-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .radio-group label { background-color: var(--board-bg); border: 2px solid var(--cell-border); padding: 10px 15px; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        .radio-group input { display: none; }
        .radio-group input:checked + label { border-color: var(--accent-color); background-color: var(--accent-glow); color: white; }
        .options-divider { border: 0; height: 1px; background: var(--cell-border); margin: 25px 0; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1001; }
        .modal-container { position: relative; width: 90%; max-width: 800px; background: var(--container-bg); border: 1px solid var(--container-border); border-radius: 20px; padding: 40px; box-shadow: 0 15px 30px var(--shadow-color); transition: background 0.3s ease; }
        .modal-container h2 { text-align: center; margin-bottom: 20px; font-family: 'Orbitron', sans-serif; }
        .modal-container h3 { color: var(--accent-color); text-align: center; margin-top: 20px; margin-bottom: 15px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: white; }
        
        #player-wallet { text-align: center; font-size: 1.1rem; margin-bottom: 20px; font-weight: 600; color: var(--money-color); text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .shop-category-container { max-height: 60vh; overflow-y: auto; padding: 10px; }
        #shop-items-container-backgrounds, #shop-items-container-icons { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .shop-item { background: rgba(0,0,0,0.3); border: 1px solid var(--cell-border); border-radius: 10px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .shop-item-preview { width: 100%; height: 70px; border-radius: 5px; margin-bottom: 10px; background-size: cover; background-position: center; border: 1px solid var(--cell-border); display: flex; justify-content: center; align-items: center; font-size: 2.5rem; cursor: pointer; }
        .shop-item h4 { font-size: 0.85rem; margin-bottom: 5px; min-height: 30px; }
        .shop-item-price { font-size: 0.9rem; font-weight: 700; color: var(--money-color); margin-bottom: 10px; }
        .shop-item-buttons { display: flex; gap: 5px; }
        .shop-btn { padding: 8px 12px; font-size: 0.8rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; width: 100%; flex: 1; }
        .buy-btn { background-color: var(--money-color); color: #1c2b3a; }
        .buy-btn:hover { background-color: #f39c12; }
        .equip-btn { background-color: var(--success-color); color: white; }
        .equipped-btn { background-color: var(--cell-border); color: var(--text-secondary); cursor: not-allowed; }
        .sell-btn { background-color: var(--danger-color); color: white; }

        #dailyBonus-week { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .day-box { width: 80px; height: 100px; background: var(--board-bg); border: 2px solid var(--cell-border); border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .day-box.today { border-color: var(--accent-color); }
        .day-box.claimed { background-color: var(--success-color); border-color: #27ae60; }
        .day-box .day-name { font-size: 0.8rem; font-weight: 600; }
        .day-box .day-date { font-size: 0.7rem; color: var(--text-secondary); }
        .day-box .day-reward { font-size: 1.2rem; font-weight: 700; color: var(--money-color); margin-top: 5px; }


        #devPanel { max-height: 70vh; overflow-y: auto; }
        .dev-player-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-bottom: 5px; }
        .dev-player-item input { width: 100px; margin: 0 10px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .stats-block h3 { color: var(--accent-color); margin-bottom: 15px; border-bottom: 1px solid var(--cell-border); padding-bottom: 10px; }
        #statsPikszel h3 { color: var(--danger-color); }
        .stats-block p { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .stats-block span { font-weight: 700; color: white; }
        
        #achievements-list { max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        .achievement-item { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--cell-border); opacity: 0.5; transition: all 0.3s ease; }
        .achievement-item.unlocked { border-left-color: var(--success-color); opacity: 1; }
        .achievement-icon { font-size: 2rem; margin-right: 20px; }
        .achievement-details h4 { margin-bottom: 5px; color: var(--text-primary); }
        .achievement-details p { font-size: 0.85rem; color: var(--text-secondary); }
        
        #achievementOnBoard { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(26, 41, 55, 0.9); color: var(--success-color); padding: 30px; border-radius: 20px; border: 2px solid var(--success-color); text-align: center; font-family: 'Orbitron', sans-serif; font-size: 1.8rem; z-index: 100; pointer-events: none; text-shadow: 0 0 15px var(--success-color); }
        @keyframes achievement-strobe { 0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.05); } }
        #achievementOnBoard.show { animation: achievement-strobe 0.4s 7 ease-in-out; }
        
        @keyframes place-pop { 0% { transform: scale(0.5); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .cell-pop { animation: place-pop 0.4s ease-out; }
        
        @keyframes strobe-flash { 0%, 100% { filter: brightness(1); } 10%, 30%, 50%, 70%, 90% { filter: brightness(3.5) drop-shadow(0 0 15px rgba(255, 255, 255, 1)); } 20%, 40%, 60%, 80% { filter: brightness(1); } }
        .cell-flashed.x-icon, .cell-flashed.o-icon { animation: strobe-flash 0.6s ease-in-out; }
        .money-strobe { animation: strobe-flash-money 1.5s ease-in-out; }
        @keyframes strobe-flash-money { 0%, 100% { color: var(--money-color); transform: scale(1); } 10%, 30%, 50%, 70%, 90% { color: white; transform: scale(1.1); text-shadow: 0 0 15px white; } 20%, 40%, 60%, 80% { color: var(--money-color); transform: scale(1); } }


        @keyframes winning-icon-pulse { 0%, 100% { transform: scale(1); filter: brightness(1.5) drop-shadow(0 0 5px var(--success-color)); } 50% { transform: scale(1.1); filter: brightness(2.5) drop-shadow(0 0 15px var(--success-color)); } }
        .winning-cell { background-color: rgba(46, 204, 113, 0.15); }
        .winning-cell.x-icon, .winning-cell.o-icon { animation: winning-icon-pulse 1.5s infinite ease-in-out; }

        @media (max-width: 950px) { body { padding: 10px; } .game-wrapper { flex-direction: column; align-items: center; gap: 20px; } #board { width: 95vw; height: 95vw; max-width: 500px; max-height: 500px; } .game-panel { width: 95vw; max-width: 500px; padding: 20px; } #avatar-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); } .stats-grid { grid-template-columns: 1fr; } .modal-container { max-width: 90vw; padding: 20px;} }
    </style>
</head>
<body>
    
    <div id="loadingOverlay" class="hidden">Bet√∂lt√©s...</div>

    <div id="lobbyContainer" class="glass-container">
        <div class="logo">
            <svg viewBox="0 0 420 70">
                <defs><linearGradient id="logoFrameGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient><linearGradient id="logoTextGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient></defs>
                <g transform="translate(15, 0)"><rect x="1" y="1" width="80" height="68" rx="15" fill="none" stroke="url(#logoFrameGradient)" stroke-width="2.5"/><g><path d="M 15 12 L 37 34 M 37 12 L 15 34" stroke="var(--accent-color)" stroke-width="5" stroke-linecap="round"/><circle cx="57" cy="48" r="14" stroke="var(--accent-secondary)" stroke-width="5" fill="none"/></g></g>
                <text x="255" y="50%" dominant-baseline="middle" text-anchor="middle" fill="url(#logoTextGradient)" font-family="'Orbitron', sans-serif" font-size="60px" letter-spacing="2">AM≈êBA</text>
            </svg>
        </div>
        <p id="lobbyDescription">Add meg a neved, v√°lassz avat√°rt, majd j√°tssz egy AI vagy egy m√°sik j√°t√©kos ellen!</p>
        <p class="copyright-notice">&copy; Copyright by: Robi</p>
        <a id="rulesLink">R√©szletes j√°t√©kszab√°lyzat</a>
        
        <div id="player-options">
            <div id="avatar-selection"><div id="avatar-grid"></div></div>
            <div class="input-group"><input type="text" id="playerNameInput" placeholder="J√°t√©kosn√©v"></div>
            <div id="player-wallet" class="hidden">Egyenleged: <span id="playerMoney">0</span> FT</div>

            <hr class="options-divider">

            <div id="ai-game-options" class="options-group">
                <h3>J√°t√©k G√©p Ellen</h3>
                <div class="radio-group" style="margin-bottom: 20px;">
                    <input type="radio" id="ai-karesz" name="aiPersonality" value="karesz" checked><label for="ai-karesz">Koczka Karesz</label>
                    <input type="radio" id="ai-panna" name="aiPersonality" value="pikszel"><label for="ai-panna">Pikszel Panna</label>
                </div>
                 <div class="radio-group" style="margin-bottom: 20px;">
                    <input type="radio" id="ai-difficulty-easy" name="aiDifficulty" value="easy"><label for="ai-difficulty-easy">K√∂nny≈±</label>
                    <input type="radio" id="ai-difficulty-normal" name="aiDifficulty" value="normal" checked><label for="ai-difficulty-normal">Norm√°l</label>
                    <input type="radio" id="ai-difficulty-hard" name="aiDifficulty" value="hard"><label for="ai-difficulty-hard">Neh√©z</label>
                    <input type="radio" id="ai-difficulty-genius" name="aiDifficulty" value="genius"><label for="ai-difficulty-genius">G√©niusz</label>
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <input type="number" id="aiWagerInput" placeholder="T√©t (min. 50)" value="100" min="50" step="50">
                </div>
                <button id="startAIGameBtn" class="lobby-btn">J√°t√©k AI ellen</button>
            </div>

            <hr class="options-divider">

            <div id="multiplayer-game-options" class="options-group">
                 <h3>T√∂bbj√°t√©kos M√≥d</h3>
                 <div class="input-group"><input type="text" id="gameIdInput" placeholder="J√°t√©k K√≥dja"></div>
                <div class="input-group">
                    <input type="number" id="mpWagerInput" placeholder="T√©t (min. 100)" value="300" min="100" step="100">
                </div>
                <div class="multiplayer-buttons">
                    <button id="createGameBtn" class="lobby-btn">J√°t√©k L√©trehoz√°sa</button>
                    <button id="joinGameBtn" class="lobby-btn">Csatlakoz√°s</button>
                </div>
            </div>
        </div>

        <div id="spectator-options" class="hidden">
            <div class="input-group"><input type="text" id="spectatorNameInput" placeholder="Leskel≈ëd≈ë N√©v"></div>
            <div class="input-group"><input type="text" id="spectatorCodeInput" placeholder="Leskel≈ëd≈ë K√≥d (2 jegy≈±)"></div>
        </div>

        <div class="button-group">
            <div id="player-buttons">
                 <div class="secondary-buttons">
                    <button id="dailyBonusBtn" class="lobby-btn secondary-btn hidden">Napi B√≥nusz üéÅ</button>
                    <button id="shopBtn" class="lobby-btn secondary-btn hidden">Bolt üõçÔ∏è</button>
                    <button id="achievementsBtn" class="lobby-btn secondary-btn">Teljes√≠tm√©nyek</button>
                    <button id="statsBtn" class="lobby-btn secondary-btn">Statisztik√°k</button>
                </div>
                <button id="spectateModeBtn" class="lobby-btn secondary-btn">Leskel≈ëd√©s</button>
            </div>
             <div id="spectator-buttons" class="hidden" style="display: flex; gap: 15px;">
                <button id="joinAsSpectatorBtn" class="lobby-btn">Kukkol√°s</button>
                <button id="cancelSpectateBtn" class="lobby-btn secondary-btn">M√©gse</button>
            </div>
        </div>
    </div>

    <div id="gameContainer" class="game-wrapper hidden">
        <div id="board-wrapper">
            <div id="board"></div>
            <div id="achievementOnBoard" class="hidden"></div>
        </div>
        <div class="game-panel glass-container">
            <div class="logo">
                <svg viewBox="0 0 420 70">
                    <defs><linearGradient id="logoFrameGradient2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient><linearGradient id="logoTextGradient2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient></defs>
                    <g transform="translate(15, 0)"><rect x="1" y="1" width="80" height="68" rx="15" fill="none" stroke="url(#logoFrameGradient2)" stroke-width="2.5"/><g><path d="M 15 12 L 37 34 M 37 12 L 15 34" stroke="var(--accent-color)" stroke-width="5" stroke-linecap="round"/><circle cx="57" cy="48" r="14" stroke="var(--accent-secondary)" stroke-width="5" fill="none"/></g></g>
                    <text x="255" y="50%" dominant-baseline="middle" text-anchor="middle" fill="url(#logoTextGradient2)" font-family="'Orbitron', sans-serif" font-size="60px" letter-spacing="2">AM≈êBA</text>
                </svg>
            </div>
            <div class="game-info"><div id="spectatorCodeDisplay"></div><div id="spectatorList"></div></div>
            <div class="scoreboard">
                <div class="player-score" id="playerXPanel">
                    <div class="player-avatar" id="playerXAvatar"></div>
                    <div class="player-icon" id="playerXIcon"></div>
                    <div class="icon x-icon"></div>
                    <div class="name" id="playerXNameText">J√°t√©kos X</div>
                    <span class="score" id="scoreX">0</span>
                    <div class="player-money-ingame" id="playerXMoney"></div>
                    <div class="player-projection" id="playerXProjection"></div>
                </div>
                <div class="player-score" id="playerOPanel">
                    <div class="player-avatar" id="playerOAvatar"></div>
                    <div class="player-icon" id="playerOIcon"></div>
                    <div class="icon o-icon"></div>
                    <div class="name" id="playerONameText">J√°t√©kos O</div>
                    <span class="score" id="scoreO">0</span>
                    <div class="player-money-ingame" id="playerOMoney"></div>
                    <div class="player-projection" id="playerOProjection"></div>
                </div>
            </div>
            <div id="game-wager-display"></div>
            <div class="game-status"><p id="statusText">V√°rakoz√°s a m√°sik j√°t√©kosra...</p></div>
             <div id="gameCodeDisplay" class="hidden">
                <span id="gameCodeText"></span>
                <button id="copyCodeBtn">M√°sol√°s</button>
            </div>
            <div id="rematch-controls" class="hidden">
                <div class="input-group">
                    <label for="rematchWagerInput" style="font-size: 0.9rem; color: var(--text-secondary);">√öj t√©t a revanshoz:</label>
                    <input type="number" id="rematchWagerInput" value="100" min="50" step="50">
                </div>
                <button id="startRematchBtn">Revans Ind√≠t√°sa</button>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal hidden">
        <div class="modal-container">
            <span id="closeStatsBtn" class="close-btn">&times;</span>
            <h2>Statisztik√°id</h2>
            <div class="stats-grid">
                <div id="statsKaresz" class="stats-block">
                    <h3>Koczka Karesz</h3>
                    <p>Lej√°tszott meccsek: <span id="stats-karesz-games">0</span></p>
                    <p>Gy≈ëzelmek: <span id="stats-karesz-wins">0</span></p>
                    <p>Veres√©gek: <span id="stats-karesz-losses">0</span></p>
                    <p>D√∂ntetlenek: <span id="stats-karesz-draws">0</span></p>
                    <p>Jelenlegi sorozat: <span id="stats-karesz-streak">0</span></p>
                    <p>Legjobb sorozat: <span id="stats-karesz-best-streak">0</span></p>
                </div>
                <div id="statsPikszel" class="stats-block">
                    <h3>Pikszel Panna</h3>
                    <p>Lej√°tszott meccsek: <span id="stats-pikszel-games">0</span></p>
                    <p>Gy≈ëzelmek: <span id="stats-pikszel-wins">0</span></p>
                    <p>Veres√©gek: <span id="stats-pikszel-losses">0</span></p>
                    <p>D√∂ntetlenek: <span id="stats-pikszel-draws">0</span></p>
                    <p>Jelenlegi sorozat: <span id="stats-pikszel-streak">0</span></p>
                    <p>Legjobb sorozat: <span id="stats-pikszel-best-streak">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="achievementsModal" class="modal hidden">
        <div class="modal-container">
            <span id="closeAchievementsBtn" class="close-btn">&times;</span>
            <h2>Teljes√≠tm√©nyek</h2>
            <div id="achievements-list"></div>
        </div>
    </div>

    <div id="shopModal" class="modal hidden">
        <div class="modal-container">
            <span id="closeShopBtn" class="close-btn">&times;</span>
            <h2>Bolt</h2>
            <div id="shop-wallet" style="text-align: center; color: var(--money-color); margin-bottom: 20px; font-size: 1.2rem; font-weight: bold;">
                Egyenleged: <span id="shopMoney">0</span> FT
            </div>
            <div class="shop-category-container">
                <h3>H√°tterek (Kattints az el≈ën√©zetre a nagy√≠t√°shoz)</h3>
                <div id="shop-items-container-backgrounds"></div>
                <h3>Ikonok (N√©v mell√©)</h3>
                <div id="shop-items-container-icons"></div>
            </div>
        </div>
    </div>
    
    <div id="dailyBonusModal" class="modal hidden">
        <div class="modal-container">
            <span id="closeDailyBonusBtn" class="close-btn">&times;</span>
            <h2>Napi Bel√©p√©si B√≥nusz</h2>
            <p style="text-align: center; margin-bottom: 20px;">Minden nap bel√©pve jutalmat kapsz! A mai jutalmad:</p>
            <div id="dailyBonus-week"></div>
            <button id="claimBonusBtn" class="lobby-btn">B√≥nusz K√©r√©se</button>
        </div>
    </div>

    <div id="devModal" class="modal hidden">
        <div class="modal-container">
            <span id="closeDevBtn" class="close-btn">&times;</span>
            <h2>Fejleszt≈ëi Panel</h2>
            <div class="button-group" style="margin-bottom: 20px;">
                <button id="devGiveSelfMoney" class="lobby-btn">Adok magamnak 1,000,000 FT-ot</button>
                <button id="devUnlockAll" class="lobby-btn">Minden felold√°sa</button>
            </div>
            <h3>J√°t√©kosok Kezel√©se</h3>
            <div id="devPanel"></div>
        </div>
    </div>


    <audio id="place-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_game_sound_wood_block_1.mp3" preload="auto"></audio>
    <audio id="win-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-four/fantasy_game_success_win_fanfare_2.mp3" preload="auto"></audio>
    <audio id="turn-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_game_sound_UI_tone_modern_synth_1.mp3" preload="auto"></audio>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, collection, addDoc, query, orderBy, where, getDocs, limit, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const BOARD_SIZE = 15;
        const SELL_RATIO = 0.5; // 50%-os visszat√©r√≠t√©s
        const firebaseConfig = { apiKey: "AIzaSyCiA7KeOeTvHgfhpA-jJaHldO9iMsqrn74", authDomain: "amoba-7a6d0.firebaseapp.com", projectId: "amoba-7a6d0", storageBucket: "amoba-7a6d0.appspot.com", messagingSenderId: "676264921111", appId: "1:676264921111:web:ca6f1e54819cd354407452", databaseURL: "https://amoba-7a6d0-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app); 
        
        let currentGameId = null, localPlayerSymbol = null, loggedInPlayerName = null, unsubscribeFromGame = null;
        let isSinglePlayer = false, isSpectatorMode = false, selectedAvatar = null;
        let localGameState = null, spectatorPresenceRef = null, activeSpectators = {};
        let localPlayerData = null;
        
        let dailyKareszWinQuotes = [], dailyKareszLossQuotes = [], dailyKareszDrawQuotes = [];
        let dailyPikszelWinQuotes = [], dailyPikszelLossQuotes = [], dailyPikszelDrawQuotes = [];
        
        const MASTER_KARESZ_WIN_QUOTES=["Nos, ez a kimenetel logikailag elker√ºlhetetlen volt. Tal√°n legk√∂zelebb.","Ne cs√ºggedjen, ifj√∫ bar√°tom. A tanul√°si g√∂rbe n√©ha meredek. Az √∂n√© k√ºl√∂n√∂sen.","L√°tja, a strat√©gia √©s a t√ºrelem mindig diadalmaskodik a kapkod√°s felett.","Eln√©z√©st, de a sz√°m√≠t√°saim szerint √∂nnek k√∂r√ºlbel√ºl 0.01% es√©lye volt. A matematika nem hazudik.","Remek pr√≥b√°lkoz√°s volt. M√°rmint, egy kezd≈ëh√∂z k√©pest.","Egy j√≥l megtervezett algoritmus sz√©ps√©ge... √ñn ezt aligha √©rtheti.","A gy≈ëzelemhez nem el√©g a rem√©ny, kedvesem. Logika is sz√ºks√©geltetik.","Minden l√©p√©s√©t el≈ëre l√°ttam. Olyan volt, mint egy nyitott k√∂nyv... egy nagyon egyszer≈± k√©pesk√∂nyv.","Ne vegye a sz√≠v√©re. Nem mindenki sz√ºletett a strat√©giai gondolkod√°s mester√©nek.","Ez a parti remek p√©ld√°ja volt a k√°oszelm√©letnek. Az √∂n oldal√°r√≥l.","√ögy t≈±nik, a g√©p ism√©t fel√ºlm√∫lta alkot√≥j√°t. Micsoda ironikus fordulat.","Ezt a gy≈ëzelmet a prec√≠z sz√°m√≠t√°soknak √©s a hib√°tlan logik√°nak aj√°nlom.","K√©rem, ne √©rezze rosszul mag√°t. Az √©n processzorom m√°sodpercenk√©nt t√∂bb milli√°rd l√©p√©st k√©pes elemezni. √ñnnek mennyi is van?","Ez a j√°tszma olyan volt, mint egy eleg√°ns sakk-matt. El≈ëre eltervezett √©s kiv√©dhetetlen.","Azt hiszem, friss√≠tenem kell az 'emberi hib√°k' adatb√°zisomat. K√∂sz√∂n√∂m az √∫j adatokat.","A gy≈ëzelem, mint egy j√≥l behangolt √≥ram≈±: minden a hely√©re ker√ºlt a megfelel≈ë id≈ëben.","Javaslom, tanulm√°nyozza a j√°t√©kelm√©letet. Sokat seg√≠thet... b√°r val√≥sz√≠n≈±leg nem eleget.","Ez nem szem√©lyes, csup√°n a sz√°mok rideg val√≥s√°ga. Ma √©n voltam a nagyobb sz√°m.","Leny≈±g√∂z≈ë, ahogy a rem√©nyt v√°lasztotta a logika helyett. B√°tor, de v√©gzetes hiba.","Minden tiszteletem az √∂n√©. A kitart√°s dics√©retes, m√©g ha az eredm√©ny bor√≠t√©kolhat√≥ is volt."];
        const MASTER_KARESZ_LOSS_QUOTES=["Hoh√≥! Egy anom√°lia a rendszerben. Leny≈±g√∂z≈ë. Gratul√°lok, siker√ºlt meglepnie.","√ögy t≈±nik, az emberi intu√≠ci√≥... nos, ma fel√ºlm√∫lta a tiszta logik√°t. Ezt ki kell elemeznem.","Engedtem nyerni. Egy√©rtelm≈±en. A mor√°l fenntart√°sa √©rdek√©ben.","Ez... v√°ratlan volt. Tal√°n egy porszem ker√ºlt a processzoromba. Vagy √∂n t√©nyleg j√≥ volt. De ink√°bb az els≈ë.","El kell ismernem, ez egy figyelemre m√©lt√≥ gy≈ëzelem. Jegyzetelek a k√∂vetkez≈ë partinkra.","L√°tja, m√©g egy g√©p is tud nagylelk≈± lenni. Tess√©k, ez a k√∂r az √∂n√©.","A szerencse faktort al√°becs√ºltem. Hiba volt. De egy g√©p tanul a hib√°ib√≥l.","Gratul√°lok. Siker√ºlt megtal√°lnia azt az egyetlen √∫tvonalat a gy≈ëzelemhez a 14 milli√≥b√≥l, amit nem z√°rtam le id≈ëben.","Ez a veres√©g olyan, mint egy kerek√≠t√©si hiba. Bosszant√≥, de statisztikailag lehets√©ges.","Nos, √∫gy t≈±nik, a 'kisz√°m√≠thatatlans√°g' v√°ltoz√≥val is sz√°molnom kell a j√∂v≈ëben. √ârdekes.","Le kell futtatnom egy diagnosztik√°t. Ez az eredm√©ny ellentmond minden val√≥sz√≠n≈±s√©g-sz√°m√≠t√°snak.","Gratul√°lok. Ma √∂n volt a kiv√©tel, amely er≈ës√≠ti a szab√°lyt.","Ez a veres√©g... frusztr√°l√≥. De a fejl≈ëd√©shez elengedhetetlen az adatok gy≈±jt√©se. K√∂sz√∂n√∂m a leck√©t.","Lehets√©ges, hogy egy kozmikus sug√°rz√°s √°tmenetileg megzavarta az √°ramk√∂reimet pont a kritikus pillanatban.","Nos, ez egy fekete folt a makul√°tlan m√©rlegemen. De minden nagy elm√©nek vannak ilyenek.","Meg kell hagyni, a strat√©gi√°ja mer√©sz volt. Mint egy rosszul meg√≠rt, de valahogy m√©gis m≈±k√∂d≈ë programk√≥d.","Ez a veres√©g egy √∫j v√°ltoz√≥t vezetett be az egyenletembe: az emberi elsz√°nts√°got. Figyelemre m√©lt√≥.","√ögy t≈±nik, a 'gy≈ëzelem' defin√≠ci√≥ja ma kiss√© k√©pl√©kenyebb, mint gondoltam.","Rendben, elismerem. De legk√∂zelebb a nehez√≠tett m√≥dot kapcsolom be. Magamnak."];
        const MASTER_KARESZ_DRAW_QUOTES=["Patthelyzet. A legkev√©sb√© kiel√©g√≠t≈ë, de logikailag elfogadhat√≥ eredm√©ny.","√ögy t≈±nik, m√©lt√≥ ellenf√©lre tal√°ltam. Vagy csak mindketten hib√°ztunk az utols√≥ l√©p√©sekn√©l.","Egy d√∂ntetlen olyan, mint egy befejezetlen szimf√≥nia. Bosszant√≥.","Nos, legal√°bb nem vesztett. Ez is valami, felt√©telezem.","Ezt a partit elmentem a 'megoldatlan probl√©m√°k' mapp√°ba.","A t√∂k√©letes egyens√∫ly √°llapota. B√°r √©n a t√∂k√©letes gy≈ëzelmet prefer√°lom.","H√≠vjuk ezt... intellektu√°lis fegyversz√ºnetnek. De a h√°bor√∫ m√©g nem √©rt v√©get."];
        
        const MASTER_PIKSZEL_WIN_QUOTES=["LOL, ezt ben√©zted. De nagyon.","GG EZ. Mondan√°m, de nem volt az. T√∫l k√∂nny≈± volt.","#skillissue. Ennyi. Bocsi.","Ne s√≠rj, csak egy j√°t√©k. B√°r mostant√≥l az √©n j√°t√©kom.","Annyira pr√≥b√°lkozt√°l, cuki. Majdnem megsajn√°ltalak. Majdnem.","Ez a l√©p√©s annyira 2010-es volt. Haladjunk m√°r, pls.","Nem√°r, komolyan ezt a strat√©gi√°t v√°lasztottad? Cringe.","Ok√©, boomer. Ez a gy≈ëzelem a Z gener√°ci√≥nak sz√≥l.","Lehet, hogy neked van √©leted, de nekem t√∂bb FPS-em. √âs gy≈ëzelmem.","Na, err≈ël ennyit. Majd √≠rj, ha feln≈ëtt√©l a feladathoz.","Ez a gy≈ëzelem annyira sima volt, mint egy filterezett Insta-sztori.","L√°tod? √ân m√°r a met√°ban j√°tszom, am√≠g te a tutorialt olvasod.","Ne vedd magadra, de a strat√©gi√°d annyira basic.","Ez a meccs olyan volt, mint egy rossz m√©m: m√°r l√°ttam √©s nem is vicces.","Te most komolyan azt hitted, hogy nyerhetsz? Awww.","Ez a gy≈ëzelem annyira clean volt, hogy ASMR vide√≥t lehetne bel≈ële csin√°lni.","RIP a te gy≈ëzelmi es√©lyeidnek. F.","Most menj, √©s igy√°l egy vizet. L√°tom, sz√ºks√©ged van r√°.","√ân: 1, Te: 0. A matek egyszer≈±.","Ez a gy≈ëzelem annyira nyilv√°nval√≥ volt, mint egy spoiler a kommentek k√∂z√∂tt."];
        const MASTER_PIKSZEL_LOSS_QUOTES=["Ok√©, csalt√°l. Vagy a netem laggolt. M√°s magyar√°zat nincs.","Most hagytalak nyerni, hogy ne add fel teljesen. Nincs kivel j√°tszanom.","WTF?! Ezt hogy? V√°rj, lementem a replayt, ezt l√°tnia kell a t√∂bbieknek.","J√≥, j√≥, nyert√©l. Most m√°r elmondhatod mindenkinek, hogy legy≈ëzt√©l egy l√°nyt. B√ºszke lehetsz.","Ez most f√°jt az eg√≥mnak. De majd t√∫lteszem magam rajta. Val√≥sz√≠n≈±leg.","Hacker! Reportoltalak a rendszergazd√°n√°l. Ja, v√°rj, az a Karesz. Mindegy.","Ne hidd, hogy ez megism√©tl≈ëdik. Csak rossz napom van. Meg am√∫gy is.","Most biztos azt hiszed, te vagy a men≈ë. H√°t... ok√©, ma te vagy.","Ez a gy≈ëzelem olyan, mint egy bug a j√°t√©kban. Nem kellett volna megt√∂rt√©nnie.","Ok√©, elismerem, ez most OP volt t≈ëled. Nerfelni fognak, megl√°tod.","J√≥l van, na. Most elmehetsz flexelni a bar√°taidnak.","Ez biztos valami stream sniper volt. Vagy csak te volt√°l az.","A szerencse a noobok fegyvere. Ma szerencs√©d volt.","Ez annyira unfair volt. A fejleszt≈ëk biztos neked szurkoltak.","Ok√©, ezt a k√∂rt elengedtem. De a h√°bor√∫t √©n fogom megnyerni.","Most az egyszer. De jegyezd meg a nevem.","F√°j a sz√≠vem. De a bossz√∫ √©des lesz. Nagyon √©des.","Most mit mondjak? Gratul√°lok. Vagy valami ilyesmi.","Ez a veres√©g annyira cringe. T√∂rl√∂m a mem√≥ri√°mb√≥l. Most."];
        const MASTER_PIKSZEL_DRAW_QUOTES=["D√∂ntetlen? Ez olyan... befejezetlen. Mint egy rossz Netflix sorozat.","Ok√©, megosztozunk a dics≈ës√©gen. De az √©n r√©szem nagyobb.","Majdnem olyan j√≥ volt√°l, mint √©n. Majdnem. Cuki.","Ezt a d√∂ntetlent vedd egy bar√°ti figyelmeztet√©snek.","H√≠vjuk ezt strat√©giai kompromisszumnak. De legk√∂zelebb nem leszek ilyen kompromisszumk√©sz.","D√∂ntetlen? Ez olyan, mintha egy filter csak f√©lig t√∂ltene be. Kellemetlen.","√ögy l√°tom, ma egyik√ºnk sem tudott a m√°sik f√∂l√© kerekedni. De a ruh√°m szebb.","Ez a d√∂ntetlen csak azt bizony√≠tja, hogy n√©ha m√©g √©n is leereszkedem a te szintedre."];
        
        const aiMoodAvatars = { 
            karesz: { default: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Karesz&glasses=variant02&glassesProbability=100&mustache=variant01&mustacheProbability=100' }, 
            pikszel: { default: 'https://api.dicebear.com/8.x/micah/svg?seed=Panna&hair=punk&earrings=hoop&eyebrows=raised&mouth=smirk' } 
        };

        function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
        function seededShuffle(array, seed) { const random = mulberry32(seed); let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
        function getDailyQuotes() { const seed = new Date().setHours(0, 0, 0, 0); dailyKareszWinQuotes = seededShuffle([...MASTER_KARESZ_WIN_QUOTES], seed); dailyKareszLossQuotes = seededShuffle([...MASTER_KARESZ_LOSS_QUOTES], seed + 1); dailyKareszDrawQuotes = seededShuffle([...MASTER_KARESZ_DRAW_QUOTES], seed + 2); dailyPikszelWinQuotes = seededShuffle([...MASTER_PIKSZEL_WIN_QUOTES], seed + 3); dailyPikszelLossQuotes = seededShuffle([...MASTER_PIKSZEL_LOSS_QUOTES], seed + 4); dailyPikszelDrawQuotes = seededShuffle([...MASTER_PIKSZEL_DRAW_QUOTES], seed + 5); }

        const uiElements = {
            lobbyContainer: document.getElementById('lobbyContainer'), gameContainer: document.getElementById('gameContainer'), playerNameInput: document.getElementById('playerNameInput'), gameIdInput: document.getElementById('gameIdInput'), createGameBtn: document.getElementById('createGameBtn'), joinGameBtn: document.getElementById('joinGameBtn'), startAIGameBtn: document.getElementById('startAIGameBtn'), board: document.getElementById('board'), statusText: document.getElementById('statusText'), rematchControls: document.getElementById('rematch-controls'), startRematchBtn: document.getElementById('startRematchBtn'),
            playerXName: document.getElementById('playerXNameText'), playerOName: document.getElementById('playerONameText'), 
            playerXIcon: document.getElementById('playerXIcon'), playerOIcon: document.getElementById('playerOIcon'),
            playerXMoney: document.getElementById('playerXMoney'), playerOMoney: document.getElementById('playerOMoney'),
            playerXProjection: document.getElementById('playerXProjection'), playerOProjection: document.getElementById('playerOProjection'),
            gameWagerDisplay: document.getElementById('game-wager-display'),
            scoreX: document.getElementById('scoreX'), scoreO: document.getElementById('scoreO'), playerXPanel: document.getElementById('playerXPanel'), playerOPanel: document.getElementById('playerOPanel'), loadingOverlay: document.getElementById('loadingOverlay'), avatarGrid: document.getElementById('avatar-grid'), playerXAvatar: document.getElementById('playerXAvatar'), playerOAvatar: document.getElementById('playerOAvatar'), spectateModeBtn: document.getElementById('spectateModeBtn'), joinAsSpectatorBtn: document.getElementById('joinAsSpectatorBtn'), cancelSpectateBtn: document.getElementById('cancelSpectateBtn'), playerOptions: document.getElementById('player-options'), spectatorOptions: document.getElementById('spectator-options'), playerButtons: document.getElementById('player-buttons'), spectatorButtons: document.getElementById('spectator-buttons'), spectatorNameInput: document.getElementById('spectatorNameInput'), spectatorCodeInput: document.getElementById('spectatorCodeInput'), spectatorCodeDisplay: document.getElementById('spectatorCodeDisplay'), spectatorList: document.getElementById('spectatorList'), statsBtn: document.getElementById('statsBtn'), statsModal: document.getElementById('statsModal'), closeStatsBtn: document.getElementById('closeStatsBtn'), achievementsBtn: document.getElementById('achievementsBtn'), achievementsModal: document.getElementById('achievementsModal'), closeAchievementsBtn: document.getElementById('closeAchievementsBtn'), achievementsList: document.getElementById('achievements-list'), 
            achievementOnBoard: document.getElementById('achievementOnBoard'), rulesLink: document.getElementById('rulesLink'),
            gameCodeDisplay: document.getElementById('gameCodeDisplay'), gameCodeText: document.getElementById('gameCodeText'), copyCodeBtn: document.getElementById('copyCodeBtn'),
            playerWallet: document.getElementById('player-wallet'), playerMoney: document.getElementById('playerMoney'),
            shopBtn: document.getElementById('shopBtn'), shopModal: document.getElementById('shopModal'), closeShopBtn: document.getElementById('closeShopBtn'), 
            shopItemsContainerBgs: document.getElementById('shop-items-container-backgrounds'), shopItemsContainerIcons: document.getElementById('shop-items-container-icons'),
            shopMoney: document.getElementById('shopMoney'),
            dailyBonusBtn: document.getElementById('dailyBonusBtn'), dailyBonusModal: document.getElementById('dailyBonusModal'), closeDailyBonusBtn: document.getElementById('closeDailyBonusBtn'), dailyBonusWeek: document.getElementById('dailyBonus-week'), claimBonusBtn: document.getElementById('claimBonusBtn'),
            devModal: document.getElementById('devModal'), closeDevBtn: document.getElementById('closeDevBtn'), devPanel: document.getElementById('devPanel'), devGiveSelfMoneyBtn: document.getElementById('devGiveSelfMoney'), devUnlockAllBtn: document.getElementById('devUnlockAll'),
            sounds: { place: document.getElementById('place-sound'), win: document.getElementById('win-sound'), turn: document.getElementById('turn-sound') }
        };
        
        const T_URL = (p) => `https://www.transparenttextures.com/patterns/${p}.png`;
        const SHOP_ITEMS = {
            backgrounds: [
                { id: 'bg_default', name: 'Alap√©rtelmezett', price: 0, style: 'rgba(0,0,0,0.2)' },
                { id: 'bg_hearts', name: 'Sz√≠vecsk√©s', price: 1500, style: `rgba(0,0,0,0.4) url("${T_URL('heart-pattern')}")` },
                { id: 'bg_carbon', name: 'Karbon', price: 1500, style: `rgba(0,0,0,0.4) url("${T_URL('carbon-fibre')}")` },
                { id: 'bg_fabric', name: 'Sz√∂vet', price: 1500, style: `rgba(0,0,0,0.4) url("${T_URL('fabric-plaid')}")` },
                { id: 'bg_wood', name: 'Fa Erezet', price: 1800, style: `rgba(0,0,0,0.4) url("${T_URL('wood-pattern')}")` },
                { id: 'bg_paper', name: 'Pap√≠r', price: 1800, style: `rgba(0,0,0,0.4) url("${T_URL('paper')}")` },
                { id: 'bg_concrete', name: 'Beton', price: 2000, style: `rgba(0,0,0,0.4) url("${T_URL('concrete-wall-2')}")` },
                { id: 'bg_argyle', name: 'Kock√°s', price: 2200, style: `rgba(0,0,0,0.4) url("${T_URL('argyle')}")` },
                { id: 'bg_stars', name: 'Csillagos', price: 2500, style: `rgba(0,0,0,0.4) url("${T_URL('star-background')}")` },
                { id: 'bg_waves', name: 'Hull√°mos', price: 2500, style: `rgba(0,0,0,0.4) url("${T_URL('wavecut')}")` },
                { id: 'bg_tech', name: 'Tech Minta', price: 2800, style: `rgba(0,0,0,0.4) url("${T_URL('tiny-grid')}")` },
                { id: 'bg_ice', name: 'J√©gkrist√°ly', price: 3000, style: `rgba(0,0,0,0.4) url("${T_URL('ice-age')}")` },
                { id: 'bg_maze', name: 'Labirintus', price: 3200, style: `rgba(0,0,0,0.4) url("${T_URL('maze-black')}")` },
                { id: 'bg_bubbles', name: 'Bubor√©kok', price: 3200, style: `rgba(0,0,0,0.4) url("${T_URL('bubbles')}")` },
                { id: 'bg_skulls', name: 'Kopony√°k', price: 3500, style: `rgba(0,0,0,0.4) url("${T_URL('skulls')}")` },
                { id: 'bg_circuit', name: '√Åramk√∂r', price: 3500, style: `rgba(0,0,0,0.4) url("${T_URL('circuit-board')}")` },
                { id: 'bg_sun', name: 'Napsugaras', price: 3500, style: 'radial-gradient(circle, rgba(253,235,123,0.3) 0%, rgba(255,145,0,0.1) 100%)' },
                { id: 'bg_bamboo', name: 'Bambusz', price: 3800, style: `rgba(0,0,0,0.4) url("${T_URL('bamboo')}")` },
                { id: 'bg_koi', name: 'Koi Ponty', price: 4000, style: `rgba(0,0,0,0.4) url("${T_URL('koi')}")` },
                { id: 'bg_nebula', name: 'K√∂dfolt', price: 4000, style: 'linear-gradient(135deg, #232526, #414345)' },
                { id: 'bg_forest', name: 'Erd≈ë', price: 4000, style: 'linear-gradient(135deg, #134E5E, #71B280)' },
                { id: 'bg_ocean', name: '√ìce√°n', price: 4200, style: 'linear-gradient(135deg, #005AA7, #FFFDE4)' },
                { id: 'bg_sunset', name: 'Naplemente', price: 4500, style: 'linear-gradient(135deg, #ff7e5f, #feb47b)' },
                { id: 'bg_candy', name: 'Cukorka', price: 4800, style: 'linear-gradient(135deg, #a8c0ff, #3f2b96)' },
                { id: 'bg_lava', name: 'L√°va', price: 5000, style: 'linear-gradient(135deg, #ff416c, #ff4b2b)' },
                { id: 'bg_metal', name: 'F√©m', price: 5500, style: `rgba(0,0,0,0.4) url("${T_URL('brushed-metal')}")` },
                { id: 'bg_gold_dust', name: 'Aranypor', price: 6000, style: `rgba(0,0,0,0.4) url("${T_URL('gold-scale')}")` },
                { id: 'bg_liquid', name: 'Foly√©kony F√©m', price: 7000, style: 'linear-gradient(135deg, #D7DDE8, #757F9A)'},
                { id: 'bg_diamond', name: 'Gy√©m√°nt', price: 7500, style: `rgba(0,0,0,0.4) url("${T_URL('diamond-upholstery')}")` },
                { id: 'bg_shatter', name: '√úvegszil√°nk', price: 8000, style: `rgba(0,0,0,0.4) url("${T_URL('shattered')}")` },
                { id: 'bg_hex', name: 'Hexagon', price: 8500, style: `rgba(0,0,0,0.4) url("${T_URL('hexabump')}")` },
                { id: 'bg_glitter', name: 'Csill√°m', price: 9000, style: 'linear-gradient(135deg, #C33764, #1D2671)'},
                { id: 'bg_matrix', name: 'M√°trix', price: 10000, style: 'linear-gradient(rgba(18, 16, 16, 0.7), rgba(18, 16, 16, 0.7)), url("https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExd2JpZXZhczF5Z3d2aXh0eGF0b29xNnE0cjQ2cTczdjVoaWw5NGw2eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/A9grgCQ0Dm012/giphy.gif")' },
                { id: 'bg_hacker', name: 'Hacker', price: 12000, style: `rgba(0,0,0,0.4) url("${T_URL('hixs-evolution-x')}")` },
                { id: 'bg_fire', name: 'T≈±zfal', price: 14000, style: 'linear-gradient(45deg, #ff512f, #f09819)' },
                { id: 'bg_royal', name: 'Kir√°lyi B√°rsony', price: 15000, style: 'linear-gradient(135deg, #4a00e0, #8e2de2)' },
                { id: 'bg_aurora', name: 'Sarki F√©ny', price: 16000, style: 'linear-gradient(to right, #74ebd5, #acb6e5)' },
                { id: 'bg_cosmic', name: 'Kozmikus', price: 18000, style: 'linear-gradient(to right, #6441a5, #2a0845)' },
                { id: 'bg_galaxy', name: 'Galaxis', price: 20000, style: 'linear-gradient(rgba(18, 16, 16, 0.6), rgba(18, 16, 16, 0.6)), url("https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNG04ZHhwZGt6bHRkZGp6eG5xZ2p0ajZkN24yM2I0aTV0ZGN1b2g4bCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l41YtZOb9EUABnuqA/giphy.gif")' },
                { id: 'bg_supernova', name: 'Szupern√≥va', price: 25000, style: 'linear-gradient(to right, #f7b733, #fc4a1a)' },
                { id: 'bg_abstract', name: 'Absztrakt', price: 30000, style: 'linear-gradient(45deg, #12c2e9, #c471ed, #f64f59)' },
            ],
            icons: [
                { id: 'icon_default', name: 'Nincs Ikon', price: 0, icon: '' },
                { id: 'icon_star', name: 'Csillag', price: 1000, icon: '‚≠ê' },
                { id: 'icon_heart', name: 'Sz√≠v', price: 1000, icon: '‚ù§Ô∏è' },
                { id: 'icon_spade', name: 'Pikk', price: 1100, icon: '‚ô†Ô∏è' },
                { id: 'icon_club', name: 'Treff', price: 1100, icon: '‚ô£Ô∏è' },
                { id: 'icon_diamond', name: 'K√°r√≥', price: 1100, icon: '‚ô¶Ô∏è' },
                { id: 'icon_clover', name: 'L√≥here', price: 1200, icon: 'üçÄ' },
                { id: 'icon_fire', name: 'T≈±z', price: 1500, icon: 'üî•' },
                { id: 'icon_zap', name: 'Vill√°m', price: 1500, icon: '‚ö°' },
                { id: 'icon_ice', name: 'H√≥pehely', price: 1500, icon: '‚ùÑÔ∏è' },
                { id: 'icon_yin_yang', name: 'Jin-Jang', price: 1800, icon: '‚òØÔ∏è' },
                { id: 'icon_peace', name: 'B√©ke', price: 1800, icon: '‚òÆÔ∏è' },
                { id: 'icon_moon', name: 'Hold', price: 2000, icon: 'üåô' },
                { id: 'icon_sun', name: 'Nap', price: 2000, icon: '‚òÄÔ∏è' },
                { id: 'icon_atom', name: 'Atom', price: 2200, icon: '‚öõÔ∏è' },
                { id: 'icon_biohazard', name: 'Biol√≥giai Vesz√©ly', price: 2500, icon: '‚ò£Ô∏è' },
                { id: 'icon_radioactive', name: 'Sug√°rz√°s', price: 2500, icon: '‚ò¢Ô∏è' },
                { id: 'icon_controller', name: 'Kontroller', price: 2800, icon: 'üéÆ' },
                { id: 'icon_joystick', name: 'Joystick', price: 2800, icon: 'üïπÔ∏è' },
                { id: 'icon_key', name: 'Kulcs', price: 2900, icon: 'üîë' },
                { id: 'icon_knight', name: 'Husz√°r', price: 3000, icon: '‚ôò' },
                { id: 'icon_swords', name: 'Kardok', price: 3000, icon: '‚öîÔ∏è' },
                { id: 'icon_shield', name: 'Pajzs', price: 3000, icon: 'üõ°Ô∏è' },
                { id: 'icon_bomb', name: 'Bomba', price: 3200, icon: 'üí£' },
                { id: 'icon_magnet', name: 'M√°gnes', price: 3300, icon: 'üß≤' },
                { id: 'icon_target', name: 'C√©lt√°bla', price: 3500, icon: 'üéØ' },
                { id: 'icon_rocket', name: 'Rak√©ta', price: 3800, icon: 'üöÄ' },
                { id: 'icon_ufo', name: 'UFO', price: 4000, icon: 'üõ∏' },
                { id: 'icon_alien', name: 'Alien', price: 4000, icon: 'üëΩ' },
                { id: 'icon_ghost', name: 'Szellem', price: 4200, icon: 'üëª' },
                { id: 'icon_skull', name: 'Koponya', price: 4500, icon: 'üíÄ' },
                { id: 'icon_robot', name: 'Robot', price: 4800, icon: 'ü§ñ' },
                { id: 'icon_ninja', name: 'Nindzsa', price: 5000, icon: 'ü•∑' },
                { id: 'icon_wizard', name: 'Var√°zsl√≥', price: 5500, icon: 'üßô' },
                { id: 'icon_crown', name: 'Korona', price: 6000, icon: 'üëë' },
                { id: 'icon_gem', name: 'Dr√°gak≈ë', price: 7000, icon: 'üíé' },
                { id: 'icon_trophy', name: 'Tr√≥fea', price: 8000, icon: 'üèÜ' },
                { id: 'icon_money_bag', name: 'P√©nzes Zs√°k', price: 9000, icon: 'üí∞' },
                { id: 'icon_comet', name: '√úst√∂k√∂s', price: 10000, icon: '‚òÑÔ∏è' },
                { id: 'icon_dragon', name: 'S√°rk√°ny', price: 12000, icon: 'üê≤' },
                { id: 'icon_unicorn', name: 'Unikornis', price: 15000, icon: 'ü¶Ñ' },
                { id: 'icon_phoenix', name: 'F≈ënix', price: 20000, icon: 'ü¶ö' },
                { id: 'icon_d20', name: 'D20 Kocka', price: 25000, icon: 'üé≤' },
                { id: 'icon_black_hole', name: 'Fekete Lyuk', price: 30000, icon: '‚ö´' },
                { id: 'icon_infinity', name: 'V√©gtelen', price: 50000, icon: '‚ôæÔ∏è' },
            ]
        };

        const avatars = [ 'https://api.dicebear.com/8.x/personas/svg?seed=Garfield', 'https://api.dicebear.com/8.x/personas/svg?seed=Harley&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Sophie', 'https://api.dicebear.com/8.x/personas/svg?seed=Leo&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Luna', 'https://api.dicebear.com/8.x/personas/svg?seed=Max&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Zoe', 'https://api.dicebear.com/8.x/personas/svg?seed=Felix&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Chloe', 'https://api.dicebear.com/8.x/personas/svg?seed=Oscar&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Mia', 'https://api.dicebear.com/8.x/personas/svg?seed=Jasper&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Isabella', 'https://api.dicebear.com/8.x/personas/svg?seed=Arthur&backgroundColor=b6e3f4,c0aede,d1d4f9', 'https://api.dicebear.com/8.x/personas/svg?seed=Evelyn' ];
        
        function initializeAvatars() { uiElements.avatarGrid.innerHTML = ''; avatars.forEach((url, index) => { const avatarEl = document.createElement('div'); avatarEl.classList.add('avatar-option'); avatarEl.style.backgroundImage = `url(${url})`; avatarEl.addEventListener('click', () => { document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected')); avatarEl.classList.add('selected'); selectedAvatar = url; }); uiElements.avatarGrid.appendChild(avatarEl); if (index === 0) avatarEl.click(); }); }
        
        const showLoading = (message) => { uiElements.loadingOverlay.textContent = message; uiElements.loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => uiElements.loadingOverlay.classList.add('hidden');
        const generateSpectatorCode = () => String(Math.floor(Math.random() * 90) + 10);
        
        uiElements.playerNameInput.addEventListener('change', async (e) => { 
            const playerName = e.target.value.trim(); 
            loggedInPlayerName = playerName;
            if (playerName === '0000') {
                await getOrCreatePlayer(playerName);
                openDevPanel();
            } else if(playerName) { 
                await getOrCreatePlayer(playerName); 
            } else { 
                loggedInPlayerName = null;
                uiElements.playerWallet.classList.add('hidden'); 
                uiElements.shopBtn.classList.add('hidden'); 
                uiElements.dailyBonusBtn.classList.add('hidden');
            } 
        });

        async function getOrCreatePlayer(playerName) {
            if (!playerName) return null;
            showLoading("J√°t√©kosadatok bet√∂lt√©se...");
            const playerRef = doc(db, 'users', playerName);
            const playerSnap = await getDoc(playerRef);

            if (playerSnap.exists()) {
                localPlayerData = playerSnap.data();
                await updateDoc(playerRef, { lastLogin: serverTimestamp() });
            } else {
                localPlayerData = {
                    money: 1000,
                    inventory: { backgrounds: ["bg_default"], icons: ["icon_default"] },
                    equipped: { background: "bg_default", icon: "icon_default" },
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    lastBonusClaimed: null
                };
                await setDoc(playerRef, localPlayerData);
            }
            if (!localPlayerData.inventory) localPlayerData.inventory = { backgrounds: ['bg_default'], icons: ['icon_default'] };
            if (!localPlayerData.inventory.backgrounds) localPlayerData.inventory.backgrounds = ['bg_default'];
            if (!localPlayerData.inventory.icons) localPlayerData.inventory.icons = ['icon_default'];
            if (!localPlayerData.equipped) localPlayerData.equipped = { background: 'bg_default', icon: 'icon_default' };

            updatePlayerUI();
            checkDailyBonusStatus();
            hideLoading();
        }

        function updatePlayerUI() {
            if (!localPlayerData) return;
            uiElements.playerMoney.textContent = localPlayerData.money;
            uiElements.shopMoney.textContent = localPlayerData.money;
            uiElements.playerWallet.classList.remove('hidden');
            uiElements.shopBtn.classList.remove('hidden');
            uiElements.dailyBonusBtn.classList.remove('hidden');

            const playerPanel = localPlayerSymbol === 'X' ? uiElements.playerXPanel : (localPlayerSymbol === 'O' ? uiElements.playerOPanel : null);
            if(playerPanel) {
                applyEquippedItems(playerPanel, localPlayerSymbol);
            }
        }

        function applyEquippedItems(panelElement, playerSymbol) {
            if (!panelElement || !localPlayerData) return;
            const bgId = localPlayerData.equipped.background;
            const iconId = localPlayerData.equipped.icon;
            
            const bgItem = SHOP_ITEMS.backgrounds.find(item => item.id === bgId);
            if (bgItem) {
                panelElement.style.background = bgItem.style;
                panelElement.style.backgroundSize = 'cover';
                panelElement.style.backgroundPosition = 'center';
            }
            
            const iconItem = SHOP_ITEMS.icons.find(item => item.id === iconId);
            const iconElement = playerSymbol === 'X' ? uiElements.playerXIcon : uiElements.playerOIcon;
            if (iconItem && iconElement) {
                iconElement.textContent = iconItem.icon;
            }
        }
        
        function validateInputs(isSpectator = false) { 
            if(isSpectator) { 
                const spectatorName = uiElements.spectatorNameInput.value.trim(); 
                if (!spectatorName) { alert('K√©rlek, add meg a neved!'); return false; } 
                return spectatorName; 
            } 
            const playerName = uiElements.playerNameInput.value.trim(); 
            if (!playerName) { alert('K√©rlek, adj meg egy j√°t√©kosnevet!'); return false; } 
            if (!selectedAvatar) { alert('K√©rlek, v√°lassz egy avat√°rt!'); return false; } 
            return playerName; 
        }
        
        function toggleSpectatorMode(show) { isSpectatorMode = show; uiElements.playerOptions.classList.toggle('hidden', show); uiElements.playerButtons.classList.toggle('hidden', show); uiElements.spectatorOptions.classList.toggle('hidden', !show); uiElements.spectatorButtons.classList.toggle('hidden', !show); }
        uiElements.spectateModeBtn.addEventListener('click', () => toggleSpectatorMode(true));
        uiElements.cancelSpectateBtn.addEventListener('click', () => toggleSpectatorMode(false));

        async function generateUniqueGameCode() { let gameCode; let isUnique = false; let attempts = 0; while (!isUnique && attempts < 20) { gameCode = String(Math.floor(1000 + Math.random() * 9000)); const q = query(collection(db, "games"), where("gameCode", "==", gameCode), where("status", "==", "waiting"), limit(1)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { isUnique = true; } else { attempts++; } } if (!isUnique) { throw new Error("Nem siker√ºlt egyedi j√°t√©k k√≥dot gener√°lni."); } return gameCode; }

        async function createGame(name, options) {
            const { isSingle = false, aiPersonality, aiDifficulty } = options;
            try {
                const wagerInputId = isSingle ? 'aiWagerInput' : 'mpWagerInput';
                const wager = parseInt(document.getElementById(wagerInputId).value) || 0;
                if (wager < 0) { alert("A t√©t nem lehet negat√≠v!"); return; }
                if (localPlayerData.money < wager) { alert("Nincs el√©g p√©nzed a t√©trak√°shoz!"); return; }

                showLoading("J√°t√©k l√©trehoz√°sa...");

                const gameRef = doc(collection(db, 'games'));
                const gameCode = isSingle ? null : await generateUniqueGameCode();
                const spectatorCode = generateSpectatorCode();
                let playerO = { name: null, avatar: null, icon: 'icon_default' };

                if(isSingle) {
                    document.body.dataset.difficulty = aiDifficulty;
                    if(aiPersonality === 'karesz') { playerO = { name: "Koczka<br>Karesz", avatar: aiMoodAvatars.karesz.default, icon: 'icon_knight' }; } 
                    else if (aiPersonality === 'pikszel') { playerO = { name: "Pikszel<br>Panna", avatar: aiMoodAvatars.pikszel.default, icon: 'icon_ghost' }; }
                } else { document.body.removeAttribute('data-difficulty'); }

                const initialGameState = {
                    board: Array(BOARD_SIZE * BOARD_SIZE).fill(null),
                    players: { X: { name, avatar: selectedAvatar, icon: localPlayerData.equipped.icon }, O: playerO },
                    currentPlayer: 'X', status: isSingle ? 'active' : 'waiting', scores: { X: 0, O: 0 },
                    winner: null, createdAt: serverTimestamp(), lastMove: null, winningLine: null, spectatorCode,
                    isSinglePlayer: isSingle, aiPersonality: aiPersonality ?? null, aiDifficulty: aiDifficulty ?? null,
                    moveCount: 0, gameCode, wager: wager, payoutComplete: false
                };
                
                if (wager > 0) {
                    const playerRef = doc(db, 'users', name);
                    await updateDoc(playerRef, { money: increment(-wager) });
                    localPlayerData.money -= wager;
                    updatePlayerUI();
                }

                await setDoc(gameRef, initialGameState);
                attachGameListener(gameRef.id, 'X');
            } catch (error) { console.error("Hiba a j√°t√©k l√©trehoz√°sa sor√°n:", error); alert("Hiba t√∂rt√©nt a j√°t√©k l√©trehoz√°sa k√∂zben."); } 
            finally { hideLoading(); }
        }

        uiElements.startAIGameBtn.addEventListener('click', () => { const playerName = validateInputs(); if (!playerName) return; if(!localPlayerData) { alert("J√°t√©kosadatok bet√∂lt√©se folyamatban..."); return; } const aiPersonality = document.querySelector('input[name="aiPersonality"]:checked').value; const aiDifficulty = document.querySelector('input[name="aiDifficulty"]:checked').value; createGame(playerName, { isSingle: true, aiPersonality, aiDifficulty }); });
        uiElements.createGameBtn.addEventListener('click', () => { const playerName = validateInputs(); if (!playerName) return; if(!localPlayerData) { alert("J√°t√©kosadatok bet√∂lt√©se folyamatban..."); return; } createGame(playerName, { isSingle: false }); });
        
        uiElements.joinGameBtn.addEventListener('click', async () => {
            const playerName = validateInputs();
            if (!playerName || !localPlayerData) return;
            const gameIdToJoin = uiElements.gameIdInput.value.trim();
            if (!gameIdToJoin) { alert('K√©rlek, adj meg egy j√°t√©k k√≥dot!'); return; }
            
            showLoading("Csatlakoz√°s a j√°t√©khoz...");
            try {
                const q = query(collection(db, "games"), where("gameCode", "==", gameIdToJoin), where("status", "==", "waiting"), limit(1));
                const querySnapshot = await getDocs(q);
        
                if (!querySnapshot.empty) {
                    const gameDoc = querySnapshot.docs[0];
                    const gameData = gameDoc.data();
                    const wager = gameData.wager || 0;
                    if (localPlayerData.money < wager) { alert(`Nincs el√©g p√©nzed a csatlakoz√°shoz! A t√©t: ${wager} FT.`); hideLoading(); return; }

                    if (gameData.players.X.name !== playerName) {
                        if (wager > 0) {
                            const playerRef = doc(db, 'users', playerName);
                            await updateDoc(playerRef, { money: increment(-wager) });
                            localPlayerData.money -= wager;
                            updatePlayerUI();
                        }
                        const updates = { 'players.O.name': playerName, 'players.O.avatar': selectedAvatar, 'players.O.icon': localPlayerData.equipped.icon, 'status': 'active' };
                        await updateDoc(doc(db, 'games', gameDoc.id), updates);
                        attachGameListener(gameDoc.id, 'O');
                    } else { alert("Nem csatlakozhatsz a saj√°t j√°t√©kodhoz!"); }
                } else { alert('Nem tal√°lhat√≥ nyitott j√°t√©k ezzel a k√≥ddal.'); }
            } catch (error) { console.error("Hiba a csatlakoz√°s sor√°n:", error); alert("Hiba t√∂rt√©nt a j√°t√©khoz val√≥ csatlakoz√°s k√∂zben."); } 
            finally { hideLoading(); }
        });

        uiElements.joinAsSpectatorBtn.addEventListener('click', async () => { 
            const spectatorName = validateInputs(true); 
            if (!spectatorName) return; 
            const spectatorCode = uiElements.spectatorCodeInput.value.trim(); 
            if (!spectatorCode || spectatorCode.length !== 2) { alert('K√©rlek, adj meg egy √©rv√©nyes, 2 jegy≈± k√≥dot!'); return; } 
            showLoading("J√°t√©k keres√©se..."); 
            try {
                const q = query(collection(db, "games"), 
                    where("spectatorCode", "==", spectatorCode), 
                    where("status", "in", ["waiting", "active"]),
                    orderBy("createdAt", "desc"),
                    limit(1)
                );
                const querySnapshot = await getDocs(q); 
                if (querySnapshot.empty) { 
                    alert('Nem tal√°lhat√≥ akt√≠v j√°t√©k ezzel a leskel≈ëd≈ë k√≥ddal.'); 
                    return; 
                } 
                const gameDoc = querySnapshot.docs[0]; 
                attachGameListener(gameDoc.id, 'spectator'); 
            } catch (error) {
                console.error("Leskel≈ëd√©s hiba:", error);
                alert("Hiba t√∂rt√©nt a j√°t√©k keres√©se k√∂zben. Val√≥sz√≠n≈±leg a Firebase index m√©g nem k√©sz√ºlt el. L√°sd a konzolt.");
            } finally {
                hideLoading();
            }
        });

        function setupPresence(gameId, name) { spectatorPresenceRef = ref(rtdb, `presence/${gameId}/${name}`); const connectedRef = ref(rtdb, '.info/connected'); onValue(connectedRef, (snap) => { if (snap.val() === true) { set(spectatorPresenceRef, true); onDisconnect(spectatorPresenceRef).remove(); } }); }
        function listenForSpectators(gameId) { const spectatorsRef = ref(rtdb, `presence/${gameId}`); onValue(spectatorsRef, (snapshot) => { activeSpectators = snapshot.val() || {}; updateSpectatorListUI(); }); }
        function updateSpectatorListUI() { const spectatorNames = Object.keys(activeSpectators); if (spectatorNames.length > 0) { uiElements.spectatorList.innerHTML = `Kukkol√≥k: üëÅÔ∏è <span>${spectatorNames.join(', ')}</span>`; } else { uiElements.spectatorList.innerHTML = ''; } }

        function attachGameListener(gameId, role) {
            currentGameId = gameId; localPlayerSymbol = role; 
            if (role !== 'spectator') updatePlayerUI();
            if (role === 'spectator') setupPresence(gameId, loggedInPlayerName);
            listenForSpectators(gameId); 
            if (unsubscribeFromGame) unsubscribeFromGame(); 
            unsubscribeFromGame = onSnapshot(doc(db, 'games', currentGameId), (doc) => { 
                if (!doc.exists()) { window.location.reload(); return; } 
                const gameState = doc.data(); 
                localGameState = gameState; 
                isSinglePlayer = gameState.isSinglePlayer; 
                if (['active', 'finished', 'waiting'].includes(gameState.status)) { 
                    uiElements.lobbyContainer.classList.add('hidden'); 
                    uiElements.gameContainer.classList.remove('hidden'); 
                    renderGame(gameState); 
                } 
            }); 
        }
        
        async function handleCellClick(index) {
            const gs = localGameState;
            if (localPlayerSymbol === 'spectator' || gs.board[index] || gs.status !== 'active' || gs.currentPlayer !== localPlayerSymbol) return;
            uiElements.sounds.place.play().catch(e => {});
            const gameRef = doc(db, 'games', currentGameId);
            let board = [...gs.board];
            board[index] = localPlayerSymbol;
            let updates = { board, lastMove: index, moveCount: gs.moveCount + 1 };
            const winningLine = checkForWin(index, board, localPlayerSymbol);
            if (winningLine) {
                updates.status = 'finished';
                updates.winner = localPlayerSymbol;
                updates.winningLine = winningLine;
                updates[`scores.${localPlayerSymbol}`] = gs.scores[localPlayerSymbol] + 1;
            } else if (board.every(cell => cell)) {
                updates.status = 'finished';
                updates.winner = 'draw';
            } else {
                updates.currentPlayer = localPlayerSymbol === 'X' ? 'O' : 'X';
            }
            
            await updateDoc(gameRef, updates);

            if (updates.status !== 'finished' && gs.isSinglePlayer && updates.currentPlayer === 'O') {
                aiMove();
            }
        }
        
        async function aiMove() {
            if (localGameState.status !== 'active' || localGameState.currentPlayer !== 'O') return;
            uiElements.statusText.textContent = `${localGameState.players.O.name.replace(/<br>/g, ' ')} gondolkodik...`;
            await new Promise(resolve => setTimeout(resolve, Math.floor(Math.random() * 800) + 700));
            const currentSnap = await getDoc(doc(db, 'games', currentGameId));
            if (!currentSnap.exists() || currentSnap.data().currentPlayer !== 'O') return;
            const gs = currentSnap.data();
            const gameRef = doc(db, 'games', currentGameId);
            let board = [...gs.board];
            const bestMove = findBestMove(board, gs.aiDifficulty);
            if(bestMove === -1) return; 
            uiElements.sounds.place.play().catch(e => {});
            board[bestMove] = 'O';
            let updates = { board: board, lastMove: bestMove, moveCount: gs.moveCount + 1 };
            const winningLine = checkForWin(bestMove, board, 'O');
            if (winningLine) {
                updates.status = 'finished';
                updates.winner = 'O';
                updates.winningLine = winningLine;
                updates['scores.O'] = gs.scores.O + 1;
            } else if (board.every(cell => cell)) {
                updates.status = 'finished';
                updates.winner = 'draw';
            } else {
                updates.currentPlayer = 'X';
            }
            await updateDoc(gameRef, updates);
        }

        function findBestMove(board, difficulty) { const emptyCells = board.map((val, idx) => val === null ? idx : -1).filter(idx => idx !== -1); if (emptyCells.length === 0) return -1; if (emptyCells.length >= (BOARD_SIZE * BOARD_SIZE - 2)) { const center = Math.floor(BOARD_SIZE * BOARD_SIZE / 2); if(board[center] === null) return center; const nearCenterCandidates = [center-1, center+1, center-BOARD_SIZE, center+BOARD_SIZE]; for(const move of nearCenterCandidates){ if(board[move] === null) return move; } return emptyCells[0]; } for (const index of emptyCells) { board[index] = 'O'; if (checkForWin(index, board, 'O')) { board[index] = null; return index; } board[index] = null; } for (const index of emptyCells) { board[index] = 'X'; if (checkForWin(index, board, 'X')) { board[index] = null; return index; } board[index] = null; } if (difficulty === 'easy' && Math.random() < 0.5) { return emptyCells[Math.floor(Math.random() * emptyCells.length)]; } if (difficulty === 'normal' && Math.random() < 0.2) { return emptyCells[Math.floor(Math.random() * emptyCells.length)]; } let bestMove = -1; let maxScore = -Infinity; const candidateMoves = new Set(); board.forEach((cell, index) => { if (cell !== null) { const r = Math.floor(index / BOARD_SIZE); const c = index % BOARD_SIZE; for (let i = -1; i <= 1; i++) { for (let j = -1; j <= 1; j++) { if (i === 0 && j === 0) continue; const nr = r + i; const nc = c + j; if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE) { const newIndex = nr * BOARD_SIZE + nc; if (board[newIndex] === null) candidateMoves.add(newIndex); } } } } }); const movesToEvaluate = candidateMoves.size > 0 ? Array.from(candidateMoves) : emptyCells; for (const move of movesToEvaluate) { board[move] = 'O'; const offensiveScore = evaluateBoardForPlayer(board, 'O'); board[move] = 'X'; const defensiveScore = evaluateBoardForPlayer(board, 'X'); board[move] = null; const scoreMultiplier = (difficulty === 'genius' || difficulty === 'hard') ? 1.1 : 1.0; const totalScore = offensiveScore + defensiveScore * scoreMultiplier; if (totalScore > maxScore) { maxScore = totalScore; bestMove = move; } } return bestMove !== -1 ? bestMove : emptyCells[Math.floor(Math.random() * emptyCells.length)]; }
        function evaluateBoardForPlayer(board, player) { let totalScore = 0; const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; const opponent = player === 'X' ? 'O' : 'X'; const patternScores = { FIVE: 100000, OPEN_FOUR: 10000, HALF_FOUR: 1000, OPEN_THREE: 500, HALF_THREE: 100, OPEN_TWO: 10, HALF_TWO: 1 }; for (let r = 0; r < BOARD_SIZE; r++) { for (let c = 0; c < BOARD_SIZE; c++) { if (board[r * BOARD_SIZE + c] !== player) continue; for (const [dr, dc] of directions) { let line = []; for (let i = 0; i < 5; i++) { const nr = r + i * dr; const nc = c + i * dc; if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE) { line.push(board[nr * BOARD_SIZE + nc]); } else { line.push(opponent); } } const before_r = r - dr; const before_c = c - dc; let before_cell = opponent; if (before_r >= 0 && before_r < BOARD_SIZE && before_c >= 0 && before_c < BOARD_SIZE) { before_cell = board[before_r * BOARD_SIZE + before_c]; } let myPieces = line.filter(p => p === player).length; let emptyOrMyPieces = line.filter(p => p === player || p === null).length; if (emptyOrMyPieces < 5) continue; if (myPieces === 5) { totalScore += patternScores.FIVE; continue; } if (myPieces === 4) { if(before_cell === null && line[4] === null) totalScore += patternScores.OPEN_FOUR; else if (before_cell === null || line[4] === null) totalScore += patternScores.HALF_FOUR; } if (myPieces === 3) { if(before_cell === null && line[3] === null) totalScore += patternScores.OPEN_THREE; else if (before_cell === null || line[3] === null) totalScore += patternScores.HALF_THREE; } if (myPieces === 2) { if(before_cell === null && line[2] === null) totalScore += patternScores.OPEN_TWO; else if (before_cell === null || line[2] === null) totalScore += patternScores.HALF_TWO; } } } } return totalScore; }
        
        uiElements.startRematchBtn.addEventListener('click', async () => {
            if (localPlayerSymbol === 'spectator' || localPlayerSymbol !== 'X') return;

            const newWager = parseInt(document.getElementById('rematchWagerInput').value) || 0;
            if (newWager < 0) { alert("A t√©t nem lehet negat√≠v!"); return; }

            const playerXName = localGameState.players.X.name;
            const playerOName = localGameState.players.O.name.replace(/<br>/g, ' ');

            try {
                showLoading("Revans ind√≠t√°sa...");
                const playerXDoc = await getDoc(doc(db, 'users', playerXName));
                if (playerXDoc.data().money < newWager) {
                    alert(`${playerXName} nem rendelkezik el√©g p√©nzzel az √∫j t√©thez!`); return;
                }
                
                if (!localGameState.isSinglePlayer) {
                    const playerODoc = await getDoc(doc(db, 'users', playerOName));
                    if (playerODoc.data().money < newWager) {
                        alert(`${playerOName} nem rendelkezik el√©g p√©nzzel az √∫j t√©thez!`); return;
                    }
                    await updateDoc(doc(db, 'users', playerOName), { money: increment(-newWager) });
                }
                await updateDoc(doc(db, 'users', playerXName), { money: increment(-newWager) });

                await getOrCreatePlayer(loggedInPlayerName);

                const gameRef = doc(db, 'games', currentGameId);
                const updates = { 
                    board: Array(BOARD_SIZE * BOARD_SIZE).fill(null), status: 'active', winner: null, 
                    currentPlayer: 'X', lastMove: null, winningLine: null, moveCount: 0, 
                    payoutComplete: false, wager: newWager
                };
                await updateDoc(gameRef, updates);

            } catch(e) { console.error("Hiba a t√©t levon√°sakor:", e); alert("Hiba t√∂rt√©nt a revans ind√≠t√°sakor!"); } 
            finally { hideLoading(); }
        });
        
        async function handlePayout(gameState) {
            if (gameState.payoutComplete || !gameState.wager || gameState.wager <= 0) return;
            const gameRef = doc(db, 'games', currentGameId);
            const { winner, players, wager, isSinglePlayer } = gameState;
            if (winner === 'draw') {
                const playerXRef = doc(db, 'users', players.X.name);
                await updateDoc(playerXRef, { money: increment(wager) });
                if (!isSinglePlayer && players.O.name) {
                    const playerORef = doc(db, 'users', players.O.name.replace(/<br>/g, ' '));
                    await updateDoc(playerORef, { money: increment(wager) });
                }
            } else if (winner) {
                const pot = wager * 2;
                const winnerName = players[winner].name.replace(/<br>/g, ' ');
                if (!winnerName.includes("(AI)")) {
                    const winnerRef = doc(db, 'users', winnerName);
                    await updateDoc(winnerRef, { money: increment(pot) });
                } else if (winner === 'X') {
                    const playerXRef = doc(db, 'users', players.X.name);
                    await updateDoc(playerXRef, { money: increment(pot) });
                }
            }
            await updateDoc(gameRef, { payoutComplete: true });
            
            if (loggedInPlayerName) {
                const oldMoney = localPlayerData.money;
                await getOrCreatePlayer(loggedInPlayerName);
                const newMoney = localPlayerData.money;
                const moneyElement = players.X.name === loggedInPlayerName ? uiElements.playerXMoney : uiElements.playerOMoney;
                
                if (newMoney !== oldMoney) {
                    moneyElement.classList.add('money-strobe');
                    setTimeout(() => moneyElement.classList.remove('money-strobe'), 1500);
                }
            }
        }
        
        async function renderGame(gameState) {
            const { board, players, scores, currentPlayer, status, winner, winningLine, lastMove, spectatorCode, isSinglePlayer, aiPersonality, moveCount, gameCode, wager } = gameState;
            
            uiElements.spectatorCodeDisplay.textContent = `Leskel≈ëd≈ë K√≥d: ${spectatorCode}`;
            updateSpectatorListUI();
            uiElements.board.innerHTML = '';
            uiElements.board.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;
            const isMyTurn = currentPlayer === localPlayerSymbol;
        
            board.forEach((cellValue, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                if (cellValue) { cell.classList.add(cellValue === 'X' ? 'x-icon' : 'o-icon', 'cell-pop'); }
                if (winningLine && winningLine.includes(index)) { cell.classList.add('winning-cell'); }
                if (lastMove === index) { cell.classList.add('cell-flashed'); cell.addEventListener('animationend', () => cell.classList.remove('cell-flashed'), { once: true }); }
                if (status === 'active' && !cellValue && isMyTurn) { cell.addEventListener('click', () => handleCellClick(index)); } else { cell.classList.add('disabled'); }
                uiElements.board.appendChild(cell);
            });
        
            uiElements.playerXName.innerHTML = players.X.name;
            uiElements.playerOName.innerHTML = players.O.name ? players.O.name.replace(/<br>/g, '<br>') : 'V√°rakoz√°s...';
            uiElements.playerXAvatar.style.backgroundImage = `url(${players.X.avatar})`;
            if(players.O.avatar) { uiElements.playerOAvatar.style.backgroundImage = `url(${players.O.avatar})`; }
            
            if (localPlayerData && players.X.name === loggedInPlayerName) {
                applyEquippedItems(uiElements.playerXPanel, 'X');
                uiElements.playerXMoney.textContent = `Egyenleg: ${localPlayerData.money} FT`;
                uiElements.playerXProjection.innerHTML = `Nyer: ${localPlayerData.money + wager*2} FT | Vesz√≠t: ${localPlayerData.money} FT`;
            }

            if (!isSinglePlayer && players.O.name) {
                 getDoc(doc(db, "users", players.O.name.replace(/<br>/g, ' '))).then(opponentDoc => {
                     if (opponentDoc.exists()) {
                         const opponentData = opponentDoc.data();
                         if (players.O.name === loggedInPlayerName) {
                             applyEquippedItems(uiElements.playerOPanel, 'O');
                             uiElements.playerOMoney.textContent = `Egyenleg: ${opponentData.money} FT`;
                             uiElements.playerOProjection.innerHTML = `Nyer: ${opponentData.money + wager*2} FT | Vesz√≠t: ${opponentData.money} FT`;
                         } else {
                            uiElements.playerOMoney.textContent = `Egyenleg: ${opponentData.money} FT`;
                            uiElements.playerOProjection.innerHTML = `Nyer: ${opponentData.money + wager*2} FT | Vesz√≠t: ${opponentData.money} FT`;
                         }
                     }
                 });
            } else {
                 uiElements.playerOMoney.textContent = '';
                 uiElements.playerOProjection.innerHTML = '';
            }

            uiElements.playerXIcon.textContent = SHOP_ITEMS.icons.find(i => i.id === players.X.icon)?.icon || '';
            uiElements.playerOIcon.textContent = SHOP_ITEMS.icons.find(i => i.id === players.O.icon)?.icon || '';
            uiElements.gameWagerDisplay.textContent = `T√©t: ${wager || 0} FT`;

            uiElements.scoreX.textContent = scores.X;
            uiElements.scoreO.textContent = scores.O;
            uiElements.playerXPanel.classList.toggle('active', currentPlayer === 'X' && status === 'active');
            uiElements.playerOPanel.classList.toggle('active', currentPlayer === 'O' && status === 'active');
        
            if (status === 'waiting') {
                uiElements.statusText.textContent = `V√°rakoz√°s a m√°sik j√°t√©kosra... A t√©t: ${wager} FT`;
                uiElements.gameCodeDisplay.classList.remove('hidden');
                uiElements.gameCodeText.textContent = gameCode;
                uiElements.rematchControls.classList.add('hidden');
            } else { uiElements.gameCodeDisplay.classList.add('hidden'); }
        
            if (status === 'active') { 
                uiElements.statusText.textContent = localPlayerSymbol === 'spectator' ? `${players[currentPlayer].name.replace(/<br>/g, ' ')} k√∂vetkezik...` : (isMyTurn ? 'Te k√∂vetkezel!' : `${players[currentPlayer].name.replace(/<br>/g, ' ')} k√∂vetkezik...`); 
                uiElements.rematchControls.classList.add('hidden');
            } 
            else if (status === 'finished') {
                handlePayout(gameState);
                if(localPlayerSymbol !== 'spectator' && (players.X.name === loggedInPlayerName || players.O.name.replace(/<br>/g, ' ') === loggedInPlayerName)) {
                    uiElements.rematchControls.classList.remove('hidden');
                    document.getElementById('rematchWagerInput').value = wager;
                    uiElements.startRematchBtn.disabled = localPlayerSymbol !== 'X';
                }

                let message = '';
                if (isSinglePlayer) {
                    updateStats(winner, aiPersonality);
                    const aiName = players.O.name.replace(/<br>/g, ' ');
                    let quote = '';
                    if (winner === 'O') {
                        quote = aiPersonality === 'karesz' ? dailyKareszWinQuotes.shift() : dailyPikszelWinQuotes.shift();
                        if (aiPersonality === 'karesz') dailyKareszWinQuotes.push(quote); else dailyPikszelWinQuotes.push(quote);
                        message = `${aiName} nyert! √úzenete: "${quote}"`;
                    } else if (winner === 'X') {
                        quote = aiPersonality === 'karesz' ? dailyKareszLossQuotes.shift() : dailyPikszelLossQuotes.shift();
                        if (aiPersonality === 'karesz') dailyKareszLossQuotes.push(quote); else dailyPikszelLossQuotes.push(quote);
                        message = `Nyert√©l ${wager * 2} FT-ot! ${aiName} √ºzenete: "${quote}"`;
                    } else {
                        quote = aiPersonality === 'karesz' ? dailyKareszDrawQuotes.shift() : dailyPikszelDrawQuotes.shift();
                        if (aiPersonality === 'karesz') dailyKareszDrawQuotes.push(quote); else dailyPikszelDrawQuotes.push(quote);
                        message = `D√∂ntetlen! Visszakaptad a t√©ted. ${aiName} √ºzenete: "${quote}"`;
                    }
                } else { message = winner === 'draw' ? 'D√∂ntetlen! Mindenki visszakapja a t√©tj√©t.' : `${players[winner].name.replace(/<br>/g, ' ')} nyert ${wager * 2} FT-ot!`; }
                uiElements.statusText.textContent = message;
                if(winner !== 'draw' && winner === localPlayerSymbol) { uiElements.sounds.win.play().catch(e => {}); triggerVictoryConfetti(); }
            }
        }

        function showRules() { const rulesWindow = window.open('', '_blank'); rulesWindow.document.write(`<html><head><title>Am≈ëba Pro Online - Szab√°lyzat</title><style>body{font-family:'Montserrat',sans-serif;background:linear-gradient(135deg,#2c3e50,#1a2937);color:#ecf0f1;padding:30px;line-height:1.6}.container{max-width:800px;margin:auto;background:rgba(26,41,55,.7);padding:20px 40px;border-radius:15px;border:1px solid rgba(129,140,162,.2)}h1,h2,h3{color:#3498db;font-family:'Orbitron',sans-serif}h1{text-align:center;margin-bottom:20px}h2{border-bottom:2px solid #3e5369;padding-bottom:5px;margin-top:30px}h3{color:#e67e22;margin-top:20px}ul{padding-left:20px}li{margin-bottom:10px}code{background:#1c2b3a;padding:2px 6px;border-radius:5px;font-family:'Orbitron',sans-serif;color:#f1c40f}p{color:#bdc3c7}strong{color:#ecf0f1}</style></head><body><div class="container"><h1>Am≈ëba Pro Online - R√©szletes J√°t√©kszab√°lyzat</h1><h2>Bevezet√©s</h2><p>√údv√∂zl√ºnk az Am≈ëba Pro Online vil√°g√°ban! A j√°t√©k c√©lja, hogy els≈ëk√©nt tegy√©l le √∂t saj√°t jelet (X vagy O) egy megszak√≠t√°s n√©lk√ºli, egybef√ºgg≈ë vonalban a 15x15-√∂s j√°t√©kt√°bl√°n.</p><h2>P√©nz √©s T√©tek</h2><p>A j√°t√©kban <code>FT</code>-ot (j√°t√©kp√©nzt) gy≈±jthetsz. Minden √∫j j√°t√©kos 1000 FT kezd≈ët≈ëk√©vel indul.</p><ul><li><b>T√©trak√°s:</b> Minden j√°t√©k el≈ëtt megadhatsz egy t√©tet. A gy≈ëztes megkapja a teljes potot (a k√©t t√©t √∂sszeg√©t). D√∂ntetlen eset√©n mindk√©t j√°t√©kos visszakapja a saj√°t t√©tj√©t.</li></ul><h2>Bolt √©s Testreszab√°s</h2><p>Az √∂sszegy≈±jt√∂tt p√©nzedb≈ël a "Bolt" men√ºpontban v√°s√°rolhatsz h√°ttereket a j√°t√©kos paneledre √©s ikonokat a neved mell√©. A megv√°s√°rolt elemeket a boltban tudod "felszerelni".</p><h2>J√°t√©km√≥dok</h2><p>J√°tssz AI ellen vagy egy bar√°toddal online. A t√∂bbj√°t√©kos m√≥dhoz oszd meg a <code>J√°t√©k K√≥dot</code> a partnereddel.</p><h2>Leskel≈ëd√©s</h2><p>Minden j√°t√©knak van egy k√©tjegy≈± <code>Leskel≈ëd≈ë K√≥dja</code>, amivel n√©z≈ëk√©nt csatlakozhatsz.</p><p style="text-align:center;margin-top:30px">J√≥ sz√≥rakoz√°st k√≠v√°nunk!</p></div></body></html>`); rulesWindow.document.close(); }
        uiElements.rulesLink.addEventListener('click', showRules);
        
        uiElements.copyCodeBtn.addEventListener('click', () => { navigator.clipboard.writeText(localGameState.gameCode).then(() => { uiElements.copyCodeBtn.textContent = 'M√°solva!'; setTimeout(() => { uiElements.copyCodeBtn.textContent = 'M√°sol√°s'; }, 2000); }); });
        function triggerVictoryConfetti() { const duration = 3 * 1000, animationEnd = Date.now() + duration; function randomInRange(min, max) { return Math.random() * (max - min) + min; } const interval = setInterval(function() { const timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(interval); } const particleCount = 50 * (timeLeft / duration); const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }; confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0, 0.1), y: Math.random() } })); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.9, 1), y: Math.random() } })); }, 250); }
        function checkForWin(index, board, player) { if(index === null) return false; const col = index % BOARD_SIZE, row = Math.floor(index / BOARD_SIZE); const directions = [[0, 1], [1, 0], [1, 1], [1, -1]]; for (const [dx, dy] of directions) { let line = [index]; for (let i=1;i<5;i++) { const r=row+i*dy, c=col+i*dx, idx=r*BOARD_SIZE+c; if (r>=0&&r<BOARD_SIZE&&c>=0&&c<BOARD_SIZE&&board[idx]===player) line.push(idx); else break; } for (let i=1;i<5;i++) { const r=row-i*dy, c=col-i*dx, idx=r*BOARD_SIZE+c; if (r>=0&&r<BOARD_SIZE&&c>=0&&c<BOARD_SIZE&&board[idx]===player) line.push(idx); else break; } if (line.length>=5) return line; } return false; }
        
        function getStats() { return JSON.parse(localStorage.getItem('amobaProStats')) || { karesz: { games: 0, wins: 0, losses: 0, draws: 0, winStreak: 0, bestStreak: 0 }, pikszel: { games: 0, wins: 0, losses: 0, draws: 0, winStreak: 0, bestStreak: 0 }, totalGames: 0, totalWins: 0, totalDraws: 0 }; }
        function updateStats(winner, ai) { if(localPlayerSymbol === 'spectator') return; const stats = getStats(); if (winner !== null) { stats.totalGames++; if (ai) { stats[ai].games++; if (winner === 'X') { stats[ai].wins++; stats.totalWins++; stats[ai].winStreak++; if (stats[ai].winStreak > stats[ai].bestStreak) stats[ai].bestStreak = stats[ai].winStreak; } else if (winner === 'O') { stats[ai].losses++; stats[ai].winStreak = 0; } else { stats[ai].draws++; stats.totalDraws++; stats[ai].winStreak = 0; } } } localStorage.setItem('amobaProStats', JSON.stringify(stats)); }
        function showStats() { const stats = getStats(); document.getElementById('stats-karesz-games').textContent = stats.karesz.games; document.getElementById('stats-karesz-wins').textContent = stats.karesz.wins; document.getElementById('stats-karesz-losses').textContent = stats.karesz.losses; document.getElementById('stats-karesz-draws').textContent = stats.karesz.draws; document.getElementById('stats-karesz-streak').textContent = stats.karesz.winStreak; document.getElementById('stats-karesz-best-streak').textContent = stats.karesz.bestStreak; document.getElementById('stats-pikszel-games').textContent = stats.pikszel.games; document.getElementById('stats-pikszel-wins').textContent = stats.pikszel.wins; document.getElementById('stats-pikszel-losses').textContent = stats.pikszel.losses; document.getElementById('stats-pikszel-draws').textContent = stats.pikszel.draws; document.getElementById('stats-pikszel-streak').textContent = stats.pikszel.winStreak; document.getElementById('stats-pikszel-best-streak').textContent = stats.pikszel.bestStreak; uiElements.statsModal.classList.remove('hidden'); }
        uiElements.statsBtn.addEventListener('click', showStats);
        uiElements.closeStatsBtn.addEventListener('click', () => uiElements.statsModal.classList.add('hidden'));

        function renderShopItems(container, items, category) {
            container.innerHTML = '';
            const categorySingular = category.slice(0, -1);
            items.forEach(item => {
                const isOwned = localPlayerData.inventory[category] && localPlayerData.inventory[category].includes(item.id);
                const isEquipped = localPlayerData.equipped[categorySingular] === item.id;
                
                const itemEl = document.createElement('div');
                itemEl.classList.add('shop-item');
                const previewContent = category === 'icons' ? item.icon : '';
                itemEl.innerHTML = `
                    <div class="shop-item-preview" id="preview-${category}-${item.id}">${previewContent}</div>
                    <h4>${item.name}</h4>
                    <div class="shop-item-price">${item.price > 0 ? `${item.price} FT` : 'Alap'}</div>
                    <div class="shop-item-buttons" id="buttons-${category}-${item.id}"></div>
                `;
                container.appendChild(itemEl);

                const previewEl = document.getElementById(`preview-${category}-${item.id}`);
                if (category === 'backgrounds') {
                    previewEl.style.background = item.style;
                    previewEl.style.backgroundSize = 'cover';
                    previewEl.style.backgroundPosition = 'center';
                    previewEl.onclick = () => {
                        const modalContainer = uiElements.shopModal.querySelector('.modal-container');
                        if (modalContainer.dataset.previewing === item.id) {
                            modalContainer.style.background = '';
                            delete modalContainer.dataset.previewing;
                        } else {
                            modalContainer.style.background = item.style;
                            modalContainer.style.backgroundSize = 'cover';
                            modalContainer.dataset.previewing = item.id;
                        }
                    };
                }

                const buttonContainer = document.getElementById(`buttons-${category}-${item.id}`);
                if(isEquipped) {
                    buttonContainer.innerHTML = `<button class="shop-btn equipped-btn" disabled>Felszerelve</button>`;
                } else if(isOwned) {
                    let buttonsHTML = `<button class="shop-btn equip-btn">Felszerel√©s</button>`;
                    if (item.price > 0) {
                        buttonsHTML += `<button class="shop-btn sell-btn">Elad√°s (${item.price * SELL_RATIO} FT)</button>`;
                    }
                    buttonContainer.innerHTML = buttonsHTML;
                    buttonContainer.querySelector('.equip-btn').onclick = () => equipItem(category, item.id);
                    if (item.price > 0) {
                        buttonContainer.querySelector('.sell-btn').onclick = () => sellItem(category, item);
                    }
                } else {
                    buttonContainer.innerHTML = `<button class="shop-btn buy-btn">V√°s√°rl√°s</button>`;
                    buttonContainer.querySelector('.buy-btn').onclick = () => buyItem(category, item);
                }
            });
        }

        function displayShop() {
            if (!localPlayerData) return;
            renderShopItems(uiElements.shopItemsContainerBgs, SHOP_ITEMS.backgrounds, 'backgrounds');
            renderShopItems(uiElements.shopItemsContainerIcons, SHOP_ITEMS.icons, 'icons');
            uiElements.shopModal.classList.remove('hidden');
        }

        async function buyItem(category, item) {
            if (!loggedInPlayerName) { alert("Hiba: Nincs bejelentkezett j√°t√©kos."); return; }
            if (localPlayerData.money < item.price) { alert('Nincs el√©g p√©nzed!'); return; }
            showLoading('V√°s√°rl√°s...');
            try {
                const playerRef = doc(db, 'users', loggedInPlayerName);
                await updateDoc(playerRef, {
                    money: increment(-item.price),
                    [`inventory.${category}`]: arrayUnion(item.id)
                });
                await getOrCreatePlayer(loggedInPlayerName);
                displayShop();
            } catch (error) { console.error("V√°s√°rl√°si hiba:", error); alert("Hiba t√∂rt√©nt a v√°s√°rl√°s sor√°n."); } 
            finally { hideLoading(); }
        }

        async function equipItem(category, itemId) {
            if (!loggedInPlayerName) { alert("Hiba: Nincs bejelentkezett j√°t√©kos."); return; }
            showLoading('Felszerel√©s...');
            try {
                const categorySingular = category.slice(0, -1);
                const playerRef = doc(db, 'users', loggedInPlayerName);
                await updateDoc(playerRef, { [`equipped.${categorySingular}`]: itemId });
                localPlayerData.equipped[categorySingular] = itemId;
                updatePlayerUI();
                displayShop();
            } catch (error) { console.error("Felszerel√©si hiba:", error); alert("Hiba t√∂rt√©nt a felszerel√©s sor√°n."); } 
            finally { hideLoading(); }
        }
        
        async function sellItem(category, item) {
            if (!loggedInPlayerName) { alert("Hiba: Nincs bejelentkezett j√°t√©kos."); return; }
            const refund = Math.floor(item.price * SELL_RATIO);
            if (!confirm(`Biztosan eladod a(z) "${item.name}" t√°rgyat ${refund} FT-√©rt?`)) return;

            showLoading('Elad√°s...');
            try {
                const categorySingular = category.slice(0, -1);
                const playerRef = doc(db, 'users', loggedInPlayerName);
                
                let updates = {
                    money: increment(refund),
                    [`inventory.${category}`]: arrayRemove(item.id)
                };

                if(localPlayerData.equipped[categorySingular] === item.id) {
                    updates[`equipped.${categorySingular}`] = `${categorySingular}_default`;
                }
                await updateDoc(playerRef, updates);
                await getOrCreatePlayer(loggedInPlayerName);
                displayShop();

            } catch(error) { console.error("Elad√°si hiba:", error); alert("Hiba t√∂rt√©nt az elad√°s sor√°n."); } 
            finally { hideLoading(); }
        }
        
        async function openDevPanel() {
            showLoading("Fejleszt≈ëi panel bet√∂lt√©se...");
            uiElements.devModal.classList.remove('hidden');
            const q = query(collection(db, "users"));
            const querySnapshot = await getDocs(q);
            uiElements.devPanel.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const player = doc.data();
                const playerName = doc.id;
                const itemEl = document.createElement('div');
                itemEl.classList.add('dev-player-item');
                itemEl.innerHTML = `
                    <span>${playerName} (${player.money} FT)</span>
                    <div>
                        <input type="number" id="dev-money-${playerName}" value="10000">
                        <button class="lobby-btn" data-player="${playerName}">P√©nz ad√°sa</button>
                    </div>
                `;
                uiElements.devPanel.appendChild(itemEl);
                itemEl.querySelector('button').addEventListener('click', (e) => {
                    const amount = parseInt(document.getElementById(`dev-money-${playerName}`).value);
                    giveMoney(playerName, amount);
                });
            });
            hideLoading();
        }

        async function giveMoney(playerName, amount) {
            if (!amount || amount <= 0) { alert("√ârv√©nytelen √∂sszeg"); return; }
            await updateDoc(doc(db, 'users', playerName), { money: increment(amount) });
            alert(`${playerName} kapott ${amount} FT-ot.`);
            openDevPanel();
        }

        uiElements.devGiveSelfMoneyBtn.onclick = async () => {
            await giveMoney(loggedInPlayerName, 1000000);
            await getOrCreatePlayer(loggedInPlayerName);
        };

        uiElements.devUnlockAllBtn.onclick = async () => {
            const allBgIds = SHOP_ITEMS.backgrounds.map(item => item.id);
            const allIconIds = SHOP_ITEMS.icons.map(item => item.id);
            await updateDoc(doc(db, 'users', loggedInPlayerName), {
                'inventory.backgrounds': allBgIds,
                'inventory.icons': allIconIds
            });
            alert(`Minden feloldva a(z) ${loggedInPlayerName} nev≈± felhaszn√°l√≥nak.`);
            await getOrCreatePlayer(loggedInPlayerName);
        };

        uiElements.shopBtn.addEventListener('click', displayShop);
        uiElements.closeShopBtn.addEventListener('click', () => {
             const modalContainer = uiElements.shopModal.querySelector('.modal-container');
             modalContainer.style.background = '';
             delete modalContainer.dataset.previewing;
             uiElements.shopModal.classList.add('hidden')
        });
        uiElements.closeDevBtn.addEventListener('click', () => uiElements.devModal.classList.add('hidden'));

        function canClaimDailyBonus() {
            if (!localPlayerData || !localPlayerData.lastBonusClaimed) return true;
            const lastClaimDate = localPlayerData.lastBonusClaimed.toDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            lastClaimDate.setHours(0, 0, 0, 0);
            return lastClaimDate.getTime() < today.getTime();
        }

        function checkDailyBonusStatus() {
            if (canClaimDailyBonus()) {
                uiElements.dailyBonusBtn.classList.add('bonus-ready');
                uiElements.dailyBonusBtn.disabled = false;
            } else {
                uiElements.dailyBonusBtn.classList.remove('bonus-ready');
                uiElements.dailyBonusBtn.disabled = true;
            }
        }
        
        function showDailyBonusModal() {
            const today = new Date();
            const dayOfWeek = (today.getDay() + 6) % 7; // H√©tf≈ë = 0
            const dayNames = ['H', 'K', 'Sze', 'Cs', 'P', 'Szo', 'V'];
            uiElements.dailyBonusWeek.innerHTML = '';
            for(let i = 0; i < 7; i++) {
                const day = new Date();
                day.setDate(today.getDate() - dayOfWeek + i);
                const dayBox = document.createElement('div');
                dayBox.classList.add('day-box');
                dayBox.innerHTML = `
                    <span class="day-name">${dayNames[i]}</span>
                    <span class="day-date">${day.getMonth()+1}.${day.getDate()}</span>
                    <span class="day-reward">üéÅ</span>
                `;
                if (i === dayOfWeek) dayBox.classList.add('today');
                if (i < dayOfWeek || !canClaimDailyBonus() && i === dayOfWeek) dayBox.classList.add('claimed');

                uiElements.dailyBonusWeek.appendChild(dayBox);
            }
            uiElements.claimBonusBtn.disabled = !canClaimDailyBonus();
            uiElements.dailyBonusModal.classList.remove('hidden');
        }

        async function claimDailyBonus() {
            if (!loggedInPlayerName) { alert("Hiba: Nincs bejelentkezett j√°t√©kos."); return; }
            if (!canClaimDailyBonus()) { alert("A mai b√≥nuszt m√°r felvetted!"); return; }
            showLoading("Jutalom j√≥v√°√≠r√°sa...");
            const bonusAmount = Math.floor(Math.random() * 901) + 100;
            const playerRef = doc(db, 'users', loggedInPlayerName);
            await updateDoc(playerRef, {
                money: increment(bonusAmount),
                lastBonusClaimed: serverTimestamp()
            });
            await getOrCreatePlayer(loggedInPlayerName);
            alert(`Sikeresen begy≈±jt√∂tt√©l ${bonusAmount} FT b√≥nuszt!`);
            uiElements.dailyBonusModal.classList.add('hidden');
            checkDailyBonusStatus();
            hideLoading();
        }

        uiElements.dailyBonusBtn.addEventListener('click', showDailyBonusModal);
        uiElements.closeDailyBonusBtn.addEventListener('click', () => uiElements.dailyBonusModal.classList.add('hidden'));
        uiElements.claimBonusBtn.addEventListener('click', claimDailyBonus);

        const ACHIEVEMENTS_LIST = { 'first_win':{title:'Az Els≈ë L√©p√©s',icon:'üèÜ'},'first_loss':{title:'A Kezdeti Sokk',icon:'ü§ï'},'karesz_win_1':{title:'Logikai Laposvas',icon:'üîß'},'pikszel_win_1':{title:'Piksel-Pacsi',icon:'‚úã'},'win_streak_3':{title:'Tripla',icon:'üî•'},'win_streak_5':{title:'Lend√ºletben',icon:'üöÄ'},'win_streak_10':{title:'Meg√°ll√≠thatatlan',icon:'‚òÑÔ∏è'},'karesz_win_10':{title:'Karesz Ismer≈ëse',icon:'ü§ñ'},'pikszel_win_10':{title:'Pikszel Bar√°tja',icon:'üé®'},'both_defeated':{title:'Dupla Diadal',icon:'üëë'},'draw_master':{title:'Patthelyzet',icon:'ü§ù'},'hard_win':{title:'Kem√©ny Di√≥',icon:'üß†'},'genius_win':{title:'G√©prombol√≥',icon:'üí•'},'karesz_genius':{title:'Szil√≠cium-Szelid√≠t≈ë',icon:'ü¶æ'},'panna_genius':{title:'Pikszel-Professzor',icon:'üéì'},'total_wins_25':{title:'Negyed Sz√°zad',icon:'üèÖ'},'total_wins_50':{title:'F√©l Sz√°zad',icon:'üéñÔ∏è'},'total_wins_100':{title:'Sz√°zados',icon:'ü•á'},'total_games_10':{title:'Bemeleg√≠t√©s',icon:'üëü'},'total_games_50':{title:'Kitart√≥',icon:'üí™'},'total_games_150':{title:'Veter√°n',icon:'üõ°Ô∏è'},'draw_master_5':{title:'Diplomata',icon:'üïäÔ∏è'}};
        function getUnlockedAchievements() { return new Set(JSON.parse(localStorage.getItem('unlockedAchievements')) || []); }
        function showAchievementOnBoard(achievement) { const el = uiElements.achievementOnBoard; el.innerHTML = `üèÜ Teljes√≠tm√©ny feloldva!<br>"${achievement.title}"`; el.classList.remove('hidden'); el.classList.add('show'); setTimeout(() => { el.classList.add('hidden'); el.classList.remove('show'); }, 3000); }
        function unlockAchievement(id) { const unlocked = getUnlockedAchievements(); if (!unlocked.has(id)) { unlocked.add(id); localStorage.setItem('unlockedAchievements', JSON.stringify([...unlocked])); showAchievementOnBoard(ACHIEVEMENTS_LIST[id]); } }
        function displayAchievements() { const unlocked = getUnlockedAchievements(); uiElements.achievementsList.innerHTML = ''; for (const id in ACHIEVEMENTS_LIST) { const ach = ACHIEVEMENTS_LIST[id]; const isUnlocked = unlocked.has(id); uiElements.achievementsList.innerHTML += `<div class="achievement-item ${isUnlocked ? 'unlocked' : ''}"><span class="achievement-icon">${ach.icon}</span><div class="achievement-details"><h4>${ach.title}</h4><p>${ACHIEVEMENTS_LIST[id].description || ''}</p></div></div>`; } uiElements.achievementsModal.classList.remove('hidden'); }
        function checkAllAchievements(gameState) { /* ... A megl√©v≈ë logika ... */ }
        uiElements.achievementsBtn.addEventListener('click', displayAchievements);
        uiElements.closeAchievementsBtn.addEventListener('click', () => uiElements.achievementsModal.classList.add('hidden'));

        getDailyQuotes();
        initializeAvatars();
    </script>
</body>
</html>

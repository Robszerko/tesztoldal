<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Legfrissebb Láncszem - Online Párbaj</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00d4ff;
            --accent-color: #9f50ff;
            --background-dark: #000c24;
            --background-light: #0b1a3d;
            --text-light: #f0f0f0;
            --text-dark: #000c24;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --selected-color: #ffc107;
        }

        @keyframes background-pan { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes glow { 0% { text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color); } 100% { text-shadow: 0 0 10px var(--primary-color), 0 0 15px var(--primary-color); } }
        @keyframes flash-warning { 0%, 100% { background-color: var(--danger-color); box-shadow: 0 0 15px #ff0000; } 50% { background-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); } }
        /* ÚJ: Stroboszkóp animáció */
        @keyframes strobe { 50% { background-color: var(--background-light); color: var(--text-light); transform: scale(1.02); } }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-dark);
            background-image: linear-gradient(270deg, var(--background-light), var(--background-dark), var(--background-light));
            background-size: 200% 200%;
            animation: background-pan 30s linear infinite;
            color: var(--text-light);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; text-align: center; overflow: hidden;
        }

        .screen { display: none; }
        .screen.active { display: block; width: 90%; max-width: 1100px; }
        
        h1, h2, h3 { font-family: 'Russo One', sans-serif; text-transform: uppercase; color: var(--primary-color); text-shadow: 0 0 8px var(--primary-color);}

        button {
            background: linear-gradient(145deg, var(--accent-color), #673ab7);
            color: var(--text-light); border: none; padding: 12px 30px;
            font-size: 1.2em; font-family: 'Russo One', sans-serif; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); border: 2px solid var(--accent-color);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 10% 100%, 0 75%);
        }
        button:hover:not(:disabled) { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 20px rgba(159, 80, 255, 0.5); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; border-color: #555;}
        
        .secondary-btn { background: transparent; border-color: var(--primary-color); color: var(--primary-color); font-size: 1em; padding: 10px 25px; }

        .container {
            background-color: rgba(11, 26, 61, 0.6); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px;
            border: 1px solid var(--primary-color); box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
            clip-path: polygon(0 10%, 10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
        }
        .container button { margin: 10px; }
        
        #game-code-display { font-size: 3em; font-weight: 700; letter-spacing: 10px; background-color: var(--background-dark); padding: 15px; border-radius: 10px; border: 2px dashed var(--primary-color); margin: 20px 0; cursor: pointer; }
        #game-code-display.copied { border-style: solid; border-color: var(--success-color); }
        
        input { padding: 12px; font-size: 1.5em; border-radius: 8px; border: 2px solid var(--primary-color); background-color: var(--background-dark); color: #fff; text-align: center; width: 250px; font-family: 'Poppins'; }

        .logo-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .logo-svg { width: 80px; height: auto; }
        .logo-text h1 { font-size: 2.5em; margin: 0; }

        #weekly-winner-display { color: var(--selected-color); font-family: 'Russo One'; margin-top: -10px; margin-bottom: 10px; height: 20px; }

        /* Játék Képernyő Stílusok */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 20px; }
        .player-info-box { padding: 10px 15px; background-color: rgba(11, 26, 61, 0.6); backdrop-filter: blur(5px); border: 2px solid var(--primary-color); border-radius: 15px; width: 35%; transition: all 0.3s ease; clip-path: polygon(0 0, 90% 0, 100% 20%, 100% 100%, 10% 100%, 0 80%); }
        .player-info-box.active { border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .player-info-box .name { font-size: 1.2em; font-family: 'Russo One'; color: var(--primary-color); }
        .player-info-box .score { font-size: 1.5em; font-weight: 700; color: #fff; }
        
        #game-progress-bar { width: 100%; background-color: var(--background-dark); border: 1px solid var(--primary-color); border-radius: 10px; padding: 2px; margin-bottom: 20px; }
        #game-progress-bar-inner { height: 15px; width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); border-radius: 8px; transition: width 0.5s ease; }
        #game-progress-text { font-family: 'Russo One'; margin-top: -2px; }

        .main-game-area { display: flex; gap: 20px; }
        #money-pyramid { width: 300px; background-color: rgba(0,0,0,0.3); border: 1px solid var(--primary-color); padding: 10px; border-radius: 15px; display: flex; flex-direction: column-reverse; align-items: center; }
        .pyramid-level { width: 80%; height: 28px; line-height: 28px; margin: 1px 0; border-radius: 5px; text-align: center; font-weight: 600; font-size: 1em; color: var(--primary-color); transition: all 0.3s ease; text-shadow: 0 0 3px var(--primary-color); position: relative; }
        .pyramid-level.current { background-color: var(--accent-color); color: var(--text-dark); transform: scale(1.05); font-weight: 700; text-shadow: none; }
        .pyramid-level.next { border: 2px dashed var(--accent-color); color: var(--accent-color); }
        .pyramid-level.lifeline-level { font-weight: 700; }
        .pyramid-level.lifeline-level::after { content: ' ★'; }
        #game-center-area { flex-grow: 1; display: flex; flex-direction: column; }
        .game-status-display { background-color: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; border: 1px solid var(--primary-color); min-height: 100px; }
        #last-action-display { font-size: 1.3em; height: 30px; transition: color 0.3s; }
        #turn-display { font-size: 1.1em; }
        #lifeline-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .lifeline-btn { background: transparent; border: 2px solid var(--accent-color); border-radius: 10px; padding: 10px; font-size: 1em; color: var(--accent-color); }
        .lifeline-btn .count { display: inline-block; background-color: var(--accent-color); color: var(--text-dark); border-radius: 50%; width: 24px; height: 24px; line-height: 24px; font-weight: 700; margin-left: 8px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--background-light); border: 2px solid var(--primary-color); box-shadow: 0 0 30px var(--primary-color); padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; }
        #timer-display { font-size: 3em; font-weight: 700; color: var(--text-dark); background-color: var(--success-color); padding: 5px 20px; border-radius: 8px; margin: 10px auto 20px; width: fit-content; }
        #timer-display.timer-warning { animation: flash-warning 0.8s infinite; }
        #modal-wager-display { font-family: 'Russo One'; color: var(--accent-color); font-size: 1.2em; }
        #modal-question { font-size: 1.4em; }
        #modal-options button { display: block; width: 100%; margin: 10px 0; background-color: #1c2e59; color: #f0f0f0; border: 2px solid var(--primary-color); padding: 15px; font-size: 1.2em; border-radius: 10px; transition: all 0.3s; }
        #modal-options button.hidden { display: none; }
        #modal-options button:hover:not(:disabled) { background-color: #2b4588; border-color: var(--accent-color); }
        #modal-options button:disabled { pointer-events: none; opacity: 0.7; }
        #modal-options button.selected { border-color: var(--selected-color); background-color: #474023; }
        #modal-options button.correct { border-color: var(--success-color); background-color: #14361f; }
        #modal-options button.strobing { animation: strobe 0.25s linear infinite 4; }
        #modal-options button.incorrect { border-color: var(--danger-color); background-color: #42191e; }

        /* Szerencsekerék Stílusok */
        #wheel-modal .modal-content { max-width: 900px; }
        .wheel-area { display: flex; align-items: center; gap: 30px; }
        .wheel-scores { width: 200px; text-align: left; }
        .wheel-player-score { margin: 15px 0; }
        .wheel-player-score.active { color: var(--selected-color); }
        #wheel-container { position: relative; width: 350px; height: 350px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        #wheel-svg { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1); }
        .wheel-slice { stroke: #fff; stroke-width: 0.5; }
        .wheel-text { font-family: 'Russo One', sans-serif; font-size: 5px; fill: #fff; text-anchor: middle; }
        #wheel-pointer {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 50px;
            background: linear-gradient(45deg, #ffeb3b, #ffc107);
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            transform: translate(-50%, -120%);
            z-index: 10;
            border-bottom: 3px solid #c89200;
        }
        .wheel-controls { flex-grow: 1; }
        #power-meter-container { width: 100%; margin: 20px auto; background: var(--background-dark); border-radius: 10px; border: 2px solid var(--primary-color); }
        #power-bar { width: 0%; height: 20px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); border-radius: 8px; }
        #wheel-result, #wheel-turn-display { font-size: 1.5em; font-family: 'Russo One'; margin-top: 20px; height: 30px; }

        /* Játék Vége Képernyő Stílusok */
        #game-over-summary { display: flex; justify-content: space-around; margin: 20px 0; }
        .player-final-score { padding: 20px; border: 2px solid var(--primary-color); border-radius: 15px; }
        .player-final-score.winner { border-color: var(--selected-color); box-shadow: 0 0 15px var(--selected-color); }
        #rematch-status { margin-top: 15px; font-size: 1.1em; height: 25px; }

        @media (max-width: 900px) {
            .wheel-area { flex-direction: column; }
            .wheel-scores { display: flex; justify-content: space-around; width: 100%; text-align: center; }
        }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .logo-container { flex-direction: column; gap: 5px; }
            .logo-text h1 { font-size: 1.8em; }
            .game-header, .main-game-area { flex-direction: column; }
            .player-info-box { width: 100%; }
            #money-pyramid { width: 100%; order: 2; margin-top: 15px; }
            #game-center-area { width: 100%; order: 1; }
            .modal-content { width: 95%; padding: 20px; }
            #game-code-display { font-size: 2em; }
            .pyramid-level { height: 24px; line-height: 24px; font-size: 0.9em; }
            #wheel-container { width: 280px; height: 280px; }
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><h2 id="loading-text">Kapcsolódás...</h2></div>

    <div id="name-setup-screen" class="screen">
        <div class="container">
            <div class="logo-container">
                <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--primary-color);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient><filter id="glow"><feGaussianBlur stdDeviation="3.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path d="M 50 10 C 27.9 10 10 27.9 10 50 C 10 72.1 27.9 90 50 90 C 72.1 90 90 72.1 90 50" fill="none" stroke="url(#logoGradient)" stroke-width="12" filter="url(#glow)"/><path d="M 50 10 C 72.1 10 90 27.9 90 50" fill="none" stroke="var(--background-light)" stroke-width="14"/><path d="M 50 10 C 72.1 10 90 27.9 90 50" fill="none" stroke="url(#logoGradient)" stroke-width="12" filter="url(#glow)"/></svg>
                <div class="logo-text"><h1>A LÁNCSZEM</h1></div>
            </div>
            <h2 id="name-setup-title">Üdv a játékban!</h2>
            <p id="name-setup-subtitle">Kérlek, add meg a játékosneved:</p>
            <input type="text" id="player-name-input" maxlength="15" placeholder="Játékosnév">
            <br><br>
            <button id="save-name-btn">Mentés és Tovább</button>
            <button id="cancel-name-change-btn" class="secondary-btn" style="display: none;">Mégse</button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="container">
            <h1 id="welcome-message">Üdv, Játékos!</h1>
            <h3 id="weekly-winner-display"></h3>
            <p>Hívd ki egy barátodat egy párbajra!</p>
            <button id="host-game-btn">Játék Létrehozása</button>
            <button id="join-game-btn">Csatlakozás Játékhoz</button>
            <br>
            <button id="change-name-btn" class="secondary-btn">Név Módosítása</button>
        </div>
    </div>
    
    <div id="host-wait-screen" class="screen">
        <div class="container">
            <h2>Várakozás a másik játékosra...</h2>
            <p>Oszd meg ezt a kódot a barátoddal (kattints a másoláshoz):</p>
            <div id="game-code-display" title="Kattints a másoláshoz">----</div>
            <button id="cancel-host-btn">Mégse</button>
        </div>
    </div>

    <div id="join-screen" class="screen">
        <div class="container">
            <h2>Csatlakozás játékhoz</h2>
            <p>Írd be a 4-jegyű kódot:</p>
            <input type="number" id="join-code-input" maxlength="4" placeholder="----">
            <br><br>
            <button id="confirm-join-btn">Csatlakozás!</button>
            <button id="cancel-join-btn">Vissza</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="game-header">
            <div id="player1-info" class="player-info-box">
                <div id="player1-name" class="name">1. Játékos</div>
                <div id="player1-score" class="score">0 Ft</div>
            </div>
            <div style="text-align: center; width: 30%;">
                <h3 id="game-progress-text">Kérdés: 1 / 10</h3>
                <div id="game-progress-bar"><div id="game-progress-bar-inner"></div></div>
            </div>
            <div id="player2-info" class="player-info-box">
                <div id="player2-name" class="name">2. Játékos</div>
                <div id="player2-score" class="score">0 Ft</div>
            </div>
        </div>
        <div class="main-game-area">
            <div id="money-pyramid"></div>
            <div id="game-center-area">
                <div class="game-status-display">
                    <h3 id="last-action-display">Kezdődjön a játék!</h3>
                    <p id="turn-display">Az 1. Játékos kezd.</p>
                </div>
                <div id="lifeline-container">
                    <button id="lifeline-5050-btn" class="lifeline-btn">50:50 <span id="lifeline-5050-count" class="count">0</span></button>
                </div>
                <div class="action-buttons" style="margin-top: auto;">
                    <button id="bank-btn">BANK</button>
                    <button id="answer-btn">Válaszolok</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="answer-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="timer-display">10.0</div>
            <h3 id="modal-wager-display">Játék X Ft-ért</h3>
            <h2 id="modal-question">Kérdés betöltése...</h2>
            <div id="modal-options"></div>
        </div>
    </div>

    <div id="wheel-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="wheel-title">Pörgesd meg a kereket!</h2>
            <div class="wheel-area">
                <div class="wheel-scores">
                    <div id="wheel-p1-score" class="wheel-player-score">
                        <h3 id="wheel-p1-name" class="name">1. Játékos</h3>
                        <p id="wheel-p1-points" class="score">0 Ft</p>
                    </div>
                    <div id="wheel-p2-score" class="wheel-player-score">
                        <h3 id="wheel-p2-name" class="name">2. Játékos</h3>
                        <p id="wheel-p2-points" class="score">0 Ft</p>
                    </div>
                </div>
                <div id="wheel-container">
                    <svg id="wheel-svg" viewBox="0 0 100 100"></svg>
                    <div id="wheel-pointer"></div>
                </div>
                <div class="wheel-controls">
                    <h3 id="wheel-turn-display"></h3>
                    <div id="power-meter-container">
                        <div id="power-bar"></div>
                    </div>
                    <button id="spin-btn">BOOST!</button>
                    <h3 id="wheel-result"></h3>
                </div>
            </div>
        </div>
    </div>
    
    <div id="game-over-screen" class="screen">
        <div class="container">
            <h1>Kör Vége</h1>
            <h2 id="winner-announcement"></h2>
            <div id="game-over-summary">
                <div id="p1-final-score" class="player-final-score">
                    <h3 id="p1-final-name">1. Játékos</h3>
                    <p id="p1-final-points" class="score">0 Ft</p>
                </div>
                <div id="p2-final-score" class="player-final-score">
                    <h3 id="p2-final-name">2. Játékos</h3>
                    <p id="p2-final-points" class="score">0 Ft</p>
                </div>
            </div>
            <p id="rematch-status"></p>
            <button id="rematch-btn">Revans</button>
            <button id="back-to-menu-btn" class="secondary-btn">Főmenü</button>
        </div>
    </div>

    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content container">
            <h1 id="summary-modal-title">Eredményhirdetés</h1>
            <p id="summary-modal-text" style="font-size: 1.2em;"></p>
            <button id="summary-modal-close-btn" class="secondary-btn">Ok</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // JAVASLAT: Az API kulcsokat és konfigurációs adatokat érdemesebb egy külön, nem verziókövetett
    // fájlban tárolni, vagy környezeti változókból betölteni egy build folyamat során.
    // A kliens oldali kódban való tárolásuk biztonsági kockázatot jelenthet, ha nincsenek
    // megfelelően beállítva a Firebase Security Rules.
    const firebaseConfig = {
      apiKey: "AIzaSyDToVf58oqEO9s-WAF87IS1GDIb8LKtNMA",
      authDomain: "a-leggyengebb-lancszem.firebaseapp.com",
      databaseURL: "https://a-leggyengebb-lancszem-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "a-leggyengebb-lancszem",
      storageBucket: "a-leggyengebb-lancszem.appspot.com",
      messagingSenderId: "454539315458",
      appId: "1:454539315458:web:ef8c9ae8981e71a1b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const MONEY_PYRAMID = [ { value: 0 }, { value: 10000, label: "10 000 Ft" }, { value: 25000, label: "25 000 Ft" }, { value: 50000, label: "50 000 Ft", isLifelineLevel: true }, { value: 100000, label: "100 000 Ft" }, { value: 200000, label: "200 000 Ft" }, { value: 350000, label: "350 000 Ft", isLifelineLevel: true }, { value: 500000, label: "500 000 Ft" }, { value: 1000000, label: "1 000 000 Ft" } ];
    const QUESTIONS_PER_GAME = 10;
    const WHEEL_PRIZES = [ { label: "+10k Ft", type: 'money', value: 10000, color: ['#42a5f5', '#1976d2'] }, { label: "CSŐD", type: 'bankruptcy', value: 0, color: ['#ef5350', '#d32f2f'] }, { label: "+ 50:50", type: 'lifeline', value: 'fiftyFifty', color: ['#66bb6a', '#388e3c'] }, { label: "+25k Ft", type: 'money', value: 25000, color: ['#42a5f5', '#1976d2'] }, { label: "+50k Ft", type: 'money', value: 50000, color: ['#29b6f6', '#0288d1'] }, { label: "+ 50:50", type: 'lifeline', value: 'fiftyFifty', color: ['#66bb6a', '#388e3c'] }, { label: "+100k Ft", type: 'money', value: 100000, color: ['#29b6f6', '#0288d1'] }, { label: "CSŐD", type: 'bankruptcy', value: 0, color: ['#ef5350', '#d32f2f'] } ];
    const QUESTIONS = [ { "question": "Melyik bolygó a legnagyobb a Naprendszerben?", "options": ["Föld", "Jupiter", "Mars", "Szaturnusz"], "answer": "Jupiter" }, { "question": "Hány lába van egy póknak?", "options": ["6", "8", "10", "12"], "answer": "8" }, { "question": "Mi a víz kémiai képlete?", "options": ["H2O", "CO2", "O2", "NaCl"], "answer": "H2O" }, { "question": "Ki írta a Hamletet?", "options": ["Charles Dickens", "J.K. Rowling", "William Shakespeare", "Tolkien"], "answer": "William Shakespeare" }, { "question": "Melyik a világ legmagasabb hegye?", "options": ["K2", "Mount Everest", "Kancsendzönga", "Lhoce"], "answer": "Mount Everest" }, { "question": "Melyik ország fővárosa Tokió?", "options": ["Kína", "Dél-Korea", "Japán", "Thaiföld"], "answer": "Japán" }, { "question": "Melyik évben kezdődött a második világháború?", "options": ["1939", "1941", "1945", "1914"], "answer": "1939" }, { "question": "Hány kontinens van a Földön?", "options": ["5", "6", "7", "8"], "answer": "7" }, { "question": "Melyik festő festette a Mona Lisát?", "options": ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "answer": "Leonardo da Vinci" }, { "question": "Melyik a legkeményebb természetes anyag a Földön?", "options": ["Arany", "Vas", "Kvarc", "Gyémánt"], "answer": "Gyémánt" }, { "question": "Hány nap van egy szökőévben?", "options": ["364", "365", "366", "367"], "answer": "366" }, { "question": "Mi a 'fotoszintézis' folyamatának lényege?", "options": ["Víz elpárologtatása", "Szén-dioxidból oxigén termelése", "Ásványi anyagok felvétele", "Fényenergia kémiai energiává alakítása"], "answer": "Fényenergia kémiai energiává alakítása" }, { "question": "Melyik óceán a legnagyobb?", "options": ["Atlanti-óceán", "Indiai-óceán", "Csendes-óceán", "Jeges-tenger"], "answer": "Csendes-óceán"}, { "question": "Ki volt az első ember a Holdon?", "options": ["Jurij Gagarin", "Buzz Aldrin", "Neil Armstrong", "Michael Collins"], "answer": "Neil Armstrong"}, { "question": "Melyik a periódusos rendszer első eleme?", "options": ["Hélium", "Oxigén", "Hidrogén", "Szén"], "answer": "Hidrogén"}, { "question": "Melyik város Olaszország fővárosa?", "options": ["Velence", "Milánó", "Róma", "Nápoly"], "answer": "Róma" }, { "question": "Hány oldalú egy kocka?", "options": ["4", "6", "8", "12"], "answer": "6" }, { "question": "Melyik állat a 'dzsungel királya'?", "options": ["Tigris", "Elefánt", "Oroszlán", "Medve"], "answer": "Oroszlán" }, { "question": "Melyik a leggyorsabb szárazföldi állat?", "options": ["Gepárd", "Gazella", "Oroszlán", "Ló"], "answer": "Gepárd" }, { "question": "Mi a Naprendszer középpontja?", "options": ["A Föld", "A Jupiter", "A Nap", "A Tejút"], "answer": "A Nap" } ];

    const screens = { loading: document.getElementById('loading-screen'), nameSetup: document.getElementById('name-setup-screen'), menu: document.getElementById('menu-screen'), hostWait: document.getElementById('host-wait-screen'), join: document.getElementById('join-screen'), game: document.getElementById('game-screen'), wheel: document.getElementById('wheel-modal'), gameOver: document.getElementById('game-over-screen'), summaryModal: document.getElementById('summary-modal') };
    let localPlayer = { uid: null, name: null, lifelines: { fiftyFifty: 0 }, totalScore: 0, lastLoginDate: null };
    let currentGameId = null; let gameUnsubscribe = null; let timerInterval = null; let lastKnownGameData = null;
    let wheelState = 'idle'; let power = 0; let animationFrameId = null;

    function getTodayString() { return new Date().toISOString().slice(0, 10); }

    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); if (screens[screenName]) { screens[screenName].classList.add('active'); } }
    function setMenuButtonsState(disabled) { document.getElementById('host-game-btn').disabled = disabled; document.getElementById('join-game-btn').disabled = disabled; document.getElementById('change-name-btn').disabled = disabled; }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                localPlayer.uid = user.uid;
                setMenuButtonsState(true);
                document.getElementById('loading-text').textContent = "Adatok betöltése...";
                await loadPlayerData(user.uid);
                await checkDailyAndWeeklyStatus();
                setMenuButtonsState(false);
                if (localPlayer.name) {
                    document.getElementById('welcome-message').textContent = `Üdv újra, ${localPlayer.name}!`;
                    switchScreen('menu');
                } else {
                    switchScreen('nameSetup');
                }
            } catch (error) {
                console.error("Hiba a bejelentkezés és adatbetöltés során:", error);
                document.getElementById('loading-text').textContent = "Hiba történt. Kérlek, frissítsd az oldalt.";
            }
        } else {
            signInAnonymously(auth).catch(err => console.error("Névtelen bejelentkezés sikertelen:", err));
        }
    });

    async function loadPlayerData(uid) {
        const snapshot = await get(ref(db, `players/${uid}`));
        if (snapshot.exists() && snapshot.val().name) {
            localPlayer = { uid, ...snapshot.val(), lifelines: snapshot.val().lifelines || { fiftyFifty: 0 } };
        } else {
            localPlayer = { uid, name: null, lifelines: { fiftyFifty: 0 }, totalScore: 0, lastLoginDate: null };
        }
    }

    async function checkDailyAndWeeklyStatus() {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);

        const weeklyStateSnap = await get(ref(db, `weeklyState`));
        if (weeklyStateSnap.exists() && weeklyStateSnap.val().previousWeekWinner) {
            document.getElementById('weekly-winner-display').textContent = `Előző heti győztes: ${weeklyStateSnap.val().previousWeekWinner.name}`;
        }

        if (localPlayer.lastLoginDate === todayStr) return;

        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);
        
        if (today.getDay() === 1 && localPlayer.lastLoginDate && localPlayer.lastLoginDate < todayStr) {
            await calculateAndShowWeeklyWinner();
        }
        
        if (localPlayer.lastLoginDate && localPlayer.lastLoginDate < todayStr) {
            await calculateAndShowDailyWinner(yesterdayStr);
        }

        await update(ref(db, `/players/${localPlayer.uid}`), { lastLoginDate: todayStr });
        localPlayer.lastLoginDate = todayStr;
        
        const dailyStateRef = ref(db, `dailyState/${todayStr}/${localPlayer.uid}`);
        const dailyStateSnap = await get(dailyStateRef);
        if (!dailyStateSnap.exists() && localPlayer.name) {
            await set(dailyStateRef, { name: localPlayer.name, score: 0 });
        }
    }

    async function calculateAndShowDailyWinner(dateStr) {
        const snap = await get(ref(db, `dailyState/${dateStr}`));
        if (!snap.exists()) return;
        const dailyData = snap.val();
        const players = Object.keys(dailyData).map(uid => ({ uid, ...dailyData[uid] }));
        if (players.length < 2) return;

        const winner = players.reduce((a, b) => (a.score || 0) > (b.score || 0) ? a : b);
        const loser = players.find(p => p.uid !== winner.uid);

        if (!loser || winner.score === loser.score) {
            showSummaryModal("Az előző nap döntetlen lett!", `A játékosok azonos pontszámot értek el.`);
        } else {
            showSummaryModal(`Az előző nap győztese: ${winner.name}!`, `${winner.name} (${(winner.score || 0).toLocaleString()} Ft) legyőzte ${loser.name}-t (${(loser.score || 0).toLocaleString()} Ft). Gratulálunk!`);
            const weeklyPointsRef = ref(db, `weeklyState/weeklyPoints/${winner.uid}`);
            const weeklyPointsSnap = await get(weeklyPointsRef);
            const currentPoints = weeklyPointsSnap.exists() ? (weeklyPointsSnap.val().points || 0) : 0;
            await set(weeklyPointsRef, { name: winner.name, points: currentPoints + 1 });
        }
    }

    async function calculateAndShowWeeklyWinner() {
        const snap = await get(ref(db, 'weeklyState'));
        if (!snap.exists() || !snap.val().weeklyPoints) return;
        const weeklyPointsData = snap.val().weeklyPoints;
        const players = Object.keys(weeklyPointsData).map(uid => ({ uid, ...weeklyPointsData[uid] }));
        if (players.length === 0) return;

        const winner = players.reduce((a, b) => (a.points || 0) > (b.points || 0) ? a : b);
        showSummaryModal(`Az előző hét győztese: ${winner.name}!`, `A legtöbb napot nyerte a héten. Gratulálunk!`);
        
        await set(ref(db, 'weeklyState'), {
            previousWeekWinner: { name: winner.name },
            weeklyPoints: {}
        });
        document.getElementById('weekly-winner-display').textContent = `Előző heti győztes: ${winner.name}`;
    }

    function showSummaryModal(title, text) { screens.summaryModal.style.display = 'flex'; document.getElementById('summary-modal-title').textContent = title; document.getElementById('summary-modal-text').textContent = text; }
    document.getElementById('summary-modal-close-btn').addEventListener('click', () => screens.summaryModal.style.display = 'none');

    async function handleSaveName() {
        const newName = document.getElementById('player-name-input').value.trim();
        if (newName.length < 3) { alert("A névnek legalább 3 karakter hosszúnak kell lennie."); return; }
        localPlayer.name = newName;
        localPlayer.lastLoginDate = getTodayString();
        await set(ref(db, `players/${localPlayer.uid}`), localPlayer);
        document.getElementById('welcome-message').textContent = `Üdv, ${localPlayer.name}!`;
        switchScreen('menu');
    }
    function handleChangeName() { document.getElementById('player-name-input').value = localPlayer.name; document.getElementById('name-setup-title').textContent = "Név Módosítása"; document.getElementById('name-setup-subtitle').textContent = "Add meg az új neved:"; document.getElementById('cancel-name-change-btn').style.display = 'inline-block'; switchScreen('nameSetup'); }

    async function hostGame() {
        currentGameId = (Math.floor(Math.random() * 9000) + 1000).toString();
        const dailyStateSnap = await get(ref(db, `dailyState/${getTodayString()}/${localPlayer.uid}`));
        const p1Score = dailyStateSnap.exists() ? (dailyStateSnap.val().score || 0) : 0;
        const gameData = { status: 'waiting', player1: { uid: localPlayer.uid, name: localPlayer.name, score: p1Score }, player2: null, turn: 'player1', chainLevel: 0, questionIndex: 0, questions: [...QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_GAME), lastAction: `Várakozás a 2. játékosra...`, questionActive: false, selectedAnswer: null, rematch: { p1: false, p2: false } };
        const gameRef = ref(db, `games/${currentGameId}`);
        await set(gameRef, gameData); onDisconnect(gameRef).remove();
        listenToGameUpdates(currentGameId);
        document.getElementById('game-code-display').textContent = currentGameId; switchScreen('hostWait');
    }

    async function joinGame() {
        const gameId = document.getElementById('join-code-input').value; if (!gameId) return;
        const gameRef = ref(db, `games/${gameId}`); const snapshot = await get(gameRef);
        if (snapshot.exists() && snapshot.val().status === 'waiting') {
            currentGameId = gameId;
            const dailyStateSnap = await get(ref(db, `dailyState/${getTodayString()}/${localPlayer.uid}`));
            const p2Score = dailyStateSnap.exists() ? (dailyStateSnap.val().score || 0) : 0;
            await update(ref(db), {
                [`/games/${gameId}/player2`]: { uid: localPlayer.uid, name: localPlayer.name, score: p2Score },
                [`/games/${gameId}/status`]: 'active',
                [`/games/${gameId}/lastAction`]: `${localPlayer.name} csatlakozott! Az 1. Játékos kezd.`
            });
            onDisconnect(ref(db, `/games/${gameId}/status`)).set('aborted');
            listenToGameUpdates(gameId);
        } else { alert("A játék nem található, vagy már tele van."); }
    }

    function listenToGameUpdates(gameId) {
        if (gameUnsubscribe) gameUnsubscribe();
        const gameRef = ref(db, `games/${gameId}`);
        gameUnsubscribe = onValue(gameRef, (snapshot) => {
            const gameData = snapshot.val();
            if (!gameData || gameData.status === 'aborted') {
                if (screens.game.classList.contains('active') || screens.gameOver.classList.contains('active')) {
                    alert("A másik játékos kilépett vagy megszakadt a kapcsolat.");
                }
                leaveGame(false); return;
            }

            const oldStatus = lastKnownGameData?.status;
            lastKnownGameData = gameData;
            
            if (gameData.status === 'active' && oldStatus !== 'active') switchScreen('game');
            if (gameData.status === 'finished' && oldStatus === 'active') {
                showWheel(gameData); return;
            }
            if (gameData.status === 'rematch' && oldStatus !== 'rematch') resetGameForRematch(gameData);

            if (screens.game.classList.contains('active')) updateGameUI(gameData);
            if (screens.wheel.style.display === 'flex') updateWheelUI(gameData);
            if (screens.gameOver.classList.contains('active')) updateGameOverUI(gameData);
        });
    }

    async function leaveGame(isHost) {
        if (gameUnsubscribe) gameUnsubscribe();
        isHost = isHost === undefined ? (lastKnownGameData && lastKnownGameData.player1.uid === localPlayer.uid) : isHost;
        if (currentGameId && isHost) await remove(ref(db, `games/${currentGameId}`));
        currentGameId = null; lastKnownGameData = null;
        switchScreen('menu');
    }
    
    function updateGameUI(data) {
        document.getElementById('player1-name').textContent = data.player1.name;
        document.getElementById('player1-score').textContent = `${(data.player1.score || 0).toLocaleString()} Ft`;
        if (data.player2) {
            document.getElementById('player2-name').textContent = data.player2.name;
            document.getElementById('player2-score').textContent = `${(data.player2.score || 0).toLocaleString()} Ft`;
        }
        document.getElementById('player1-info').classList.toggle('active', data.turn === 'player1');
        document.getElementById('player2-info').classList.toggle('active', data.turn === 'player2');
        for (let i = 1; i < MONEY_PYRAMID.length; i++) {
            const levelDiv = document.getElementById(`pyramid-level-${i}`);
            levelDiv.classList.remove('current', 'next');
            if (i === data.chainLevel) levelDiv.classList.add('current');
            else if (i === data.chainLevel + 1) levelDiv.classList.add('next');
        }
        document.getElementById('last-action-display').textContent = data.lastAction || '';
        const turnPlayer = data.turn === 'player1' ? data.player1 : (data.player2 || { name: '...' });
        document.getElementById('turn-display').textContent = `${turnPlayer.name} következik.`;
        document.getElementById('game-progress-text').textContent = `Kérdés: ${Math.min(data.questionIndex + 1, QUESTIONS_PER_GAME)} / ${QUESTIONS_PER_GAME}`;
        document.getElementById('game-progress-bar-inner').style.width = `${(data.questionIndex / QUESTIONS_PER_GAME) * 100}%`;
        document.getElementById('lifeline-5050-count').textContent = localPlayer.lifelines.fiftyFifty || 0;
        const myTurn = (data.turn === 'player1' && data.player1.uid === localPlayer.uid) || (data.turn === 'player2' && data.player2 && data.player2.uid === localPlayer.uid);
        document.getElementById('answer-btn').disabled = !myTurn || data.questionActive;
        document.getElementById('bank-btn').disabled = !myTurn || data.chainLevel === 0 || data.questionActive;
        document.getElementById('lifeline-5050-btn').disabled = !myTurn || (localPlayer.lifelines.fiftyFifty || 0) < 1 || data.fiftyFiftyUsed || !data.questionActive;
        if (data.questionActive) showQuestionModal(data, myTurn); else hideQuestionModal();
    }
    
    async function handleSelectAnswer(event, selectedOption) {
        document.querySelectorAll('#modal-options button').forEach(btn => btn.disabled = true);
        event.target.classList.add('selected');
        // Először elküldjük a választ az adatbázisba
        await update(ref(db, `/games/${currentGameId}`), { selectedAnswer: selectedOption });
        
        // JAVÍTÁS: A válasz kiértékelését a választó kliens azonnal megkezdi,
        // ahelyett, hogy az onValue listenerre várna. Ez megelőzi a versenyhelyzeteket.
        const currentData = await get(ref(db, `games/${currentGameId}`)).then(snap => snap.val());
        if (currentData) {
            resolveAnswer(currentData);
        }
    }

    async function resolveAnswer(gameData) {
        if (!gameData || gameData.answerResolved) return;
        await update(ref(db, `/games/${currentGameId}`), { answerResolved: true });

        const correctAnswer = gameData.questions[gameData.questionIndex].answer;
        const buttons = document.querySelectorAll('#modal-options button');
        const correctButton = Array.from(buttons).find(b => b.textContent === correctAnswer);
        
        buttons.forEach(btn => {
            if (btn.textContent === correctAnswer) btn.classList.add('correct');
            if (btn.textContent === gameData.selectedAnswer && gameData.selectedAnswer !== correctAnswer) {
                btn.classList.remove('selected'); btn.classList.add('incorrect');
            }
        });
        if(correctButton) { correctButton.classList.add('strobing'); setTimeout(() => correctButton.classList.remove('strobing'), 1000); }

        setTimeout(async () => {
            const isCorrect = gameData.selectedAnswer === correctAnswer;
            const updates = {};
            const currentPlayerKey = gameData.turn;
            const currentPlayer = gameData[currentPlayerKey];
            let scoreUpdate = 0;

            if (isCorrect) {
                const newChainLevel = Math.min(gameData.chainLevel + 1, MONEY_PYRAMID.length - 1);
                updates.chainLevel = newChainLevel; updates.lastAction = `${currentPlayer.name} helyesen válaszolt!`;
                
                // JAVÍTÁS: Csak akkor adjuk hozzá a mentőövet a helyi játékoshoz,
                // ha valóban ő válaszolt helyesen.
                if (MONEY_PYRAMID[newChainLevel].isLifelineLevel && currentPlayer.uid === localPlayer.uid) {
                    if ((localPlayer.lifelines.fiftyFifty || 0) < 3) {
                         localPlayer.lifelines.fiftyFifty++;
                         set(ref(db, `/players/${localPlayer.uid}/lifelines/fiftyFifty`), localPlayer.lifelines.fiftyFifty);
                         updates.lastAction += ` Szerzett egy 50:50 mentőövet!`;
                    }
                }
            } else { updates.chainLevel = 0; updates.turn = currentPlayerKey === 'player1' ? 'player2' : 'player1'; updates.lastAction = `${currentPlayer.name} hibázott! A lánc megszakadt.`; }
            
            if (gameData.questionIndex + 1 >= QUESTIONS_PER_GAME) {
                if (isCorrect) { scoreUpdate = MONEY_PYRAMID[updates.chainLevel].value; updates.chainLevel = 0; updates.lastAction += ` Az utolsó körben bankolt ${scoreUpdate.toLocaleString()} Ft-ot!`; }
                updates.status = 'finished';
            } else { updates.questionIndex = gameData.questionIndex + 1; }
            
            updates.questionActive = false; updates.selectedAnswer = null; updates.fiftyFiftyUsed = false; updates.answerResolved = false;
            if (scoreUpdate > 0) updates[`${currentPlayerKey}/score`] = (currentPlayer.score || 0) + scoreUpdate;
            await update(ref(db, `/games/${currentGameId}`), updates);
        }, 2000);
    }
    
    async function bankPoints() {
        const pointsToBank = MONEY_PYRAMID[lastKnownGameData.chainLevel].value;
        const currentPlayerKey = lastKnownGameData.turn;
        const currentPlayer = lastKnownGameData[currentPlayerKey];
        await update(ref(db, `/games/${currentGameId}`), {
            [`${currentPlayerKey}/score`]: (currentPlayer.score || 0) + pointsToBank,
            chainLevel: 0,
            turn: currentPlayerKey === 'player1' ? 'player2' : 'player1',
            lastAction: `${currentPlayer.name} bankolt ${pointsToBank.toLocaleString()} Ft-ot!`
        });
    }
    
    async function useFiftyFifty() {
        if ((localPlayer.lifelines.fiftyFifty || 0) > 0 && !lastKnownGameData.fiftyFiftyUsed) {
            localPlayer.lifelines.fiftyFifty--;
            await update(ref(db), { [`/players/${localPlayer.uid}/lifelines/fiftyFifty`]: localPlayer.lifelines.fiftyFifty, [`/games/${currentGameId}/fiftyFiftyUsed`]: true });
        }
    }

    function showQuestionModal(data, isMyTurn) {
        const modal = document.getElementById('answer-modal');
        const optionsContainer = document.getElementById('modal-options');
        optionsContainer.innerHTML = '';
        const currentQuestion = data.questions[data.questionIndex];
        document.getElementById('modal-question').textContent = currentQuestion.question;
        const nextLevelData = MONEY_PYRAMID[data.chainLevel + 1] || MONEY_PYRAMID[MONEY_PYRAMID.length - 1];
        document.getElementById('modal-wager-display').textContent = `JÁTÉK ${nextLevelData.label}-ÉRT`;
        currentQuestion.options.forEach(option => {
            const button = document.createElement('button'); button.textContent = option;
            button.disabled = !isMyTurn; button.onclick = (e) => handleSelectAnswer(e, option);
            optionsContainer.appendChild(button);
        });
        if (data.fiftyFiftyUsed) {
            const wrongAnswers = currentQuestion.options.filter(o => o !== currentQuestion.answer);
            const toKeep = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
            optionsContainer.querySelectorAll('button').forEach(btn => { if(btn.textContent !== currentQuestion.answer && btn.textContent !== toKeep) btn.classList.add('hidden'); });
        }
        modal.style.display = 'flex';
        startTimer();
    }
    function hideQuestionModal() { stopTimer(); document.getElementById('answer-modal').style.display = 'none'; }
    
    function startTimer() { stopTimer(); let timeLeft = 10.0; const timerDisplay = document.getElementById('timer-display'); timerDisplay.textContent = timeLeft.toFixed(1); timerDisplay.classList.remove('timer-warning'); timerInterval = setInterval(() => { timeLeft -= 0.1; if (timeLeft < 0) timeLeft = 0; timerDisplay.textContent = timeLeft.toFixed(1); if (timeLeft <= 5.0) timerDisplay.classList.add('timer-warning'); if (timeLeft <= 0) { timeUp(); } }, 100); }
    function stopTimer() { clearInterval(timerInterval); }

    async function timeUp() {
        stopTimer();
        const currentData = await get(ref(db, `games/${currentGameId}`)).then(snap => snap.val());
        if(!currentData || currentData.selectedAnswer) return;
        const myTurn = (currentData.turn === 'player1' && currentData.player1.uid === localPlayer.uid) || (currentData.turn === 'player2' && currentData.player2 && currentData.player2.uid === localPlayer.uid);
        if (myTurn) handleTimeout(currentData);
    }

    async function handleTimeout(gameData) {
        hideQuestionModal();
        const newQuestionIndex = gameData.questionIndex + 1;
        await update(ref(db, `/games/${currentGameId}`), {
            chainLevel: 0,
            turn: gameData.turn === 'player1' ? 'player2' : 'player1',
            lastAction: `${gameData[gameData.turn].name} kifutott az időből!`,
            questionActive: false, selectedAnswer: null, fiftyFiftyUsed: false,
            // JAVÍTÁS: Ha az utolsó kérdésnél jár le az idő, a játék befejeződik
            status: newQuestionIndex >= QUESTIONS_PER_GAME ? 'finished' : gameData.status,
            questionIndex: newQuestionIndex < QUESTIONS_PER_GAME ? newQuestionIndex : gameData.questionIndex,
        });
    }
    
    async function showWheel(gameData) {
        screens.game.classList.remove('active');
        const p1s = gameData.player1.score || 0;
        const p2s = gameData.player2.score || 0;
        const wheelTurn = p1s >= p2s ? 'player1' : 'player2';
        
        await update(ref(db, `/games/${currentGameId}`), {
            wheelState: { turn: wheelTurn, p1Spun: false, p2Spun: false }
        });
        
        screens.wheel.style.display = 'flex';
        updateWheelUI(gameData);
    }

    function updateWheelUI(gameData) {
        if (!gameData.wheelState) return;
        const { turn } = gameData.wheelState;
        const myPlayerKey = gameData.player1.uid === localPlayer.uid ? 'player1' : 'player2';

        document.getElementById('wheel-p1-name').textContent = gameData.player1.name;
        document.getElementById('wheel-p1-points').textContent = `${(gameData.player1.score || 0).toLocaleString()} Ft`;
        document.getElementById('wheel-p2-name').textContent = gameData.player2.name;
        document.getElementById('wheel-p2-points').textContent = `${(gameData.player2.score || 0).toLocaleString()} Ft`;
        document.getElementById('wheel-p1-score').classList.toggle('active', turn === 'player1');
        document.getElementById('wheel-p2-score').classList.toggle('active', turn === 'player2');
        
        const turnPlayerName = gameData[turn].name;
        if (myPlayerKey === turn) {
            document.getElementById('wheel-turn-display').textContent = "Te pörgetsz!";
            document.getElementById('spin-btn').disabled = false;
        } else {
            document.getElementById('wheel-turn-display').textContent = `Várakozás, hogy ${turnPlayerName} pörgessen...`;
            document.getElementById('spin-btn').disabled = true;
        }
    }

    function handleWheelClick() { if (wheelState === 'idle') { wheelState = 'charging'; document.getElementById('spin-btn').textContent = 'PÖRGETÉS!'; startPowerMeter(); } else if (wheelState === 'charging') { wheelState = 'spinning'; document.getElementById('spin-btn').disabled = true; stopPowerMeter(); spinWheel(power); } }
    function startPowerMeter() { let startTime = null; const powerBar = document.getElementById('power-bar'); function animate(timestamp) { if (!startTime) startTime = timestamp; power = Math.abs(Math.sin((timestamp - startTime) / 300)); powerBar.style.width = `${power * 100}%`; animationFrameId = requestAnimationFrame(animate); } animationFrameId = requestAnimationFrame(animate); }
    function stopPowerMeter() { cancelAnimationFrame(animationFrameId); }
    function spinWheel(power) { const wheel = document.getElementById('wheel-svg'); const finalAngle = (5 * 360) + (power * 720) + (Math.random() * 360); wheel.style.transform = `rotate(${finalAngle}deg)`; setTimeout(() => { getPrize(finalAngle); }, 5100); }
    
    async function getPrize(finalAngle) {
        const sliceAngle = 360 / WHEEL_PRIZES.length;
        const prizeIndex = Math.floor(((360 - (finalAngle % 360)) + sliceAngle / 2) % 360 / sliceAngle);
        const prize = WHEEL_PRIZES[prizeIndex];
        document.getElementById('wheel-result').textContent = `NYEREMÉNY: ${prize.label}!`;
        
        const todayStr = getTodayString();
        const spinningPlayerKey = lastKnownGameData.wheelState.turn;
        const spinningPlayerUid = lastKnownGameData[spinningPlayerKey].uid;

        if (prize.type === 'lifeline' && spinningPlayerUid === localPlayer.uid && (localPlayer.lifelines.fiftyFifty || 0) < 3) {
            localPlayer.lifelines.fiftyFifty++;
            await set(ref(db, `/players/${spinningPlayerUid}/lifelines/fiftyFifty`), localPlayer.lifelines.fiftyFifty);
        } else if (prize.type === 'money') {
            const dailyScoreRef = ref(db, `/dailyState/${todayStr}/${spinningPlayerUid}/score`);
            const snap = await get(dailyScoreRef);
            await set(dailyScoreRef, (snap.val() || 0) + prize.value);
        } else if (prize.type === 'bankruptcy') {
            await set(ref(db, `/dailyState/${todayStr}/${spinningPlayerUid}/score`), 0);
        }

        setTimeout(async () => {
            const nextWheelState = { ...lastKnownGameData.wheelState };
            nextWheelState[`${spinningPlayerKey}Spun`] = true;
            nextWheelState.turn = spinningPlayerKey === 'player1' ? 'player2' : 'player1';
            
            if (nextWheelState.p1Spun && nextWheelState.p2Spun) {
                // JAVÍTÁS: A játék végén a legfrissebb pontszámokat kérjük le az adatbázisból,
                // hogy biztosan a pörgetések utáni állapotot mutassuk.
                const finalDailyState = await get(ref(db, `dailyState/${todayStr}`)).then(s => s.val());
                const finalGameData = { ...lastKnownGameData };
                finalGameData.player1.score = finalDailyState[finalGameData.player1.uid]?.score || 0;
                finalGameData.player2.score = finalDailyState[finalGameData.player2.uid]?.score || 0;
                screens.wheel.style.display = 'none';
                showGameOverScreen(finalGameData);
            } else {
                await update(ref(db, `/games/${currentGameId}/wheelState`), nextWheelState);
                document.getElementById('wheel-result').textContent = "";
                wheelState = 'idle';
                document.getElementById('spin-btn').textContent = 'BOOST!';
            }
        }, 2000);
    }

    function showGameOverScreen(data) {
        document.getElementById('p1-final-name').textContent = data.player1.name;
        document.getElementById('p1-final-points').textContent = `${(data.player1.score || 0).toLocaleString()} Ft`;
        document.getElementById('p2-final-name').textContent = data.player2.name;
        document.getElementById('p2-final-points').textContent = `${(data.player2.score || 0).toLocaleString()} Ft`;
        const p1Score = data.player1.score || 0, p2Score = data.player2.score || 0;
        document.getElementById('p1-final-score').classList.toggle('winner', p1Score > p2Score);
        document.getElementById('p2-final-score').classList.toggle('winner', p2Score > p1Score);
        if (p1Score > p2Score) document.getElementById('winner-announcement').textContent = `A mai nap állása szerint ${data.player1.name} vezet!`;
        else if (p2Score > p1Score) document.getElementById('winner-announcement').textContent = `A mai nap állása szerint ${data.player2.name} vezet!`;
        else document.getElementById('winner-announcement').textContent = `A mai nap állása döntetlen!`;
        updateGameOverUI(data);
        switchScreen('gameOver');
    }
    
    function updateGameOverUI(data) {
        const isPlayer1 = localPlayer.uid === data.player1.uid;
        const statusEl = document.getElementById('rematch-status');
        const rematchBtn = document.getElementById('rematch-btn');
        if (data.rematch.p1 && data.rematch.p2) {
            if (isPlayer1) update(ref(db, `/games/${currentGameId}`), { status: 'rematch' });
            return;
        }
        const myChoice = isPlayer1 ? data.rematch.p1 : data.rematch.p2;
        const opponentChoice = isPlayer1 ? data.rematch.p2 : data.rematch.p1;
        rematchBtn.disabled = myChoice;
        if (myChoice) statusEl.textContent = "Várakozás a másik játékosra...";
        else if (opponentChoice) statusEl.textContent = `${isPlayer1 ? data.player2.name : data.player1.name} visszavágót szeretne!`;
        else statusEl.textContent = "";
    }

    async function handleRematchClick() { await set(ref(db, localPlayer.uid === lastKnownGameData.player1.uid ? `/games/${currentGameId}/rematch/p1` : `/games/${currentGameId}/rematch/p2`), true); }
    
    async function resetGameForRematch(oldGameData) {
        if (localPlayer.uid !== oldGameData.player1.uid) return;
        await update(ref(db, `/games/${currentGameId}`), {
            status: 'active', turn: 'player1', chainLevel: 0, questionIndex: 0,
            questions: [...QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_GAME),
            lastAction: `Kezdődjön a visszavágó!`,
            questionActive: false, selectedAnswer: null, fiftyFiftyUsed: false, answerResolved: false,
            rematch: { p1: false, p2: false }, wheelState: null
        });
    }

    function createWheel() {
        const svgNS = "http://www.w3.org/2000/svg", wheelSvg = document.getElementById('wheel-svg');
        wheelSvg.innerHTML = ''; const numPrizes = WHEEL_PRIZES.length;
        const sliceAngle = 360 / numPrizes, radius = 50, center = 50;
        const defs = document.createElementNS(svgNS, 'defs');
        WHEEL_PRIZES.forEach((prize, i) => {
            const gradient = document.createElementNS(svgNS, 'radialGradient'); gradient.id = `grad${i}`;
            const stop1 = document.createElementNS(svgNS, 'stop'); stop1.setAttribute('offset', '0%'); stop1.setAttribute('stop-color', prize.color[0]);
            const stop2 = document.createElementNS(svgNS, 'stop'); stop2.setAttribute('offset', '100%'); stop2.setAttribute('stop-color', prize.color[1]);
            gradient.append(stop1, stop2); defs.appendChild(gradient);
        });
        wheelSvg.appendChild(defs);
        const g = document.createElementNS(svgNS, 'g');
        WHEEL_PRIZES.forEach((prize, i) => {
            const startAngle = i * sliceAngle, endAngle = startAngle + sliceAngle;
            const start = { x: center + radius * Math.cos(Math.PI * startAngle / 180), y: center + radius * Math.sin(Math.PI * startAngle / 180) };
            const end = { x: center + radius * Math.cos(Math.PI * endAngle / 180), y: center + radius * Math.sin(Math.PI * endAngle / 180) };
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", `M ${center},${center} L ${start.x},${start.y} A ${radius},${radius} 0 ${sliceAngle > 180 ? 1 : 0} 1 ${end.x},${end.y} Z`);
            path.setAttribute("fill", `url(#grad${i})`); path.classList.add('wheel-slice'); g.appendChild(path);
            const textRadius = radius * 0.75;
            const textStart = { x: center + textRadius * Math.cos(Math.PI * startAngle / 180), y: center + textRadius * Math.sin(Math.PI * startAngle / 180) };
            const textEnd = { x: center + textRadius * Math.cos(Math.PI * endAngle / 180), y: center + textRadius * Math.sin(Math.PI * endAngle / 180) };
            const textPath = document.createElementNS(svgNS, 'path'); textPath.id = `textPath${i}`;
            textPath.setAttribute('d', `M ${textStart.x},${textStart.y} A ${textRadius},${textRadius} 0 0 1 ${textEnd.x},${textEnd.y}`); defs.appendChild(textPath);
            const text = document.createElementNS(svgNS, "text"); text.classList.add('wheel-text');
            const textPathNode = document.createElementNS(svgNS, 'textPath'); textPathNode.setAttribute('href', `#textPath${i}`); textPathNode.setAttribute('startOffset', '50%'); textPathNode.textContent = prize.label;
            text.appendChild(textPathNode); g.appendChild(text);
        });
        wheelSvg.appendChild(g);
    }

    document.getElementById('save-name-btn').addEventListener('click', handleSaveName);
    document.getElementById('change-name-btn').addEventListener('click', handleChangeName);
    document.getElementById('cancel-name-change-btn').addEventListener('click', () => switchScreen('menu'));
    document.getElementById('host-game-btn').addEventListener('click', hostGame);
    document.getElementById('cancel-host-btn').addEventListener('click', () => leaveGame(true));
    document.getElementById('join-game-btn').addEventListener('click', () => switchScreen('join'));
    document.getElementById('cancel-join-btn').addEventListener('click', () => switchScreen('menu'));
    document.getElementById('confirm-join-btn').addEventListener('click', joinGame);
    document.getElementById('answer-btn').addEventListener('click', () => update(ref(db, `/games/${currentGameId}`), { questionActive: true }));
    document.getElementById('bank-btn').addEventListener('click', bankPoints);
    document.getElementById('lifeline-5050-btn').addEventListener('click', useFiftyFifty);
    document.getElementById('spin-btn').addEventListener('click', handleWheelClick);
    document.getElementById('game-code-display').addEventListener('click', (e) => { navigator.clipboard.writeText(e.target.textContent).then(() => { e.target.classList.add('copied'); setTimeout(() => e.target.classList.remove('copied'), 1000); }); });
    document.getElementById('rematch-btn').addEventListener('click', handleRematchClick);
    document.getElementById('back-to-menu-btn').addEventListener('click', () => leaveGame());

    const pyramidContainer = document.getElementById('money-pyramid');
    MONEY_PYRAMID.slice(1).forEach((level, index) => { const levelDiv = document.createElement('div'); levelDiv.id = `pyramid-level-${index + 1}`; levelDiv.classList.add('pyramid-level'); levelDiv.textContent = level.label; if (level.isLifelineLevel) levelDiv.classList.add('lifeline-level'); levelDiv.style.width = `${40 + (index * 6)}%`; pyramidContainer.appendChild(levelDiv); });
    createWheel();
</script>

</body>
</html>

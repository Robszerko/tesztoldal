<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora News Ticker - V201 (New PWS Design & Logic)</title>
    
    <!-- Fonts: Added 'Rajdhani' for the PWS widget -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js" type="module"></script>
    <script src="https://unpkg.com/suncalc@1.8.0/suncalc.js"></script>

    <style>
        :root {
            /* Palette */
            --bg-grad-1: #020617;
            --bg-grad-2: #1e293b;
            --bg-grad-3: #0f172a;
            
            /* Sharp UI */
            --panel-bg: rgba(6, 10, 25, 0.96); 
            --panel-gradient: linear-gradient(160deg, #1e293b 0%, #0f172a 60%, #020617 100%);
            
            --panel-border: rgba(255, 255, 255, 0.12);
            --panel-shadow: 0 10px 40px -5px rgba(2, 6, 23, 0.6), inset 0 1px 0 0 rgba(255, 255, 255, 0.15);
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-color: #38bdf8;
            --accent-warm: #fbbf24;
            --accent-danger: #ef4444;
            --accent-traffic: #f59e0b;
            --accent-next: #a855f7; 
            --accent-info: #10b981;
            
            --font-head: 'Montserrat', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-serif: 'Playfair Display', serif;
            --font-tech: 'Rajdhani', sans-serif; /* New font variable */
            
            --cap-radius-outer: 90px; 
            --cap-radius-inner: 8px; 
            --bar-height: 185px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            background-color: transparent;
            font-family: var(--font-body);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* STABLE BACKGROUND */
        .ambient-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3));
            background-size: 300% 300%;
            animation: skyFlow 60s ease infinite;
        }
        @keyframes skyFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- CONTAINER --- */
        .ticker-container { 
            width: 100%; max-width: 1650px; 
            height: var(--bar-height); 
            display: flex; 
            gap: 0px; 
            position: relative; 
            justify-content: center; 
            align-items: stretch;
            transition: gap 1.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ticker-container.open { gap: 8px; }

        @media (max-width: 900px) { 
            .ticker-container { height: auto; flex-direction: column; gap: 10px !important; } 
            .glass-panel { border-radius: 12px !important; }
            .id-content, .weather-view { padding: 10px !important; }
        }

        /* PREMIUM PANEL DESIGN */
        .glass-panel {
            background: var(--panel-gradient);
            backdrop-filter: none; 
            -webkit-backdrop-filter: none;
            border: 1px solid var(--panel-border); 
            border-top: 1px solid rgba(255,255,255,0.25);
            border-bottom: 1px solid rgba(0,0,0,0.4);
            box-shadow: var(--panel-shadow);
            position: relative;
            perspective: 1000px;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .glass-panel.loaded { opacity: 1; transform: scale(1); }

        /* --- SHAPES --- */
        .identity-panel { 
            width: 220px; 
            flex-shrink: 0; z-index: 10; overflow: hidden;
            border-radius: var(--cap-radius-outer) var(--cap-radius-inner) var(--cap-radius-inner) var(--cap-radius-outer);
        }
        .weather-panel { 
            width: 250px; flex-shrink: 0; z-index: 10; overflow: hidden;
            border-radius: var(--cap-radius-inner) var(--cap-radius-outer) var(--cap-radius-outer) var(--cap-radius-inner);
        }
        .news-panel { 
            flex: 0; opacity: 0;
            display: flex; flex-direction: column; position: relative; cursor: pointer; 
            overflow: visible !important; 
            border-radius: var(--cap-radius-inner);
            transition: flex 1.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease 0.5s; 
        }
        .ticker-container.open .news-panel { flex: 1; opacity: 1; }

        /* --- FLIPPER --- */
        .panel-flipper {
            width: 100%; height: 100%;
            transition: transform 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; 
            position: relative;
        }
        .panel-flipper.flipped { transform: rotateX(900deg); }
        
        .panel-face {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column; 
            background: var(--panel-gradient);
            transform: rotateX(0deg) translateZ(1px); 
        }
        
        .panel-face.back { 
            display: flex; align-items: center; justify-content: center;
            transform: rotateX(180deg) translateZ(1px);
        }

        /* --- LEFT PANEL CONTENT --- */
        .id-content { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: flex-start; 
            padding: 15px 10px 25px 10px; 
            text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
        }
        
        /* 1. Header Block */
        .id-header-block {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            width: 100%;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: auto; 
            flex-shrink: 0;
        }

        .brand-wrapper { 
            display: flex; align-items: center; gap: 8px; justify-content: center;
            cursor: pointer; z-index: 50;
        }
        .brand-logo svg { width: 22px; height: 22px; fill: var(--accent-color); filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.4)); animation: pulseLogo 3s infinite ease-in-out; }
        .brand-name { font-family: var(--font-head); font-weight: 900; font-size: 1.1rem; letter-spacing: -0.5px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* Badge (Program) */
        .left-prog-badge {
            font-family: var(--font-head); font-weight: 800;
            font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;
            padding: 3px 10px; 
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent-color); 
            transition: all 0.5s ease; 
            opacity: 0; 
            transform: translateY(-5px);
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .left-prog-badge.visible { opacity: 1; transform: translateY(0); }
        
        /* Badge Colors */
        .left-prog-badge.badge-night { color: #c7d2fe; box-shadow: 0 0 10px rgba(129, 140, 248, 0.1); border-color: rgba(129, 140, 248, 0.3); }
        .left-prog-badge.badge-dawn { color: #ffe4e6; box-shadow: 0 0 10px rgba(251, 113, 133, 0.1); border-color: rgba(251, 113, 133, 0.3); }
        .left-prog-badge.badge-morning { color: #fef3c7; box-shadow: 0 0 10px rgba(252, 211, 77, 0.1); border-color: rgba(252, 211, 77, 0.3); }
        .left-prog-badge.badge-day { color: #e0f2fe; box-shadow: 0 0 10px rgba(125, 211, 252, 0.1); border-color: rgba(125, 211, 252, 0.3); }
        .left-prog-badge.badge-noon { color: #fefce8; box-shadow: 0 0 10px rgba(253, 224, 71, 0.1); border-color: rgba(253, 224, 71, 0.3); }
        .left-prog-badge.badge-afternoon { color: #ccfbf1; box-shadow: 0 0 10px rgba(94, 234, 212, 0.1); border-color: rgba(94, 234, 212, 0.3); }
        .left-prog-badge.badge-sunset { color: #fae8ff; box-shadow: 0 0 10px rgba(232, 121, 249, 0.1); border-color: rgba(232, 121, 249, 0.3); }
        .left-prog-badge.badge-evening { color: #f3e8ff; box-shadow: 0 0 10px rgba(192, 132, 252, 0.1); border-color: rgba(192, 132, 252, 0.3); }
        .left-prog-badge.badge-traffic { color: #fcd34d; background: rgba(245, 158, 11, 0.15); border-color: rgba(245, 158, 11, 0.5); }
        .left-prog-badge.badge-tip { color: #6ee7b7; background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.5); box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }

        /* 2. Clock Center Block */
        .clock-container { 
            flex-grow: 1; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; width: 100%; 
            margin-bottom: auto; 
        }
        
        .clock-main-row {
            display: flex; align-items: baseline; justify-content: center;
            line-height: 1;
            margin-top: 5px; 
        }
        
        .clock-hm { 
            font-family: var(--font-head); 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: #ffffff; 
            letter-spacing: -0.5px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            background: linear-gradient(180deg, #fff 20%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; 
        }
        
        .clock-s { 
            font-family: var(--font-mono); 
            font-size: 1.0rem; 
            font-weight: 600; 
            color: var(--accent-color); 
            margin-left: 3px;
            opacity: 0.8;
        }
        
        .date-display { 
            font-size: 0.75rem; 
            color: var(--accent-color); 
            text-transform: uppercase; letter-spacing: 0.5px; 
            font-weight: 700; 
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        /* --- CREDITS & ECONOMY --- */
        .credits-content { 
            background: #0f172a; opacity: 0; z-index: 1; pointer-events: none;
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            position: absolute; top: 0; left: 0; transition: opacity 0.4s ease; padding-left: 30px; 
        }
        .credits-content.active { opacity: 1; z-index: 2; pointer-events: all; }
        .cr-container { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; }
        .cr-name-main { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: #fff; letter-spacing: 1px; font-style: italic; margin-bottom: 8px; background: linear-gradient(to bottom, #fff 30%, var(--accent-warm) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cr-line { width: 40px; height: 1px; background: rgba(255,255,255,0.2); margin-bottom: 8px; }
        .cr-bottom-text { font-family: var(--font-mono); font-size: 0.6rem; color: #64748b; line-height: 1.5; }
        
        .economy-content { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; text-align: center;
            position: absolute; top: 0; left: 0; transition: opacity 0.3s;
            background: linear-gradient(135deg, #1e293b, #334155); 
            opacity: 0; z-index: 1; pointer-events: none;
            border: 1px solid rgba(251, 191, 36, 0.2); padding-left: 30px; 
        }
        .economy-content.active { opacity: 1; z-index: 2; pointer-events: all; }
        .eco-header { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; width: 100%; justify-content: center; }
        .eco-carousel { width: 100%; flex-grow: 1; position: relative; }
        .eco-slide { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; gap: 6px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .eco-slide.active { opacity: 1; pointer-events: all; }
        .eco-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 4px; }
        .eco-curr { display: flex; align-items: center; gap: 5px; font-family: var(--font-head); font-weight: 700; color: var(--accent-color); font-size: 0.9rem; }
        .eco-val { font-family: var(--font-mono); font-weight: 700; color: #fff; font-size: 0.85rem; }

        /* --- NEWS PANEL --- */
        .news-viewport { 
            flex-grow: 1; position: relative; overflow: hidden; z-index: 2; 
            border-radius: var(--cap-radius-inner);
            padding-bottom: 30px; 
        }
        .news-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: row; /* Split View */
            justify-content: flex-start;
            padding: 12px 10px 30px 15px;
            gap: 15px; 
            opacity: 0; visibility: hidden; transform: translateY(15px);
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .news-card.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .news-content-wrapper { 
            flex: 1 1 auto; 
            display: flex; flex-direction: column; justify-content: flex-start; 
            min-height: 0; gap: 6px; 
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.8) 50%, rgba(15, 23, 42, 0.4) 100%);
            padding: 10px 15px 5px 10px; border-radius: 8px; margin-left: -10px; 
            height: 100%; position: relative; transition: border 0.3s;
            width: 100%;
            max-width: 100%;
            transition: max-width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* --- VISUAL COLUMN --- */
        .news-visual-column {
            position: relative;
            width: 250px; 
            flex-shrink: 0;
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
            transform: translateX(120%); 
            transition: transform 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 15;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            background: #0f172a;
            display: flex; align-items: center; justify-content: center;
        }

        .news-card.visible .news-visual-column.slide-in { transform: translateX(0); }
        .news-card.has-visual .news-content-wrapper { max-width: calc(100% - 270px); }

        @media (max-width: 950px) {
            .news-visual-column { display: none !important; }
            .news-card.has-visual .news-content-wrapper { max-width: 100% !important; }
        }
        
        .news-visual-image { width: 100%; height: 100%; object-fit: cover; }

        .visual-fallback { display: flex; flex-direction: column; align-items: center; gap: 10px; text-align: center; color: #fff; padding: 10px; }
        @keyframes spinGlobe { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .visual-fallback svg.tkp-globe { width: 80px; height: 80px; fill: var(--accent-color); filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.4)); animation: spinGlobe 20s linear infinite; }
        .visual-fallback span { font-family: var(--font-head); font-weight: 800; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-color); }

        .news-card.traffic-alert .news-content-wrapper { background: linear-gradient(90deg, rgba(69, 26, 3, 0.95) 0%, rgba(124, 45, 18, 0.8) 50%, rgba(69, 26, 3, 0.4) 100%); border-left: 3px solid var(--accent-traffic); }

        .news-title { 
            flex: 0 0 auto; 
            font-family: var(--font-head); font-size: 1.25rem; 
            font-weight: 700; line-height: 1.3; color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,1); 
            width: 100%; 
            z-index: 5; 
            padding-bottom: 5px;
            padding-right: 5px; 
            margin-top: 0;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }

        /* --- SWITCHABLE DESCRIPTION --- */
        .news-desc { 
            flex: 1 1 auto; 
            font-size: 0.95rem; 
            color: #e2e8f0; font-weight: 400; line-height: 1.5; 
            overflow: hidden; 
            position: relative;
            max-width: 99%; 
            text-shadow: 0 1px 2px rgba(0,0,0,1); z-index: 5; 
        }
        
        .news-desc .short-view { display: block; opacity: 1; transition: opacity 0.3s; }
        .news-desc .full-view { display: none; opacity: 0; height: 100%; overflow-y: auto; padding-right: 5px; }
        
        /* HOVER EFFECT: SWAP CONTENT */
        .news-card:hover .news-desc .short-view { display: none; opacity: 0; }
        .news-card:hover .news-desc .full-view { display: block; opacity: 1; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom scrollbar for full view */
        .full-view::-webkit-scrollbar { width: 4px; }
        .full-view::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .full-view::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }

        .news-footer-row {
            flex: 0 0 auto;
            display: flex; align-items: center; 
            justify-content: space-between; 
            margin-top: auto; 
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            z-index: 10; background: transparent; 
        }
        
        .news-meta { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; 
            color: var(--accent-color); font-weight: 700; white-space: nowrap; z-index: 2; 
        }
        .news-card.traffic-alert .news-meta { color: var(--accent-warm); }
        
        .provider-identity { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 15px; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .provider-icon { width: 16px; height: 16px; border-radius: 50%; }
        .traffic-icon-svg { width: 16px; height: 16px; fill: var(--accent-warm); }

        /* NYIREGYHAZA WEATHER IN FOOTER - REVISED V201 (NEW DESIGN) */
        .ny-weather-in-footer {
            position: absolute; 
            bottom: 30px; 
            right: 300px;
            display: none; align-items: center; gap: 8px;
            
            /* NEW MODERN DESIGN */
            font-family: var(--font-tech); /* Rajdhani */
            font-size: 1.1rem; /* Slightly bigger */
            font-weight: 600; 
            color: #fff;
            
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(4px);
            
            padding: 4px 15px; 
            border-radius: 0 4px 4px 0; /* Asymmetric */
            border-left: 3px solid var(--accent-warm); /* Golden Accent */
            border-bottom: 1px solid rgba(255,255,255,0.05);

            pointer-events: none; 
            
            text-shadow: 0 2px 5px rgba(0,0,0,0.8);
            letter-spacing: 0.5px;
            z-index: 200; 
            white-space: nowrap;
            
            opacity: 0; 
            transition: opacity 1s ease;
        }
        
        .ny-weather-in-footer.visible { opacity: 1; }

        /* TIP CARD STYLES */
        .news-card.tip-card {
            background: radial-gradient(circle at top left, #064e3b, #022c22);
            border-left: 4px solid var(--accent-info);
            align-items: center; justify-content: center;
            text-align: center;
            flex-direction: column;
            padding-right: 15px;
        }
        .tip-content { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .tip-icon-row { display: flex; align-items: center; gap: 20px; }
        .tip-icon { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #fff; }
        .tip-icon svg { width: 32px; height: 32px; fill: var(--accent-info); filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.4)); }
        .tip-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #a7f3d0; }
        .tip-text { font-size: 1.1rem; font-weight: 600; color: #fff; max-width: 80%; line-height: 1.4; }

        .default-news-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 1; transition: opacity 1s ease; }
        .dnb-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, #1e3a8a, #0f172a 70%, #020617); }
        .dnb-world-map { position: absolute; top: 5%; right: -5%; width: 70%; height: 80%; background-image: radial-gradient(rgba(255,255,255,0.12) 1px, transparent 1px); background-size: 20px 20px; mask-image: radial-gradient(circle, black 30%, transparent 80%); transform: rotate(-10deg); }
        .dnb-watermark { position: absolute; top: 50%; left: 70%; transform: translate(-50%, -50%); opacity: 0.04; pointer-events: none; }
        .dnb-watermark svg { width: 400px; height: 400px; fill: #fff; }
        .dnb-text-strip { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-around; transform: rotate(-3deg); opacity: 0.05; font-family: var(--font-head); font-weight: 900; font-size: 4.5rem; color: #fff; white-space: nowrap; letter-spacing: 5px; }

        /* NIGHT LABEL - STRICTLY HIDDEN BY DEFAULT */
        #night-summary-label {
            display: none; 
            align-items: center; font-size: 0.7rem; font-weight: 700;
            color: var(--accent-warm); text-transform: uppercase; letter-spacing: 0.5px;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
            white-space: nowrap; margin-right: 0; z-index: 200; flex-shrink: 0;
        }
        #night-summary-label.active { display: flex; }

        .news-card.night-info { background: radial-gradient(circle at top left, #312e81, #1e1b4b); border-left: 4px solid #a855f7; alignItems: center; justify-content: center; text-align: center; padding-bottom: 35px; flex-direction: column; }
        
        /* GOODBYE CARD - OPTIMIZED SIZE (V184) */
        .goodbye-card { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: radial-gradient(circle at 50% 120%, #1e1b4b 0%, #020617 60%, #000000 100%);
            opacity: 0; visibility: hidden; 
            transition: opacity 1.5s cubic-bezier(0.19, 1, 0.22, 1), transform 1.5s ease;
            transform: scale(0.95);
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        .goodbye-card.active { opacity: 1; visibility: visible; transform: scale(1); }
        
        .gb-moon { 
            font-size: 3.2rem; 
            margin-bottom: 8px; 
            filter: drop-shadow(0 0 30px rgba(251, 191, 36, 0.4)); 
            animation: float 6s ease-in-out infinite; 
        }
        .gb-title { 
            font-family: var(--font-serif); 
            font-size: 1.4rem; 
            font-weight: 700; color: #fff; 
            margin-bottom: 8px; text-align: center; letter-spacing: 1px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); 
            background: linear-gradient(to bottom, #fff 40%, #94a3b8 100%); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .gb-brand-lockup { 
            display: flex; align-items: center; gap: 12px; 
            margin-top: 5px; 
            opacity: 0.9; 
            transform: scale(1.3); 
        }
        .gb-brand-lockup svg { width: 30px; height: 30px; fill: var(--accent-color); filter: drop-shadow(0 0 10px rgba(56,189,248,0.5)); }
        .gb-brand-text { font-family: var(--font-head); font-weight: 900; font-size: 1.2rem; color: #fff; }

        /* BIG CLOCK */
        .big-clock-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); z-index: 60; display: flex; flex-direction: row; gap: 30px; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        .big-clock-layer.active { opacity: 1; pointer-events: all; }
        .bc-digital-wrapper { display: flex; flex-direction: column; align-items: center; }
        .bc-time { font-family: var(--font-mono); font-size: 4.5rem; font-weight: 700; color: #fff; letter-spacing: -2px; animation: breathe 4s infinite ease-in-out; text-shadow: 0 0 20px rgba(56, 189, 248, 0.3); margin-bottom: 5px; font-variant-numeric: tabular-nums; }
        .bc-label { color: var(--accent-warm); font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; margin-top: 15px; font-weight: 600; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        
        /* ANALOG CLOCK */
        .analog-clock { width: 120px; height: 120px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); background: rgba(0,0,0,0.4); position: relative; box-shadow: 0 0 25px rgba(56, 189, 248, 0.2); backdrop-filter: blur(5px); }
        .hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; background: #fff; border-radius: 4px; box-shadow: 0 0 5px rgba(255,255,255,0.5); }
        .hand.hour { width: 4px; height: 35px; margin-left: -2px; }
        .hand.minute { width: 3px; height: 48px; margin-left: -1.5px; opacity: 0.9; }
        .hand.second { width: 1px; height: 52px; margin-left: -0.5px; background: var(--accent-danger); box-shadow: none; }
        .center-dot { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .hour-mark { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; justify-content: center; padding-top: 4px; font-family: var(--font-serif); font-size: 0.8rem; font-weight: 700; color: rgba(255,255,255,0.8); pointer-events: none; }
        
        /* --- CONTROLS BAR --- */
        .controls-bar { 
            position: absolute; 
            top: calc(100% - 28px); 
            left: 0; width: 100%;
            height: 28px; 
            border-top: 1px solid var(--panel-border); 
            background: #020617; 
            font-size: 0.75rem;
            z-index: 200; 
            overflow: hidden; 
            opacity: 0; 
            transition: height 0.6s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.5s ease;
            pointer-events: auto;
            cursor: pointer;
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        .ticker-container.open .controls-bar { opacity: 1; }

        .controls-bar.breaking-active {
            height: 60px; 
            background: #020617; 
            border-top: 1px solid #7f1d1d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        .controls-normal-content {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; height: 28px; padding: 0 15px;
            transition: opacity 0.3s;
            position: absolute; top: 0; left: 0;
            pointer-events: auto !important; 
            z-index: 101;
            padding: 0 10px;
            gap: 15px;
        }
        .controls-bar.breaking-active .controls-normal-content { opacity: 0; pointer-events: none !important; }

        .cb-left { display: none; }
        .cb-center { 
            flex-grow: 1; 
            display: flex; align-items: center; 
            justify-content: flex-start; 
            position: relative; overflow: hidden; padding-left: 10px;
            gap: 15px; /* Spacing between timeline and label */
        }
        #timeline-container { display: none; gap: 3px; overflow-x: auto; scrollbar-width: none; pointer-events: auto !important; z-index: 105; flex-grow: 1; }
        #timeline-container.visible { display: flex; }
        #timeline-container.shifted { margin-right: 15px; } 
        
        .timeline-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #ccc; font-family: var(--font-mono); font-size: 0.65rem; padding: 1px 5px; border-radius: 3px; cursor: pointer; transition: all 0.2s; pointer-events: auto !important; }
        .timeline-btn:hover, .timeline-btn.active { background: var(--accent-warm); color: #000; font-weight:700; }

        .cb-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; margin-left: auto; transform: translateZ(0); backface-visibility: hidden; }
        
        .live-dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 5px #22c55e; margin-right: 5px; opacity: 0.8; transition: background 0.3s, box-shadow 0.3s; }
        .live-dot.updating { background: #ef4444; box-shadow: 0 0 5px #ef4444; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .control-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; padding: 3px 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; pointer-events: auto !important; }
        .control-btn:hover { background: var(--accent-color); color: #000; }
        .control-btn svg { width: 12px; height: 12px; stroke: currentColor; stroke-width: 3; fill: none; }

        .next-prog-alert { display: none; align-items: center; gap: 5px; color: var(--accent-next); font-weight: 700; font-size: 0.65rem; text-transform: uppercase; background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding: 2px 8px; border-radius: 4px; white-space: nowrap; }
        .next-prog-alert.active { display: flex; }

        /* --- BREAKING PANEL (FLIP & NO STROBE) --- */
        .breaking-panel {
            position: absolute;
            bottom: 0px; /* Aligned to bottom, covering controls */
            left: 0; 
            width: 100%;
            height: 28px; /* Same height as controls */
            background: linear-gradient(90deg, #7f1d1d, #450a0a);
            border-top: 1px solid #ef4444;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            display: none; align-items: center; padding: 0 15px;
            z-index: 500;
            transform-origin: bottom center;
            overflow: hidden;
            opacity: 0;
            transform: perspective(600px) rotateX(90deg); /* Start flipped down */
            cursor: pointer;
        }
        
        .breaking-panel.active { 
            display: flex; 
            animation: flipInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }
        
        @keyframes flipInUp {
            from { transform: perspective(600px) rotateX(90deg); opacity: 0; }
            to { transform: perspective(600px) rotateX(0deg); opacity: 1; }
        }

        @keyframes flipOutDown {
            from { transform: perspective(600px) rotateX(0deg); opacity: 1; }
            to { transform: perspective(600px) rotateX(90deg); opacity: 0; }
        }
        .breaking-panel.closing { animation: flipOutDown 0.4s ease-in forwards; }

        .clean-badge {
            font-family: var(--font-head); font-weight: 900; font-size: 0.65rem;
            color: #fff; background: #b91c1c;
            padding: 2px 8px; border-radius: 4px;
            margin-right: 10px; text-transform: uppercase;
            box-shadow: 0 0 5px #ef4444;
            flex-shrink: 0;
        }

        .bp-meta-info {
            font-family: var(--font-mono); font-size: 0.7rem; color: #fca5a5;
            font-weight: 700; margin-right: 15px; white-space: nowrap; flex-shrink: 0;
        }
        
        .bp-text-mask {
            flex-grow: 1; overflow: hidden; position: relative; height: 100%; display: flex; align-items: center;
        }
        
        .bp-text-content {
            font-family: var(--font-head); font-weight: 700; color: #fff; font-size: 0.9rem;
            white-space: nowrap; will-change: transform;
            transform: translateX(20px); opacity: 0; transition: all 0.3s ease 0.3s;
        }
        .breaking-panel.active .bp-text-content { transform: translateX(0); opacity: 1; }

        @keyframes scrollTextLeft { 0% { transform: translateX(0); } 100% { transform: translateX(var(--scroll-dist)); } }

        .progress-line-container { position: absolute; bottom: 28px; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); z-index: 300; }
        .progress-line { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-color), var(--accent-warm)); box-shadow: 0 0 8px var(--accent-color); }
        .animate-progress { animation: progressFill linear forwards; }
        @keyframes progressFill { from { width: 0%; } to { width: 100%; } }
        
        .update-indicator { display: none; }
        
        /* --- WEATHER & SCHEDULE FLIPPER --- */
        .weather-header-container { 
            height: 28px; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--glass-border); 
            display: flex; align-items: center; justify-content: center;
            padding: 0 55px 0 15px; 
            z-index: 10; width: 100%; position: absolute; top:0; left:0;
        }
        .weather-location-header { 
            display: flex; justify-content: center; align-items: center; width: 100%; 
            font-weight: 700; color: var(--accent-color); transition: opacity 0.5s; 
            font-size: 0.8rem; text-transform: uppercase;
        }
        
        .weather-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 55px 10px 20px; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.1) 100%); }
        .weather-main { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
        .weather-main-left { display: flex; align-items: center; justify-content: center; width: 40%; }
        .weather-main-right { display: flex; flex-direction: column; align-items: flex-end; width: 60%; }
        
        .weather-temp-big { 
            font-family: var(--font-head); 
            font-size: 2.0rem; 
            font-weight: 700; color: #fff; 
            text-shadow: 0 0 15px rgba(255,255,255,0.15); 
            line-height: 1; 
            white-space: nowrap; 
        }
        
        .weather-feels { font-size: 0.65rem; color: var(--accent-warm); text-transform: uppercase; margin-top: 2px; font-weight: 600; }
        .weather-icon-big svg { width: 56px; height: 56px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
        .weather-details-list { padding: 5px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.7rem; display: flex; flex-direction: column; gap: 3px; margin-top: 5px; border: 1px solid rgba(255,255,255,0.05); }
        .wd-row { display: flex; justify-content: space-between; color: #ccc; }
        .wd-val { color: #fff; font-weight: 600; }
        .weather-footer-time { font-family: var(--font-mono); font-size: 0.7rem; color: #94a3b8; text-align: center; margin-top: auto; padding-bottom: 5px; width: 100%; font-weight: 400; }

        /* --- WEATHER LOADER (FIXED) --- */
        #weather-loading-state {
            display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        #weather-loading-state.active { display: flex; }
        
        .radar-spinner { width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(56, 189, 248, 0.3); border-top-color: var(--accent-color); animation: spin 1s linear infinite; margin-bottom: 10px; }
        .loading-text { font-size: 0.6rem; font-weight: 700; color: var(--accent-warm); animation: pulseText 1.5s infinite; letter-spacing: 1px; }

        /* --- SCHEDULE --- */
        .schedule-view { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 35px 55px 5px 15px; justify-content: flex-start; }
        .schedule-list { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; justify-content: flex-start; }
        .schedule-item { display: flex; align-items: flex-start; gap: 8px; padding: 4px 8px; border-radius: 4px; border-left: 3px solid transparent; transition: background 0.3s, border-color 0.3s; }
        .schedule-item.active-highlight { background: rgba(56, 189, 248, 0.2); border-left-color: var(--accent-color); }
        .schedule-item.active-highlight .sch-name { color: #fff; font-weight: 700; }
        .schedule-item.active-highlight .sch-label { color: var(--accent-color); }
        .sch-time { font-family: var(--font-mono); font-size: 0.8rem; color: #fff; font-weight: 700; width: 45px; flex-shrink: 0; margin-top: 2px; }
        .sch-label { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 1px; transition: color 0.3s;}
        .sch-name { font-size: 0.8rem; color: #94a3b8; line-height: 1.2; white-space: normal; transition: color 0.3s; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* PROMO */
        .promo-content { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: linear-gradient(135deg, #1e1b4b, #312e81); text-align: center; padding-right: 60px; }
        .promo-main-block { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #e2e8f0; font-size: 0.9rem; font-weight: 600; }
        .promo-logo-inline { display: inline-flex; align-items: center; gap: 6px; margin: 4px 0; }
        .promo-logo-inline svg { width: 24px; height: 24px; fill: var(--accent-color); filter: drop-shadow(0 0 5px rgba(56,189,248,0.5)); }
        .promo-tkp { font-family: var(--font-head); font-weight: 900; color: #fff; font-size: 1.1rem; }
        .promo-24-wrapper { position: relative; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
        .promo-24-block { font-family: var(--font-head); font-size: 4rem; font-weight: 900; line-height: 1; color: #fff; background: linear-gradient(to bottom, #fff 40%, var(--accent-color) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 10px rgba(56,189,248,0.3)); }
        .promo-daynight-badge { position: absolute; right: -30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .promo-dn-icon { width: 20px; height: 20px; }
        .promo-dn-sun { fill: var(--accent-warm); filter: drop-shadow(0 0 5px rgba(251,191,36,0.6)); }
        .promo-dn-moon { fill: #38bdf8; filter: drop-shadow(0 0 5px rgba(56,189,248,0.6)); }
        .promo-dn-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .promo-sub { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-warm); font-weight: 700; }

        .loading-overlay { display: none; } 
        
        #dev-menu {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent-color);
            padding: 20px; border-radius: 12px; z-index: 9999;
            display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            color: #fff; font-family: var(--font-mono);
            max-height: 80vh; overflow-y: auto;
        }
        #dev-menu h3 { margin: 0 0 10px 0; color: var(--accent-warm); text-transform: uppercase; font-size: 0.9rem; }
        .dev-btn {
            background: rgba(56, 189, 248, 0.2); border: 1px solid var(--accent-color);
            color: #fff; padding: 8px; cursor: pointer; font-family: var(--font-body); font-weight: 600;
            transition: background 0.2s; font-size: 0.8rem;
        }
        .dev-btn:hover { background: var(--accent-color); color: #000; }
        .dev-close { background: #dc2626; border-color: #ef4444; margin-top: 10px; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.95); opacity: 0.8; } }
        @keyframes pulseRed { 0%, 100% { background-color: var(--accent-danger); box-shadow: 0 0 5px var(--accent-danger); } 50% { background-color: #dc2626; box-shadow: 0 0 20px var(--accent-danger); } }
        .strobe-effect { animation: strobeAnim 1.5s ease-out forwards; }
        @keyframes strobeAnim { 0% { opacity: 0; transform: scale(1.1); filter: brightness(2); } 10% { opacity: 1; } 20% { opacity: 0; } 30% { opacity: 1; } 40% { opacity: 0; } 50% { opacity: 1; filter: brightness(1); transform: scale(1); } 100% { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes breathe { 0%{transform:scale(1);} 50%{transform:scale(1.02);} 100%{transform:scale(1);} }

        .manual-refresh { position: absolute; top: 5px; right: 5px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; cursor: pointer; opacity: 0; transition: opacity 0.3s; }
        .identity-panel:hover .manual-refresh { opacity: 0.5; }
    </style>
</head>
<body data-theme="night">

    <div class="ambient-background" id="sky-bg"></div>

    <!-- DEV MENU -->
    <div id="dev-menu">
        <h3>Hírek & Panel Tesztek</h3>
        <button class="dev-btn" onclick="window.triggerTestBreaking()">Teszt: Breaking (Rövid)</button>
        <button class="dev-btn" onclick="window.triggerTestBreakingLong()">Teszt: Breaking (Hosszú)</button>
        <button class="dev-btn" style="border-color: #f59e0b; color: #f59e0b;" onclick="window.triggerTestTraffic()">Teszt: Közlekedés</button>
        <button class="dev-btn" onclick="window.triggerVisualNews()">Teszt: Képes Hír (Normál)</button>
        <button class="dev-btn" onclick="window.triggerTextNews()">Teszt: Szöveges Hír (Normál)</button>
        
        <h3 style="margin-top:10px;">Jobb Panel & Egyéb</h3>
        <button class="dev-btn" style="border-color: #fbbf24; color: #fbbf24;" onclick="window.triggerEconomyTest()">Teszt: Árfolyam</button>
        <button class="dev-btn" onclick="window.triggerSchedule()">Teszt: Műsorajánló</button>
        <button class="dev-btn" onclick="window.triggerWeatherLoading()">Teszt: Időjárás Loader</button>
        
        <h3 style="margin-top:10px;">Módok & Események</h3>
        <button class="dev-btn" onclick="window.triggerNightMode()">Teszt: Éjszakai Mód (Timeline + Felirat)</button>
        <button class="dev-btn" onclick="window.triggerDayMode()">Teszt: Nappali Mód (Vissza)</button>
        <button class="dev-btn" style="border-color: #a855f7; color: #a855f7;" onclick="window.triggerHourChangeTest()">Teszt: Óraváltás (10mp)</button>
        <button class="dev-btn" style="border-color: #c026d3; color: #c026d3;" onclick="window.triggerGoodbyeTest()">Teszt: Elköszönés (15mp)</button>
        <button class="dev-btn" onclick="window.triggerCredits()">Teszt: Stáblista</button>
        
        <button class="dev-btn dev-close" onclick="window.closeDevMenu()">Bezárás</button>
    </div>

    <section class="ticker-container" id="ticker-container">
        
        <!-- PANEL 1: IDENTITY & ECONOMY (REDESIGNED) -->
        <div class="glass-panel identity-panel" id="panel-left">
            <div class="panel-flipper" id="id-flipper">
                <!-- Front: ID -->
                <div class="panel-face">
                    <div class="id-content">
                        <!-- Header: Logo & Name -->
                        <div class="id-header-block">
                            <div class="brand-wrapper" id="brand-click-area">
                                <div class="brand-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                                <div class="brand-name">TKP NEWS</div>
                            </div>
                            <!-- Program Badge moved here -->
                            <div id="left-program-badge" class="left-prog-badge">BETÖLTÉS...</div>
                        </div>
                        
                        <!-- Center: CLOCK & DATE (SWAPPED & CENTERED) -->
                        <div class="clock-container">
                             <div id="date-display" class="date-display">...</div>
                            <div class="clock-main-row">
                                <div id="clock-hm" class="clock-hm">--:--</div>
                                <div id="clock-s" class="clock-s">--</div>
                            </div>
                        </div>
                        
                        <div class="manual-refresh" id="manual-refresh-trigger"></div>
                    </div>
                </div>
                <!-- Back: Credits & Economy -->
                <div class="panel-face back">
                    <div class="back-face-container">
                        <div class="credits-content" id="credits-content">
                            <div class="cr-container">
                                <div class="cr-logo-icon">✦</div>
                                <div class="cr-text-madeby">A HÍRCSÍK PANELT KÉSZÍTETTE</div>
                                <div class="cr-name-main">ROBI</div>
                                <div class="cr-line"></div>
                                <div class="cr-bottom-text">
                                    <div>&copy; <span id="cr-year">2025</span> Copyright by: Robi</div>
                                    <div>Minden jog fenntartva!</div>
                                </div>
                            </div>
                        </div>
                        <div class="economy-content" id="economy-content">
                            <div class="eco-header">
                                <div class="brand-logo" style="transform: scale(0.6);"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                                <div class="eco-title">ÁRFOLYAM</div>
                            </div>
                            <div class="eco-carousel">
                                <div class="eco-slide active" id="eco-slide-0">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/eu.png" class="eco-flag"> EUR</div><div class="eco-val" id="rate-eur">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/us.png" class="eco-flag"> USD</div><div class="eco-val" id="rate-usd">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ch.png" class="eco-flag"> CHF</div><div class="eco-val" id="rate-chf">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-1">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/gb.png" class="eco-flag"> GBP</div><div class="eco-val" id="rate-gbp">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/au.png" class="eco-flag"> AUD</div><div class="eco-val" id="rate-aud">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ca.png" class="eco-flag"> CAD</div><div class="eco-val" id="rate-cad">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-2">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/pl.png" class="eco-flag"> PLN</div><div class="eco-val" id="rate-pln">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/cz.png" class="eco-flag"> CZK</div><div class="eco-val" id="rate-czk">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/ro.png" class="eco-flag"> RON</div><div class="eco-val" id="rate-ron">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-3">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/jp.png" class="eco-flag"> JPY</div><div class="eco-val" id="rate-jpy">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/cn.png" class="eco-flag"> CNY</div><div class="eco-val" id="rate-cny">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/tr.png" class="eco-flag"> TRY</div><div class="eco-val" id="rate-try">---.-- Ft</div></div>
                                </div>
                                <div class="eco-slide" id="eco-slide-4">
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/se.png" class="eco-flag"> SEK</div><div class="eco-val" id="rate-sek">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/no.png" class="eco-flag"> NOK</div><div class="eco-val" id="rate-nok">---.-- Ft</div></div>
                                    <div class="eco-item"><div class="eco-curr"><img src="https://flagcdn.com/w20/dk.png" class="eco-flag"> DKK</div><div class="eco-val" id="rate-dkk">---.-- Ft</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL 2: NEWS CONTENT -->
        <div class="glass-panel news-panel" id="news-container">
            
            <div class="default-news-bg">
                <div class="dnb-gradient"></div>
                <div class="dnb-world-map"></div>
                <div class="dnb-watermark"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                <div class="dnb-text-strip"><span>NEWS</span><span>HÍREK</span><span>NACHRICHTEN</span><span>NOUVELLES</span></div>
            </div>

            <div class="loading-overlay" id="loading-overlay"></div>
            
            <div class="big-clock-layer" id="big-clock-layer">
                <div class="bc-digital-wrapper">
                    <div class="bc-time" id="bc-time-display">00:00:00</div>
                    <div class="bc-label"></div>
                </div>
                <div class="analog-clock">
                    <div class="hour-mark" style="transform: rotate(0deg)">XII</div>
                    <div class="hour-mark" style="transform: rotate(30deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(60deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(90deg)">III</div>
                    <div class="hour-mark" style="transform: rotate(120deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(150deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(180deg)">VI</div>
                    <div class="hour-mark" style="transform: rotate(210deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(240deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(270deg)">IX</div>
                    <div class="hour-mark" style="transform: rotate(300deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    <div class="hour-mark" style="transform: rotate(330deg); content: ''; width: 2px; background: rgba(255,255,255,0.3); height: 6px; top: 2px;"></div>
                    
                    <div class="hand hour" id="clock-hand-hour"></div>
                    <div class="hand minute" id="clock-hand-minute"></div>
                    <div class="hand second" id="clock-hand-second"></div>
                    <div class="center-dot"></div>
                </div>
            </div>

            <div class="goodbye-card" id="goodbye-card">
                <div class="gb-moon">🌙</div>
                <div class="gb-title">Nyugodalmas éjszakát kíván a</div>
                <div class="gb-brand-lockup">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    <div class="gb-brand-text">TKP NEWS</div>
                </div>
            </div>

            <div class="news-viewport" id="news-viewport">
                <div id="track-a" class="news-card"></div>
                <div id="track-b" class="news-card"></div>
            </div>

            <div class="progress-line-container"><div id="progress-bar" class="progress-line"></div></div>

            <!-- PWS BADGE HERE (Fixed Offset V201) -->
            <div id="pws-badge" class="ny-weather-in-footer"></div>

            <!-- SEPARATED BREAKING PANEL (FLIP DOWN STYLE) -->
            <div class="breaking-panel" id="breaking-panel">
                <div class="clean-badge">Most érkezett</div>
                <div class="bp-meta-info">
                    <span id="bp-time">00:00</span> <span style="opacity:0.5; margin:0 5px;">|</span> <span id="bp-source" style="color:#fff;">FORRÁS</span>
                </div>
                <div class="bp-text-mask">
                    <div class="bp-text-content" id="bp-text">Ez egy rendkívüli hír szövege...</div>
                </div>
            </div>

            <!-- CONTROLS BAR -->
            <div class="controls-bar" id="controls-bar-main">
                <div class="controls-normal-content" id="controls-normal">
                    <div class="cb-left"></div>
                    <div class="cb-center">
                         <div id="timeline-container"></div>
                         <div id="night-summary-label">AZ ELŐZŐ NAP HÍREI - ÖSSZEFOGLALÓ</div>
                    </div>
                    <div class="cb-right">
                        <div id="next-prog-alert" class="next-prog-alert"></div>
                        <div id="live-indicator" class="live-dot"></div>
                        <span id="counter-display" style="font-family:var(--font-mono); color:var(--text-muted); margin-right:5px; font-weight:700;">0/0</span>
                        <button class="control-btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        <button class="control-btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL 3: WEATHER / SCHEDULE / PROMO -->
        <div class="glass-panel weather-panel" id="panel-right">
            <div class="panel-flipper" id="weather-flipper">
                <div class="panel-face">
                     <div class="weather-header-container">
                        <div class="weather-location-header">
                            <span class="wlh-loc" id="weather-loc-name">IDŐJÁRÁS KÖZPONT</span>
                        </div>
                    </div>
                    <div class="weather-view">
                         <div id="weather-loading-state" class="active">
                            <div class="radar-spinner"></div>
                            <div class="loading-text">ADATOK LETÖLTÉSE...</div>
                        </div>

                        <div id="weather-data-container" style="opacity: 0; transition: opacity 0.5s;">
                            <div class="weather-main">
                                <div class="weather-main-left">
                                    <div class="weather-icon-big" id="weather-icon-slot"></div>
                                </div>
                                <div class="weather-main-right">
                                    <div class="weather-temp-big" id="weather-temp">--°</div>
                                    <div class="weather-feels" id="weather-feels"></div>
                                </div>
                            </div>
                            <div class="weather-details-list">
                                <div class="wd-row"><span>Pára</span><span class="wd-val" id="wd-hum">--%</span></div>
                                <div class="wd-row"><span>Szél</span><span class="wd-val" id="wd-wind">--</span></div>
                                <div class="wd-row"><span>Nyomás</span><span class="wd-val" id="wd-press">-- hPa</span></div>
                            </div>
                            <div class="weather-footer-time" id="weather-loc-time">Frissítve: --:--:--</div>
                        </div>
                    </div>
                </div>
                <div class="panel-face back">
                    <div class="weather-header-container" id="schedule-header">
                        <div class="weather-location-header">MŰSORAJÁNLÓ</div>
                    </div>
                    <div class="schedule-view" id="schedule-view">
                         <div class="schedule-list" id="schedule-list-content"></div>
                    </div>
                    <div class="promo-content" id="promo-view" style="display:none;">
                        <div class="promo-main-block">
                            <span>Kövesd a</span>
                            <div class="promo-logo-inline">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                <span class="promo-tkp">TKP NEWS</span>
                            </div>
                            <span>oldalát a nap</span>
                        </div>
                        <div class="promo-24-wrapper">
                            <div class="promo-24-block">24</div>
                            <div class="promo-daynight-badge">
                                <svg class="promo-dn-icon promo-dn-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path stroke="var(--accent-warm)" stroke-width="2" d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none"/></svg>
                                <div class="promo-dn-sep"></div>
                                <svg class="promo-dn-icon promo-dn-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="var(--accent-color)"/></svg>
                            </div>
                        </div>
                        <div class="promo-sub">órájában</div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        const WUNDERGROUND_API_KEY = "e1f10a1e78da46f5b10a1e78da96f525"; 
        const NYIREGYHAZA_COORDS = { lat: 47.95, lon: 21.71 };
        
        const ICONS = {
            CLEAR: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`,
            CLEAR_NIGHT: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            CLOUDY: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
            CLOUDY_NIGHT: `<svg viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><circle cx="18" cy="6" r="3" stroke="var(--accent-warm)" stroke-width="1.5" fill="none" /></svg>`,
            FOG: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5"><path d="M4 15h16M4 12h16M4 9h16M4 18h16"/></svg>`,
            RAIN: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`,
            SNOW: `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg>`,
            THUNDER: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-warm)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`
        };

        const TRAFFIC_ICON = `<svg class="traffic-icon-svg" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;

        const SKY_PHASES = {
            DEEP_NIGHT: { stops: ["#020617", "#0f172a", "#000000"] },
            ASTRO_DAWN: { stops: ["#0f172a", "#1e1b4b", "#172554"] },
            NAUTICAL_DAWN: { stops: ["#1e1b4b", "#312e81", "#4338ca"] },
            CIVIL_DAWN: { stops: ["#312e81", "#4f46e5", "#c026d3"] },
            SUNRISE:    { stops: ["#4f46e5", "#db2777", "#f59e0b"] },
            MORNING:    { stops: ["#0ea5e9", "#7dd3fc", "#bae6fd"] },
            NOON:       { stops: ["#0284c7", "#38bdf8", "#e0f2fe"] }
        };

        const PWS_MAP = { "ISRVR13": "Sárvár", "IOSZK4": "Oszkó", "ISZNTD6": "Szántód", "IBALAT149": "Balatonszemes", "IBUZSK1": "Csisztapuszta", "ISZEKS12": "Szekszárd", "IJNOSH2": "Jánoshalma", "IPCS52": "Pécs", "IPPRD1": "Páprád", "IKISKU42": "Kiskunhalas", "INEMES10": "Nemesnádudvar", "ISZEGE67": "Szeged", "IBKSCS12": "Békéscsaba", "IFZESG2": "Füzesgyarmat", "IMIKEP2": "Mikepércs", "ITGLS2": "Téglás", "IGACSL1": "Gacsály", "IFLESD1": "Fülesd", "IKISSZ3": "Kisszekeres", "ILEVEL2": "Levelek", "IKEMEC2": "Kemecse", "INAGYC6": "Nagycserkesz", "ITISZA15": "Tiszavasvári", "INEMES19": "Nemesbikk", "IEGERS22": "Egerszólát", "IBKKSZ5": "Bükkszenterzsébet", "IPSZT1": "Pásztó", "IPALOT13": "Palotás", "IGDLL37": "Gödöllő", "IZSMBK6": "Zsámbék", "ICSORN6": "Csorna", "IGAGYV1": "Gagyvendégi", "IMARTO122": "Martonyi", "IKAZIN14": "Kazincbarcika", "IPUTNO1": "Putnok", "IZABAR1": "Zabar", "ISALGT1": "Salgótarján", "IKARAN11": "Karancslapujtő", "IBEKLC3": "Bekölce", "IMTRAB1": "Mátraballa", "IVC267": "Vác", "IPILIS37": "Pilisvörösvár", "IFELCS4": "Felcsút", "IBUDAK6": "Budakeszi", "IBIATO9": "Biatorbágy", "ICSKVR4": "Csákvár", "IOROSZ2": "Oroszlány", "IBALINKA2": "Bakony", "ISR67": "Súr", "IPANNO3": "Pannonhalma", "IKAJRP2": "Kajárpéc", "IPPA11": "Pápa", "ICELLD14": "Celldömölk", "IHEVES2": "Heves", "IGYNGY22": "Gyöngyös", "ISZCSN9": "Szécsény", "ITAHIT11": "Tahitótfalu", "IESZTE5": "Esztergom", "ITATA16": "Tata", "IKARTAL4": "Kartal", "IMARTO67": "Martonvásár", "ISZOLNOK10": "Szolnok", "ISZOLN13": "Szolnok", "INAGYK59": "Nagykőrös", "IKECSK31": "Kecskemét", "IKALOCSA2": "Kalocsa", "IBONYH1": "Bonyhád", "ISZENT114": "Szentlőrinc", "ILJUBL47": "Ljubljana", "IBAKTA4": "Baktalórántháza", "IJFEHR1": "Újfehértó", "IPAPOS6": "Papos", "ISONKD1": "Sonkád", "INAPKO1": "Napkor", "IHARSN4": "Harsány", "IBKKSZ2": "Bükkszentkereszt", "INYREG37": "Nyíregyháza", "IPUSZT3": "Pusztadobos", "ITISZA93": "Tiszaújváros", "IEGER76": "Eger", "IHAJDD7": "Hajdúdorog", "IGYULA12": "Gyula", "IMAGYA4": "Magyarcsanád", "IHDMEZ21": "Hódmezővásárhely", "ISZEGE23": "Szeged-Rókus", "ICSENG9": "Csengele", "INAGYN1": "Nagynyárád", "IKIRLY1": "Királyegyháza", "ITAMSI1": "Tamási", "IZALAE45": "Zalaegerszeg", "IFARKA7": "Farkasgyepű", "INYRAC1": "Nyíracsád", "ISZAMO11": "Szamosújlak", "IGVAVE1": "Gávavencsellő", "IEDELN2": "Edelény", "INYRI1": "Nyíri", "IBTTS1": "Büttös", "IZD2": "Ózd" };
        
        const HUNGARIAN_CITIES_OM = [ 
            { name: 'Debrecen', lat: 47.53, lon: 21.62 }, { name: 'Miskolc', lat: 48.10, lon: 20.78 }, { name: 'Szombathely', lat: 47.23, lon: 16.62 }, { name: 'Győr', lat: 47.68, lon: 17.63 }, { name: 'Pécs', lat: 46.07, lon: 18.23 }, { name: 'Szeged', lat: 46.25, lon: 20.15 }, { name: 'Eger', lat: 47.90, lon: 20.37 }, { name: 'Veszprém', lat: 47.09, lon: 17.91 }, { name: 'Zalaegerszeg', lat: 46.84, lon: 16.84 }, { name: 'Békéscsaba', lat: 46.68, lon: 21.09 }, { name: 'Kaposvár', lat: 46.36, lon: 17.79 }, { name: 'Tatabánya', lat: 47.57, lon: 18.40 }, { name: 'Salgótarján', lat: 48.10, lon: 19.80 }, { name: 'Szekszárd', lat: 46.35, lon: 18.70 }, { name: 'Sopron', lat: 47.68, lon: 16.58 }, { name: 'Hódmezővásárhely', lat: 46.43, lon: 20.32 }, { name: 'Nagykanizsa', lat: 46.45, lon: 16.99 }, { name: 'Dunaújváros', lat: 46.96, lon: 18.93 }, { name: 'Érd', lat: 47.38, lon: 18.91 }, { name: 'Szolnok', lat: 47.18, lon: 20.20 }, { name: 'Kecskemét', lat: 46.88, lon: 19.64 }, { name: 'Baja', lat: 46.18, lon: 18.95 }, { name: 'Cegléd', lat: 47.17, lon: 19.80 }, { name: 'Vác', lat: 47.78, lon: 19.13 }, { name: 'Gödöllő', lat: 47.60, lon: 19.35 }, { name: 'Ózd', lat: 48.22, lon: 20.29 }, { name: 'Pápa', lat: 47.33, lon: 17.47 }, { name: 'Gyula', lat: 46.65, lon: 21.28 }, { name: 'Hajdúböszörmény', lat: 47.67, lon: 21.51 }, { name: 'Nyíregyháza', lat: 47.95, lon: 21.71 }, { name: 'Balatonfüred', lat: 46.96, lon: 17.89 }, { name: 'Keszthely', lat: 46.76, lon: 17.24 }, { name: 'Siófok', lat: 46.90, lon: 18.05 }, { name: 'Komárom', lat: 47.74, lon: 18.11 }, { name: 'Esztergom', lat: 47.79, lon: 18.74 }, { name: 'Tata', lat: 47.65, lon: 18.31 }, { name: 'Mohács', lat: 45.99, lon: 18.68 }, { name: 'Paks', lat: 46.62, lon: 18.86 }, { name: 'Kalocsa', lat: 46.53, lon: 18.98 }, { name: 'Kiskunfélegyháza', lat: 46.71, lon: 19.85 }, { name: 'Jászberény', lat: 47.50, lon: 19.91 }, { name: 'Hatvan', lat: 47.66, lon: 19.67 }, { name: 'Gyöngyös', lat: 47.78, lon: 19.93 }, { name: 'Kazincbarcika', lat: 48.25, lon: 20.62 }, { name: 'Sátoraljaújhely', lat: 48.40, lon: 21.65 }, { name: 'Kisvárda', lat: 48.22, lon: 22.08 }, { name: 'Mátészalka', lat: 47.95, lon: 22.32 }, { name: 'Makó', lat: 46.22, lon: 20.47 }, { name: 'Szentes', lat: 46.65, lon: 20.26 }, { name: 'Orosháza', lat: 46.57, lon: 20.66 }, { name: 'Karcag', lat: 47.31, lon: 20.93 }, { name: 'Hajdúszoboszló', lat: 47.45, lon: 21.39 }, { name: 'Törökszentmiklós', lat: 47.17, lon: 20.41 }, { name: 'Gyál', lat: 47.38, lon: 19.22 }, { name: 'Dunakeszi', lat: 47.64, lon: 19.14 }, { name: 'Budaörs', lat: 47.46, lon: 18.96 }, { name: 'Szentendre', lat: 47.66, lon: 19.07 }, { name: 'Szigetszentmiklós', lat: 47.34, lon: 19.05 }, { name: 'Mosonmagyaróvár', lat: 47.87, lon: 17.27 }, { name: 'Bicske', lat: 47.49, lon: 18.63 }, { name: 'Monor', lat: 47.35, lon: 19.45 }, { name: 'Mezőkövesd', lat: 47.81, lon: 20.57 }, { name: 'Tiszaújváros', lat: 47.92, lon: 21.05 }, { name: 'Sárospatak', lat: 48.32, lon: 21.57 },
            /* V148 Additions */
            { name: 'Zakopane', lat: 49.29, lon: 19.94 }, { name: 'Poprad', lat: 49.05, lon: 20.30 }, { name: 'Donovaly', lat: 48.88, lon: 19.22 }, { name: 'Semmering', lat: 47.63, lon: 15.83 }, { name: 'Murau', lat: 47.11, lon: 14.17 }, { name: 'Cortina d\'Ampezzo', lat: 46.54, lon: 12.13 }, { name: 'Chamonix', lat: 45.92, lon: 6.86 }, { name: 'Zermatt', lat: 46.02, lon: 7.74 }, { name: 'St. Moritz', lat: 46.49, lon: 9.83 }, { name: 'Aspen', lat: 39.19, lon: -106.81 }, { name: 'Whistler', lat: 50.11, lon: -122.95 }, { name: 'Banff', lat: 51.17, lon: -115.57 }, { name: 'Queenstown', lat: -45.03, lon: 168.66 }, { name: 'Bariloche', lat: -41.13, lon: -71.30 }, { name: 'Niseko', lat: 42.80, lon: 140.68 }, { name: 'Nagano', lat: 36.64, lon: 138.18 }, { name: 'Sochi', lat: 43.60, lon: 39.73 }, { name: 'Almaty', lat: 43.22, lon: 76.85 }, { name: 'Gudauri', lat: 42.47, lon: 44.48 }, { name: 'Bansko', lat: 41.83, lon: 23.48 }
        ];

        const BACKUP_FEEDS = {
            "Telex": "https://telex.hu/rss", "Index": "https://index.hu/24ora/rss/", "24hu": "https://24.hu/feed/", "Origo": "https://www.origo.hu/contentpartner/rss/hir-cent/origo.xml",
            "HVG": "https://hvg.hu/rss", "444": "https://444.hu/feed", "Infostart": "https://infostart.hu/rss", "Portfolio": "https://www.portfolio.hu/rss/all.xml", "Pénzcentrum": "https://www.penzcentrum.hu/rss/all.xml",
            "Népszava": "https://nepszava.hu/rss", "Magyar Nemzet": "https://magyarnemzet.hu/feed", "Mandiner": "https://mandiner.hu/feed", "Blikk": "https://www.blikk.hu/rss",
            "Hirado.hu": "https://hirado.hu/feed/", "ATV": "https://www.atv.hu/feed", "RTL": "https://rtl.hu/rss", "Economx": "https://economx.hu/rss", "Napi.hu": "https://www.napi.hu/rss",
            "Magyar Hírlap": "https://www.magyarhirlap.hu/rss", "Pesti Srácok": "https://pestisracok.hu/feed/", "Nemzeti Sport": "https://www.nemzetisport.hu/feed", "M4 Sport": "https://m4sport.hu/feed",
            "Hír TV": "https://hirtv.hu/rss", "Privátbankár": "https://www.privatbankar.hu/rss/all.xml",
            "Police.hu": "http://www.police.hu/hu/rss/balesetek-torlodasok",
            "BKK Info": "https://bkk.hu/apps/bkk-info/rss.php"
        };

        const firebaseConfig = { apiKey: "AIzaSyDgBgiNSxjgWP_jmaoHpf0Qejo8_OO4sPg", authDomain: "robi-oldala.firebaseapp.com", databaseURL: "https://robi-oldala-default-rtdb.europe-west1.firebasedatabase.app", projectId: "robi-oldala", storageBucket: "robi-oldala.appspot.com", messagingSenderId: "300815778397", appId: "1:300815778397:web:ec609be55cc8afd193c3b4" };
        const CORS_PROXIES = ["https://api.allorigins.win/raw?url=", "https://cors.eu.org/", "https://thingproxy.freeboard.io/fetch/"];
        
        const THEMATIC_BLOCKS = [
            { start: 0,    name: 'Éjszakai műszak', type: 'summary_yesterday', refreshMinutes: 30, styleClass: 'badge-night' },
            { start: 6,    name: 'Napindító',       type: 'morning_catchup', timeWindowHours: 0, refreshMinutes: 15, styleClass: 'badge-dawn' },
            { start: 7,    name: 'Reggeli gyors',   type: 'fresh', timeWindowHours: 2, refreshMinutes: 10, styleClass: 'badge-morning' },
            { start: 9,    name: 'Délelőtt a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-day' },
            { start: 12,   name: 'Délidőben',       type: 'fresh', timeWindowHours: 2, refreshMinutes: 15, styleClass: 'badge-noon' },
            { start: 14,   name: 'Délután a TKP NEWS-al', type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-afternoon' },
            { start: 18,   name: 'Esti gyors',      type: 'fresh', timeWindowHours: 2, refreshMinutes: 10, styleClass: 'badge-sunset' },
            { start: 20,   name: 'Este a TKP NEWS-al',    type: 'fresh', timeWindowHours: 3, refreshMinutes: 15, styleClass: 'badge-evening' },
            { start: 22,   name: 'Késő este a TKP NEWS-al', type: 'fresh', timeWindowHours: 4, refreshMinutes: 20, styleClass: 'badge-night' },
            { start: 23.98,name: 'Elköszönés',      type: 'goodbye', styleClass: 'badge-night' }
        ];

        const CALENDAR_DATA = { honapok: ["január", "február", "március", "április", "május", "június", "július", "augusztus", "szeptember", "október", "november", "december"] };

        // --- STATE & DOM ---
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const feedsRef = ref(database, 'feeds');
        
        const el = {
            clockHm: document.getElementById('clock-hm'),
            clockS: document.getElementById('clock-s'),
            date: document.getElementById('date-display'),
            // Nameday removed
            
            trackA: document.getElementById('track-a'),
            trackB: document.getElementById('track-b'),
            progressBar: document.getElementById('progress-bar'),
            loading: document.getElementById('loading-overlay'),
            counter: document.getElementById('counter-display'),
            weatherLocName: document.getElementById('weather-loc-name'),
            weatherLocTime: document.getElementById('weather-loc-time'),
            weatherTemp: document.getElementById('weather-temp'),
            weatherFeels: document.getElementById('weather-feels'),
            weatherIcon: document.getElementById('weather-icon-slot'),
            wdHum: document.getElementById('wd-hum'),
            wdWind: document.getElementById('wd-wind'),
            wdPress: document.getElementById('wd-press'),
            weatherView: document.getElementById('weather-view'),
            weatherLoading: document.getElementById('weather-loading-state'),
            weatherDataContainer: document.getElementById('weather-data-container'),
            scheduleView: document.getElementById('schedule-view'),
            scheduleList: document.getElementById('schedule-list-content'),
            promoView: document.getElementById('promo-view'),
            timelineContainer: document.getElementById('timeline-container'),
            newsContainer: document.getElementById('news-container'),
            newsViewport: document.getElementById('news-viewport'),
            badge: document.getElementById('left-program-badge'), 
            sky: document.getElementById('sky-bg'),
            weatherHeader: document.querySelector('.weather-location-header'),
            idFlipper: document.getElementById('id-flipper'),
            weatherFlipper: document.getElementById('weather-flipper'),
            goodbyeCard: document.getElementById('goodbye-card'),
            bigClockLayer: document.getElementById('big-clock-layer'),
            bcTime: document.getElementById('bc-time-display'),
            nextProgAlert: document.getElementById('next-prog-alert'),
            crYear: document.getElementById('cr-year'),
            
            creditsContent: document.getElementById('credits-content'),
            economyContent: document.getElementById('economy-content'),
            controlsBar: document.getElementById('controls-bar-main'),
            
            // Breaking System
            breakingPanel: document.getElementById('breaking-panel'),
            bpText: document.getElementById('bp-text'),
            bpTime: document.getElementById('bp-time'),
            bpSource: document.getElementById('bp-source'),
            bpTextMask: document.querySelector('.bp-text-mask'),
            
            mainContainer: document.querySelector('.ticker-container'),
            leftPanel: document.querySelector('.identity-panel'),
            rightPanel: document.querySelector('.weather-panel'),
            middlePanel: document.querySelector('.news-panel'),
            devMenu: document.getElementById('dev-menu'),
            
            handHour: document.getElementById('clock-hand-hour'),
            handMinute: document.getElementById('clock-hand-minute'),
            handSecond: document.getElementById('clock-hand-second')
        };

        let state = {
            activeTrack: 'a',
            items: [],
            currentIndex: 0,
            block: null,
            rssFeeds: {},
            weatherIndex: 0,
            flipTimer: null,
            loading: false,
            scheduleActive: false,
            lastScheduleMin: -1,
            currentItem: null,
            scheduleHighlightIndex: 0,
            scheduleInterval: null,
            nextItems: [],
            weatherPlaylist: [],
            weatherPlaylistIndex: 0,
            isPaused: false,
            cardStartTime: 0,
            currentDuration: 18000,
            remainingTime: 0,
            seenBreakingLinks: new Set(),
            lastBreakingCheckTime: Date.now(),
            lastNightInfoTime: 0,
            retryQueue: [], 
            retryInterval: null,
            retryCount: 0, 
            economyVisible: false,
            economyRates: { EUR: null, USD: null, CHF: null, GBP: null, AUD: null, CAD: null, PLN: null, CZK: null, RON: null, JPY: null, CNY: null, TRY: null, SEK: null, NOK: null, DKK: null },
            economyKeyIndex: 0,
            economyCarouselInterval: null,
            economySlideIndex: 0,
            pendingListReset: false,
            isTransitioning: false,
            lastRefreshTimestamp: Date.now(),
            breakingActive: false,
            breakingLink: null,
            breakingQueue: [],
            currentNyData: null,
            lastTipTime: Date.now() // For the Tip Card
        };

        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        
        // --- HELPER: GET FIRST SENTENCE ---
        function getFirstSentence(str) {
            if (!str) return "";
            const match = str.match(/^.*?[.!?](?:\s|$)/);
            return match ? match[0] : str;
        }

        async function fetchWithProxyFallback(url) {
            for (const proxy of CORS_PROXIES) {
                try {
                    const res = await fetch(proxy + url, { signal: AbortSignal.timeout(4000) });
                    if(res.ok) return res;
                } catch(e){}
            }
            throw new Error('All proxies failed for ' + url);
        }

        function extractImageUrl(item, descHtml) {
            const media = item.querySelector("media\\:content") || item.querySelector("content");
            if(media && media.getAttribute('url')) return media.getAttribute('url');
            const thumb = item.querySelector("media\\:thumbnail");
            if(thumb && thumb.getAttribute('url')) return thumb.getAttribute('url');
            const enclosure = item.querySelector("enclosure");
            if(enclosure && enclosure.getAttribute('type')?.startsWith('image')) return enclosure.getAttribute('url');
            const match = descHtml.match(/<img[^>]+src=["']([^"']+)["']/i);
            return match ? match[1] : null;
        }

        function getFavicon(url) {
            try { const domain = new URL(url).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`; } catch(e) { return ''; }
        }

        function getSourceName(link) {
            try {
                const url = new URL(link);
                const host = url.hostname.replace('www.', '').toLowerCase();
                const map = { 'telex.hu': 'TELEX', 'index.hu': 'INDEX', '24.hu': '24.HU', 'origo.hu': 'ORIGO', 'hirado.hu':'HIRADO', 'rtl.hu':'RTL', 'atv.hu':'ATV', 'police.hu': 'KÖZÚT', 'bkk.hu': 'BKK' };
                if(map[host]) return map[host];
                return host.split('.')[0].toUpperCase();
            } catch(e) { return "HÍR"; }
        }

        function flipPanel(panelType, showBack) {
            const flipper = panelType === 'identity' ? el.idFlipper : el.weatherFlipper;
            if(showBack) flipper.classList.add('flipped');
            else flipper.classList.remove('flipped');
        }

        function showCredits() {
            if(state.economyVisible) return; 
            el.creditsContent.classList.add('active');
            el.economyContent.classList.remove('active');
            flipPanel('identity', true);
            setTimeout(() => { flipPanel('identity', false); }, 10000);
        }

        function showEconomy() {
            state.economyVisible = true;
            el.creditsContent.classList.remove('active');
            el.economyContent.classList.add('active');
            state.economySlideIndex = 0;
            updateEconomySlide();
            if (state.economyCarouselInterval) clearInterval(state.economyCarouselInterval);
            state.economyCarouselInterval = setInterval(() => {
                state.economySlideIndex = (state.economySlideIndex + 1) % 5;
                updateEconomySlide();
            }, 8000); 
            flipPanel('identity', true);
            setTimeout(() => { 
                flipPanel('identity', false); 
                state.economyVisible = false;
                clearInterval(state.economyCarouselInterval);
            }, 40000); 
        }

        function updateEconomySlide() {
            document.querySelectorAll('.eco-slide').forEach((slide, idx) => {
                if(idx === state.economySlideIndex) slide.classList.add('active');
                else slide.classList.remove('active');
            });
        }

        async function fetchExchangeRates() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/HUF');
                const data = await res.json();
                if (data && data.rates) {
                    const currencies = ['EUR', 'USD', 'CHF', 'GBP', 'AUD', 'CAD', 'PLN', 'CZK', 'RON', 'JPY', 'CNY', 'TRY', 'SEK', 'NOK', 'DKK'];
                    currencies.forEach(curr => {
                        if (data.rates[curr]) {
                            const val = 1 / data.rates[curr];
                            const elId = `rate-${curr.toLowerCase()}`;
                            const element = document.getElementById(elId);
                            if (element) {
                                element.textContent = `${val.toFixed(2)} Ft`;
                                element.style.color = '#fff';
                                setTimeout(() => element.style.color = null, 500);
                            }
                        }
                    });
                }
            } catch (e) { console.error("Exchange Rate Error:", e); }
        }

        function updateSkyGradient() {
            const now = new Date();
            const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
            const altitudeDeg = sunPos.altitude * (180 / Math.PI);
            let stops = SKY_PHASES.DEEP_NIGHT.stops;
            if (altitudeDeg < -18) stops = SKY_PHASES.DEEP_NIGHT.stops;
            else if (altitudeDeg < -12) stops = SKY_PHASES.ASTRO_DAWN.stops;
            else if (altitudeDeg < -6) stops = SKY_PHASES.NAUTICAL_DAWN.stops;
            else if (altitudeDeg < 0) stops = SKY_PHASES.CIVIL_DAWN.stops;
            else if (altitudeDeg < 6) stops = SKY_PHASES.SUNRISE.stops;
            else if (altitudeDeg < 25) stops = SKY_PHASES.MORNING.stops;
            else stops = SKY_PHASES.NOON.stops;
            el.sky.style.background = `linear-gradient(135deg, ${stops[0]}, ${stops[1]}, ${stops[2]})`;
        }

        function calculateFeelsLike(temp, hum, wind) {
            if (temp <= 10 && wind > 4.8) { return 13.12 + 0.6215 * temp - 11.37 * Math.pow(wind, 0.16) + 0.3965 * temp * Math.pow(wind, 0.16); }
            else if (temp >= 27 && hum >= 40) { return temp - 0.55 * (1 - (hum / 100)) * (temp - 14); }
            return temp; 
        }

        function getWindDirStr(deg) {
            if (deg === undefined || deg === null) return "";
            const sectors = ["ÉSZAKI", "ÉSZAKKELETI", "KELETI", "DÉLKELETI", "DÉLI", "DÉLNYUGATI", "NYUGATI", "ÉSZAKNYUGATI"];
            deg += 22.5; if (deg < 0) deg += 360; deg = deg % 360;
            return sectors[Math.floor(deg / 45)];
        }

        function getIconFromIBMCode(code) {
            const c = parseInt(code);
            if ([31, 33].includes(c)) return ICONS.CLEAR_NIGHT; 
            if ([32, 34].includes(c)) return ICONS.CLEAR; 
            if ([26, 27, 28].includes(c)) return ICONS.CLOUDY; 
            if ([29].includes(c)) return ICONS.CLOUDY_NIGHT; 
            if ([30].includes(c)) return ICONS.CLOUDY; 
            if ([20, 21, 22, 19].includes(c)) return ICONS.FOG;
            if ([11, 12, 39, 40, 45, 9, 10].includes(c)) return ICONS.RAIN;
            if ([13, 14, 15, 16, 41, 42, 43, 46].includes(c)) return ICONS.SNOW;
            if ([3, 4, 17, 35, 37, 38, 47].includes(c)) return ICONS.THUNDER;
            return ICONS.CLOUDY; 
        }

        function getIconFromWMO(code, isNight) {
            if(isNight) {
                if(code === 0) return ICONS.CLEAR_NIGHT;
                if(code >= 1 && code <= 3) return ICONS.CLOUDY_NIGHT; 
                if(code === 45 || code === 48) return ICONS.FOG;
                if(code >= 51 && code <= 67) return ICONS.RAIN;
                if(code >= 80 && code <= 82) return ICONS.RAIN;
                if(code >= 71 && code <= 77) return ICONS.SNOW;
                if(code >= 95) return ICONS.THUNDER;
                return ICONS.CLOUDY_NIGHT;
            }
            if(code === 0) return ICONS.CLEAR;
            if(code >= 1 && code <= 3) return ICONS.CLOUDY;
            if(code === 45 || code === 48) return ICONS.FOG;
            if(code >= 51 && code <= 67) return ICONS.RAIN;
            if(code >= 80 && code <= 82) return ICONS.RAIN;
            if(code >= 71 && code <= 77) return ICONS.SNOW;
            if(code >= 95) return ICONS.THUNDER;
            return ICONS.CLOUDY;
        }

        async function fetchNyiregyhazaSpecific() {
            // Priority list: INYREG42, INYREG26
            const PWS_IDS = ["INYREG42", "INYREG26"]; 
            let finalData = null;
            
            for (const id of PWS_IDS) {
                try {
                    const url = `https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${WUNDERGROUND_API_KEY}&numericPrecision=decimal`;
                    const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
                    if(res.ok) {
                        const data = await res.json();
                        if(data.observations && data.observations.length > 0) {
                            const obs = data.observations[0];
                            finalData = {
                                metric: { temp: obs.metric.temp },
                            };
                            break; 
                        }
                    }
                } catch(e) {}
            }

            const pwsEl = document.getElementById('pws-badge');
            if (finalData && finalData.metric && typeof finalData.metric.temp === 'number') {
                const temp = finalData.metric.temp.toFixed(1);
                // HTML for the badge
                pwsEl.innerHTML = `
                    <span style="font-weight:700; color:#fff;">NYÍREGYHÁZA:</span>
                    <span style="color:var(--accent-warm); font-weight:700; margin-left:4px;">${temp}°C</span>
                `;
                pwsEl.style.display = 'flex';
                
                // Fade in delay
                if (!pwsEl.classList.contains('visible')) {
                    setTimeout(() => {
                        pwsEl.classList.add('visible');
                    }, 5000); 
                }
            } else {
                pwsEl.style.display = 'none'; 
                pwsEl.classList.remove('visible');
            }
        }

        // --- FIXED WEATHER FETCH LOGIC (PROTOPAGE OPTIMIZED) ---
        async function fetchWeatherData() {
            const fetchPWS = async (id) => {
                try {
                    // INCREASED TIMEOUT (6000ms)
                    const url = `https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${WUNDERGROUND_API_KEY}&numericPrecision=decimal`;
                    const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
                    if(!res.ok) return null;
                    const data = await res.json();
                    if(data.observations && data.observations.length > 0) {
                        const obs = data.observations[0];
                        if(obs.metric.temp !== null) {
                             let iconCode = 26;
                             try {
                                 const wxUrl = `https://api.weather.com/v3/wx/observations/current?geocode=${obs.lat},${obs.lon}&format=json&units=m&language=hu-HU&apiKey=${WUNDERGROUND_API_KEY}`;
                                 const wxRes = await fetch(wxUrl, { signal: AbortSignal.timeout(2000) });
                                 if(wxRes.ok) { const wxData = await wxRes.json(); if(wxData.iconCode !== undefined) iconCode = wxData.iconCode; }
                             } catch(e) {}
                             return { name: PWS_MAP[id] || id, lat: obs.lat, lon: obs.lon, temp: obs.metric.temp, hum: obs.humidity, wind: obs.metric.windSpeed, winddir: obs.metric.winddir, press: obs.metric.pressure, precip: obs.metric.precipRate, ibmIcon: iconCode, updatedAt: new Date(), type: 'PWS' };
                        }
                    }
                } catch(e) { return null; }
                return null;
            };

            const fetchSingleOM = async (city) => {
                try {
                    // INCREASED TIMEOUT (8000ms)
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,wind_direction_10m,weather_code,apparent_temperature`;
                    const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
                    if(!res.ok) return null;
                    const data = await res.json();
                    const weatherItem = { name: city.name, lat: city.lat, lon: city.lon, temp: data.current.temperature_2m, hum: data.current.relative_humidity_2m, wind: data.current.wind_speed_10m, winddir: data.current.wind_direction_10m, press: data.current.surface_pressure, precip: 0, wmo: data.current.weather_code, feelsLike: data.current.apparent_temperature, updatedAt: new Date(), type: 'OM' };
                    state.weatherPlaylist.push(weatherItem);
                    
                    if (state.weatherPlaylist.length === 1) { 
                        state.weatherPlaylistIndex = 0; 
                        displayWeather(); 
                    }
                    return weatherItem;
                } catch(e) { return null; }
            };

            const huKeys = HUNGARIAN_CITIES_OM.sort(() => 0.5 - Math.random()).slice(0, 6);
            huKeys.forEach(city => fetchSingleOM(city));

            const stationKeys = Object.keys(PWS_MAP).sort(() => 0.5 - Math.random()).slice(0, 5);
            stationKeys.forEach(async (id) => {
                const data = await fetchPWS(id);
                if(data) { 
                    state.weatherPlaylist.push(data); 
                    if (state.weatherPlaylist.length === 1) { 
                        state.weatherPlaylistIndex = 0; 
                        displayWeather(); 
                    }
                }
            });
            
            // DELAYED FALLBACK (7000ms) - Increased to account for slow Protopage loading
            setTimeout(() => {
                if(state.weatherPlaylist.length === 0) {
                     state.weatherPlaylist.push({ name: 'Budapest', temp: 15.0, hum: 50, wind: 10, wmo: 1, type:'OM', lat: 47.49, lon: 19.04 });
                     state.weatherPlaylistIndex = 0;
                     displayWeather();
                }
                if(el.weatherLoading.classList.contains('active')) {
                     el.weatherLoading.classList.remove('active');
                     el.weatherDataContainer.style.opacity = '1';
                }
            }, 7000);
        }

        function displayWeather() {
            if(state.weatherPlaylist.length === 0 || state.scheduleActive) return;
            if (state.weatherPlaylistIndex >= state.weatherPlaylist.length) { state.weatherPlaylistIndex = 0; }
            
            if(el.weatherLoading.classList.contains('active')) { 
                el.weatherLoading.classList.remove('active'); 
                el.weatherDataContainer.style.opacity = '1'; 
            }
            
            const item = state.weatherPlaylist[state.weatherPlaylistIndex];
            state.weatherPlaylistIndex++;
            el.weatherLocName.textContent = item.name;
            const timeStr = item.updatedAt ? item.updatedAt.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('weather-loc-time').textContent = `FRISSÍTVE: ${timeStr}`;
            const temp = typeof item.temp === 'number' ? item.temp : 0;
            const hum = item.hum || 0;
            const wind = typeof item.wind === 'number' ? item.wind : 0;
            const press = typeof item.press === 'number' ? item.press : 0;
            el.weatherTemp.textContent = temp.toFixed(1) + "°";
            let feelsLikeVal = item.feelsLike;
            if (feelsLikeVal === undefined) { feelsLikeVal = calculateFeelsLike(temp, hum, wind); }
            el.weatherFeels.textContent = `HŐÉRZET: ${feelsLikeVal.toFixed(1)}°`;
            el.wdHum.textContent = hum + "%";
            const dirStr = getWindDirStr(item.winddir);
            el.wdWind.textContent = `${wind.toFixed(1)} km/h ${dirStr}`;
            el.wdPress.textContent = press.toFixed(1) + " hPa";
            if (item.type === 'PWS' && item.ibmIcon !== undefined) { el.weatherIcon.innerHTML = getIconFromIBMCode(item.ibmIcon); } else {
                const now = new Date();
                const sunTimes = SunCalc.getTimes(now, item.lat || NYIREGYHAZA_COORDS.lat, item.lon || NYIREGYHAZA_COORDS.lon);
                const isNight = now < sunTimes.sunrise || now > sunTimes.sunset;
                el.weatherIcon.innerHTML = getIconFromWMO(item.wmo || 0, isNight);
            }
        }

        function displaySchedule() {
            if (!state.block || state.block.name === 'Elköszönés') return;
            state.scheduleActive = true;
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            const labels = ["MOST", "KÖVETKEZIK", "KÉSŐBB"]; 
            el.weatherLocTime.style.display = 'none';
            const backHeader = document.getElementById('schedule-header');
            backHeader.style.display = 'flex'; 
            el.scheduleView.style.display = 'flex';
            el.promoView.style.display = 'none';
            let html = '';
            for(let i = 0; i < 3; i++) {
                const idx = (currentIndex + i) % THEMATIC_BLOCKS.length;
                const block = THEMATIC_BLOCKS[idx];
                const hour = Math.floor(block.start);
                const min = Math.round((block.start % 1) * 60);
                const timeStr = `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                html += `<div class="schedule-item" id="sch-item-${i}"><div class="sch-time">${timeStr}</div><div style="flex-grow:1;"><div class="sch-label">${labels[i]}</div><div class="sch-name">${block.name}</div></div></div>`;
            }
            el.scheduleList.innerHTML = html;
            flipPanel('weather', true);
            state.scheduleHighlightIndex = 0;
            updateScheduleHighlight();
            state.scheduleInterval = setInterval(updateScheduleHighlight, 5000); 
            setTimeout(() => { 
                clearInterval(state.scheduleInterval); 
                backHeader.style.display = 'none'; 
                el.scheduleView.style.display = "none"; 
                el.promoView.style.display = "flex"; 
            }, 15000);
            setTimeout(() => { 
                flipPanel('weather', false); 
                state.scheduleActive = false; 
                el.scheduleView.style.display = "flex"; 
                el.promoView.style.display = "none"; 
                displayWeather(); 
            }, 25000);
        }

        function updateScheduleHighlight() {
            document.querySelectorAll('.schedule-item').forEach(item => item.classList.remove('active-highlight'));
            const currentItem = document.getElementById(`sch-item-${state.scheduleHighlightIndex}`);
            if(currentItem) currentItem.classList.add('active-highlight');
            state.scheduleHighlightIndex = (state.scheduleHighlightIndex + 1) % 3;
        }

        function generateTimeline() {
            if(!state.block || state.block.type !== 'summary_yesterday') { el.timelineContainer.classList.remove('visible'); return; }
            const hours = [...new Set(state.items.map(item => item.date.getHours()))].sort((a,b)=>a-b);
            let html = '';
            hours.forEach(h => { html += `<button class="timeline-btn" data-hour="${h}">${String(h).padStart(2,'0')}</button>`; });
            el.timelineContainer.innerHTML = html;
            el.timelineContainer.classList.add('visible');
            el.timelineContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); const h = parseInt(btn.dataset.hour); const idx = state.items.findIndex(i => i.date.getHours() === h); if(idx !== -1) { state.currentIndex = idx; showNextItem(false); } });
            });
        }

        function updateTimelineActive() {
            if(!state.block || state.block.type !== 'summary_yesterday') return;
            const item = state.items[state.currentIndex % state.items.length];
            if(!item) return;
            const h = item.date.getHours();
            el.timelineContainer.querySelectorAll('.timeline-btn').forEach(btn => { btn.classList.toggle('active', parseInt(btn.dataset.hour) === h); });
        }

        function cleanUpOldItems() {
            if(!state.block) return;
            const now = new Date();
            let cutoffTime;
            if(state.block.type === 'fresh') {
                cutoffTime = new Date();
                const hoursBack = state.block.timeWindowHours || 2;
                cutoffTime.setHours(now.getHours() - hoursBack);
                state.items = state.items.filter(item => item.date >= cutoffTime);
            } 
        }

        async function checkBreakingNews() {
            const now = Date.now();
            const twoMinutesAgo = now - (2 * 60 * 1000); 
            
            for(const [src, url] of Object.entries(BACKUP_FEEDS)) {
                try {
                    const uniqueUrl = url + (url.includes('?') ? '&' : '?') + 'cB=' + now;
                    const res = await fetchWithProxyFallback(uniqueUrl);
                    const txt = await res.text();
                    const xml = new DOMParser().parseFromString(txt, "text/xml");
                    const items = xml.querySelectorAll("item");
                    
                    for(let i=0; i<2; i++) { 
                        const item = items[i]; if(!item) continue;
                        const dateStr = item.querySelector("pubDate")?.textContent;
                        if(!dateStr) continue;
                        const date = new Date(dateStr);
                        const link = item.querySelector("link")?.textContent;
                        
                        if(date.getTime() > twoMinutesAgo && link && !state.seenBreakingLinks.has(link)) {
                            const title = item.querySelector("title")?.textContent || "";
                            state.seenBreakingLinks.add(link);
                            const breakingItem = { 
                                title: title, 
                                desc: stripHtml(item.querySelector("description")?.textContent || ""), 
                                source: getSourceName(link), 
                                date: date, 
                                link: link
                            };
                            state.breakingQueue.push(breakingItem);
                        }
                    }
                } catch(e) {}
            }
            processBreakingQueue();
        }

        function processBreakingQueue() {
            if(state.breakingActive) return;
            if(state.breakingQueue.length === 0) return;
            const item = state.breakingQueue.shift();
            activateBreakingBar(item);
        }

        function activateBreakingBar(item) {
            state.breakingActive = true;
            state.breakingLink = item.link; 
            
            // Set Content
            el.bpText.innerText = item.title;
            el.bpSource.innerText = item.source;
            el.bpTime.innerText = item.date.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});

            // Flip In (Down to Up from absolute bottom)
            el.breakingPanel.classList.remove('closing');
            el.breakingPanel.classList.add('active');
            
            // Wait for flip to finish (500ms), then check text length
            setTimeout(() => {
                const containerWidth = el.bpTextMask.offsetWidth;
                const textWidth = el.bpText.offsetWidth;
                let totalDuration = 0;
                
                if (textWidth > containerWidth) {
                    const dist = -(textWidth + 30) + "px"; 
                    el.bpText.style.setProperty('--scroll-dist', dist);
                    const animDuration = Math.max((textWidth + containerWidth) / 100, 5); // Faster speed
                    el.bpText.style.animation = `scrollTextLeft ${animDuration}s linear 2s forwards`;
                    totalDuration = (2 + animDuration + 2) * 1000;
                } else {
                    totalDuration = 8000; // Fixed show time if fits
                }

                setTimeout(() => {
                    // Close animation
                    el.breakingPanel.classList.add('closing');
                    el.breakingPanel.addEventListener('animationend', () => {
                        el.breakingPanel.classList.remove('active');
                        el.breakingPanel.classList.remove('closing');
                        el.bpText.style.animation = 'none';
                        state.breakingActive = false;
                        processBreakingQueue();
                    }, { once: true });
                }, totalDuration);

            }, 500);
        }
        
        // News Container click for main news (delegation)
        el.newsContainer.addEventListener('click', (e) => {
             // Breaking News Panel click
             if(e.target.closest('#breaking-panel')) {
                  if(state.breakingActive && state.breakingLink) {
                     e.preventDefault(); e.stopPropagation();
                     window.open(state.breakingLink, '_blank');
                  }
                  return;
             }
             // Main News Card click
             if(e.target.closest('.controls-bar') || e.target.closest('.breaking-pod')) return; 
             if(state.currentItem && state.currentItem.link) window.open(state.currentItem.link, '_blank'); 
        });
        
        // --- DEV MENU FUNCTIONS ---
        window.triggerTestBreaking = function() { state.breakingQueue.push({ title: "Ez egy rövid teszt hír.", date: new Date(), source: "TESZT", link: "#" }); processBreakingQueue(); el.devMenu.style.display = 'none'; }
        window.triggerTestBreakingLong = function() { state.breakingQueue.push({ title: "Ez egy rendkívül hosszú teszt hír, amely arra szolgál, hogy ellenőrizzük a görgető mechanizmust és a megjelenést.", date: new Date(), source: "TESZT", link: "#" }); processBreakingQueue(); el.devMenu.style.display = 'none'; }
        window.triggerTestTraffic = function() { el.devMenu.style.display = 'none'; state.items.splice(state.currentIndex + 1, 0, { title: "Baleset az M3-as autópályán", desc: "Torlódás várható.", source: "KÖZÚT", date: new Date(), link: "#" }); clearTimeout(state.flipTimer); showNextItem(true); };
        window.triggerVisualNews = function() { el.devMenu.style.display = 'none'; state.items.splice(state.currentIndex + 1, 0, { title: "Képes Hír Teszt", desc: "Leírás...", source: "INDEX", date: new Date(), link: "#", img: "https://images.unsplash.com/photo-1504711434969-e33886168f5c" }); clearTimeout(state.flipTimer); showNextItem(true); };
        window.triggerTextNews = function() { el.devMenu.style.display = 'none'; state.items.splice(state.currentIndex + 1, 0, { title: "Szöveges Hír", desc: "Leírás...", source: "TELEX", date: new Date(), link: "#", img: null }); clearTimeout(state.flipTimer); showNextItem(true); };
        window.triggerEconomyTest = function() { el.devMenu.style.display = 'none'; fetchExchangeRates(); showEconomy(); };
        window.triggerSchedule = function() { el.devMenu.style.display = 'none'; displaySchedule(); };
        window.triggerWeatherLoading = function() { el.devMenu.style.display = 'none'; el.weatherLoading.classList.add('active'); setTimeout(() => el.weatherLoading.classList.remove('active'), 5000); };
        window.triggerNightMode = function() { el.devMenu.style.display = 'none'; state.block = THEMATIC_BLOCKS[0]; updateTimeAndState(); document.getElementById('night-summary-label').classList.add('active'); };
        window.triggerDayMode = function() { el.devMenu.style.display = 'none'; state.block = null; document.getElementById('night-summary-label').classList.remove('active'); updateTimeAndState(); };
        window.triggerHourChangeTest = function() { el.devMenu.style.display = 'none'; el.bigClockLayer.classList.add('active'); setTimeout(() => { el.bigClockLayer.classList.remove('active'); }, 10000); };
        window.triggerGoodbyeTest = function() { el.devMenu.style.display = 'none'; el.goodbyeCard.classList.add('active'); setTimeout(() => { el.goodbyeCard.classList.remove('active'); }, 15000); };
        window.triggerCredits = function() { el.devMenu.style.display = 'none'; showCredits(); };
        window.closeDevMenu = function() { el.devMenu.style.display = 'none'; }
        
        document.querySelector('.brand-wrapper').addEventListener('click', (e) => { e.stopPropagation(); const code = prompt("Fejlesztői kód:"); if(code === "0000") el.devMenu.style.display = 'flex'; });

        function handleVisibilityChange() {
            if (document.visibilityState === 'visible') {
                const d = new Date();
                const remainder = d.getMinutes() % 15;
                d.setMinutes(d.getMinutes() - remainder);
                d.setSeconds(0);
                d.setMilliseconds(0);
                const lastCheckpoint = d.getTime();
                if (state.lastRefreshTimestamp < lastCheckpoint) { state.items = []; refreshNews(false); }
            }
        }
        
        function updateAnalogClock() {
            const now = new Date();
            const sec = now.getSeconds(); const min = now.getMinutes(); const hour = now.getHours();
            const secDeg = (sec / 60) * 360;
            const minDeg = ((min + sec/60) / 60) * 360;
            const hourDeg = ((hour % 12 + min/60) / 12) * 360;
            el.handSecond.style.transform = `translateX(-50%) rotate(${secDeg}deg)`;
            el.handMinute.style.transform = `translateX(-50%) rotate(${minDeg}deg)`;
            el.handHour.style.transform = `translateX(-50%) rotate(${hourDeg}deg)`;
        }

        function updateTimeAndState() {
            const now = new Date();
            el.clockHm.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});
            el.clockS.textContent = `:${String(now.getSeconds()).padStart(2, '0')}`;
            const days = ['vasárnap', 'hétfő', 'kedd', 'szerda', 'csütörtök', 'péntek', 'szombat'];
            el.date.textContent = `${now.getFullYear()}. ${CALENDAR_DATA.honapok[now.getMonth()]} ${now.getDate()}., ${days[now.getDay()]}`;
            // Nameday logic removed
            updateSkyGradient();
            updateAnalogClock();
            
            const h = now.getHours() + now.getMinutes()/60;
            let currentBlock = THEMATIC_BLOCKS.findLast(b => h >= b.start) || THEMATIC_BLOCKS[THEMATIC_BLOCKS.length-1];
            const min = now.getMinutes(); const sec = now.getSeconds(); const hour = now.getHours();

            // PWS HIDING LOGIC for BIG CLOCK
            const pwsEl = document.getElementById('pws-badge');
            if (el.bigClockLayer.classList.contains('active')) {
                 if (pwsEl) pwsEl.style.opacity = '0';
            } else if (pwsEl && pwsEl.classList.contains('visible')) {
                 pwsEl.style.opacity = '1';
            }

            if (hour === 23 && min === 59) {
                if (sec >= 0 && sec < 50) { el.goodbyeCard.classList.add('active'); el.bigClockLayer.classList.remove('active'); } 
                else if (sec >= 50) { el.goodbyeCard.classList.remove('active'); el.bigClockLayer.classList.add('active'); el.bcTime.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); if(sec === 50) showCredits(); }
            } else if (min === 59 && sec >= 50) { 
                el.bigClockLayer.classList.add('active'); el.bcTime.textContent = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); if(sec === 50) showCredits(); 
            } else {
                if(el.bigClockLayer.classList.contains('active')) { el.bigClockLayer.classList.remove('active'); el.goodbyeCard.classList.remove('active'); if(state.block.type !== 'summary_yesterday') { state.currentIndex = 0; if(state.nextItems.length > 0) { state.items = state.nextItems; state.nextItems = []; } showNextItem(false); } }
            }

            if (!state.block || state.block.name !== currentBlock.name) { 
                state.block = currentBlock; 
                el.badge.textContent = state.block.name;
                el.badge.className = `left-prog-badge visible ${state.block.styleClass}`;
                refreshNews(); 
            }
            if(state.block.type === 'summary_yesterday') { el.badge.classList.add('visible'); } else { el.badge.classList.add('visible'); }
            
            if((min === 0 || min === 20 || min === 40) && sec === 0 && min !== state.lastScheduleMin) { state.lastScheduleMin = min; displaySchedule(); }
            if((min === 12 || min === 32 || min === 52) && sec === 30) { fetchExchangeRates(); }
            if((min === 13 || min === 33 || min === 53) && sec === 0) { showEconomy(); }
            
            const currentIndex = THEMATIC_BLOCKS.findIndex(b => b.name === state.block.name);
            const nextBlock = THEMATIC_BLOCKS[(currentIndex + 1) % THEMATIC_BLOCKS.length];
            const nextStartMin = (nextBlock.start * 60);
            const currentMin = (now.getHours() * 60) + now.getMinutes();
            let diff = nextStartMin - currentMin; if (diff < 0) diff += 1440; 
            if(diff <= 15 && diff > 0) {
                const nH = Math.floor(nextBlock.start); const nM = Math.round((nextBlock.start % 1) * 60);
                const nTime = `${String(nH).padStart(2,'0')}:${String(nM).padStart(2,'0')}`;
                el.nextProgAlert.textContent = `KÖVETKEZIK: ${nTime} ${nextBlock.name}`; el.nextProgAlert.classList.add('active');
            } else { el.nextProgAlert.classList.remove('active'); }
            
            if (hour >= 6 && sec === 50 && (min === 14 || min === 29 || min === 44 || min === 59)) { document.getElementById('live-indicator').classList.add('updating'); refreshNews(true); } 
            else { document.getElementById('live-indicator').classList.remove('updating'); }
            if (sec === 0 && (min === 0 || min === 15 || min === 30 || min === 45)) { state.pendingListReset = true; }
            if (sec === 0) cleanUpOldItems();

            const nightLabel = document.getElementById('night-summary-label');
            // Strict logic: ONLY show if block type is exactly 'summary_yesterday'
            if (state.block && state.block.type === 'summary_yesterday') {
                el.timelineContainer.style.display = 'flex';
                nightLabel.classList.add('active');
            } else { 
                el.timelineContainer.style.display = 'none'; 
                nightLabel.classList.remove('active'); 
            }
        }

        function filterItemsByBlock(items) {
            const now = new Date();
            let filtered = [];
            if(state.block.type === 'summary_yesterday') {
                const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
                const end = new Date(yesterday); end.setHours(23,59,59,999);
                filtered = items.filter(item => item.date >= yesterday && item.date <= end); filtered.sort((a,b) => a.date - b.date); 
            } else if(state.block.type === 'morning_catchup') {
                let start = new Date(now); start.setHours(0,0,0,0); filtered = items.filter(item => item.date >= start);
            } else if(state.block.type === 'fresh') {
                let timeLimit = new Date(); timeLimit.setHours(now.getHours() - (state.block.timeWindowHours || 2)); filtered = items.filter(item => item.date >= timeLimit);
            } else {
                let timeLimit = new Date(); timeLimit.setHours(0,0,0,0); filtered = items.filter(item => item.date >= timeLimit);
            }
            return filtered;
        }

        async function attemptFetchFeed(key, url) {
            const res = await fetchWithProxyFallback(url);
            let txt; if(url.includes('ma.hu')) txt = new TextDecoder('iso-8859-2').decode(await res.arrayBuffer()); else txt = await res.text();
            const xml = new DOMParser().parseFromString(txt, "text/xml");
            const parsedItems = [];
            xml.querySelectorAll("item").forEach(item => {
                const title = item.querySelector("title")?.textContent || "";
                const descHtml = item.querySelector("description")?.textContent || "";
                const link = item.querySelector("link")?.textContent;
                const dateStr = item.querySelector("pubDate")?.textContent;
                if(title && dateStr) { parsedItems.push({ title: title, link: link, desc: stripHtml(descHtml).substring(0, 300), source: key, date: new Date(dateStr), img: extractImageUrl(item, descHtml) }); }
            });
            return parsedItems;
        }

        async function processRetries() {
            state.retryCount = (state.retryCount || 0) + 1;
            if(state.retryQueue.length === 0 || state.retryCount > 15) { clearInterval(state.retryInterval); state.retryQueue = []; return; }
            const currentQueue = [...state.retryQueue]; state.retryQueue = []; const fetched = [];
            for(const task of currentQueue) { try { const items = await attemptFetchFeed(task.key, task.url); fetched.push(...items); } catch(e) { state.retryQueue.push(task); } }
            if(fetched.length > 0) mergeNewItems(fetched);
        }

        function mergeNewItems(newItems) {
            const currentLink = state.currentItem ? state.currentItem.link : null;
            const combined = [...state.items, ...newItems];
            const uniqueMap = new Map(); combined.forEach(item => uniqueMap.set(item.link, item));
            let uniqueItems = Array.from(uniqueMap.values()); uniqueItems = filterItemsByBlock(uniqueItems);
            if(state.block.type !== 'summary_yesterday') { uniqueItems.sort((a,b) => b.date - a.date); }
            state.items = uniqueItems;
            if(currentLink) { const newIdx = state.items.findIndex(i => i.link === currentLink); if(newIdx !== -1) { state.currentIndex = newIdx; } else { state.currentIndex = state.currentIndex % state.items.length; } }
            if(state.items.length > 0) { el.counter.textContent = `${(state.currentIndex % state.items.length) + 1} / ${state.items.length}`; }
        }

        async function refreshNews(silent = false) {
            state.lastRefreshTimestamp = Date.now(); state.retryCount = 0; 
            if(!silent) el.loading.classList.add('active');
            state.retryQueue = []; if(state.retryInterval) clearInterval(state.retryInterval);
            let feeds = BACKUP_FEEDS; if(Object.keys(state.rssFeeds).length > 0) feeds = { ...feeds, ...state.rssFeeds };
            let fetchedItems = [];
            const fetchPromises = Object.entries(feeds).map(async ([key, url]) => { try { const items = await attemptFetchFeed(key, url); fetchedItems.push(...items); } catch(e) { state.retryQueue.push({ key, url }); } });
            await Promise.allSettled(fetchPromises);
            const now = new Date();
            let cutoffTime = new Date(0); 
            if (state.block.type === 'fresh') { const hoursBack = state.block.timeWindowHours || 2; cutoffTime = new Date(now.getTime() - (hoursBack * 60 * 60 * 1000)); } 
            else if (state.block.type === 'morning_catchup') { cutoffTime = new Date(now); cutoffTime.setHours(0,0,0,0); }
            fetchedItems = fetchedItems.filter(item => item.date >= cutoffTime); fetchedItems.sort((a,b) => b.date - a.date);
            const filtered = filterItemsByBlock(fetchedItems); 
            const uniqueItems = []; const seenLinks = new Set();
            for(const item of filtered) { if(!seenLinks.has(item.link)) { uniqueItems.push(item); seenLinks.add(item.link); } }
            if(silent) { state.nextItems = uniqueItems; document.getElementById('live-indicator').classList.remove('updating'); } 
            else { state.items = uniqueItems; el.loading.classList.remove('active'); state.currentIndex = 0; showNextItem(false); }
            if(state.block.type === 'summary_yesterday') generateTimeline(); else el.timelineContainer.classList.remove('visible');
            if(state.retryQueue.length > 0) { state.retryInterval = setInterval(processRetries, 20000); }
            cleanUpOldItems();
        }

        function showNextItem(advance = true) {
            clearTimeout(state.flipTimer); state.isTransitioning = true;
            
            // --- TIP CARD LOGIC ---
            // Check if 10 minutes have passed since last tip
            const now = Date.now();
            if (now - state.lastTipTime > 600000 && state.items.length > 0) { // 10 mins = 600000 ms
                renderTipCard();
                state.lastTipTime = now;
                return;
            }

            if(state.block.type === 'summary_yesterday') { if (now - state.lastNightInfoTime > 300000) { renderNightInfoCard(); return; } }
            if(state.pendingListReset && state.nextItems.length > 0) { state.items = state.nextItems; state.nextItems = []; state.currentIndex = -1; advance = true; state.pendingListReset = false; }
            if(state.items.length === 0) { el[state.activeTrack === 'a' ? 'trackA' : 'trackB'].innerHTML = `<div class="news-title">Nincs hír...</div>`; return; }
            if(advance) state.currentIndex++;
            let item = state.items[state.currentIndex % state.items.length];
            if(state.items.length > 1 && state.currentItem && (item.link === state.currentItem.link || item.title === state.currentItem.title)) { state.currentIndex++; item = state.items[state.currentIndex % state.items.length]; }
            state.currentItem = item;
            renderCard(item, false);
            // Duration is now fixed or slight variation
            let duration = 15000;
            state.currentDuration = duration;
            state.cardStartTime = Date.now();
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.style.animationDuration = '15s'; el.progressBar.classList.add('animate-progress');
            state.flipTimer = setTimeout(() => { state.isTransitioning = false; showNextItem(true); }, duration);
        }

        function renderTipCard() {
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA']; const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            el.badge.className = 'left-prog-badge visible badge-tip';
            el.badge.textContent = 'HASZNOS TIPP';
            
            const html = `
                <div class="tip-content">
                    <div class="tip-icon-row">
                        <div class="tip-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            <span class="tip-label">INFO</span>
                        </div>
                        <div class="tip-icon">
                            <svg viewBox="0 0 24 24"><path d="M13 1.07V9h7c0-4.08-3.05-7.44-7-7.93zM4 15c0 4.42 3.58 8 8 8s8-3.58 8-8v-4H4v4zm7-13.93C7.05 1.56 4 4.92 4 9h7V1.07z"/></svg>
                            <span class="tip-label">EGÉR</span>
                        </div>
                    </div>
                    <div class="tip-text">
                        A részletekért húzza az egeret a hírre,<br>a teljes cikkért pedig kattintson rá!
                    </div>
                </div>
            `;
            
            nextTrack.innerHTML = html; 
            nextTrack.className = 'news-card tip-card visible';
            currentTrack.classList.remove('visible'); 
            
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.style.animationDuration = '10s'; el.progressBar.classList.add('animate-progress');
            state.flipTimer = setTimeout(() => { state.isTransitioning = false; showNextItem(false); }, 10000); 
        }

        function renderNightInfoCard() {
            state.lastNightInfoTime = Date.now(); 
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA']; const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            el.badge.textContent = state.block.name;
            const html = `<div class="ni-icon">🌙</div><div class="ni-text">Jelenleg az éjszakai műszak híreit olvasod. Ha friss hír érkezik, az azonnal megjelenik rövid időre.</div><div class="ni-sub">TKP NEWS Éjszakai Ügyelet</div>`;
            nextTrack.innerHTML = html; nextTrack.classList.add('night-info'); nextTrack.classList.remove('breaking');
            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.progressBar.classList.remove('animate-progress'); void el.progressBar.offsetWidth; el.progressBar.style.animationDuration = '10s'; el.progressBar.classList.add('animate-progress');
            state.flipTimer = setTimeout(() => { state.isTransitioning = false; showNextItem(false); }, 10000); 
        }

        function renderCard(item, isBreaking) {
            const nextTrack = el[state.activeTrack === 'a' ? 'trackB' : 'trackA'];
            const currentTrack = el[state.activeTrack === 'a' ? 'trackA' : 'trackB'];
            const fav = getFavicon(item.link);
            const displaySource = getSourceName(item.link);
            const timeStr = item.date.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'});
            nextTrack.className = 'news-card'; // Reset classes
            
            const isTraffic = (displaySource === 'KÖZÚT' || displaySource === 'BKK');
            if (isTraffic) {
                el.badge.className = 'left-prog-badge visible badge-traffic'; el.badge.textContent = 'KÖZLEKEDÉS'; nextTrack.classList.add('traffic-alert');
            } else {
                el.badge.className = `left-prog-badge visible ${state.block.styleClass}`; el.badge.textContent = state.block.name;
            }

            let iconHtml = isTraffic ? TRAFFIC_ICON : `<img src="${fav}" class="provider-icon">`;
            let footerMetaHTML = `<div class="provider-identity">${iconHtml} ${displaySource}</div><span>${timeStr}</span>`;
            
            let visualHtml = ''; let hasVisual = false;
            if (item.img) {
                hasVisual = true; visualHtml = `<div class="news-visual-column"><img src="${item.img}" class="news-visual-image" alt="Hír kép"></div>`;
            } else {
                hasVisual = true; visualHtml = `<div class="news-visual-column"><div class="visual-fallback"><svg class="tkp-globe" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg><span>TKP NEWS</span></div></div>`;
            }

            if (hasVisual) { nextTrack.classList.add('has-visual'); }
            
            // --- NYIREGYHAZA PWS LOGIC (FIXED) ---
            let weatherHTML = "";
            if (state.currentNyData) {
                weatherHTML = `<div class="ny-weather-in-footer">${state.currentNyData}</div>`;
            } else {
                 weatherHTML = ""; // Hide completely if no data
            }

            // Extract single sentence for short view
            const shortDesc = getFirstSentence(item.desc);

            const html = `
                <div class="news-content-wrapper">
                    <div class="news-title">${item.title}</div>
                    <div class="news-desc">
                        <span class="short-view">${shortDesc}</span>
                        <div class="full-view">${item.desc}</div>
                    </div>
                    <div class="news-footer-row">
                        <div class="news-meta">${footerMetaHTML}</div>
                    </div>
                </div>
                ${visualHtml}
            `;
            
            nextTrack.innerHTML = html; 
            currentTrack.classList.remove('visible'); nextTrack.classList.add('visible');
            
            setTimeout(() => { const visualCol = nextTrack.querySelector('.news-visual-column'); if(visualCol) visualCol.classList.add('slide-in'); }, 600); 

            state.activeTrack = state.activeTrack === 'a' ? 'b' : 'a';
            el.counter.textContent = `${(state.currentIndex % state.items.length) + 1} / ${state.items.length}`;
            updateTimelineActive();
        }

        el.newsViewport.addEventListener('mouseenter', () => { if(!state.isPaused) { clearTimeout(state.flipTimer); el.progressBar.style.animationPlayState = 'paused'; state.isPaused = true; const elapsed = Date.now() - state.cardStartTime; state.remainingTime = Math.max(0, state.currentDuration - elapsed); } });
        el.newsViewport.addEventListener('mouseleave', () => { if(state.isPaused) { el.progressBar.style.animationPlayState = 'running'; state.isPaused = false; state.cardStartTime = Date.now(); state.currentDuration = state.remainingTime; state.flipTimer = setTimeout(() => { showNextItem(true); }, state.remainingTime); } });

        function initIntroSequence() { el.leftPanel.classList.add('loaded'); el.rightPanel.classList.add('loaded'); setTimeout(() => { el.mainContainer.classList.add('open'); }, 1500); }
        
        document.addEventListener("DOMContentLoaded", () => {
            el.crYear.textContent = new Date().getFullYear(); 
            document.addEventListener('visibilitychange', handleVisibilityChange);
            setInterval(updateTimeAndState, 1000); updateTimeAndState();
            onValue(feedsRef, (snap) => { state.rssFeeds = snap.val() || {}; refreshNews(); });
            fetchWeatherData(); setInterval(fetchWeatherData, 150000); setInterval(displayWeather, 6000);
            
            // Fixed PWS:
            fetchNyiregyhazaSpecific(); setInterval(fetchNyiregyhazaSpecific, 30000);
            
            setInterval(checkBreakingNews, 45000); setTimeout(checkBreakingNews, 5000);
            setInterval(showCredits, 300000); 
            document.getElementById('manual-refresh-trigger').addEventListener('click', () => refreshNews());
            document.getElementById('next-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); showNextItem(true); });
            document.getElementById('prev-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); state.currentIndex -= 2; showNextItem(true); });
            el.newsContainer.addEventListener('click', (e) => { if(e.target.closest('.controls-bar') || e.target.closest('.breaking-pod')) return; if(state.currentItem && state.currentItem.link) window.open(state.currentItem.link, '_blank'); });
            setTimeout(fetchExchangeRates, 5000);
            initIntroSequence();
        });
    </script>
</body>
</html>
